<HTML><HEAD><META CONTENT="text/html; charset=UTF-8" HTTP-EQUIV="Content-Type"/><TITLE>EMMA Coverage Report</TITLE><STYLE TYPE="text/css"> TABLE,TD,TH {border-style:solid; border-color:black;} TD,TH {background:white;margin:0;line-height:100%;padding-left:0.5em;padding-right:0.5em;} TD {border-width:0 1px 0 0;} TH {border-width:1px 1px 1px 0;} TR TD.h {color:red;} TABLE {border-spacing:0; border-collapse:collapse;border-width:0 0 1px 1px;} P,H1,H2,H3,TH {font-family:verdana,arial,sans-serif;font-size:10pt;} TD {font-family:courier,monospace;font-size:10pt;} TABLE.hdft {border-spacing:0;border-collapse:collapse;border-style:none;} TABLE.hdft TH,TABLE.hdft TD {border-style:none;line-height:normal;} TABLE.hdft TH.tl,TABLE.hdft TD.tl {background:#6699CC;color:white;} TABLE.hdft TD.nv {background:#6633DD;color:white;} .nv A:link {color:white;} .nv A:visited {color:white;} .nv A:active {color:yellow;} TABLE.hdft A:link {color:white;} TABLE.hdft A:visited {color:white;} TABLE.hdft A:active {color:yellow;} .in {color:#356085;} TABLE.s TD {padding-left:0.25em;padding-right:0.25em;} TABLE.s TD.l {padding-left:0.25em;padding-right:0.25em;text-align:right;background:#F0F0F0;} TABLE.s TR.z TD {background:#FF9999;} TABLE.s TR.p TD {background:#FFFF88;} TABLE.s TR.c TD {background:#CCFFCC;} A:link {color:#0000EE;text-decoration:none;} A:visited {color:#0000EE;text-decoration:none;} A:hover {color:#0000EE;text-decoration:underline;} TABLE.cn {border-width:0 0 1px 0;} TABLE.s {border-width:1px 0 1px 1px;} TD.h {color:red;border-width:0 1px 0 0;} TD.f {border-width:0 1px 0 1px;} TD.hf {color:red;border-width:0 1px 0 1px;} TH.f {border-width:1px 1px 1px 1px;} TR.cis TD {background:#F0F0F0;} TR.cis TD {border-width:1px 1px 1px 0;} TR.cis TD.h {color:red;border-width:1px 1px 1px 0;} TR.cis TD.f {border-width:1px 1px 1px 1px;} TR.cis TD.hf {color:red;border-width:1px 1px 1px 1px;} TD.b {border-style:none;background:transparent;line-height:50%;}  TD.bt {border-width:1px 0 0 0;background:transparent;line-height:50%;} TR.o TD {background:#F0F0F0;}TABLE.it {border-style:none;}TABLE.it TD,TABLE.it TH {border-style:none;}</STYLE></HEAD><BODY><TABLE WIDTH="100%" CLASS="hdft" CELLSPACING="0"><TR><TH CLASS="tl"><A HREF="http://emma.sourceforge.net/">EMMA</A> Coverage Report (generated Thu Nov 16 15:09:53 CET 2017)</TH></TR><TR><TD CLASS="nv">[<A HREF="../index.html">all classes</A>][<A HREF="25.html">org.apache.jk.server</A>]</TD></TR></TABLE><H2>COVERAGE SUMMARY FOR SOURCE FILE [<SPAN CLASS="in">JkMain.java</SPAN>]</H2><TABLE WIDTH="100%" CELLSPACING="0"><TR><TH>name</TH><TH>class, %</TH><TH>method, %</TH><TH>block, %</TH><TH>line, %</TH></TR><TR><TD>JkMain.java</TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/47)</TD><TD CLASS="h">0%   (0/1537)</TD><TD CLASS="h">0%   (0/360)</TD></TR></TABLE><H3>COVERAGE BREAKDOWN BY CLASS AND METHOD</H3><TABLE WIDTH="100%" CLASS="cn" CELLSPACING="0"><TR><TH CLASS="f">name</TH><TH>class, %</TH><TH>method, %</TH><TH>block, %</TH><TH>line, %</TH></TR><TR><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#0">JkMain</A></TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/47)</TD><TD CLASS="h">0%   (0/1537)</TD><TD CLASS="h">0%   (0/360)</TD></TR><TR><TD CLASS="f"><A HREF="#1">&lt;static initializer&gt;</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/99)</TD><TD CLASS="h">0%   (0/21)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#0">JkMain (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/90)</TD><TD CLASS="h">0%   (0/19)</TD></TR><TR><TD CLASS="f"><A HREF="#3">checkPropertiesFile (): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/36)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#4">getChannelClassName (): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/6)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#5">getDomain (): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#6">getErr (): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#7">getInitTime (): long</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#8">getJkHome (): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#9">getJkMain (): JkMain</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/2)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#a">getObjectName (): ObjectName</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#b">getOut (): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#c">getPropertiesFile (): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#d">getProperty (String): Object</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/23)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#e">getStartTime (): long</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#f">getWorkerClassName (): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/6)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#10">getWorkerEnv (): WorkerEnv</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/11)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR><TD CLASS="f"><A HREF="#11">guessHome (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/30)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#12">init (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/84)</TD><TD CLASS="h">0%   (0/22)</TD></TR><TR><TD CLASS="f"><A HREF="#13">initHTTPSUrls (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/35)</TD><TD CLASS="h">0%   (0/11)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#14">loadPropertiesFile (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/27)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR><TD CLASS="f"><A HREF="#15">main (String []): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/59)</TD><TD CLASS="h">0%   (0/17)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#16">newHandler (String, String, String): JkHandler</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/94)</TD><TD CLASS="h">0%   (0/19)</TD></TR><TR><TD CLASS="f"><A HREF="#17">pause (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/23)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#18">postDeregister (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#19">postRegister (Boolean): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1a">preDeregister (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#1b">preProcessProperties (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/74)</TD><TD CLASS="h">0%   (0/18)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1c">preRegister (MBeanServer, ObjectName): ObjectName</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/12)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR><TD CLASS="f"><A HREF="#1d">processModules (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/52)</TD><TD CLASS="h">0%   (0/12)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1e">processProperties (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/24)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR><TD CLASS="f"><A HREF="#1f">processProperty (String, String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/137)</TD><TD CLASS="h">0%   (0/28)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#20">resume (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/20)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR><TD CLASS="f"><A HREF="#21">saveProperties (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/60)</TD><TD CLASS="h">0%   (0/11)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#22">setBeanProperty (Object, String, String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/35)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR><TD CLASS="f"><A HREF="#23">setChannelClassName (String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/7)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#24">setErr (String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#25">setJkHome (String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#26">setOut (String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#27">setPropertiesFile (String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/9)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#28">setProperty (String, String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/70)</TD><TD CLASS="h">0%   (0/16)</TD></TR><TR><TD CLASS="f"><A HREF="#29">setPropertyString (String, String, String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/37)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2a">setSaveProperties (boolean): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#2b">setWorkerClassName (String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/7)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2c">setWorkerEnv (WorkerEnv): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#2d">split (String, String): String []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/39)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2e">start (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/142)</TD><TD CLASS="h">0%   (0/26)</TD></TR><TR><TD CLASS="f"><A HREF="#2f">stop (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/138)</TD><TD CLASS="h">0%   (0/32)</TD></TR></TABLE><P></P><TABLE WIDTH="100%" CLASS="s" CELLSPACING="0"><TR><TD CLASS="l">1</TD><TD>/*</TD></TR><TR><TD CLASS="l">2</TD><TD> *  Licensed to the Apache Software Foundation (ASF) under one or more</TD></TR><TR><TD CLASS="l">3</TD><TD> *  contributor license agreements.  See the NOTICE file distributed with</TD></TR><TR><TD CLASS="l">4</TD><TD> *  this work for additional information regarding copyright ownership.</TD></TR><TR><TD CLASS="l">5</TD><TD> *  The ASF licenses this file to You under the Apache License, Version 2.0</TD></TR><TR><TD CLASS="l">6</TD><TD> *  (the &#34;License&#34;); you may not use this file except in compliance with</TD></TR><TR><TD CLASS="l">7</TD><TD> *  the License.  You may obtain a copy of the License at</TD></TR><TR><TD CLASS="l">8</TD><TD> *</TD></TR><TR><TD CLASS="l">9</TD><TD> *      http://www.apache.org/licenses/LICENSE-2.0</TD></TR><TR><TD CLASS="l">10</TD><TD> *</TD></TR><TR><TD CLASS="l">11</TD><TD> *  Unless required by applicable law or agreed to in writing, software</TD></TR><TR><TD CLASS="l">12</TD><TD> *  distributed under the License is distributed on an &#34;AS IS&#34; BASIS,</TD></TR><TR><TD CLASS="l">13</TD><TD> *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</TD></TR><TR><TD CLASS="l">14</TD><TD> *  See the License for the specific language governing permissions and</TD></TR><TR><TD CLASS="l">15</TD><TD> *  limitations under the License.</TD></TR><TR><TD CLASS="l">16</TD><TD> */</TD></TR><TR><TD CLASS="l">17</TD><TD> </TD></TR><TR><TD CLASS="l">18</TD><TD>package org.apache.jk.server;</TD></TR><TR><TD CLASS="l">19</TD><TD> </TD></TR><TR><TD CLASS="l">20</TD><TD>import java.io.File;</TD></TR><TR><TD CLASS="l">21</TD><TD>import java.io.FileInputStream;</TD></TR><TR><TD CLASS="l">22</TD><TD>import java.io.FileOutputStream;</TD></TR><TR><TD CLASS="l">23</TD><TD>import java.io.IOException;</TD></TR><TR><TD CLASS="l">24</TD><TD>import java.io.PrintStream;</TD></TR><TR><TD CLASS="l">25</TD><TD>import java.util.Enumeration;</TD></TR><TR><TD CLASS="l">26</TD><TD>import java.util.Hashtable;</TD></TR><TR><TD CLASS="l">27</TD><TD>import java.util.Properties;</TD></TR><TR><TD CLASS="l">28</TD><TD>import java.util.StringTokenizer;</TD></TR><TR><TD CLASS="l">29</TD><TD>import java.util.Vector;</TD></TR><TR><TD CLASS="l">30</TD><TD> </TD></TR><TR><TD CLASS="l">31</TD><TD>import javax.management.MBeanRegistration;</TD></TR><TR><TD CLASS="l">32</TD><TD>import javax.management.MBeanServer;</TD></TR><TR><TD CLASS="l">33</TD><TD>import javax.management.ObjectName;</TD></TR><TR><TD CLASS="l">34</TD><TD> </TD></TR><TR><TD CLASS="l">35</TD><TD>import org.apache.jk.core.JkHandler;</TD></TR><TR><TD CLASS="l">36</TD><TD>import org.apache.jk.core.WorkerEnv;</TD></TR><TR><TD CLASS="l">37</TD><TD>import org.apache.tomcat.util.IntrospectionUtils;</TD></TR><TR><TD CLASS="l">38</TD><TD>import org.apache.tomcat.util.modeler.Registry;</TD></TR><TR><TD CLASS="l">39</TD><TD> </TD></TR><TR><TD CLASS="l">40</TD><TD>/** Main class used to startup and configure jk. It manages the conf/jk2.properties file</TD></TR><TR><TD CLASS="l">41</TD><TD> *  and is the target of JMX proxy.</TD></TR><TR><TD CLASS="l">42</TD><TD> *</TD></TR><TR><TD CLASS="l">43</TD><TD> *  It implements a policy of save-on-change - whenever a property is changed at</TD></TR><TR><TD CLASS="l">44</TD><TD> *  runtime the jk2.properties file will be overriden. </TD></TR><TR><TD CLASS="l">45</TD><TD> *</TD></TR><TR><TD CLASS="l">46</TD><TD> *  You can edit the config file when tomcat is stoped ( or if you don't use JMX or</TD></TR><TR><TD CLASS="l">47</TD><TD> *  other admin tools ).</TD></TR><TR><TD CLASS="l">48</TD><TD> *</TD></TR><TR><TD CLASS="l">49</TD><TD> *  The format of jk2.properties:</TD></TR><TR><TD CLASS="l">50</TD><TD> *  &lt;dl&gt;</TD></TR><TR><TD CLASS="l">51</TD><TD> *   &lt;dt&gt;TYPE[.LOCALNAME].PROPERTY_NAME=VALUE</TD></TR><TR><TD CLASS="l">52</TD><TD> *   &lt;dd&gt;Set a property on the associated component. TYPE will be used to</TD></TR><TR><TD CLASS="l">53</TD><TD> *   find the class name and instantiate the component. LOCALNAME allows</TD></TR><TR><TD CLASS="l">54</TD><TD> *   multiple instances. In JMX mode, TYPE and LOCALNAME will form the</TD></TR><TR><TD CLASS="l">55</TD><TD> *   JMX name ( eventually combined with a 'jk2' component )</TD></TR><TR><TD CLASS="l">56</TD><TD> *</TD></TR><TR><TD CLASS="l">57</TD><TD> *   &lt;dt&gt;NAME=VALUE</TD></TR><TR><TD CLASS="l">58</TD><TD> *   &lt;dd&gt;Define global properties to be used in ${} substitutions</TD></TR><TR><TD CLASS="l">59</TD><TD> *</TD></TR><TR><TD CLASS="l">60</TD><TD> *   &lt;dt&gt;class.COMPONENT_TYPE=JAVA_CLASS_NAME</TD></TR><TR><TD CLASS="l">61</TD><TD> *   &lt;dd&gt;Adds a new 'type' of component. We predefine all known types.</TD></TR><TR><TD CLASS="l">62</TD><TD> * &lt;/dl&gt;</TD></TR><TR><TD CLASS="l">63</TD><TD> *</TD></TR><TR><TD CLASS="l">64</TD><TD> * Instances are created the first time a component name is found. In addition,</TD></TR><TR><TD CLASS="l">65</TD><TD> * 'handler.list' property will override the list of 'default' components that are</TD></TR><TR><TD CLASS="l">66</TD><TD> * loaded automatically.</TD></TR><TR><TD CLASS="l">67</TD><TD> *</TD></TR><TR><TD CLASS="l">68</TD><TD> *  Note that the properties file is just one (simplistic) way to configure jk. We hope</TD></TR><TR><TD CLASS="l">69</TD><TD> *  to see configs based on registry, LDAP, db, etc. ( XML is not necesarily better )</TD></TR><TR><TD CLASS="l">70</TD><TD> * </TD></TR><TR><TD CLASS="l">71</TD><TD> * @author Costin Manolache</TD></TR><TR><TD CLASS="l">72</TD><TD> */</TD></TR><TR><TD CLASS="l">73</TD><TD>public class JkMain implements MBeanRegistration</TD></TR><TR><TD CLASS="l">74</TD><TD>{</TD></TR><TR><TD CLASS="l">75</TD><TD>    WorkerEnv wEnv;</TD></TR><TR><TD CLASS="l">76</TD><TD>    String propFile;</TD></TR><TR CLASS="z"><TD CLASS="l">77</TD><TD>    Properties props=new Properties();</TD></TR><TR><TD CLASS="l">78</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">79</TD><TD>    Properties modules=new Properties();</TD></TR><TR CLASS="z"><TD CLASS="l">80</TD><TD>    boolean modified=false;</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="0">81</A></TD><TD>    boolean started=false;</TD></TR><TR CLASS="z"><TD CLASS="l">82</TD><TD>    boolean saveProperties=false;</TD></TR><TR><TD CLASS="l">83</TD><TD> </TD></TR><TR><TD CLASS="l">84</TD><TD>    public JkMain()</TD></TR><TR CLASS="z"><TD CLASS="l">85</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">86</TD><TD>        JkMain.jkMain=this;</TD></TR><TR CLASS="z"><TD CLASS="l">87</TD><TD>        modules.put(&#34;channelSocket&#34;, &#34;org.apache.jk.common.ChannelSocket&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">88</TD><TD>        modules.put(&#34;channelNioSocket&#34;, &#34;org.apache.jk.common.ChannelNioSocket&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">89</TD><TD>        modules.put(&#34;channelUnix&#34;, &#34;org.apache.jk.common.ChannelUn&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">90</TD><TD>        modules.put(&#34;channelJni&#34;, &#34;org.apache.jk.common.ChannelJni&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">91</TD><TD>        modules.put(&#34;apr&#34;, &#34;org.apache.jk.apr.AprImpl&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">92</TD><TD>        modules.put(&#34;mx&#34;, &#34;org.apache.jk.common.JkMX&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">93</TD><TD>        modules.put(&#34;modeler&#34;, &#34;org.apache.jk.common.JkModeler&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">94</TD><TD>        modules.put(&#34;shm&#34;, &#34;org.apache.jk.common.Shm&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">95</TD><TD>        modules.put(&#34;request&#34;,&#34;org.apache.jk.common.HandlerRequest&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">96</TD><TD>        modules.put(&#34;container&#34;,&#34;org.apache.jk.common.HandlerRequest&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">97</TD><TD>        modules.put(&#34;modjk&#34;,&#34;org.apache.jk.common.ModJkMX&#34;);</TD></TR><TR><TD CLASS="l"><A NAME="9">98</A></TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">99</TD><TD>    }</TD></TR><TR><TD CLASS="l">100</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="1">101</A></TD><TD>    public static JkMain getJkMain() {</TD></TR><TR CLASS="z"><TD CLASS="l">102</TD><TD>        return jkMain;</TD></TR><TR><TD CLASS="l">103</TD><TD>    }</TD></TR><TR><TD CLASS="l">104</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="13">105</A></TD><TD>    private static String DEFAULT_HTTPS=&#34;com.sun.net.ssl.internal.www.protocol&#34;;</TD></TR><TR><TD CLASS="l">106</TD><TD>    private void initHTTPSUrls() {</TD></TR><TR><TD CLASS="l">107</TD><TD>        try {</TD></TR><TR><TD CLASS="l">108</TD><TD>            // 11657: if only ajp is used, https: redirects need to work ( at least for 1.3+)</TD></TR><TR CLASS="z"><TD CLASS="l">109</TD><TD>            String value = System.getProperty(&#34;java.protocol.handler.pkgs&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">110</TD><TD>            if (value == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">111</TD><TD>                value = DEFAULT_HTTPS;</TD></TR><TR CLASS="z"><TD CLASS="l">112</TD><TD>            } else if (value.indexOf(DEFAULT_HTTPS) &gt;= 0  ) {</TD></TR><TR CLASS="z"><TD CLASS="l">113</TD><TD>                return; // already set</TD></TR><TR><TD CLASS="l">114</TD><TD>            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">115</TD><TD>                value += &#34;|&#34; + DEFAULT_HTTPS;</TD></TR><TR><TD CLASS="l">116</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">117</TD><TD>            System.setProperty(&#34;java.protocol.handler.pkgs&#34;, value);</TD></TR><TR CLASS="z"><TD CLASS="l">118</TD><TD>        } catch(Exception ex ) {</TD></TR><TR CLASS="z"><TD CLASS="l">119</TD><TD>            log.info(&#34;Error adding SSL Protocol Handler&#34;,ex);</TD></TR><TR CLASS="z"><TD CLASS="l">120</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">121</TD><TD>    }</TD></TR><TR><TD CLASS="l">122</TD><TD> </TD></TR><TR><TD CLASS="l">123</TD><TD>    // -------------------- Setting --------------------</TD></TR><TR><TD CLASS="l">124</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="27">125</A></TD><TD>    /** Load a .properties file into and set the values</TD></TR><TR><TD CLASS="l">126</TD><TD>     *  into jk2 configuration.</TD></TR><TR><TD CLASS="l">127</TD><TD>     */</TD></TR><TR><TD CLASS="l">128</TD><TD>    public void setPropertiesFile( String p  ) {</TD></TR><TR CLASS="z"><TD CLASS="l">129</TD><TD>        propFile=p;</TD></TR><TR CLASS="z"><TD CLASS="l">130</TD><TD>        if( started ) {</TD></TR><TR CLASS="z"><TD CLASS="l">131</TD><TD>            loadPropertiesFile();</TD></TR><TR><TD CLASS="l"><A NAME="c">132</A></TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">133</TD><TD>    }</TD></TR><TR><TD CLASS="l">134</TD><TD> </TD></TR><TR><TD CLASS="l">135</TD><TD>    public String getPropertiesFile() {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="2a">136</A></TD><TD>        return propFile;</TD></TR><TR><TD CLASS="l">137</TD><TD>    }</TD></TR><TR><TD CLASS="l">138</TD><TD> </TD></TR><TR><TD CLASS="l">139</TD><TD>    public void setSaveProperties( boolean b ) {</TD></TR><TR CLASS="z"><TD CLASS="l">140</TD><TD>        saveProperties=b;</TD></TR><TR CLASS="z"><TD CLASS="l">141</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="28">142</A></TD><TD> </TD></TR><TR><TD CLASS="l">143</TD><TD>    /** Set a name/value as a jk2 property</TD></TR><TR><TD CLASS="l">144</TD><TD>     */</TD></TR><TR><TD CLASS="l">145</TD><TD>    public void setProperty( String n, String v ) {</TD></TR><TR CLASS="z"><TD CLASS="l">146</TD><TD>        if( &#34;jkHome&#34;.equals( n ) ) {</TD></TR><TR CLASS="z"><TD CLASS="l">147</TD><TD>            setJkHome( v );</TD></TR><TR><TD CLASS="l">148</TD><TD>        } </TD></TR><TR CLASS="z"><TD CLASS="l">149</TD><TD>        if( &#34;propertiesFile&#34;.equals( n ) ) {</TD></TR><TR CLASS="z"><TD CLASS="l">150</TD><TD>            setPropertiesFile( v );</TD></TR><TR><TD CLASS="l">151</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">152</TD><TD>        props.put( n, v );</TD></TR><TR CLASS="z"><TD CLASS="l">153</TD><TD>        if( started ) {</TD></TR><TR><TD CLASS="l">154</TD><TD>            // Replacements need special processing only when started==true,</TD></TR><TR><TD CLASS="l">155</TD><TD>            // because preProcessProperties() handles them during startup.</TD></TR><TR CLASS="z"><TD CLASS="l">156</TD><TD>            String alias = (String) replacements.get(n);</TD></TR><TR CLASS="z"><TD CLASS="l">157</TD><TD>            if (alias != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">158</TD><TD>                props.put( alias, v );</TD></TR><TR CLASS="z"><TD CLASS="l">159</TD><TD>                if (log.isDebugEnabled()) {</TD></TR><TR CLASS="z"><TD CLASS="l">160</TD><TD>                    log.debug(&#34;Substituting &#34; + n + &#34; &#34; + alias + &#34; &#34; + v);</TD></TR><TR><TD CLASS="l">161</TD><TD>                }</TD></TR><TR><TD CLASS="l">162</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">163</TD><TD>            processProperty( n, v );</TD></TR><TR CLASS="z"><TD CLASS="l">164</TD><TD>            if (alias != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">165</TD><TD>                processProperty( alias, v );</TD></TR><TR><TD CLASS="l">166</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">167</TD><TD>            saveProperties();</TD></TR><TR><TD CLASS="l">168</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">169</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="d">170</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">171</TD><TD>     * Retrieve a property.</TD></TR><TR><TD CLASS="l">172</TD><TD>     */</TD></TR><TR><TD CLASS="l">173</TD><TD>    public Object getProperty(String name) {</TD></TR><TR CLASS="z"><TD CLASS="l">174</TD><TD>        String alias = (String)replacements.get(name);</TD></TR><TR CLASS="z"><TD CLASS="l">175</TD><TD>        Object result = null;</TD></TR><TR CLASS="z"><TD CLASS="l">176</TD><TD>        if(alias != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">177</TD><TD>            result = props.get(alias);</TD></TR><TR><TD CLASS="l">178</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">179</TD><TD>        if(result == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">180</TD><TD>            result = props.get(name);</TD></TR><TR><TD CLASS="l">181</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">182</TD><TD>        return result;</TD></TR><TR><TD CLASS="l">183</TD><TD>    }</TD></TR><TR><TD CLASS="l">184</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="23">185</A></TD><TD>     * Set the &lt;code&gt;channelClassName&lt;/code&gt; that will used to connect to</TD></TR><TR><TD CLASS="l">186</TD><TD>     * httpd.</TD></TR><TR><TD CLASS="l">187</TD><TD>     */</TD></TR><TR><TD CLASS="l">188</TD><TD>    public void setChannelClassName(String name) {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="4">189</A></TD><TD>        props.put( &#34;handler.channel.className&#34;,name);</TD></TR><TR CLASS="z"><TD CLASS="l">190</TD><TD>    }</TD></TR><TR><TD CLASS="l">191</TD><TD> </TD></TR><TR><TD CLASS="l">192</TD><TD>    public String getChannelClassName() {</TD></TR><TR CLASS="z"><TD CLASS="l">193</TD><TD>        return (String)props.get( &#34;handler.channel.className&#34;);</TD></TR><TR><TD CLASS="l">194</TD><TD>    }</TD></TR><TR><TD CLASS="l">195</TD><TD> </TD></TR><TR><TD CLASS="l">196</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="2b">197</A></TD><TD>     * Set the &lt;code&gt;workerClassName&lt;/code&gt; that will handle the request.</TD></TR><TR><TD CLASS="l">198</TD><TD>     * ( sort of 'pivot' in axis :-)</TD></TR><TR><TD CLASS="l">199</TD><TD>     */</TD></TR><TR><TD CLASS="l">200</TD><TD>    public void setWorkerClassName(String name) {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="f">201</A></TD><TD>        props.put( &#34;handler.container.className&#34;,name);</TD></TR><TR CLASS="z"><TD CLASS="l">202</TD><TD>    }</TD></TR><TR><TD CLASS="l">203</TD><TD> </TD></TR><TR><TD CLASS="l">204</TD><TD>    public String getWorkerClassName() {</TD></TR><TR CLASS="z"><TD CLASS="l">205</TD><TD>        return (String)props.get( &#34;handler.container.className&#34;);</TD></TR><TR><TD CLASS="l">206</TD><TD>    }</TD></TR><TR><TD CLASS="l">207</TD><TD> </TD></TR><TR><TD CLASS="l">208</TD><TD>    /** Set the base dir of jk2. ( including WEB-INF if in a webapp ).</TD></TR><TR><TD CLASS="l">209</TD><TD>     *  We'll try to guess it from classpath if none is set ( for</TD></TR><TR><TD CLASS="l">210</TD><TD>     *  example on command line ), but if in a servlet environment</TD></TR><TR><TD CLASS="l"><A NAME="25">211</A></TD><TD>     *  you need to use Context.getRealPath or a system property or</TD></TR><TR><TD CLASS="l">212</TD><TD>     *  set it expliciltey.</TD></TR><TR><TD CLASS="l">213</TD><TD>     */</TD></TR><TR><TD CLASS="l">214</TD><TD>    public void setJkHome( String s ) {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="8">215</A></TD><TD>        getWorkerEnv().setJkHome(s);</TD></TR><TR CLASS="z"><TD CLASS="l">216</TD><TD>    }</TD></TR><TR><TD CLASS="l">217</TD><TD> </TD></TR><TR><TD CLASS="l">218</TD><TD>    public String getJkHome() {</TD></TR><TR CLASS="z"><TD CLASS="l">219</TD><TD>        return getWorkerEnv().getJkHome();</TD></TR><TR><TD CLASS="l">220</TD><TD>    }</TD></TR><TR><TD CLASS="l">221</TD><TD> </TD></TR><TR><TD CLASS="l">222</TD><TD>    String out;</TD></TR><TR><TD CLASS="l"><A NAME="26">223</A></TD><TD>    String err;</TD></TR><TR><TD CLASS="l">224</TD><TD>    File propsF;</TD></TR><TR><TD CLASS="l">225</TD><TD>    </TD></TR><TR><TD CLASS="l">226</TD><TD>    public void setOut( String s ) {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="b">227</A></TD><TD>        this.out=s;</TD></TR><TR CLASS="z"><TD CLASS="l">228</TD><TD>    }</TD></TR><TR><TD CLASS="l">229</TD><TD> </TD></TR><TR><TD CLASS="l">230</TD><TD>    public String getOut() {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="24">231</A></TD><TD>        return this.out;</TD></TR><TR><TD CLASS="l">232</TD><TD>    }</TD></TR><TR><TD CLASS="l">233</TD><TD> </TD></TR><TR><TD CLASS="l">234</TD><TD>    public void setErr( String s ) {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="6">235</A></TD><TD>        this.err=s;</TD></TR><TR CLASS="z"><TD CLASS="l">236</TD><TD>    }</TD></TR><TR><TD CLASS="l">237</TD><TD>    </TD></TR><TR><TD CLASS="l">238</TD><TD>    public String getErr() {</TD></TR><TR CLASS="z"><TD CLASS="l">239</TD><TD>        return this.err;</TD></TR><TR><TD CLASS="l">240</TD><TD>    }</TD></TR><TR><TD CLASS="l">241</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="12">242</A></TD><TD>    // -------------------- Initialization --------------------</TD></TR><TR><TD CLASS="l">243</TD><TD>    </TD></TR><TR><TD CLASS="l">244</TD><TD>    public void init() throws IOException</TD></TR><TR><TD CLASS="l">245</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">246</TD><TD>        long t1=System.currentTimeMillis();</TD></TR><TR CLASS="z"><TD CLASS="l">247</TD><TD>        if(null != out) {</TD></TR><TR CLASS="z"><TD CLASS="l">248</TD><TD>            PrintStream outS=new PrintStream(new FileOutputStream(out));</TD></TR><TR CLASS="z"><TD CLASS="l">249</TD><TD>            System.setOut(outS);</TD></TR><TR><TD CLASS="l">250</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">251</TD><TD>        if(null != err) {</TD></TR><TR CLASS="z"><TD CLASS="l">252</TD><TD>            PrintStream errS=new PrintStream(new FileOutputStream(err));</TD></TR><TR CLASS="z"><TD CLASS="l">253</TD><TD>            System.setErr(errS);</TD></TR><TR><TD CLASS="l">254</TD><TD>        }</TD></TR><TR><TD CLASS="l">255</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">256</TD><TD>        String home=getWorkerEnv().getJkHome();</TD></TR><TR CLASS="z"><TD CLASS="l">257</TD><TD>        if( home==null ) {</TD></TR><TR><TD CLASS="l">258</TD><TD>            // XXX use IntrospectionUtil to find myself</TD></TR><TR CLASS="z"><TD CLASS="l">259</TD><TD>            this.guessHome();</TD></TR><TR><TD CLASS="l">260</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">261</TD><TD>        home=getWorkerEnv().getJkHome();</TD></TR><TR CLASS="z"><TD CLASS="l">262</TD><TD>        if( home==null ) {</TD></TR><TR CLASS="z"><TD CLASS="l">263</TD><TD>            log.info( &#34;Can't find home, jk2.properties not loaded&#34;);</TD></TR><TR><TD CLASS="l">264</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">265</TD><TD>        if(log.isDebugEnabled())</TD></TR><TR CLASS="z"><TD CLASS="l">266</TD><TD>            log.debug(&#34;Starting Jk2, base dir= &#34; + home  );</TD></TR><TR CLASS="z"><TD CLASS="l">267</TD><TD>        loadPropertiesFile();</TD></TR><TR><TD CLASS="l">268</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">269</TD><TD>        String initHTTPS = (String)props.get(&#34;class.initHTTPS&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">270</TD><TD>        if(&#34;true&#34;.equalsIgnoreCase(initHTTPS)) {</TD></TR><TR CLASS="z"><TD CLASS="l">271</TD><TD>            initHTTPSUrls();</TD></TR><TR><TD CLASS="l">272</TD><TD>        }</TD></TR><TR><TD CLASS="l">273</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">274</TD><TD>        long t2=System.currentTimeMillis();</TD></TR><TR CLASS="z"><TD CLASS="l">275</TD><TD>        initTime=t2-t1;</TD></TR><TR CLASS="z"><TD CLASS="l">276</TD><TD>    }</TD></TR><TR><TD CLASS="l">277</TD><TD>    </TD></TR><TR CLASS="z"><TD CLASS="l">278</TD><TD>    static String defaultHandlers[]= { &#34;request&#34;,</TD></TR><TR><TD CLASS="l">279</TD><TD>                                       &#34;container&#34;,</TD></TR><TR><TD CLASS="l">280</TD><TD>                                       &#34;channelSocket&#34;};</TD></TR><TR><TD CLASS="l">281</TD><TD>    /*</TD></TR><TR><TD CLASS="l">282</TD><TD>     static String defaultHandlers[]= { &#34;apr&#34;,</TD></TR><TR><TD CLASS="l">283</TD><TD>                                       &#34;shm&#34;,</TD></TR><TR><TD CLASS="l">284</TD><TD>                                       &#34;request&#34;,</TD></TR><TR><TD CLASS="l">285</TD><TD>                                       &#34;container&#34;,</TD></TR><TR><TD CLASS="l">286</TD><TD>                                       &#34;channelSocket&#34;,</TD></TR><TR><TD CLASS="l">287</TD><TD>                                       &#34;channelJni&#34;,</TD></TR><TR><TD CLASS="l">288</TD><TD>                                       &#34;channelUnix&#34;};</TD></TR><TR><TD CLASS="l">289</TD><TD>    */</TD></TR><TR><TD CLASS="l"><A NAME="2f">290</A></TD><TD>    </TD></TR><TR><TD CLASS="l">291</TD><TD>    public void stop() </TD></TR><TR><TD CLASS="l">292</TD><TD>    {</TD></TR><TR><TD CLASS="l">293</TD><TD>        // Clean up the handlers</TD></TR><TR CLASS="z"><TD CLASS="l">294</TD><TD>        MBeanServer s = Registry.getRegistry(null,null).getMBeanServer();</TD></TR><TR CLASS="z"><TD CLASS="l">295</TD><TD>        for( int i=0; i&lt;wEnv.getHandlerCount(); i++ ) {</TD></TR><TR CLASS="z"><TD CLASS="l">296</TD><TD>            JkHandler handler = wEnv.getHandler(i);</TD></TR><TR CLASS="z"><TD CLASS="l">297</TD><TD>            if(handler != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">298</TD><TD>                String handlerName = handler.getName();</TD></TR><TR><TD CLASS="l">299</TD><TD>                try {</TD></TR><TR CLASS="z"><TD CLASS="l">300</TD><TD>                    handler.destroy();</TD></TR><TR CLASS="z"><TD CLASS="l">301</TD><TD>                } catch( IOException ex) {</TD></TR><TR CLASS="z"><TD CLASS="l">302</TD><TD>                    log.error(&#34;Error stopping &#34; + handlerName, ex);</TD></TR><TR CLASS="z"><TD CLASS="l">303</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">304</TD><TD>                if(domain != null) {</TD></TR><TR><TD CLASS="l">305</TD><TD>                    try {</TD></TR><TR CLASS="z"><TD CLASS="l">306</TD><TD>                        ObjectName handlerOname = new ObjectName(</TD></TR><TR><TD CLASS="l">307</TD><TD>                                this.domain + &#34;:&#34; + &#34;type=JkHandler,name=&#34; +</TD></TR><TR><TD CLASS="l">308</TD><TD>                                handlerName);</TD></TR><TR CLASS="z"><TD CLASS="l">309</TD><TD>                        if (s.isRegistered(handlerOname)) {</TD></TR><TR CLASS="z"><TD CLASS="l">310</TD><TD>                            s.unregisterMBean(handlerOname);</TD></TR><TR><TD CLASS="l">311</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">312</TD><TD>                    } catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">313</TD><TD>                        log.error( &#34;Error unregistering &#34; + handlerName, e );</TD></TR><TR CLASS="z"><TD CLASS="l">314</TD><TD>                    }</TD></TR><TR><TD CLASS="l">315</TD><TD> </TD></TR><TR><TD CLASS="l">316</TD><TD>                }</TD></TR><TR><TD CLASS="l">317</TD><TD>            }</TD></TR><TR><TD CLASS="l">318</TD><TD>        }</TD></TR><TR><TD CLASS="l">319</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">320</TD><TD>        started=false;</TD></TR><TR><TD CLASS="l">321</TD><TD>        </TD></TR><TR><TD CLASS="l">322</TD><TD>        // De-register JMX for Env</TD></TR><TR CLASS="z"><TD CLASS="l">323</TD><TD>        if (domain != null) {</TD></TR><TR><TD CLASS="l">324</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">325</TD><TD>                ObjectName wEnvName =</TD></TR><TR><TD CLASS="l">326</TD><TD>                    new ObjectName(domain + &#34;:type=JkWorkerEnv&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">327</TD><TD>                if (s.isRegistered(wEnvName)) {</TD></TR><TR CLASS="z"><TD CLASS="l">328</TD><TD>                    s.unregisterMBean(wEnvName);</TD></TR><TR><TD CLASS="l">329</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">330</TD><TD>            } catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">331</TD><TD>                log.error( &#34;Error unregistering JkWorkerEnv&#34;, e );</TD></TR><TR CLASS="z"><TD CLASS="l">332</TD><TD>            }</TD></TR><TR><TD CLASS="l">333</TD><TD>        }</TD></TR><TR><TD CLASS="l">334</TD><TD> </TD></TR><TR><TD CLASS="l">335</TD><TD>        // De-register JMX for JkMain</TD></TR><TR CLASS="z"><TD CLASS="l">336</TD><TD>        if(oname != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">337</TD><TD>            if (s.isRegistered(oname)) {</TD></TR><TR><TD CLASS="l">338</TD><TD>                try {</TD></TR><TR CLASS="z"><TD CLASS="l">339</TD><TD>                    Registry.getRegistry(null, null)</TD></TR><TR CLASS="z"><TD CLASS="l">340</TD><TD>                        .unregisterComponent(oname);</TD></TR><TR CLASS="z"><TD CLASS="l">341</TD><TD>                } catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">342</TD><TD>                    log.error( &#34;Error unregistering jkmain &#34; + e );</TD></TR><TR CLASS="z"><TD CLASS="l">343</TD><TD>                }</TD></TR><TR><TD CLASS="l">344</TD><TD>            }</TD></TR><TR><TD CLASS="l">345</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="2e">346</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">347</TD><TD>    </TD></TR><TR><TD CLASS="l">348</TD><TD>    public void start() throws IOException</TD></TR><TR><TD CLASS="l">349</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">350</TD><TD>        long t1=System.currentTimeMillis();</TD></TR><TR><TD CLASS="l">351</TD><TD>        // We must have at least 3 handlers:</TD></TR><TR><TD CLASS="l">352</TD><TD>        // channel is the 'transport'</TD></TR><TR><TD CLASS="l">353</TD><TD>        // request is the request processor or 'global' chain</TD></TR><TR><TD CLASS="l">354</TD><TD>        // container is the 'provider'</TD></TR><TR><TD CLASS="l">355</TD><TD>        // Additional handlers may exist and be used internally</TD></TR><TR><TD CLASS="l">356</TD><TD>        // or be chained to create one of the standard handlers </TD></TR><TR><TD CLASS="l">357</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">358</TD><TD>        String handlers[]=defaultHandlers;</TD></TR><TR><TD CLASS="l">359</TD><TD>        // backward compat</TD></TR><TR CLASS="z"><TD CLASS="l">360</TD><TD>        String workers=props.getProperty( &#34;handler.list&#34;, null );</TD></TR><TR CLASS="z"><TD CLASS="l">361</TD><TD>        if( workers!=null ) {</TD></TR><TR CLASS="z"><TD CLASS="l">362</TD><TD>            handlers= split( workers, &#34;,&#34;);</TD></TR><TR><TD CLASS="l">363</TD><TD>        }</TD></TR><TR><TD CLASS="l">364</TD><TD> </TD></TR><TR><TD CLASS="l">365</TD><TD>        // Load additional component declarations</TD></TR><TR CLASS="z"><TD CLASS="l">366</TD><TD>        processModules();</TD></TR><TR><TD CLASS="l">367</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">368</TD><TD>        for( int i=0; i&lt;handlers.length; i++ ) {</TD></TR><TR CLASS="z"><TD CLASS="l">369</TD><TD>            String name= handlers[i];</TD></TR><TR CLASS="z"><TD CLASS="l">370</TD><TD>            JkHandler w=getWorkerEnv().getHandler( name );</TD></TR><TR CLASS="z"><TD CLASS="l">371</TD><TD>            if( w==null ) {</TD></TR><TR CLASS="z"><TD CLASS="l">372</TD><TD>                newHandler( name, &#34;&#34;, name );</TD></TR><TR><TD CLASS="l">373</TD><TD>            }</TD></TR><TR><TD CLASS="l">374</TD><TD>        }</TD></TR><TR><TD CLASS="l">375</TD><TD> </TD></TR><TR><TD CLASS="l">376</TD><TD>        // Process properties - and add aditional handlers.</TD></TR><TR CLASS="z"><TD CLASS="l">377</TD><TD>        processProperties();</TD></TR><TR><TD CLASS="l">378</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">379</TD><TD>        for( int i=0; i&lt;wEnv.getHandlerCount(); i++ ) {</TD></TR><TR CLASS="z"><TD CLASS="l">380</TD><TD>            if( wEnv.getHandler(i) != null ) {</TD></TR><TR><TD CLASS="l">381</TD><TD>                try {</TD></TR><TR CLASS="z"><TD CLASS="l">382</TD><TD>                    wEnv.getHandler(i).init();</TD></TR><TR CLASS="z"><TD CLASS="l">383</TD><TD>                } catch( IOException ex) {</TD></TR><TR CLASS="z"><TD CLASS="l">384</TD><TD>                    if( &#34;apr&#34;.equals(wEnv.getHandler(i).getName() )) {</TD></TR><TR CLASS="z"><TD CLASS="l">385</TD><TD>                        log.info( &#34;APR not loaded, disabling jni components: &#34; + ex.toString());</TD></TR><TR><TD CLASS="l">386</TD><TD>                    } else {</TD></TR><TR CLASS="z"><TD CLASS="l">387</TD><TD>                        log.error( &#34;error initializing &#34; + wEnv.getHandler(i).getName(), ex );</TD></TR><TR><TD CLASS="l">388</TD><TD>                    }</TD></TR><TR CLASS="z"><TD CLASS="l">389</TD><TD>                }</TD></TR><TR><TD CLASS="l">390</TD><TD>            }</TD></TR><TR><TD CLASS="l">391</TD><TD>        }</TD></TR><TR><TD CLASS="l">392</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">393</TD><TD>        started=true;</TD></TR><TR CLASS="z"><TD CLASS="l">394</TD><TD>        long t2=System.currentTimeMillis();</TD></TR><TR CLASS="z"><TD CLASS="l">395</TD><TD>        startTime=t2-t1;</TD></TR><TR><TD CLASS="l">396</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">397</TD><TD>        this.saveProperties();</TD></TR><TR CLASS="z"><TD CLASS="l">398</TD><TD>        log.info(&#34;Jk running ID=&#34; + wEnv.getLocalId() + &#34; time=&#34; + initTime + &#34;/&#34; + startTime +</TD></TR><TR><TD CLASS="l">399</TD><TD>                 &#34;  config=&#34; + propFile);</TD></TR><TR CLASS="z"><TD CLASS="l">400</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="10">401</A></TD><TD> </TD></TR><TR><TD CLASS="l">402</TD><TD>    // -------------------- Usefull methods --------------------</TD></TR><TR><TD CLASS="l">403</TD><TD>    </TD></TR><TR><TD CLASS="l">404</TD><TD>    public WorkerEnv getWorkerEnv() {</TD></TR><TR CLASS="z"><TD CLASS="l">405</TD><TD>        if( wEnv==null ) { </TD></TR><TR CLASS="z"><TD CLASS="l">406</TD><TD>            wEnv=new WorkerEnv();</TD></TR><TR><TD CLASS="l">407</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="2c">408</A></TD><TD>        return wEnv;</TD></TR><TR><TD CLASS="l">409</TD><TD>    }</TD></TR><TR><TD CLASS="l">410</TD><TD> </TD></TR><TR><TD CLASS="l">411</TD><TD>    public void setWorkerEnv(WorkerEnv wEnv) {</TD></TR><TR CLASS="z"><TD CLASS="l">412</TD><TD>        this.wEnv = wEnv;</TD></TR><TR CLASS="z"><TD CLASS="l">413</TD><TD>    }</TD></TR><TR><TD CLASS="l">414</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="22">415</A></TD><TD>    /* A bit of magic to support workers.properties without giving</TD></TR><TR><TD CLASS="l">416</TD><TD>       up the clean get/set</TD></TR><TR><TD CLASS="l">417</TD><TD>    */</TD></TR><TR><TD CLASS="l">418</TD><TD>    public void setBeanProperty( Object target, String name, String val ) {</TD></TR><TR CLASS="z"><TD CLASS="l">419</TD><TD>        if( val!=null )</TD></TR><TR CLASS="z"><TD CLASS="l">420</TD><TD>            val=IntrospectionUtils.replaceProperties( val, props, null );</TD></TR><TR CLASS="z"><TD CLASS="l">421</TD><TD>        if( log.isDebugEnabled())</TD></TR><TR CLASS="z"><TD CLASS="l">422</TD><TD>            log.debug( &#34;setProperty &#34; + target + &#34; &#34; + name + &#34;=&#34; + val );</TD></TR><TR><TD CLASS="l">423</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">424</TD><TD>        IntrospectionUtils.setProperty( target, name, val );</TD></TR><TR CLASS="z"><TD CLASS="l">425</TD><TD>    }</TD></TR><TR><TD CLASS="l">426</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="29">427</A></TD><TD>    /* </TD></TR><TR><TD CLASS="l">428</TD><TD>     * Set a handler property</TD></TR><TR><TD CLASS="l">429</TD><TD>     */</TD></TR><TR><TD CLASS="l">430</TD><TD>    public void setPropertyString( String handlerN, String name, String val ) {</TD></TR><TR CLASS="z"><TD CLASS="l">431</TD><TD>        if( log.isDebugEnabled() )</TD></TR><TR CLASS="z"><TD CLASS="l">432</TD><TD>            log.debug( &#34;setProperty &#34; + handlerN + &#34; &#34; + name + &#34;=&#34; + val );</TD></TR><TR CLASS="z"><TD CLASS="l">433</TD><TD>        Object target=getWorkerEnv().getHandler( handlerN );</TD></TR><TR><TD CLASS="l">434</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">435</TD><TD>        setBeanProperty( target, name, val );</TD></TR><TR CLASS="z"><TD CLASS="l">436</TD><TD>        if( started ) {</TD></TR><TR CLASS="z"><TD CLASS="l">437</TD><TD>            saveProperties();</TD></TR><TR><TD CLASS="l">438</TD><TD>        }</TD></TR><TR><TD CLASS="l">439</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">440</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="7">441</A></TD><TD> </TD></TR><TR><TD CLASS="l">442</TD><TD>    /** The time it took to initialize jk ( ms)</TD></TR><TR><TD CLASS="l">443</TD><TD>     */</TD></TR><TR><TD CLASS="l">444</TD><TD>    public long getInitTime() {</TD></TR><TR CLASS="z"><TD CLASS="l">445</TD><TD>        return initTime;</TD></TR><TR><TD CLASS="l">446</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="e">447</A></TD><TD> </TD></TR><TR><TD CLASS="l">448</TD><TD>    /** The time it took to start jk ( ms )</TD></TR><TR><TD CLASS="l">449</TD><TD>     */</TD></TR><TR><TD CLASS="l">450</TD><TD>    public long getStartTime() {</TD></TR><TR CLASS="z"><TD CLASS="l">451</TD><TD>        return startTime;</TD></TR><TR><TD CLASS="l">452</TD><TD>    }</TD></TR><TR><TD CLASS="l">453</TD><TD>    </TD></TR><TR><TD CLASS="l">454</TD><TD>    // -------------------- Main --------------------</TD></TR><TR><TD CLASS="l">455</TD><TD> </TD></TR><TR><TD CLASS="l">456</TD><TD>    long initTime;</TD></TR><TR><TD CLASS="l">457</TD><TD>    long startTime;</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="15">458</A></TD><TD>    static JkMain jkMain=null;</TD></TR><TR><TD CLASS="l">459</TD><TD> </TD></TR><TR><TD CLASS="l">460</TD><TD>    public static void main(String args[]) {</TD></TR><TR><TD CLASS="l">461</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">462</TD><TD>            if( args.length == 1 &amp;&amp;</TD></TR><TR CLASS="z"><TD CLASS="l">463</TD><TD>                ( &#34;-?&#34;.equals(args[0]) || &#34;-h&#34;.equals( args[0])) ) {</TD></TR><TR CLASS="z"><TD CLASS="l">464</TD><TD>                System.out.println(&#34;Usage: &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">465</TD><TD>                System.out.println(&#34;  JkMain [args]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">466</TD><TD>                System.out.println();</TD></TR><TR CLASS="z"><TD CLASS="l">467</TD><TD>                System.out.println(&#34;  Each bean setter corresponds to an arg ( like -debug 10 )&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">468</TD><TD>                System.out.println(&#34;  System properties:&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">469</TD><TD>                System.out.println(&#34;    jk2.home    Base dir of jk2&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">470</TD><TD>                return;</TD></TR><TR><TD CLASS="l">471</TD><TD>            }</TD></TR><TR><TD CLASS="l">472</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">473</TD><TD>            jkMain=new JkMain();</TD></TR><TR><TD CLASS="l">474</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">475</TD><TD>            IntrospectionUtils.processArgs( jkMain, args, new String[] {},</TD></TR><TR><TD CLASS="l">476</TD><TD>                                            null, new Hashtable());</TD></TR><TR><TD CLASS="l">477</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">478</TD><TD>            jkMain.init();</TD></TR><TR CLASS="z"><TD CLASS="l">479</TD><TD>            jkMain.start();</TD></TR><TR CLASS="z"><TD CLASS="l">480</TD><TD>        } catch( Exception ex ) {</TD></TR><TR CLASS="z"><TD CLASS="l">481</TD><TD>            log.warn(&#34;Error running&#34;,ex);</TD></TR><TR CLASS="z"><TD CLASS="l">482</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">483</TD><TD>    }</TD></TR><TR><TD CLASS="l">484</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="3">485</A></TD><TD>    // -------------------- Private methods --------------------</TD></TR><TR><TD CLASS="l">486</TD><TD> </TD></TR><TR><TD CLASS="l">487</TD><TD> </TD></TR><TR><TD CLASS="l">488</TD><TD>    private boolean checkPropertiesFile() {</TD></TR><TR CLASS="z"><TD CLASS="l">489</TD><TD>        if(propFile == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">490</TD><TD>            return false;</TD></TR><TR><TD CLASS="l">491</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">492</TD><TD>        propsF = new File(propFile);</TD></TR><TR CLASS="z"><TD CLASS="l">493</TD><TD>        if(!propsF.isAbsolute()) {</TD></TR><TR CLASS="z"><TD CLASS="l">494</TD><TD>            String home = getWorkerEnv().getJkHome();</TD></TR><TR CLASS="z"><TD CLASS="l">495</TD><TD>            if( home == null ) {</TD></TR><TR CLASS="z"><TD CLASS="l">496</TD><TD>                return false;</TD></TR><TR><TD CLASS="l">497</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">498</TD><TD>            propsF = new File(home, propFile);</TD></TR><TR><TD CLASS="l">499</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="14">500</A></TD><TD>        return propsF.exists();</TD></TR><TR><TD CLASS="l">501</TD><TD>    }</TD></TR><TR><TD CLASS="l">502</TD><TD>            </TD></TR><TR><TD CLASS="l">503</TD><TD>    private void loadPropertiesFile() {</TD></TR><TR CLASS="z"><TD CLASS="l">504</TD><TD>        if(!checkPropertiesFile()) {</TD></TR><TR CLASS="z"><TD CLASS="l">505</TD><TD>            return;</TD></TR><TR><TD CLASS="l">506</TD><TD>        }</TD></TR><TR><TD CLASS="l">507</TD><TD> </TD></TR><TR><TD CLASS="l">508</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">509</TD><TD>            props.load( new FileInputStream(propsF) );</TD></TR><TR CLASS="z"><TD CLASS="l">510</TD><TD>        } catch(IOException ex ){</TD></TR><TR CLASS="z"><TD CLASS="l">511</TD><TD>            log.warn(&#34;Unable to load properties from &#34;+propsF,ex);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="21">512</A></TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">513</TD><TD>    }</TD></TR><TR><TD CLASS="l">514</TD><TD> </TD></TR><TR><TD CLASS="l">515</TD><TD>    public  void saveProperties() {</TD></TR><TR CLASS="z"><TD CLASS="l">516</TD><TD>        if( !saveProperties) return;</TD></TR><TR><TD CLASS="l">517</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">518</TD><TD>        if(propsF == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">519</TD><TD>            log.warn(&#34;No properties file specified. Unable to save&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">520</TD><TD>            return;</TD></TR><TR><TD CLASS="l">521</TD><TD>        }</TD></TR><TR><TD CLASS="l">522</TD><TD>        // Temp - to check if it works</TD></TR><TR CLASS="z"><TD CLASS="l">523</TD><TD>        File outFile= new File(propsF.getParentFile(), propsF.getName()+&#34;.save&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">524</TD><TD>        log.debug(&#34;Saving properties &#34; + outFile );</TD></TR><TR><TD CLASS="l">525</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">526</TD><TD>            props.store( new FileOutputStream(outFile), &#34;AUTOMATICALLY GENERATED&#34; );</TD></TR><TR CLASS="z"><TD CLASS="l">527</TD><TD>        } catch(IOException ex ){</TD></TR><TR CLASS="z"><TD CLASS="l">528</TD><TD>            log.warn(&#34;Unable to save to &#34;+outFile,ex);</TD></TR><TR CLASS="z"><TD CLASS="l">529</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">530</TD><TD>    }</TD></TR><TR><TD CLASS="l">531</TD><TD> </TD></TR><TR><TD CLASS="l">532</TD><TD>    // translate top-level keys ( from coyote or generic ) into component keys</TD></TR><TR CLASS="z"><TD CLASS="l">533</TD><TD>    static Hashtable replacements=new Hashtable();</TD></TR><TR><TD CLASS="l">534</TD><TD>    static {</TD></TR><TR CLASS="z"><TD CLASS="l">535</TD><TD>        replacements.put(&#34;port&#34;,&#34;channelSocket.port&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">536</TD><TD>        replacements.put(&#34;maxPort&#34;, &#34;channelSocket.maxPort&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">537</TD><TD>        replacements.put(&#34;maxThreads&#34;, &#34;channelSocket.maxThreads&#34;);   </TD></TR><TR CLASS="z"><TD CLASS="l">538</TD><TD>        replacements.put(&#34;minSpareThreads&#34;, &#34;channelSocket.minSpareThreads&#34;);   </TD></TR><TR CLASS="z"><TD CLASS="l">539</TD><TD>        replacements.put(&#34;maxSpareThreads&#34;, &#34;channelSocket.maxSpareThreads&#34;);   </TD></TR><TR CLASS="z"><TD CLASS="l">540</TD><TD>        replacements.put(&#34;backlog&#34;, &#34;channelSocket.backlog&#34;);   </TD></TR><TR CLASS="z"><TD CLASS="l">541</TD><TD>        replacements.put(&#34;tcpNoDelay&#34;, &#34;channelSocket.tcpNoDelay&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">542</TD><TD>        replacements.put(&#34;soTimeout&#34;, &#34;channelSocket.soTimeout&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">543</TD><TD>        replacements.put(&#34;timeout&#34;, &#34;channelSocket.timeout&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">544</TD><TD>        replacements.put(&#34;address&#34;, &#34;channelSocket.address&#34;);            </TD></TR><TR CLASS="z"><TD CLASS="l">545</TD><TD>        replacements.put(&#34;bufferSize&#34;, &#34;channelSocket.bufferSize&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">546</TD><TD>        replacements.put(&#34;tomcatAuthentication&#34;, &#34;request.tomcatAuthentication&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">547</TD><TD>        replacements.put(&#34;packetSize&#34;, &#34;channelSocket.packetSize&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="1b">548</A></TD><TD>        replacements.put(&#34;maxHeaderCount&#34;, &#34;request.maxHeaderCount&#34;);</TD></TR><TR><TD CLASS="l">549</TD><TD>    }</TD></TR><TR><TD CLASS="l">550</TD><TD> </TD></TR><TR><TD CLASS="l">551</TD><TD>    private void preProcessProperties() {</TD></TR><TR CLASS="z"><TD CLASS="l">552</TD><TD>        Enumeration keys=props.keys();</TD></TR><TR CLASS="z"><TD CLASS="l">553</TD><TD>        Vector v=new Vector();</TD></TR><TR><TD CLASS="l">554</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">555</TD><TD>        while( keys.hasMoreElements() ) {</TD></TR><TR CLASS="z"><TD CLASS="l">556</TD><TD>            String key=(String)keys.nextElement();          </TD></TR><TR CLASS="z"><TD CLASS="l">557</TD><TD>            Object newName=replacements.get(key);</TD></TR><TR CLASS="z"><TD CLASS="l">558</TD><TD>            if( newName !=null ) {</TD></TR><TR CLASS="z"><TD CLASS="l">559</TD><TD>                v.addElement(key);</TD></TR><TR><TD CLASS="l">560</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">561</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">562</TD><TD>        keys=v.elements();</TD></TR><TR CLASS="z"><TD CLASS="l">563</TD><TD>        while( keys.hasMoreElements() ) {</TD></TR><TR CLASS="z"><TD CLASS="l">564</TD><TD>            String key=(String)keys.nextElement();</TD></TR><TR CLASS="z"><TD CLASS="l">565</TD><TD>            Object propValue=props.getProperty( key );</TD></TR><TR CLASS="z"><TD CLASS="l">566</TD><TD>            String replacement=(String)replacements.get(key);</TD></TR><TR CLASS="z"><TD CLASS="l">567</TD><TD>            props.put(replacement, propValue);</TD></TR><TR CLASS="z"><TD CLASS="l">568</TD><TD>            if( log.isDebugEnabled()) </TD></TR><TR CLASS="z"><TD CLASS="l">569</TD><TD>                log.debug(&#34;Substituting &#34; + key + &#34; &#34; + replacement + &#34; &#34; + </TD></TR><TR><TD CLASS="l">570</TD><TD>                    propValue);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="1e">571</A></TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">572</TD><TD>    }</TD></TR><TR><TD CLASS="l">573</TD><TD>    </TD></TR><TR><TD CLASS="l">574</TD><TD>    private void processProperties() {</TD></TR><TR CLASS="z"><TD CLASS="l">575</TD><TD>        preProcessProperties();</TD></TR><TR CLASS="z"><TD CLASS="l">576</TD><TD>        Enumeration keys=props.keys();</TD></TR><TR><TD CLASS="l">577</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">578</TD><TD>        while( keys.hasMoreElements() ) {</TD></TR><TR CLASS="z"><TD CLASS="l">579</TD><TD>            String name=(String)keys.nextElement();</TD></TR><TR CLASS="z"><TD CLASS="l">580</TD><TD>            String propValue=props.getProperty( name );</TD></TR><TR><TD CLASS="l">581</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">582</TD><TD>            processProperty( name, propValue );</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="1f">583</A></TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">584</TD><TD>    }</TD></TR><TR><TD CLASS="l">585</TD><TD> </TD></TR><TR><TD CLASS="l">586</TD><TD>    private void processProperty(String name, String propValue) {</TD></TR><TR CLASS="z"><TD CLASS="l">587</TD><TD>        String type=name;</TD></TR><TR CLASS="z"><TD CLASS="l">588</TD><TD>        String fullName=name;</TD></TR><TR CLASS="z"><TD CLASS="l">589</TD><TD>        String localName=&#34;&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">590</TD><TD>        String propName=&#34;&#34;;</TD></TR><TR><TD CLASS="l">591</TD><TD>        // ignore</TD></TR><TR CLASS="z"><TD CLASS="l">592</TD><TD>        if( name.startsWith(&#34;key.&#34;)) return;</TD></TR><TR><TD CLASS="l">593</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">594</TD><TD>        int dot=name.indexOf(&#34;.&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">595</TD><TD>        int lastDot=name.lastIndexOf(&#34;.&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">596</TD><TD>        if( dot &gt; 0 ) {</TD></TR><TR CLASS="z"><TD CLASS="l">597</TD><TD>            type=name.substring(0, dot );</TD></TR><TR CLASS="z"><TD CLASS="l">598</TD><TD>            if( dot != lastDot ) {</TD></TR><TR CLASS="z"><TD CLASS="l">599</TD><TD>                localName=name.substring( dot + 1, lastDot );</TD></TR><TR CLASS="z"><TD CLASS="l">600</TD><TD>                fullName=type + &#34;.&#34; + localName;</TD></TR><TR><TD CLASS="l">601</TD><TD>            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">602</TD><TD>                fullName=type;</TD></TR><TR><TD CLASS="l">603</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">604</TD><TD>            propName=name.substring( lastDot+1);</TD></TR><TR><TD CLASS="l">605</TD><TD>        } else {</TD></TR><TR CLASS="z"><TD CLASS="l">606</TD><TD>            return;</TD></TR><TR><TD CLASS="l">607</TD><TD>        }</TD></TR><TR><TD CLASS="l">608</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">609</TD><TD>        if( log.isDebugEnabled() )</TD></TR><TR CLASS="z"><TD CLASS="l">610</TD><TD>            log.debug( &#34;Processing &#34; + type + &#34;:&#34; + localName + &#34;:&#34; + fullName + &#34; &#34; + propName );</TD></TR><TR CLASS="z"><TD CLASS="l">611</TD><TD>        if( &#34;class&#34;.equals( type ) || &#34;handler&#34;.equals( type ) ) {</TD></TR><TR CLASS="z"><TD CLASS="l">612</TD><TD>            return;</TD></TR><TR><TD CLASS="l">613</TD><TD>        }</TD></TR><TR><TD CLASS="l">614</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">615</TD><TD>        JkHandler comp=getWorkerEnv().getHandler( fullName );</TD></TR><TR CLASS="z"><TD CLASS="l">616</TD><TD>        if( comp==null ) {</TD></TR><TR CLASS="z"><TD CLASS="l">617</TD><TD>            comp=newHandler( type, localName, fullName );</TD></TR><TR><TD CLASS="l">618</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">619</TD><TD>        if( comp==null )</TD></TR><TR CLASS="z"><TD CLASS="l">620</TD><TD>            return;</TD></TR><TR><TD CLASS="l">621</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">622</TD><TD>        if( log.isDebugEnabled() ) </TD></TR><TR CLASS="z"><TD CLASS="l">623</TD><TD>            log.debug(&#34;Setting &#34; + propName + &#34; on &#34; + fullName + &#34; &#34; + comp);</TD></TR><TR CLASS="z"><TD CLASS="l">624</TD><TD>        this.setBeanProperty( comp, propName, propValue );</TD></TR><TR CLASS="z"><TD CLASS="l">625</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="16">626</A></TD><TD> </TD></TR><TR><TD CLASS="l">627</TD><TD>    private JkHandler newHandler( String type, String localName, String fullName )</TD></TR><TR><TD CLASS="l">628</TD><TD>    {</TD></TR><TR><TD CLASS="l">629</TD><TD>        JkHandler handler;</TD></TR><TR CLASS="z"><TD CLASS="l">630</TD><TD>        String classN=modules.getProperty(type);</TD></TR><TR CLASS="z"><TD CLASS="l">631</TD><TD>        if( classN == null ) {</TD></TR><TR CLASS="z"><TD CLASS="l">632</TD><TD>            log.error(&#34;No class name for &#34; + fullName + &#34; &#34; + type );</TD></TR><TR CLASS="z"><TD CLASS="l">633</TD><TD>            return null;</TD></TR><TR><TD CLASS="l">634</TD><TD>        }</TD></TR><TR><TD CLASS="l">635</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">636</TD><TD>            Class channelclass = Class.forName(classN);</TD></TR><TR CLASS="z"><TD CLASS="l">637</TD><TD>            handler=(JkHandler)channelclass.newInstance();</TD></TR><TR CLASS="z"><TD CLASS="l">638</TD><TD>        } catch (Throwable ex) {</TD></TR><TR CLASS="z"><TD CLASS="l">639</TD><TD>            handler=null;</TD></TR><TR CLASS="z"><TD CLASS="l">640</TD><TD>            log.error( &#34;Can't create &#34; + fullName, ex );</TD></TR><TR CLASS="z"><TD CLASS="l">641</TD><TD>            return null;</TD></TR><TR CLASS="z"><TD CLASS="l">642</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">643</TD><TD>        if( this.domain != null ) {</TD></TR><TR><TD CLASS="l">644</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">645</TD><TD>                ObjectName handlerOname = new ObjectName</TD></TR><TR><TD CLASS="l">646</TD><TD>                    (this.domain + &#34;:&#34; + &#34;type=JkHandler,name=&#34; + fullName);</TD></TR><TR CLASS="z"><TD CLASS="l">647</TD><TD>                Registry.getRegistry(null, null).registerComponent(handler, handlerOname, classN);</TD></TR><TR CLASS="z"><TD CLASS="l">648</TD><TD>            } catch (Exception e) {</TD></TR><TR CLASS="z"><TD CLASS="l">649</TD><TD>                log.error( &#34;Error registering &#34; + fullName, e );</TD></TR><TR CLASS="z"><TD CLASS="l">650</TD><TD>            }</TD></TR><TR><TD CLASS="l">651</TD><TD> </TD></TR><TR><TD CLASS="l">652</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">653</TD><TD>        wEnv.addHandler( fullName, handler );</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="1d">654</A></TD><TD>        return handler;</TD></TR><TR><TD CLASS="l">655</TD><TD>    }</TD></TR><TR><TD CLASS="l">656</TD><TD> </TD></TR><TR><TD CLASS="l">657</TD><TD>    private void processModules() {</TD></TR><TR CLASS="z"><TD CLASS="l">658</TD><TD>        Enumeration keys=props.keys();</TD></TR><TR CLASS="z"><TD CLASS="l">659</TD><TD>        int plen=6;</TD></TR><TR><TD CLASS="l">660</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">661</TD><TD>        while( keys.hasMoreElements() ) {</TD></TR><TR CLASS="z"><TD CLASS="l">662</TD><TD>            String k=(String)keys.nextElement();</TD></TR><TR CLASS="z"><TD CLASS="l">663</TD><TD>            if( ! k.startsWith( &#34;class.&#34; ) )</TD></TR><TR CLASS="z"><TD CLASS="l">664</TD><TD>                continue;</TD></TR><TR><TD CLASS="l">665</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">666</TD><TD>            String name= k.substring( plen );</TD></TR><TR CLASS="z"><TD CLASS="l">667</TD><TD>            String propValue=props.getProperty( k );</TD></TR><TR><TD CLASS="l">668</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">669</TD><TD>            if( log.isDebugEnabled()) log.debug(&#34;Register &#34; + name + &#34; &#34; + propValue );</TD></TR><TR CLASS="z"><TD CLASS="l">670</TD><TD>            modules.put( name, propValue );</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="2d">671</A></TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">672</TD><TD>    }</TD></TR><TR><TD CLASS="l">673</TD><TD> </TD></TR><TR><TD CLASS="l">674</TD><TD>    private String[] split(String s, String delim ) {</TD></TR><TR CLASS="z"><TD CLASS="l">675</TD><TD>         Vector v=new Vector();</TD></TR><TR CLASS="z"><TD CLASS="l">676</TD><TD>        StringTokenizer st=new StringTokenizer(s, delim );</TD></TR><TR CLASS="z"><TD CLASS="l">677</TD><TD>        while( st.hasMoreTokens() ) {</TD></TR><TR CLASS="z"><TD CLASS="l">678</TD><TD>            v.addElement( st.nextToken());</TD></TR><TR><TD CLASS="l">679</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">680</TD><TD>        String res[]=new String[ v.size() ];</TD></TR><TR CLASS="z"><TD CLASS="l">681</TD><TD>        for( int i=0; i&lt;res.length; i++ ) {</TD></TR><TR CLASS="z"><TD CLASS="l">682</TD><TD>            res[i]=(String)v.elementAt(i);</TD></TR><TR><TD CLASS="l">683</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">684</TD><TD>        return res;</TD></TR><TR><TD CLASS="l">685</TD><TD>    }</TD></TR><TR><TD CLASS="l">686</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="11">687</A></TD><TD>    // guessing home</TD></TR><TR CLASS="z"><TD CLASS="l">688</TD><TD>    private static String CNAME=&#34;org/apache/jk/server/JkMain.class&#34;;</TD></TR><TR><TD CLASS="l">689</TD><TD> </TD></TR><TR><TD CLASS="l">690</TD><TD>    private void guessHome() {</TD></TR><TR CLASS="z"><TD CLASS="l">691</TD><TD>        String home= wEnv.getJkHome();</TD></TR><TR CLASS="z"><TD CLASS="l">692</TD><TD>        if( home != null )</TD></TR><TR CLASS="z"><TD CLASS="l">693</TD><TD>            return;</TD></TR><TR CLASS="z"><TD CLASS="l">694</TD><TD>        home=IntrospectionUtils.guessInstall( &#34;jk2.home&#34;,&#34;jk2.home&#34;,</TD></TR><TR><TD CLASS="l">695</TD><TD>                                              &#34;tomcat-jk2.jar&#34;, CNAME );</TD></TR><TR CLASS="z"><TD CLASS="l">696</TD><TD>        if( home != null ) {</TD></TR><TR CLASS="z"><TD CLASS="l">697</TD><TD>            log.info(&#34;Guessed home &#34; + home );</TD></TR><TR CLASS="z"><TD CLASS="l">698</TD><TD>            wEnv.setJkHome( home );</TD></TR><TR><TD CLASS="l">699</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">700</TD><TD>    }</TD></TR><TR><TD CLASS="l">701</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">702</TD><TD>    static org.apache.juli.logging.Log log=</TD></TR><TR CLASS="z"><TD CLASS="l">703</TD><TD>        org.apache.juli.logging.LogFactory.getLog( JkMain.class );</TD></TR><TR><TD CLASS="l">704</TD><TD> </TD></TR><TR><TD CLASS="l">705</TD><TD>    protected String domain;</TD></TR><TR><TD CLASS="l"><A NAME="a">706</A></TD><TD>    protected ObjectName oname;</TD></TR><TR><TD CLASS="l">707</TD><TD>    protected MBeanServer mserver;</TD></TR><TR><TD CLASS="l">708</TD><TD> </TD></TR><TR><TD CLASS="l">709</TD><TD>    public ObjectName getObjectName() {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="5">710</A></TD><TD>        return oname;</TD></TR><TR><TD CLASS="l">711</TD><TD>    }</TD></TR><TR><TD CLASS="l">712</TD><TD> </TD></TR><TR><TD CLASS="l">713</TD><TD>    public String getDomain() {</TD></TR><TR CLASS="z"><TD CLASS="l">714</TD><TD>        return domain;</TD></TR><TR><TD CLASS="l"><A NAME="1c">715</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">716</TD><TD> </TD></TR><TR><TD CLASS="l">717</TD><TD>    public ObjectName preRegister(MBeanServer server,</TD></TR><TR><TD CLASS="l">718</TD><TD>                                  ObjectName name) throws Exception {</TD></TR><TR CLASS="z"><TD CLASS="l">719</TD><TD>        oname=name;</TD></TR><TR CLASS="z"><TD CLASS="l">720</TD><TD>        mserver=server;</TD></TR><TR CLASS="z"><TD CLASS="l">721</TD><TD>        domain=name.getDomain();</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="19">722</A></TD><TD>        return name;</TD></TR><TR><TD CLASS="l">723</TD><TD>    }</TD></TR><TR><TD CLASS="l">724</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="1a">725</A></TD><TD>    public void postRegister(Boolean registrationDone) {</TD></TR><TR CLASS="z"><TD CLASS="l">726</TD><TD>    }</TD></TR><TR><TD CLASS="l">727</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="18">728</A></TD><TD>    public void preDeregister() throws Exception {</TD></TR><TR CLASS="z"><TD CLASS="l">729</TD><TD>    }</TD></TR><TR><TD CLASS="l">730</TD><TD> </TD></TR><TR><TD CLASS="l">731</TD><TD>    public void postDeregister() {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="17">732</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">733</TD><TD> </TD></TR><TR><TD CLASS="l">734</TD><TD>    public void pause() throws Exception {</TD></TR><TR><TD CLASS="l">735</TD><TD>        // wEnv sometime null at shutdown - bug45591</TD></TR><TR CLASS="z"><TD CLASS="l">736</TD><TD>        if (wEnv != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">737</TD><TD>            for( int i=0; i&lt;wEnv.getHandlerCount(); i++ ) {</TD></TR><TR CLASS="z"><TD CLASS="l">738</TD><TD>                if( wEnv.getHandler(i) != null ) {</TD></TR><TR CLASS="z"><TD CLASS="l">739</TD><TD>                    wEnv.getHandler(i).pause();</TD></TR><TR><TD CLASS="l">740</TD><TD>                }</TD></TR><TR><TD CLASS="l">741</TD><TD>            }</TD></TR><TR><TD CLASS="l"><A NAME="20">742</A></TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">743</TD><TD>    }</TD></TR><TR><TD CLASS="l">744</TD><TD> </TD></TR><TR><TD CLASS="l">745</TD><TD>    public void resume() throws Exception {</TD></TR><TR CLASS="z"><TD CLASS="l">746</TD><TD>        for( int i=0; i&lt;wEnv.getHandlerCount(); i++ ) {</TD></TR><TR CLASS="z"><TD CLASS="l">747</TD><TD>            if( wEnv.getHandler(i) != null ) {</TD></TR><TR CLASS="z"><TD CLASS="l">748</TD><TD>                wEnv.getHandler(i).resume();</TD></TR><TR><TD CLASS="l">749</TD><TD>            }</TD></TR><TR><TD CLASS="l">750</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">751</TD><TD>    }</TD></TR><TR><TD CLASS="l">752</TD><TD> </TD></TR><TR><TD CLASS="l">753</TD><TD> </TD></TR><TR><TD CLASS="l">754</TD><TD>}</TD></TR></TABLE><P></P><TABLE WIDTH="100%" CLASS="hdft" CELLSPACING="0"><TR><TD CLASS="nv">[<A HREF="../index.html">all classes</A>][<A HREF="25.html">org.apache.jk.server</A>]</TD></TR><TR><TD CLASS="tl"><A HREF="http://sourceforge.net/projects/emma">EMMA 2.1.5320 (stable)</A> (C) Vladimir Roubtsov</TD></TR></TABLE></BODY></HTML>