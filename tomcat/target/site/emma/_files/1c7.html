<HTML><HEAD><META CONTENT="text/html; charset=UTF-8" HTTP-EQUIV="Content-Type"/><TITLE>EMMA Coverage Report</TITLE><STYLE TYPE="text/css"> TABLE,TD,TH {border-style:solid; border-color:black;} TD,TH {background:white;margin:0;line-height:100%;padding-left:0.5em;padding-right:0.5em;} TD {border-width:0 1px 0 0;} TH {border-width:1px 1px 1px 0;} TR TD.h {color:red;} TABLE {border-spacing:0; border-collapse:collapse;border-width:0 0 1px 1px;} P,H1,H2,H3,TH {font-family:verdana,arial,sans-serif;font-size:10pt;} TD {font-family:courier,monospace;font-size:10pt;} TABLE.hdft {border-spacing:0;border-collapse:collapse;border-style:none;} TABLE.hdft TH,TABLE.hdft TD {border-style:none;line-height:normal;} TABLE.hdft TH.tl,TABLE.hdft TD.tl {background:#6699CC;color:white;} TABLE.hdft TD.nv {background:#6633DD;color:white;} .nv A:link {color:white;} .nv A:visited {color:white;} .nv A:active {color:yellow;} TABLE.hdft A:link {color:white;} TABLE.hdft A:visited {color:white;} TABLE.hdft A:active {color:yellow;} .in {color:#356085;} TABLE.s TD {padding-left:0.25em;padding-right:0.25em;} TABLE.s TD.l {padding-left:0.25em;padding-right:0.25em;text-align:right;background:#F0F0F0;} TABLE.s TR.z TD {background:#FF9999;} TABLE.s TR.p TD {background:#FFFF88;} TABLE.s TR.c TD {background:#CCFFCC;} A:link {color:#0000EE;text-decoration:none;} A:visited {color:#0000EE;text-decoration:none;} A:hover {color:#0000EE;text-decoration:underline;} TABLE.cn {border-width:0 0 1px 0;} TABLE.s {border-width:1px 0 1px 1px;} TD.h {color:red;border-width:0 1px 0 0;} TD.f {border-width:0 1px 0 1px;} TD.hf {color:red;border-width:0 1px 0 1px;} TH.f {border-width:1px 1px 1px 1px;} TR.cis TD {background:#F0F0F0;} TR.cis TD {border-width:1px 1px 1px 0;} TR.cis TD.h {color:red;border-width:1px 1px 1px 0;} TR.cis TD.f {border-width:1px 1px 1px 1px;} TR.cis TD.hf {color:red;border-width:1px 1px 1px 1px;} TD.b {border-style:none;background:transparent;line-height:50%;}  TD.bt {border-width:1px 0 0 0;background:transparent;line-height:50%;} TR.o TD {background:#F0F0F0;}TABLE.it {border-style:none;}TABLE.it TD,TABLE.it TH {border-style:none;}</STYLE></HEAD><BODY><TABLE WIDTH="100%" CLASS="hdft" CELLSPACING="0"><TR><TH CLASS="tl"><A HREF="http://emma.sourceforge.net/">EMMA</A> Coverage Report (generated Thu Nov 16 15:09:53 CET 2017)</TH></TR><TR><TD CLASS="nv">[<A HREF="../index.html">all classes</A>][<A HREF="32.html">org.apache.catalina.ha.session</A>]</TD></TR></TABLE><H2>COVERAGE SUMMARY FOR SOURCE FILE [<SPAN CLASS="in">DeltaManager.java</SPAN>]</H2><TABLE WIDTH="100%" CELLSPACING="0"><TR><TH>name</TH><TH>class, %</TH><TH>method, %</TH><TH>block, %</TH><TH>line, %</TH></TR><TR><TD>DeltaManager.java</TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/105)</TD><TD CLASS="h">0%   (0/2743)</TD><TD CLASS="h">0%   (0/653)</TD></TR></TABLE><H3>COVERAGE BREAKDOWN BY CLASS AND METHOD</H3><TABLE WIDTH="100%" CLASS="cn" CELLSPACING="0"><TR><TH CLASS="f">name</TH><TH>class, %</TH><TH>method, %</TH><TH>block, %</TH><TH>line, %</TH></TR><TR><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#0">DeltaManager</A></TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/105)</TD><TD CLASS="h">0%   (0/2743)</TD><TD CLASS="h">0%   (0/653)</TD></TR><TR><TD CLASS="f"><A HREF="#0">&lt;static initializer&gt;</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/9)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2">DeltaManager (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/134)</TD><TD CLASS="h">0%   (0/44)</TD></TR><TR><TD CLASS="f"><A HREF="#3">addLifecycleListener (LifecycleListener): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#4">changeSessionId (Session): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#5">changeSessionId (Session, boolean): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/56)</TD><TD CLASS="h">0%   (0/14)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#6">checkSenderDomain (SessionMessage, Member): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/38)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR><TD CLASS="f"><A HREF="#7">cloneFromTemplate (): ClusterManager</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/81)</TD><TD CLASS="h">0%   (0/19)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#8">createEmptySession (): Session</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#9">createSession (String): Session</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#a">createSession (String, boolean): Session</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/54)</TD><TD CLASS="h">0%   (0/10)</TD></TR><TR><TD CLASS="f"><A HREF="#b">deserializeDeltaRequest (DeltaSession, byte []): DeltaRequest</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/26)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#c">deserializeSessionId (byte []): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/11)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR><TD CLASS="f"><A HREF="#d">deserializeSessions (byte []): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/124)</TD><TD CLASS="h">0%   (0/35)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#e">doDomainReplication (): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#f">expireAllLocalSessions (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/92)</TD><TD CLASS="h">0%   (0/16)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#10">findLifecycleListeners (): LifecycleListener []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#11">findSessionMasterMember (): Member</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/41)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#12">getAllClusterSessions (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/192)</TD><TD CLASS="h">0%   (0/33)</TD></TR><TR><TD CLASS="f"><A HREF="#13">getCluster (): CatalinaCluster</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#14">getCounterNoStateTransfered (): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#15">getCounterReceive_EVT_ALL_SESSION_DATA (): long</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#16">getCounterReceive_EVT_ALL_SESSION_NOCONTEXTMANAGER (): long</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#17">getCounterReceive_EVT_ALL_SESSION_TRANSFERCOMPLETE (): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#18">getCounterReceive_EVT_CHANGE_SESSION_ID (): long</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#19">getCounterReceive_EVT_GET_ALL_SESSIONS (): long</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1a">getCounterReceive_EVT_SESSION_ACCESSED (): long</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#1b">getCounterReceive_EVT_SESSION_CREATED (): long</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1c">getCounterReceive_EVT_SESSION_DELTA (): long</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#1d">getCounterReceive_EVT_SESSION_EXPIRED (): long</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1e">getCounterSend_EVT_ALL_SESSION_DATA (): long</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#1f">getCounterSend_EVT_ALL_SESSION_TRANSFERCOMPLETE (): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#20">getCounterSend_EVT_CHANGE_SESSION_ID (): long</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#21">getCounterSend_EVT_GET_ALL_SESSIONS (): long</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#22">getCounterSend_EVT_SESSION_ACCESSED (): long</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#23">getCounterSend_EVT_SESSION_CREATED (): long</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#24">getCounterSend_EVT_SESSION_DELTA (): long</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#25">getCounterSend_EVT_SESSION_EXPIRED (): long</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#26">getInfo (): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/2)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#27">getInvalidatedSessions (): String []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#28">getMaxActiveSessions (): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#29">getName (): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2a">getNewDeltaSession (): DeltaSession</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#2b">getProcessingTime (): long</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2c">getReceivedQueueSize (): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#2d">getRejectedSessions (): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2e">getSendAllSessionsSize (): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#2f">getSendAllSessionsWaitTime (): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#30">getSessionReplaceCounter (): long</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#31">getStateTransferTimeout (): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#32">getStateTransfered (): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#33">handleALL_SESSION_DATA (SessionMessage, Member): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/33)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#34">handleALL_SESSION_NOCONTEXTMANAGER (SessionMessage, Member): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/25)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR><TD CLASS="f"><A HREF="#35">handleALL_SESSION_TRANSFERCOMPLETE (SessionMessage, Member): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/31)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#36">handleCHANGE_SESSION_ID (SessionMessage, Member): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/52)</TD><TD CLASS="h">0%   (0/12)</TD></TR><TR><TD CLASS="f"><A HREF="#37">handleGET_ALL_SESSIONS (SessionMessage, Member): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/123)</TD><TD CLASS="h">0%   (0/21)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#38">handleSESSION_ACCESSED (SessionMessage, Member): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/34)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR><TD CLASS="f"><A HREF="#39">handleSESSION_CREATED (SessionMessage, Member): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/57)</TD><TD CLASS="h">0%   (0/13)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#3a">handleSESSION_DELTA (SessionMessage, Member): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/55)</TD><TD CLASS="h">0%   (0/13)</TD></TR><TR><TD CLASS="f"><A HREF="#3b">handleSESSION_EXPIRED (SessionMessage, Member): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/32)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#3c">isDefaultMode (): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#3d">isExpireSessionsOnShutdown (): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#3e">isNoContextManagerReceived (): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#3f">isNotifyContainerListenersOnReplication (): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#40">isNotifyListenersOnReplication (): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#41">isNotifySessionListenersOnReplication (): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#42">isSendAllSessions (): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#43">isStateTimestampDrop (): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#44">load (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#45">messageDataReceived (ClusterMessage): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/47)</TD><TD CLASS="h">0%   (0/11)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#46">messageReceived (SessionMessage, Member): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/109)</TD><TD CLASS="h">0%   (0/31)</TD></TR><TR><TD CLASS="f"><A HREF="#47">propertyChange (PropertyChangeEvent): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#48">registerSessionAtReplicationValve (DeltaSession): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/68)</TD><TD CLASS="h">0%   (0/13)</TD></TR><TR><TD CLASS="f"><A HREF="#49">removeLifecycleListener (LifecycleListener): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#4a">requestCompleted (String): ClusterMessage</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#4b">requestCompleted (String, boolean): ClusterMessage</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/229)</TD><TD CLASS="h">0%   (0/45)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#4c">resetStatistics (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/126)</TD><TD CLASS="h">0%   (0/34)</TD></TR><TR><TD CLASS="f"><A HREF="#4d">send (SessionMessage): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/16)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#4e">sendCreateSession (String, DeltaSession): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/49)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR><TD CLASS="f"><A HREF="#4f">sendSessions (Member, Session [], long): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/57)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#50">serializeDeltaRequest (DeltaSession, DeltaRequest): byte []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/16)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR><TD CLASS="f"><A HREF="#51">serializeSessionId (String): byte []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/19)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#52">serializeSessions (Session []): byte []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/68)</TD><TD CLASS="h">0%   (0/18)</TD></TR><TR><TD CLASS="f"><A HREF="#53">sessionExpired (String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/41)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#54">setCluster (CatalinaCluster): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#55">setContainer (Container): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/28)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#56">setDefaultMode (boolean): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#57">setDomainReplication (boolean): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#58">setExpireSessionsOnShutdown (boolean): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#59">setMaxActiveSessions (int): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/20)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#5a">setName (String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#5b">setNoContextManagerReceived (boolean): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#5c">setNotifyContainerListenersOnReplication (boolean): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#5d">setNotifyListenersOnReplication (boolean): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#5e">setNotifySessionListenersOnReplication (boolean): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#5f">setRejectedSessions (int): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#60">setSendAllSessions (boolean): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#61">setSendAllSessionsSize (int): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#62">setSendAllSessionsWaitTime (int): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#63">setStateTimestampDrop (boolean): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#64">setStateTransferTimeout (int): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#65">setStateTransfered (boolean): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#66">start (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/126)</TD><TD CLASS="h">0%   (0/37)</TD></TR><TR><TD CLASS="f"><A HREF="#67">stop (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/81)</TD><TD CLASS="h">0%   (0/21)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#68">unload (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#69">waitForSendAllSessions (long): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/119)</TD><TD CLASS="h">0%   (0/25)</TD></TR></TABLE><P></P><TABLE WIDTH="100%" CLASS="s" CELLSPACING="0"><TR><TD CLASS="l">1</TD><TD>/*</TD></TR><TR><TD CLASS="l">2</TD><TD> * Licensed to the Apache Software Foundation (ASF) under one or more</TD></TR><TR><TD CLASS="l">3</TD><TD> * contributor license agreements.  See the NOTICE file distributed with</TD></TR><TR><TD CLASS="l">4</TD><TD> * this work for additional information regarding copyright ownership.</TD></TR><TR><TD CLASS="l">5</TD><TD> * The ASF licenses this file to You under the Apache License, Version 2.0</TD></TR><TR><TD CLASS="l">6</TD><TD> * (the &#34;License&#34;); you may not use this file except in compliance with</TD></TR><TR><TD CLASS="l">7</TD><TD> * the License.  You may obtain a copy of the License at</TD></TR><TR><TD CLASS="l">8</TD><TD> * </TD></TR><TR><TD CLASS="l">9</TD><TD> *      http://www.apache.org/licenses/LICENSE-2.0</TD></TR><TR><TD CLASS="l">10</TD><TD> * </TD></TR><TR><TD CLASS="l">11</TD><TD> * Unless required by applicable law or agreed to in writing, software</TD></TR><TR><TD CLASS="l">12</TD><TD> * distributed under the License is distributed on an &#34;AS IS&#34; BASIS,</TD></TR><TR><TD CLASS="l">13</TD><TD> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</TD></TR><TR><TD CLASS="l">14</TD><TD> * See the License for the specific language governing permissions and</TD></TR><TR><TD CLASS="l">15</TD><TD> * limitations under the License.</TD></TR><TR><TD CLASS="l">16</TD><TD> */</TD></TR><TR><TD CLASS="l">17</TD><TD> </TD></TR><TR><TD CLASS="l">18</TD><TD>package org.apache.catalina.ha.session;</TD></TR><TR><TD CLASS="l">19</TD><TD> </TD></TR><TR><TD CLASS="l">20</TD><TD>import java.beans.PropertyChangeEvent;</TD></TR><TR><TD CLASS="l">21</TD><TD>import java.io.BufferedOutputStream;</TD></TR><TR><TD CLASS="l">22</TD><TD>import java.io.ByteArrayOutputStream;</TD></TR><TR><TD CLASS="l">23</TD><TD>import java.io.IOException;</TD></TR><TR><TD CLASS="l">24</TD><TD>import java.io.ObjectInputStream;</TD></TR><TR><TD CLASS="l">25</TD><TD>import java.io.ObjectOutputStream;</TD></TR><TR><TD CLASS="l">26</TD><TD>import java.util.ArrayList;</TD></TR><TR><TD CLASS="l">27</TD><TD>import java.util.Date;</TD></TR><TR><TD CLASS="l">28</TD><TD>import java.util.Iterator;</TD></TR><TR><TD CLASS="l">29</TD><TD> </TD></TR><TR><TD CLASS="l">30</TD><TD>import org.apache.catalina.Cluster;</TD></TR><TR><TD CLASS="l">31</TD><TD>import org.apache.catalina.Container;</TD></TR><TR><TD CLASS="l">32</TD><TD>import org.apache.catalina.Context;</TD></TR><TR><TD CLASS="l">33</TD><TD>import org.apache.catalina.Engine;</TD></TR><TR><TD CLASS="l">34</TD><TD>import org.apache.catalina.Host;</TD></TR><TR><TD CLASS="l">35</TD><TD>import org.apache.catalina.LifecycleException;</TD></TR><TR><TD CLASS="l">36</TD><TD>import org.apache.catalina.LifecycleListener;</TD></TR><TR><TD CLASS="l">37</TD><TD>import org.apache.catalina.Session;</TD></TR><TR><TD CLASS="l">38</TD><TD>import org.apache.catalina.Valve;</TD></TR><TR><TD CLASS="l">39</TD><TD>import org.apache.catalina.core.StandardContext;</TD></TR><TR><TD CLASS="l">40</TD><TD>import org.apache.catalina.ha.CatalinaCluster;</TD></TR><TR><TD CLASS="l">41</TD><TD>import org.apache.catalina.ha.ClusterMessage;</TD></TR><TR><TD CLASS="l">42</TD><TD>import org.apache.catalina.ha.tcp.ReplicationValve;</TD></TR><TR><TD CLASS="l">43</TD><TD>import org.apache.catalina.session.ManagerBase;</TD></TR><TR><TD CLASS="l">44</TD><TD>import org.apache.catalina.session.TooManyActiveSessionsException;</TD></TR><TR><TD CLASS="l">45</TD><TD>import org.apache.catalina.tribes.Member;</TD></TR><TR><TD CLASS="l">46</TD><TD>import org.apache.catalina.tribes.io.ReplicationStream;</TD></TR><TR><TD CLASS="l">47</TD><TD>import org.apache.catalina.util.LifecycleSupport;</TD></TR><TR><TD CLASS="l">48</TD><TD>import org.apache.catalina.util.StringManager;</TD></TR><TR><TD CLASS="l">49</TD><TD>import org.apache.catalina.ha.ClusterManager;</TD></TR><TR><TD CLASS="l">50</TD><TD> </TD></TR><TR><TD CLASS="l">51</TD><TD>/**</TD></TR><TR><TD CLASS="l">52</TD><TD> * The DeltaManager manages replicated sessions by only replicating the deltas</TD></TR><TR><TD CLASS="l">53</TD><TD> * in data. For applications written to handle this, the DeltaManager is the</TD></TR><TR><TD CLASS="l">54</TD><TD> * optimal way of replicating data.</TD></TR><TR><TD CLASS="l">55</TD><TD> * </TD></TR><TR><TD CLASS="l">56</TD><TD> * This code is almost identical to StandardManager with a difference in how it</TD></TR><TR><TD CLASS="l">57</TD><TD> * persists sessions and some modifications to it.</TD></TR><TR><TD CLASS="l">58</TD><TD> * </TD></TR><TR><TD CLASS="l">59</TD><TD> * &lt;b&gt;IMPLEMENTATION NOTE &lt;/b&gt;: Correct behavior of session storing and</TD></TR><TR><TD CLASS="l">60</TD><TD> * reloading depends upon external calls to the &lt;code&gt;start()&lt;/code&gt; and</TD></TR><TR><TD CLASS="l">61</TD><TD> * &lt;code&gt;stop()&lt;/code&gt; methods of this class at the correct times.</TD></TR><TR><TD CLASS="l">62</TD><TD> * </TD></TR><TR><TD CLASS="l">63</TD><TD> * @author Filip Hanik</TD></TR><TR><TD CLASS="l">64</TD><TD> * @author Craig R. McClanahan</TD></TR><TR><TD CLASS="l">65</TD><TD> * @author Jean-Francois Arcand</TD></TR><TR><TD CLASS="l">66</TD><TD> * @author Peter Rossbach</TD></TR><TR><TD CLASS="l">67</TD><TD> *</TD></TR><TR><TD CLASS="l">68</TD><TD> */</TD></TR><TR><TD CLASS="l"><A NAME="0">69</A></TD><TD> </TD></TR><TR><TD CLASS="l">70</TD><TD>public class DeltaManager extends ClusterManagerBase{</TD></TR><TR><TD CLASS="l">71</TD><TD> </TD></TR><TR><TD CLASS="l">72</TD><TD>    // ---------------------------------------------------- Security Classes</TD></TR><TR CLASS="z"><TD CLASS="l">73</TD><TD>    public static org.apache.juli.logging.Log log = org.apache.juli.logging.LogFactory.getLog(DeltaManager.class);</TD></TR><TR><TD CLASS="l">74</TD><TD> </TD></TR><TR><TD CLASS="l">75</TD><TD>    /**</TD></TR><TR><TD CLASS="l">76</TD><TD>     * The string manager for this package.</TD></TR><TR><TD CLASS="l">77</TD><TD>     */</TD></TR><TR CLASS="z"><TD CLASS="l">78</TD><TD>    protected static StringManager sm = StringManager.getManager(Constants.Package);</TD></TR><TR><TD CLASS="l">79</TD><TD> </TD></TR><TR><TD CLASS="l">80</TD><TD>    // ----------------------------------------------------- Instance Variables</TD></TR><TR><TD CLASS="l">81</TD><TD> </TD></TR><TR><TD CLASS="l">82</TD><TD>    /**</TD></TR><TR><TD CLASS="l">83</TD><TD>     * The descriptive information about this implementation.</TD></TR><TR><TD CLASS="l">84</TD><TD>     */</TD></TR><TR><TD CLASS="l">85</TD><TD>    private static final String info = &#34;DeltaManager/2.1&#34;;</TD></TR><TR><TD CLASS="l">86</TD><TD> </TD></TR><TR><TD CLASS="l">87</TD><TD>    /**</TD></TR><TR><TD CLASS="l">88</TD><TD>     * Has this component been started yet?</TD></TR><TR><TD CLASS="l">89</TD><TD>     */</TD></TR><TR CLASS="z"><TD CLASS="l">90</TD><TD>    private boolean started = false;</TD></TR><TR><TD CLASS="l">91</TD><TD> </TD></TR><TR><TD CLASS="l">92</TD><TD>    /**</TD></TR><TR><TD CLASS="l">93</TD><TD>     * The descriptive name of this Manager implementation (for logging).</TD></TR><TR><TD CLASS="l">94</TD><TD>     */</TD></TR><TR CLASS="z"><TD CLASS="l">95</TD><TD>    protected static String managerName = &#34;DeltaManager&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">96</TD><TD>    protected String name = null;</TD></TR><TR CLASS="z"><TD CLASS="l">97</TD><TD>    protected boolean defaultMode = false;</TD></TR><TR CLASS="z"><TD CLASS="l">98</TD><TD>    private CatalinaCluster cluster = null;</TD></TR><TR><TD CLASS="l">99</TD><TD> </TD></TR><TR><TD CLASS="l">100</TD><TD>    /**</TD></TR><TR><TD CLASS="l">101</TD><TD>     * cached replication valve cluster container!</TD></TR><TR><TD CLASS="l">102</TD><TD>     */</TD></TR><TR CLASS="z"><TD CLASS="l">103</TD><TD>    private ReplicationValve replicationValve = null ;</TD></TR><TR><TD CLASS="l">104</TD><TD>    </TD></TR><TR><TD CLASS="l">105</TD><TD>    /**</TD></TR><TR><TD CLASS="l">106</TD><TD>     * The lifecycle event support for this component.</TD></TR><TR><TD CLASS="l">107</TD><TD>     */</TD></TR><TR CLASS="z"><TD CLASS="l">108</TD><TD>    protected LifecycleSupport lifecycle = new LifecycleSupport(this);</TD></TR><TR><TD CLASS="l">109</TD><TD> </TD></TR><TR><TD CLASS="l">110</TD><TD>    /**</TD></TR><TR><TD CLASS="l">111</TD><TD>     * The maximum number of active Sessions allowed, or -1 for no limit.</TD></TR><TR><TD CLASS="l">112</TD><TD>     */</TD></TR><TR CLASS="z"><TD CLASS="l">113</TD><TD>    private int maxActiveSessions = -1;</TD></TR><TR CLASS="z"><TD CLASS="l">114</TD><TD>    private boolean expireSessionsOnShutdown = false;</TD></TR><TR CLASS="z"><TD CLASS="l">115</TD><TD>    private boolean notifyListenersOnReplication = true;</TD></TR><TR CLASS="z"><TD CLASS="l">116</TD><TD>    private boolean notifySessionListenersOnReplication = true;</TD></TR><TR CLASS="z"><TD CLASS="l">117</TD><TD>    private boolean notifyContainerListenersOnReplication  = true;</TD></TR><TR CLASS="z"><TD CLASS="l">118</TD><TD>    private volatile boolean stateTransfered = false ;</TD></TR><TR CLASS="z"><TD CLASS="l">119</TD><TD>    private volatile boolean noContextManagerReceived = false ;</TD></TR><TR CLASS="z"><TD CLASS="l">120</TD><TD>    private int stateTransferTimeout = 60;</TD></TR><TR CLASS="z"><TD CLASS="l">121</TD><TD>    private boolean sendAllSessions = true;</TD></TR><TR CLASS="z"><TD CLASS="l">122</TD><TD>    private boolean sendClusterDomainOnly = true ;</TD></TR><TR CLASS="z"><TD CLASS="l">123</TD><TD>    private int sendAllSessionsSize = 1000 ;</TD></TR><TR><TD CLASS="l">124</TD><TD>    </TD></TR><TR><TD CLASS="l">125</TD><TD>    /**</TD></TR><TR><TD CLASS="l">126</TD><TD>     * wait time between send session block (default 2 sec) </TD></TR><TR><TD CLASS="l">127</TD><TD>     */</TD></TR><TR CLASS="z"><TD CLASS="l">128</TD><TD>    private int sendAllSessionsWaitTime = 2 * 1000 ; </TD></TR><TR CLASS="z"><TD CLASS="l">129</TD><TD>    private ArrayList receivedMessageQueue = new ArrayList() ;</TD></TR><TR CLASS="z"><TD CLASS="l">130</TD><TD>    private boolean receiverQueue = false ;</TD></TR><TR CLASS="z"><TD CLASS="l">131</TD><TD>    private boolean stateTimestampDrop = true ;</TD></TR><TR><TD CLASS="l">132</TD><TD>    private long stateTransferCreateSendTime; </TD></TR><TR><TD CLASS="l">133</TD><TD>    </TD></TR><TR><TD CLASS="l">134</TD><TD>    // ------------------------------------------------------------------ stats attributes</TD></TR><TR><TD CLASS="l">135</TD><TD>    </TD></TR><TR CLASS="z"><TD CLASS="l">136</TD><TD>    int rejectedSessions = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">137</TD><TD>    private long sessionReplaceCounter = 0 ;</TD></TR><TR CLASS="z"><TD CLASS="l">138</TD><TD>    long processingTime = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">139</TD><TD>    private long counterReceive_EVT_GET_ALL_SESSIONS = 0 ;</TD></TR><TR CLASS="z"><TD CLASS="l">140</TD><TD>    private long counterReceive_EVT_ALL_SESSION_DATA = 0 ;</TD></TR><TR CLASS="z"><TD CLASS="l">141</TD><TD>    private long counterReceive_EVT_SESSION_CREATED = 0 ;</TD></TR><TR CLASS="z"><TD CLASS="l">142</TD><TD>    private long counterReceive_EVT_SESSION_EXPIRED = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">143</TD><TD>    private long counterReceive_EVT_SESSION_ACCESSED = 0 ;</TD></TR><TR CLASS="z"><TD CLASS="l">144</TD><TD>    private long counterReceive_EVT_SESSION_DELTA = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">145</TD><TD>    private int counterReceive_EVT_ALL_SESSION_TRANSFERCOMPLETE = 0 ;</TD></TR><TR CLASS="z"><TD CLASS="l">146</TD><TD>    private long counterReceive_EVT_CHANGE_SESSION_ID = 0 ;</TD></TR><TR CLASS="z"><TD CLASS="l">147</TD><TD>    private long counterReceive_EVT_ALL_SESSION_NOCONTEXTMANAGER = 0 ;</TD></TR><TR CLASS="z"><TD CLASS="l">148</TD><TD>    private long counterSend_EVT_GET_ALL_SESSIONS = 0 ;</TD></TR><TR CLASS="z"><TD CLASS="l">149</TD><TD>    private long counterSend_EVT_ALL_SESSION_DATA = 0 ;</TD></TR><TR CLASS="z"><TD CLASS="l">150</TD><TD>    private long counterSend_EVT_SESSION_CREATED = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">151</TD><TD>    private long counterSend_EVT_SESSION_DELTA = 0 ;</TD></TR><TR CLASS="z"><TD CLASS="l">152</TD><TD>    private long counterSend_EVT_SESSION_ACCESSED = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">153</TD><TD>    private long counterSend_EVT_SESSION_EXPIRED = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">154</TD><TD>    private int counterSend_EVT_ALL_SESSION_TRANSFERCOMPLETE = 0 ;</TD></TR><TR CLASS="z"><TD CLASS="l">155</TD><TD>    private long counterSend_EVT_CHANGE_SESSION_ID = 0;</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="2">156</A></TD><TD>    private int counterNoStateTransfered = 0 ;</TD></TR><TR><TD CLASS="l">157</TD><TD> </TD></TR><TR><TD CLASS="l">158</TD><TD>    // ------------------------------------------------------------- Constructor</TD></TR><TR><TD CLASS="l">159</TD><TD>    public DeltaManager() {</TD></TR><TR CLASS="z"><TD CLASS="l">160</TD><TD>        super();</TD></TR><TR CLASS="z"><TD CLASS="l">161</TD><TD>    }</TD></TR><TR><TD CLASS="l">162</TD><TD> </TD></TR><TR><TD CLASS="l">163</TD><TD>    // ------------------------------------------------------------- Properties</TD></TR><TR><TD CLASS="l">164</TD><TD>    </TD></TR><TR><TD CLASS="l">165</TD><TD>    /**</TD></TR><TR><TD CLASS="l">166</TD><TD>     * Return descriptive information about this Manager implementation and the</TD></TR><TR><TD CLASS="l"><A NAME="26">167</A></TD><TD>     * corresponding version number, in the format</TD></TR><TR><TD CLASS="l">168</TD><TD>     * &lt;code&gt;&amp;lt;description&amp;gt;/&amp;lt;version&amp;gt;&lt;/code&gt;.</TD></TR><TR><TD CLASS="l">169</TD><TD>     */</TD></TR><TR><TD CLASS="l">170</TD><TD>    public String getInfo() {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="5a">171</A></TD><TD>        return info;</TD></TR><TR><TD CLASS="l">172</TD><TD>    }</TD></TR><TR><TD CLASS="l">173</TD><TD> </TD></TR><TR><TD CLASS="l">174</TD><TD>    public void setName(String name) {</TD></TR><TR CLASS="z"><TD CLASS="l">175</TD><TD>        this.name = name;</TD></TR><TR CLASS="z"><TD CLASS="l">176</TD><TD>    }</TD></TR><TR><TD CLASS="l">177</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="29">178</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">179</TD><TD>     * Return the descriptive short name of this Manager implementation.</TD></TR><TR><TD CLASS="l">180</TD><TD>     */</TD></TR><TR><TD CLASS="l">181</TD><TD>    public String getName() {</TD></TR><TR CLASS="z"><TD CLASS="l">182</TD><TD>        return name;</TD></TR><TR><TD CLASS="l">183</TD><TD>    }</TD></TR><TR><TD CLASS="l">184</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="21">185</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">186</TD><TD>     * @return Returns the counterSend_EVT_GET_ALL_SESSIONS.</TD></TR><TR><TD CLASS="l">187</TD><TD>     */</TD></TR><TR><TD CLASS="l">188</TD><TD>    public long getCounterSend_EVT_GET_ALL_SESSIONS() {</TD></TR><TR CLASS="z"><TD CLASS="l">189</TD><TD>        return counterSend_EVT_GET_ALL_SESSIONS;</TD></TR><TR><TD CLASS="l">190</TD><TD>    }</TD></TR><TR><TD CLASS="l">191</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="22">192</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">193</TD><TD>     * @return Returns the counterSend_EVT_SESSION_ACCESSED.</TD></TR><TR><TD CLASS="l">194</TD><TD>     */</TD></TR><TR><TD CLASS="l">195</TD><TD>    public long getCounterSend_EVT_SESSION_ACCESSED() {</TD></TR><TR CLASS="z"><TD CLASS="l">196</TD><TD>        return counterSend_EVT_SESSION_ACCESSED;</TD></TR><TR><TD CLASS="l">197</TD><TD>    }</TD></TR><TR><TD CLASS="l">198</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="23">199</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">200</TD><TD>     * @return Returns the counterSend_EVT_SESSION_CREATED.</TD></TR><TR><TD CLASS="l">201</TD><TD>     */</TD></TR><TR><TD CLASS="l">202</TD><TD>    public long getCounterSend_EVT_SESSION_CREATED() {</TD></TR><TR CLASS="z"><TD CLASS="l">203</TD><TD>        return counterSend_EVT_SESSION_CREATED;</TD></TR><TR><TD CLASS="l">204</TD><TD>    }</TD></TR><TR><TD CLASS="l">205</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="24">206</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">207</TD><TD>     * @return Returns the counterSend_EVT_SESSION_DELTA.</TD></TR><TR><TD CLASS="l">208</TD><TD>     */</TD></TR><TR><TD CLASS="l">209</TD><TD>    public long getCounterSend_EVT_SESSION_DELTA() {</TD></TR><TR CLASS="z"><TD CLASS="l">210</TD><TD>        return counterSend_EVT_SESSION_DELTA;</TD></TR><TR><TD CLASS="l">211</TD><TD>    }</TD></TR><TR><TD CLASS="l">212</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="25">213</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">214</TD><TD>     * @return Returns the counterSend_EVT_SESSION_EXPIRED.</TD></TR><TR><TD CLASS="l">215</TD><TD>     */</TD></TR><TR><TD CLASS="l">216</TD><TD>    public long getCounterSend_EVT_SESSION_EXPIRED() {</TD></TR><TR CLASS="z"><TD CLASS="l">217</TD><TD>        return counterSend_EVT_SESSION_EXPIRED;</TD></TR><TR><TD CLASS="l">218</TD><TD>    }</TD></TR><TR><TD CLASS="l">219</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="1e">220</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">221</TD><TD>     * @return Returns the counterSend_EVT_ALL_SESSION_DATA.</TD></TR><TR><TD CLASS="l">222</TD><TD>     */</TD></TR><TR><TD CLASS="l">223</TD><TD>    public long getCounterSend_EVT_ALL_SESSION_DATA() {</TD></TR><TR CLASS="z"><TD CLASS="l">224</TD><TD>        return counterSend_EVT_ALL_SESSION_DATA;</TD></TR><TR><TD CLASS="l">225</TD><TD>    }</TD></TR><TR><TD CLASS="l">226</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="1f">227</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">228</TD><TD>     * @return Returns the counterSend_EVT_ALL_SESSION_TRANSFERCOMPLETE.</TD></TR><TR><TD CLASS="l">229</TD><TD>     */</TD></TR><TR><TD CLASS="l">230</TD><TD>    public int getCounterSend_EVT_ALL_SESSION_TRANSFERCOMPLETE() {</TD></TR><TR CLASS="z"><TD CLASS="l">231</TD><TD>        return counterSend_EVT_ALL_SESSION_TRANSFERCOMPLETE;</TD></TR><TR><TD CLASS="l">232</TD><TD>    }</TD></TR><TR><TD CLASS="l">233</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="20">234</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">235</TD><TD>     * @return Returns the counterSend_EVT_CHANGE_SESSION_ID.</TD></TR><TR><TD CLASS="l">236</TD><TD>     */</TD></TR><TR><TD CLASS="l">237</TD><TD>    public long getCounterSend_EVT_CHANGE_SESSION_ID() {</TD></TR><TR CLASS="z"><TD CLASS="l">238</TD><TD>        return counterSend_EVT_CHANGE_SESSION_ID;</TD></TR><TR><TD CLASS="l">239</TD><TD>    }</TD></TR><TR><TD CLASS="l">240</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="15">241</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">242</TD><TD>     * @return Returns the counterReceive_EVT_ALL_SESSION_DATA.</TD></TR><TR><TD CLASS="l">243</TD><TD>     */</TD></TR><TR><TD CLASS="l">244</TD><TD>    public long getCounterReceive_EVT_ALL_SESSION_DATA() {</TD></TR><TR CLASS="z"><TD CLASS="l">245</TD><TD>        return counterReceive_EVT_ALL_SESSION_DATA;</TD></TR><TR><TD CLASS="l">246</TD><TD>    }</TD></TR><TR><TD CLASS="l">247</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="19">248</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">249</TD><TD>     * @return Returns the counterReceive_EVT_GET_ALL_SESSIONS.</TD></TR><TR><TD CLASS="l">250</TD><TD>     */</TD></TR><TR><TD CLASS="l">251</TD><TD>    public long getCounterReceive_EVT_GET_ALL_SESSIONS() {</TD></TR><TR CLASS="z"><TD CLASS="l">252</TD><TD>        return counterReceive_EVT_GET_ALL_SESSIONS;</TD></TR><TR><TD CLASS="l">253</TD><TD>    }</TD></TR><TR><TD CLASS="l">254</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="1a">255</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">256</TD><TD>     * @return Returns the counterReceive_EVT_SESSION_ACCESSED.</TD></TR><TR><TD CLASS="l">257</TD><TD>     */</TD></TR><TR><TD CLASS="l">258</TD><TD>    public long getCounterReceive_EVT_SESSION_ACCESSED() {</TD></TR><TR CLASS="z"><TD CLASS="l">259</TD><TD>        return counterReceive_EVT_SESSION_ACCESSED;</TD></TR><TR><TD CLASS="l">260</TD><TD>    }</TD></TR><TR><TD CLASS="l">261</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="1b">262</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">263</TD><TD>     * @return Returns the counterReceive_EVT_SESSION_CREATED.</TD></TR><TR><TD CLASS="l">264</TD><TD>     */</TD></TR><TR><TD CLASS="l">265</TD><TD>    public long getCounterReceive_EVT_SESSION_CREATED() {</TD></TR><TR CLASS="z"><TD CLASS="l">266</TD><TD>        return counterReceive_EVT_SESSION_CREATED;</TD></TR><TR><TD CLASS="l">267</TD><TD>    }</TD></TR><TR><TD CLASS="l">268</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="1c">269</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">270</TD><TD>     * @return Returns the counterReceive_EVT_SESSION_DELTA.</TD></TR><TR><TD CLASS="l">271</TD><TD>     */</TD></TR><TR><TD CLASS="l">272</TD><TD>    public long getCounterReceive_EVT_SESSION_DELTA() {</TD></TR><TR CLASS="z"><TD CLASS="l">273</TD><TD>        return counterReceive_EVT_SESSION_DELTA;</TD></TR><TR><TD CLASS="l">274</TD><TD>    }</TD></TR><TR><TD CLASS="l">275</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="1d">276</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">277</TD><TD>     * @return Returns the counterReceive_EVT_SESSION_EXPIRED.</TD></TR><TR><TD CLASS="l">278</TD><TD>     */</TD></TR><TR><TD CLASS="l">279</TD><TD>    public long getCounterReceive_EVT_SESSION_EXPIRED() {</TD></TR><TR CLASS="z"><TD CLASS="l">280</TD><TD>        return counterReceive_EVT_SESSION_EXPIRED;</TD></TR><TR><TD CLASS="l">281</TD><TD>    }</TD></TR><TR><TD CLASS="l">282</TD><TD>    </TD></TR><TR><TD CLASS="l">283</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="17">284</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">285</TD><TD>     * @return Returns the counterReceive_EVT_ALL_SESSION_TRANSFERCOMPLETE.</TD></TR><TR><TD CLASS="l">286</TD><TD>     */</TD></TR><TR><TD CLASS="l">287</TD><TD>    public int getCounterReceive_EVT_ALL_SESSION_TRANSFERCOMPLETE() {</TD></TR><TR CLASS="z"><TD CLASS="l">288</TD><TD>        return counterReceive_EVT_ALL_SESSION_TRANSFERCOMPLETE;</TD></TR><TR><TD CLASS="l">289</TD><TD>    }</TD></TR><TR><TD CLASS="l">290</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="18">291</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">292</TD><TD>     * @return Returns the counterReceive_EVT_CHANGE_SESSION_ID.</TD></TR><TR><TD CLASS="l">293</TD><TD>     */</TD></TR><TR><TD CLASS="l">294</TD><TD>    public long getCounterReceive_EVT_CHANGE_SESSION_ID() {</TD></TR><TR CLASS="z"><TD CLASS="l">295</TD><TD>        return counterReceive_EVT_CHANGE_SESSION_ID;</TD></TR><TR><TD CLASS="l">296</TD><TD>    }</TD></TR><TR><TD CLASS="l">297</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="16">298</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">299</TD><TD>     * @return Returns the counterReceive_EVT_ALL_SESSION_NOCONTEXTMANAGER.</TD></TR><TR><TD CLASS="l">300</TD><TD>     */</TD></TR><TR><TD CLASS="l">301</TD><TD>    public long getCounterReceive_EVT_ALL_SESSION_NOCONTEXTMANAGER() {</TD></TR><TR CLASS="z"><TD CLASS="l">302</TD><TD>        return counterReceive_EVT_ALL_SESSION_NOCONTEXTMANAGER;</TD></TR><TR><TD CLASS="l">303</TD><TD>    }</TD></TR><TR><TD CLASS="l">304</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="2b">305</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">306</TD><TD>     * @return Returns the processingTime.</TD></TR><TR><TD CLASS="l">307</TD><TD>     */</TD></TR><TR><TD CLASS="l">308</TD><TD>    public long getProcessingTime() {</TD></TR><TR CLASS="z"><TD CLASS="l">309</TD><TD>        return processingTime;</TD></TR><TR><TD CLASS="l">310</TD><TD>    }</TD></TR><TR><TD CLASS="l">311</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="30">312</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">313</TD><TD>     * @return Returns the sessionReplaceCounter.</TD></TR><TR><TD CLASS="l">314</TD><TD>     */</TD></TR><TR><TD CLASS="l">315</TD><TD>    public long getSessionReplaceCounter() {</TD></TR><TR CLASS="z"><TD CLASS="l">316</TD><TD>        return sessionReplaceCounter;</TD></TR><TR><TD CLASS="l">317</TD><TD>    }</TD></TR><TR><TD CLASS="l">318</TD><TD>    </TD></TR><TR><TD CLASS="l">319</TD><TD>    /**</TD></TR><TR><TD CLASS="l">320</TD><TD>     * Number of session creations that failed due to maxActiveSessions</TD></TR><TR><TD CLASS="l"><A NAME="2d">321</A></TD><TD>     * </TD></TR><TR><TD CLASS="l">322</TD><TD>     * @return The count</TD></TR><TR><TD CLASS="l">323</TD><TD>     */</TD></TR><TR><TD CLASS="l">324</TD><TD>    public int getRejectedSessions() {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="5f">325</A></TD><TD>        return rejectedSessions;</TD></TR><TR><TD CLASS="l">326</TD><TD>    }</TD></TR><TR><TD CLASS="l">327</TD><TD> </TD></TR><TR><TD CLASS="l">328</TD><TD>    public void setRejectedSessions(int rejectedSessions) {</TD></TR><TR CLASS="z"><TD CLASS="l">329</TD><TD>        this.rejectedSessions = rejectedSessions;</TD></TR><TR CLASS="z"><TD CLASS="l">330</TD><TD>    }</TD></TR><TR><TD CLASS="l">331</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="14">332</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">333</TD><TD>     * @return Returns the counterNoStateTransfered.</TD></TR><TR><TD CLASS="l">334</TD><TD>     */</TD></TR><TR><TD CLASS="l">335</TD><TD>    public int getCounterNoStateTransfered() {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="2c">336</A></TD><TD>        return counterNoStateTransfered;</TD></TR><TR><TD CLASS="l">337</TD><TD>    }</TD></TR><TR><TD CLASS="l">338</TD><TD>    </TD></TR><TR><TD CLASS="l">339</TD><TD>    public int getReceivedQueueSize() {</TD></TR><TR CLASS="z"><TD CLASS="l">340</TD><TD>        return receivedMessageQueue.size() ;</TD></TR><TR><TD CLASS="l">341</TD><TD>    }</TD></TR><TR><TD CLASS="l">342</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="31">343</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">344</TD><TD>     * @return Returns the stateTransferTimeout.</TD></TR><TR><TD CLASS="l">345</TD><TD>     */</TD></TR><TR><TD CLASS="l">346</TD><TD>    public int getStateTransferTimeout() {</TD></TR><TR CLASS="z"><TD CLASS="l">347</TD><TD>        return stateTransferTimeout;</TD></TR><TR><TD CLASS="l">348</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="64">349</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">350</TD><TD>     * @param timeoutAllSession The timeout</TD></TR><TR><TD CLASS="l">351</TD><TD>     */</TD></TR><TR><TD CLASS="l">352</TD><TD>    public void setStateTransferTimeout(int timeoutAllSession) {</TD></TR><TR CLASS="z"><TD CLASS="l">353</TD><TD>        this.stateTransferTimeout = timeoutAllSession;</TD></TR><TR CLASS="z"><TD CLASS="l">354</TD><TD>    }</TD></TR><TR><TD CLASS="l">355</TD><TD> </TD></TR><TR><TD CLASS="l">356</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="32">357</A></TD><TD>     * is session state transfered complete?</TD></TR><TR><TD CLASS="l">358</TD><TD>     * </TD></TR><TR><TD CLASS="l">359</TD><TD>     */</TD></TR><TR><TD CLASS="l">360</TD><TD>    public boolean getStateTransfered() {</TD></TR><TR CLASS="z"><TD CLASS="l">361</TD><TD>        return stateTransfered;</TD></TR><TR><TD CLASS="l">362</TD><TD>    }</TD></TR><TR><TD CLASS="l">363</TD><TD> </TD></TR><TR><TD CLASS="l">364</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="65">365</A></TD><TD>     * set that state ist complete transfered  </TD></TR><TR><TD CLASS="l">366</TD><TD>     * @param stateTransfered</TD></TR><TR><TD CLASS="l">367</TD><TD>     */</TD></TR><TR><TD CLASS="l">368</TD><TD>    public void setStateTransfered(boolean stateTransfered) {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="3e">369</A></TD><TD>        this.stateTransfered = stateTransfered;</TD></TR><TR CLASS="z"><TD CLASS="l">370</TD><TD>    }</TD></TR><TR><TD CLASS="l">371</TD><TD> </TD></TR><TR><TD CLASS="l">372</TD><TD>    public boolean isNoContextManagerReceived() {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="5b">373</A></TD><TD>        return noContextManagerReceived;</TD></TR><TR><TD CLASS="l">374</TD><TD>    }</TD></TR><TR><TD CLASS="l">375</TD><TD> </TD></TR><TR><TD CLASS="l">376</TD><TD>    public void setNoContextManagerReceived(boolean noContextManagerReceived) {</TD></TR><TR CLASS="z"><TD CLASS="l">377</TD><TD>        this.noContextManagerReceived = noContextManagerReceived;</TD></TR><TR CLASS="z"><TD CLASS="l">378</TD><TD>    }</TD></TR><TR><TD CLASS="l">379</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="2f">380</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">381</TD><TD>     * @return Returns the sendAllSessionsWaitTime in msec</TD></TR><TR><TD CLASS="l">382</TD><TD>     */</TD></TR><TR><TD CLASS="l">383</TD><TD>    public int getSendAllSessionsWaitTime() {</TD></TR><TR CLASS="z"><TD CLASS="l">384</TD><TD>        return sendAllSessionsWaitTime;</TD></TR><TR><TD CLASS="l">385</TD><TD>    }</TD></TR><TR><TD CLASS="l">386</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="62">387</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">388</TD><TD>     * @param sendAllSessionsWaitTime The sendAllSessionsWaitTime to set at msec.</TD></TR><TR><TD CLASS="l">389</TD><TD>     */</TD></TR><TR><TD CLASS="l">390</TD><TD>    public void setSendAllSessionsWaitTime(int sendAllSessionsWaitTime) {</TD></TR><TR CLASS="z"><TD CLASS="l">391</TD><TD>        this.sendAllSessionsWaitTime = sendAllSessionsWaitTime;</TD></TR><TR CLASS="z"><TD CLASS="l">392</TD><TD>    }</TD></TR><TR><TD CLASS="l">393</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="e">394</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">395</TD><TD>     * @return Returns the sendClusterDomainOnly.</TD></TR><TR><TD CLASS="l">396</TD><TD>     */</TD></TR><TR><TD CLASS="l">397</TD><TD>    public boolean doDomainReplication() {</TD></TR><TR CLASS="z"><TD CLASS="l">398</TD><TD>        return sendClusterDomainOnly;</TD></TR><TR><TD CLASS="l">399</TD><TD>    }</TD></TR><TR><TD CLASS="l">400</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="57">401</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">402</TD><TD>     * @param sendClusterDomainOnly The sendClusterDomainOnly to set.</TD></TR><TR><TD CLASS="l">403</TD><TD>     */</TD></TR><TR><TD CLASS="l">404</TD><TD>    public void setDomainReplication(boolean sendClusterDomainOnly) {</TD></TR><TR CLASS="z"><TD CLASS="l">405</TD><TD>        this.sendClusterDomainOnly = sendClusterDomainOnly;</TD></TR><TR CLASS="z"><TD CLASS="l">406</TD><TD>    }</TD></TR><TR><TD CLASS="l">407</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="43">408</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">409</TD><TD>     * @return Returns the stateTimestampDrop.</TD></TR><TR><TD CLASS="l">410</TD><TD>     */</TD></TR><TR><TD CLASS="l">411</TD><TD>    public boolean isStateTimestampDrop() {</TD></TR><TR CLASS="z"><TD CLASS="l">412</TD><TD>        return stateTimestampDrop;</TD></TR><TR><TD CLASS="l">413</TD><TD>    }</TD></TR><TR><TD CLASS="l">414</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="63">415</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">416</TD><TD>     * @param isTimestampDrop The new flag value</TD></TR><TR><TD CLASS="l">417</TD><TD>     */</TD></TR><TR><TD CLASS="l">418</TD><TD>    public void setStateTimestampDrop(boolean isTimestampDrop) {</TD></TR><TR CLASS="z"><TD CLASS="l">419</TD><TD>        this.stateTimestampDrop = isTimestampDrop;</TD></TR><TR CLASS="z"><TD CLASS="l">420</TD><TD>    }</TD></TR><TR><TD CLASS="l">421</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="28">422</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">423</TD><TD>     * Return the maximum number of active Sessions allowed, or -1 for no limit.</TD></TR><TR><TD CLASS="l">424</TD><TD>     */</TD></TR><TR><TD CLASS="l">425</TD><TD>    public int getMaxActiveSessions() {</TD></TR><TR CLASS="z"><TD CLASS="l">426</TD><TD>        return (this.maxActiveSessions);</TD></TR><TR><TD CLASS="l">427</TD><TD>    }</TD></TR><TR><TD CLASS="l">428</TD><TD> </TD></TR><TR><TD CLASS="l">429</TD><TD>    /**</TD></TR><TR><TD CLASS="l">430</TD><TD>     * Set the maximum number of actives Sessions allowed, or -1 for no limit.</TD></TR><TR><TD CLASS="l">431</TD><TD>     * </TD></TR><TR><TD CLASS="l"><A NAME="59">432</A></TD><TD>     * @param max</TD></TR><TR><TD CLASS="l">433</TD><TD>     *            The new maximum number of sessions</TD></TR><TR><TD CLASS="l">434</TD><TD>     */</TD></TR><TR><TD CLASS="l">435</TD><TD>    public void setMaxActiveSessions(int max) {</TD></TR><TR CLASS="z"><TD CLASS="l">436</TD><TD>        int oldMaxActiveSessions = this.maxActiveSessions;</TD></TR><TR CLASS="z"><TD CLASS="l">437</TD><TD>        this.maxActiveSessions = max;</TD></TR><TR CLASS="z"><TD CLASS="l">438</TD><TD>        support.firePropertyChange(&#34;maxActiveSessions&#34;, new Integer(oldMaxActiveSessions), new Integer(this.maxActiveSessions));</TD></TR><TR CLASS="z"><TD CLASS="l">439</TD><TD>    }</TD></TR><TR><TD CLASS="l">440</TD><TD>    </TD></TR><TR><TD CLASS="l">441</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="42">442</A></TD><TD>     * </TD></TR><TR><TD CLASS="l">443</TD><TD>     * @return Returns the sendAllSessions.</TD></TR><TR><TD CLASS="l">444</TD><TD>     */</TD></TR><TR><TD CLASS="l">445</TD><TD>    public boolean isSendAllSessions() {</TD></TR><TR CLASS="z"><TD CLASS="l">446</TD><TD>        return sendAllSessions;</TD></TR><TR><TD CLASS="l">447</TD><TD>    }</TD></TR><TR><TD CLASS="l">448</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="60">449</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">450</TD><TD>     * @param sendAllSessions The sendAllSessions to set.</TD></TR><TR><TD CLASS="l">451</TD><TD>     */</TD></TR><TR><TD CLASS="l">452</TD><TD>    public void setSendAllSessions(boolean sendAllSessions) {</TD></TR><TR CLASS="z"><TD CLASS="l">453</TD><TD>        this.sendAllSessions = sendAllSessions;</TD></TR><TR CLASS="z"><TD CLASS="l">454</TD><TD>    }</TD></TR><TR><TD CLASS="l">455</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="2e">456</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">457</TD><TD>     * @return Returns the sendAllSessionsSize.</TD></TR><TR><TD CLASS="l">458</TD><TD>     */</TD></TR><TR><TD CLASS="l">459</TD><TD>    public int getSendAllSessionsSize() {</TD></TR><TR CLASS="z"><TD CLASS="l">460</TD><TD>        return sendAllSessionsSize;</TD></TR><TR><TD CLASS="l">461</TD><TD>    }</TD></TR><TR><TD CLASS="l">462</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="61">463</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">464</TD><TD>     * @param sendAllSessionsSize The sendAllSessionsSize to set.</TD></TR><TR><TD CLASS="l">465</TD><TD>     */</TD></TR><TR><TD CLASS="l">466</TD><TD>    public void setSendAllSessionsSize(int sendAllSessionsSize) {</TD></TR><TR CLASS="z"><TD CLASS="l">467</TD><TD>        this.sendAllSessionsSize = sendAllSessionsSize;</TD></TR><TR CLASS="z"><TD CLASS="l">468</TD><TD>    }</TD></TR><TR><TD CLASS="l">469</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="41">470</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">471</TD><TD>     * @return Returns the notifySessionListenersOnReplication.</TD></TR><TR><TD CLASS="l">472</TD><TD>     */</TD></TR><TR><TD CLASS="l">473</TD><TD>    public boolean isNotifySessionListenersOnReplication() {</TD></TR><TR CLASS="z"><TD CLASS="l">474</TD><TD>        return notifySessionListenersOnReplication;</TD></TR><TR><TD CLASS="l">475</TD><TD>    }</TD></TR><TR><TD CLASS="l">476</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="5e">477</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">478</TD><TD>     * @param notifyListenersCreateSessionOnReplication The notifySessionListenersOnReplication to set.</TD></TR><TR><TD CLASS="l">479</TD><TD>     */</TD></TR><TR><TD CLASS="l">480</TD><TD>    public void setNotifySessionListenersOnReplication(boolean notifyListenersCreateSessionOnReplication) {</TD></TR><TR CLASS="z"><TD CLASS="l">481</TD><TD>        this.notifySessionListenersOnReplication = notifyListenersCreateSessionOnReplication;</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="3d">482</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">483</TD><TD>    </TD></TR><TR><TD CLASS="l">484</TD><TD>    </TD></TR><TR><TD CLASS="l">485</TD><TD>    public boolean isExpireSessionsOnShutdown() {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="58">486</A></TD><TD>        return expireSessionsOnShutdown;</TD></TR><TR><TD CLASS="l">487</TD><TD>    }</TD></TR><TR><TD CLASS="l">488</TD><TD> </TD></TR><TR><TD CLASS="l">489</TD><TD>    public void setExpireSessionsOnShutdown(boolean expireSessionsOnShutdown) {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="40">490</A></TD><TD>        this.expireSessionsOnShutdown = expireSessionsOnShutdown;</TD></TR><TR CLASS="z"><TD CLASS="l">491</TD><TD>    }</TD></TR><TR><TD CLASS="l">492</TD><TD>    </TD></TR><TR><TD CLASS="l">493</TD><TD>    public boolean isNotifyListenersOnReplication() {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="5d">494</A></TD><TD>        return notifyListenersOnReplication;</TD></TR><TR><TD CLASS="l">495</TD><TD>    }</TD></TR><TR><TD CLASS="l">496</TD><TD> </TD></TR><TR><TD CLASS="l">497</TD><TD>    public void setNotifyListenersOnReplication(boolean notifyListenersOnReplication) {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="3f">498</A></TD><TD>        this.notifyListenersOnReplication = notifyListenersOnReplication;</TD></TR><TR CLASS="z"><TD CLASS="l">499</TD><TD>    }</TD></TR><TR><TD CLASS="l">500</TD><TD> </TD></TR><TR><TD CLASS="l">501</TD><TD>    public boolean isNotifyContainerListenersOnReplication() {</TD></TR><TR CLASS="z"><TD CLASS="l">502</TD><TD>        return notifyContainerListenersOnReplication;</TD></TR><TR><TD CLASS="l"><A NAME="5c">503</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">504</TD><TD> </TD></TR><TR><TD CLASS="l">505</TD><TD>    public void setNotifyContainerListenersOnReplication(</TD></TR><TR><TD CLASS="l">506</TD><TD>            boolean notifyContainerListenersOnReplication) {</TD></TR><TR CLASS="z"><TD CLASS="l">507</TD><TD>        this.notifyContainerListenersOnReplication = notifyContainerListenersOnReplication;</TD></TR><TR CLASS="z"><TD CLASS="l">508</TD><TD>    }</TD></TR><TR><TD CLASS="l">509</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="3c">510</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">511</TD><TD>     * @return Returns the defaultMode.</TD></TR><TR><TD CLASS="l">512</TD><TD>     */</TD></TR><TR><TD CLASS="l">513</TD><TD>    public boolean isDefaultMode() {</TD></TR><TR CLASS="z"><TD CLASS="l">514</TD><TD>        return defaultMode;</TD></TR><TR><TD CLASS="l">515</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="56">516</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">517</TD><TD>     * @param defaultMode The defaultMode to set.</TD></TR><TR><TD CLASS="l">518</TD><TD>     */</TD></TR><TR><TD CLASS="l">519</TD><TD>    public void setDefaultMode(boolean defaultMode) {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="13">520</A></TD><TD>        this.defaultMode = defaultMode;</TD></TR><TR CLASS="z"><TD CLASS="l">521</TD><TD>    }</TD></TR><TR><TD CLASS="l">522</TD><TD>    </TD></TR><TR><TD CLASS="l">523</TD><TD>    public CatalinaCluster getCluster() {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="54">524</A></TD><TD>        return cluster;</TD></TR><TR><TD CLASS="l">525</TD><TD>    }</TD></TR><TR><TD CLASS="l">526</TD><TD> </TD></TR><TR><TD CLASS="l">527</TD><TD>    public void setCluster(CatalinaCluster cluster) {</TD></TR><TR CLASS="z"><TD CLASS="l">528</TD><TD>        this.cluster = cluster;</TD></TR><TR CLASS="z"><TD CLASS="l">529</TD><TD>    }</TD></TR><TR><TD CLASS="l">530</TD><TD> </TD></TR><TR><TD CLASS="l">531</TD><TD>    /**</TD></TR><TR><TD CLASS="l">532</TD><TD>     * Set the Container with which this Manager has been associated. If it is a</TD></TR><TR><TD CLASS="l">533</TD><TD>     * Context (the usual case), listen for changes to the session timeout</TD></TR><TR><TD CLASS="l">534</TD><TD>     * property.</TD></TR><TR><TD CLASS="l">535</TD><TD>     * </TD></TR><TR><TD CLASS="l">536</TD><TD>     * @param container</TD></TR><TR><TD CLASS="l"><A NAME="55">537</A></TD><TD>     *            The associated Container</TD></TR><TR><TD CLASS="l">538</TD><TD>     */</TD></TR><TR><TD CLASS="l">539</TD><TD>    public void setContainer(Container container) {</TD></TR><TR><TD CLASS="l">540</TD><TD>        // De-register from the old Container (if any)</TD></TR><TR CLASS="z"><TD CLASS="l">541</TD><TD>        if ((this.container != null) &amp;&amp; (this.container instanceof Context))</TD></TR><TR CLASS="z"><TD CLASS="l">542</TD><TD>            ((Context) this.container).removePropertyChangeListener(this);</TD></TR><TR><TD CLASS="l">543</TD><TD> </TD></TR><TR><TD CLASS="l">544</TD><TD>        // Default processing provided by our superclass</TD></TR><TR CLASS="z"><TD CLASS="l">545</TD><TD>        super.setContainer(container);</TD></TR><TR><TD CLASS="l">546</TD><TD> </TD></TR><TR><TD CLASS="l">547</TD><TD>        // Register with the new Container (if any)</TD></TR><TR CLASS="z"><TD CLASS="l">548</TD><TD>        if ((this.container != null) &amp;&amp; (this.container instanceof Context)) {</TD></TR><TR CLASS="z"><TD CLASS="l">549</TD><TD>            ((Context) this.container).addPropertyChangeListener(this);</TD></TR><TR><TD CLASS="l">550</TD><TD>        }</TD></TR><TR><TD CLASS="l">551</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">552</TD><TD>    }</TD></TR><TR><TD CLASS="l">553</TD><TD>    </TD></TR><TR><TD CLASS="l">554</TD><TD>    // --------------------------------------------------------- Public Methods</TD></TR><TR><TD CLASS="l">555</TD><TD> </TD></TR><TR><TD CLASS="l">556</TD><TD>    /**</TD></TR><TR><TD CLASS="l">557</TD><TD>     * Construct and return a new session object, based on the default settings</TD></TR><TR><TD CLASS="l">558</TD><TD>     * specified by this Manager's properties. The session id will be assigned</TD></TR><TR><TD CLASS="l">559</TD><TD>     * by this method, and available via the getId() method of the returned</TD></TR><TR><TD CLASS="l">560</TD><TD>     * session. If a new session cannot be created for any reason, return</TD></TR><TR><TD CLASS="l">561</TD><TD>     * &lt;code&gt;null&lt;/code&gt;.</TD></TR><TR><TD CLASS="l">562</TD><TD>     * </TD></TR><TR><TD CLASS="l">563</TD><TD>     * @exception IllegalStateException</TD></TR><TR><TD CLASS="l">564</TD><TD>     *                if a new session cannot be instantiated for any reason</TD></TR><TR><TD CLASS="l">565</TD><TD>     * </TD></TR><TR><TD CLASS="l">566</TD><TD>     * Construct and return a new session object, based on the default settings</TD></TR><TR><TD CLASS="l">567</TD><TD>     * specified by this Manager's properties. The session id will be assigned</TD></TR><TR><TD CLASS="l">568</TD><TD>     * by this method, and available via the getId() method of the returned</TD></TR><TR><TD CLASS="l">569</TD><TD>     * session. If a new session cannot be created for any reason, return</TD></TR><TR><TD CLASS="l">570</TD><TD>     * &lt;code&gt;null&lt;/code&gt;.</TD></TR><TR><TD CLASS="l">571</TD><TD>     * </TD></TR><TR><TD CLASS="l"><A NAME="9">572</A></TD><TD>     * @exception IllegalStateException</TD></TR><TR><TD CLASS="l">573</TD><TD>     *                if a new session cannot be instantiated for any reason</TD></TR><TR><TD CLASS="l">574</TD><TD>     */</TD></TR><TR><TD CLASS="l">575</TD><TD>    public Session createSession(String sessionId) {</TD></TR><TR CLASS="z"><TD CLASS="l">576</TD><TD>        return createSession(sessionId, true);</TD></TR><TR><TD CLASS="l">577</TD><TD>    }</TD></TR><TR><TD CLASS="l">578</TD><TD> </TD></TR><TR><TD CLASS="l">579</TD><TD>    /**</TD></TR><TR><TD CLASS="l">580</TD><TD>     * create new session with check maxActiveSessions and send session creation</TD></TR><TR><TD CLASS="l">581</TD><TD>     * to other cluster nodes.</TD></TR><TR><TD CLASS="l">582</TD><TD>     * </TD></TR><TR><TD CLASS="l"><A NAME="a">583</A></TD><TD>     * @param distribute</TD></TR><TR><TD CLASS="l">584</TD><TD>     * @return The session</TD></TR><TR><TD CLASS="l">585</TD><TD>     */</TD></TR><TR><TD CLASS="l">586</TD><TD>    public Session createSession(String sessionId, boolean distribute) {</TD></TR><TR CLASS="z"><TD CLASS="l">587</TD><TD>        if ((maxActiveSessions &gt;= 0) &amp;&amp; (sessions.size() &gt;= maxActiveSessions)) {</TD></TR><TR CLASS="z"><TD CLASS="l">588</TD><TD>            rejectedSessions++;</TD></TR><TR CLASS="z"><TD CLASS="l">589</TD><TD>            throw new TooManyActiveSessionsException(</TD></TR><TR CLASS="z"><TD CLASS="l">590</TD><TD>                    sm.getString(&#34;deltaManager.createSession.ise&#34;),</TD></TR><TR><TD CLASS="l">591</TD><TD>                    maxActiveSessions);</TD></TR><TR><TD CLASS="l">592</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">593</TD><TD>        DeltaSession session = (DeltaSession) super.createSession(sessionId) ;</TD></TR><TR CLASS="z"><TD CLASS="l">594</TD><TD>        if (distribute) {</TD></TR><TR CLASS="z"><TD CLASS="l">595</TD><TD>            sendCreateSession(session.getId(), session);</TD></TR><TR><TD CLASS="l">596</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">597</TD><TD>        if (log.isDebugEnabled())</TD></TR><TR CLASS="z"><TD CLASS="l">598</TD><TD>            log.debug(sm.getString(&#34;deltaManager.createSession.newSession&#34;,session.getId(), new Integer(sessions.size())));</TD></TR><TR CLASS="z"><TD CLASS="l">599</TD><TD>        return (session);</TD></TR><TR><TD CLASS="l">600</TD><TD> </TD></TR><TR><TD CLASS="l">601</TD><TD>    }</TD></TR><TR><TD CLASS="l">602</TD><TD> </TD></TR><TR><TD CLASS="l">603</TD><TD>    /**</TD></TR><TR><TD CLASS="l">604</TD><TD>     * Send create session evt to all backup node</TD></TR><TR><TD CLASS="l"><A NAME="4e">605</A></TD><TD>     * @param sessionId</TD></TR><TR><TD CLASS="l">606</TD><TD>     * @param session</TD></TR><TR><TD CLASS="l">607</TD><TD>     */</TD></TR><TR><TD CLASS="l">608</TD><TD>    protected void sendCreateSession(String sessionId, DeltaSession session) {</TD></TR><TR CLASS="z"><TD CLASS="l">609</TD><TD>        if(cluster.getMembers().length &gt; 0 ) {</TD></TR><TR CLASS="z"><TD CLASS="l">610</TD><TD>            SessionMessage msg = </TD></TR><TR CLASS="z"><TD CLASS="l">611</TD><TD>                new SessionMessageImpl(getName(),</TD></TR><TR><TD CLASS="l">612</TD><TD>                                       SessionMessage.EVT_SESSION_CREATED, </TD></TR><TR><TD CLASS="l">613</TD><TD>                                       null, </TD></TR><TR><TD CLASS="l">614</TD><TD>                                       sessionId,</TD></TR><TR CLASS="z"><TD CLASS="l">615</TD><TD>                                       sessionId + &#34;-&#34; + System.currentTimeMillis());</TD></TR><TR CLASS="z"><TD CLASS="l">616</TD><TD>            if (log.isDebugEnabled()) log.debug(sm.getString(&#34;deltaManager.sendMessage.newSession&#34;,name, sessionId));</TD></TR><TR CLASS="z"><TD CLASS="l">617</TD><TD>            msg.setTimestamp(session.getCreationTime());</TD></TR><TR CLASS="z"><TD CLASS="l">618</TD><TD>            counterSend_EVT_SESSION_CREATED++;</TD></TR><TR CLASS="z"><TD CLASS="l">619</TD><TD>            send(msg);</TD></TR><TR><TD CLASS="l">620</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">621</TD><TD>    }</TD></TR><TR><TD CLASS="l">622</TD><TD>    </TD></TR><TR><TD CLASS="l">623</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="4d">624</A></TD><TD>     * Send messages to other backup member (domain or all)</TD></TR><TR><TD CLASS="l">625</TD><TD>     * @param msg Session message</TD></TR><TR><TD CLASS="l">626</TD><TD>     */</TD></TR><TR><TD CLASS="l">627</TD><TD>    protected void send(SessionMessage msg) {</TD></TR><TR CLASS="z"><TD CLASS="l">628</TD><TD>        if(cluster != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">629</TD><TD>            if(doDomainReplication())</TD></TR><TR CLASS="z"><TD CLASS="l">630</TD><TD>                cluster.sendClusterDomain(msg);</TD></TR><TR><TD CLASS="l">631</TD><TD>            else</TD></TR><TR CLASS="z"><TD CLASS="l">632</TD><TD>                cluster.send(msg);</TD></TR><TR><TD CLASS="l">633</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">634</TD><TD>    }</TD></TR><TR><TD CLASS="l">635</TD><TD> </TD></TR><TR><TD CLASS="l">636</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="8">637</A></TD><TD>     * Create DeltaSession</TD></TR><TR><TD CLASS="l">638</TD><TD>     * @see org.apache.catalina.Manager#createEmptySession()</TD></TR><TR><TD CLASS="l">639</TD><TD>     */</TD></TR><TR><TD CLASS="l">640</TD><TD>    public Session createEmptySession() {</TD></TR><TR CLASS="z"><TD CLASS="l">641</TD><TD>        return getNewDeltaSession() ;</TD></TR><TR><TD CLASS="l">642</TD><TD>    }</TD></TR><TR><TD CLASS="l">643</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="2a">644</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">645</TD><TD>     * Get new session class to be used in the doLoad() method.</TD></TR><TR><TD CLASS="l">646</TD><TD>     */</TD></TR><TR><TD CLASS="l">647</TD><TD>    protected DeltaSession getNewDeltaSession() {</TD></TR><TR CLASS="z"><TD CLASS="l">648</TD><TD>        return new DeltaSession(this);</TD></TR><TR><TD CLASS="l">649</TD><TD>    }</TD></TR><TR><TD CLASS="l">650</TD><TD> </TD></TR><TR><TD CLASS="l">651</TD><TD>    /**</TD></TR><TR><TD CLASS="l">652</TD><TD>     * Change the session ID of the current session to a new randomly generated</TD></TR><TR><TD CLASS="l">653</TD><TD>     * session ID.</TD></TR><TR><TD CLASS="l">654</TD><TD>     * </TD></TR><TR><TD CLASS="l"><A NAME="4">655</A></TD><TD>     * @param session   The session to change the session ID for</TD></TR><TR><TD CLASS="l">656</TD><TD>     */</TD></TR><TR><TD CLASS="l">657</TD><TD>    @Override</TD></TR><TR><TD CLASS="l">658</TD><TD>    public void changeSessionId(Session session) {</TD></TR><TR CLASS="z"><TD CLASS="l">659</TD><TD>        changeSessionId(session, true);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="5">660</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">661</TD><TD> </TD></TR><TR><TD CLASS="l">662</TD><TD>    public void changeSessionId(Session session, boolean notify) {</TD></TR><TR><TD CLASS="l">663</TD><TD>        // original sessionID</TD></TR><TR CLASS="z"><TD CLASS="l">664</TD><TD>        String orgSessionID = session.getId();</TD></TR><TR CLASS="z"><TD CLASS="l">665</TD><TD>        super.changeSessionId(session);</TD></TR><TR CLASS="z"><TD CLASS="l">666</TD><TD>        if (notify) {</TD></TR><TR><TD CLASS="l">667</TD><TD>            // changed sessionID</TD></TR><TR CLASS="z"><TD CLASS="l">668</TD><TD>            String newSessionID = session.getId();</TD></TR><TR><TD CLASS="l">669</TD><TD>            try {</TD></TR><TR><TD CLASS="l">670</TD><TD>                // serialize sessionID</TD></TR><TR CLASS="z"><TD CLASS="l">671</TD><TD>                byte[] data = serializeSessionId(newSessionID);</TD></TR><TR><TD CLASS="l">672</TD><TD>                // notify change sessionID</TD></TR><TR CLASS="z"><TD CLASS="l">673</TD><TD>                SessionMessage msg = new SessionMessageImpl(getName(),</TD></TR><TR><TD CLASS="l">674</TD><TD>                        SessionMessage.EVT_CHANGE_SESSION_ID, data,</TD></TR><TR><TD CLASS="l">675</TD><TD>                        orgSessionID, orgSessionID + &#34;-&#34;</TD></TR><TR CLASS="z"><TD CLASS="l">676</TD><TD>                                + System.currentTimeMillis());</TD></TR><TR CLASS="z"><TD CLASS="l">677</TD><TD>                msg.setTimestamp(System.currentTimeMillis());</TD></TR><TR CLASS="z"><TD CLASS="l">678</TD><TD>                counterSend_EVT_CHANGE_SESSION_ID++;</TD></TR><TR CLASS="z"><TD CLASS="l">679</TD><TD>                send(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">680</TD><TD>            } catch (IOException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">681</TD><TD>                log.error(sm.getString(&#34;deltaManager.unableSerializeSessionID&#34;,</TD></TR><TR><TD CLASS="l">682</TD><TD>                        newSessionID), e);</TD></TR><TR CLASS="z"><TD CLASS="l">683</TD><TD>            }</TD></TR><TR><TD CLASS="l">684</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">685</TD><TD>    }</TD></TR><TR><TD CLASS="l">686</TD><TD> </TD></TR><TR><TD CLASS="l">687</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="51">688</A></TD><TD>     * serialize sessionID</TD></TR><TR><TD CLASS="l">689</TD><TD>     * @throws IOException if an input/output error occurs</TD></TR><TR><TD CLASS="l">690</TD><TD>     */</TD></TR><TR><TD CLASS="l">691</TD><TD>    protected byte[] serializeSessionId(String sessionId) throws IOException {</TD></TR><TR CLASS="z"><TD CLASS="l">692</TD><TD>        ByteArrayOutputStream bos = new ByteArrayOutputStream();</TD></TR><TR CLASS="z"><TD CLASS="l">693</TD><TD>        ObjectOutputStream oos = new ObjectOutputStream(bos);</TD></TR><TR CLASS="z"><TD CLASS="l">694</TD><TD>        oos.writeUTF(sessionId);</TD></TR><TR CLASS="z"><TD CLASS="l">695</TD><TD>        oos.flush();</TD></TR><TR CLASS="z"><TD CLASS="l">696</TD><TD>        oos.close();</TD></TR><TR CLASS="z"><TD CLASS="l">697</TD><TD>        return bos.toByteArray();</TD></TR><TR><TD CLASS="l">698</TD><TD>    }</TD></TR><TR><TD CLASS="l">699</TD><TD> </TD></TR><TR><TD CLASS="l">700</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="c">701</A></TD><TD>     * Load sessionID</TD></TR><TR><TD CLASS="l">702</TD><TD>     * @throws IOException if an input/output error occurs</TD></TR><TR><TD CLASS="l">703</TD><TD>     */</TD></TR><TR><TD CLASS="l">704</TD><TD>    protected String deserializeSessionId(byte[] data) throws IOException {</TD></TR><TR CLASS="z"><TD CLASS="l">705</TD><TD>        ReplicationStream ois = getReplicationStream(data);</TD></TR><TR CLASS="z"><TD CLASS="l">706</TD><TD>        String sessionId = ois.readUTF();</TD></TR><TR CLASS="z"><TD CLASS="l">707</TD><TD>        ois.close();</TD></TR><TR CLASS="z"><TD CLASS="l">708</TD><TD>        return sessionId;</TD></TR><TR><TD CLASS="l">709</TD><TD>    }</TD></TR><TR><TD CLASS="l">710</TD><TD> </TD></TR><TR><TD CLASS="l">711</TD><TD>    /**</TD></TR><TR><TD CLASS="l">712</TD><TD>     * Load Deltarequest from external node</TD></TR><TR><TD CLASS="l">713</TD><TD>     * Load the Class at container classloader</TD></TR><TR><TD CLASS="l">714</TD><TD>     * @see DeltaRequest#readExternal(java.io.ObjectInput)</TD></TR><TR><TD CLASS="l">715</TD><TD>     * @param session</TD></TR><TR><TD CLASS="l">716</TD><TD>     * @param data message data</TD></TR><TR><TD CLASS="l">717</TD><TD>     * @return The request</TD></TR><TR><TD CLASS="l">718</TD><TD>     * @throws ClassNotFoundException</TD></TR><TR><TD CLASS="l"><A NAME="b">719</A></TD><TD>     * @throws IOException</TD></TR><TR><TD CLASS="l">720</TD><TD>     */</TD></TR><TR><TD CLASS="l">721</TD><TD>    protected DeltaRequest deserializeDeltaRequest(DeltaSession session, byte[] data) throws ClassNotFoundException, IOException {</TD></TR><TR><TD CLASS="l">722</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">723</TD><TD>            session.lock();</TD></TR><TR CLASS="z"><TD CLASS="l">724</TD><TD>            ReplicationStream ois = getReplicationStream(data);</TD></TR><TR CLASS="z"><TD CLASS="l">725</TD><TD>            session.getDeltaRequest().readExternal(ois);</TD></TR><TR CLASS="z"><TD CLASS="l">726</TD><TD>            ois.close();</TD></TR><TR CLASS="z"><TD CLASS="l">727</TD><TD>            return session.getDeltaRequest();</TD></TR><TR><TD CLASS="l">728</TD><TD>        }finally {</TD></TR><TR CLASS="z"><TD CLASS="l">729</TD><TD>            session.unlock();</TD></TR><TR><TD CLASS="l">730</TD><TD>        }</TD></TR><TR><TD CLASS="l">731</TD><TD>    }</TD></TR><TR><TD CLASS="l">732</TD><TD> </TD></TR><TR><TD CLASS="l">733</TD><TD>    /**</TD></TR><TR><TD CLASS="l">734</TD><TD>     * serialize DeltaRequest</TD></TR><TR><TD CLASS="l">735</TD><TD>     * @see DeltaRequest#writeExternal(java.io.ObjectOutput)</TD></TR><TR><TD CLASS="l">736</TD><TD>     * </TD></TR><TR><TD CLASS="l">737</TD><TD>     * @param deltaRequest</TD></TR><TR><TD CLASS="l">738</TD><TD>     * @return serialized delta request</TD></TR><TR><TD CLASS="l"><A NAME="50">739</A></TD><TD>     * @throws IOException</TD></TR><TR><TD CLASS="l">740</TD><TD>     */</TD></TR><TR><TD CLASS="l">741</TD><TD>    protected byte[] serializeDeltaRequest(DeltaSession session, DeltaRequest deltaRequest) throws IOException {</TD></TR><TR><TD CLASS="l">742</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">743</TD><TD>            session.lock();</TD></TR><TR CLASS="z"><TD CLASS="l">744</TD><TD>            return deltaRequest.serialize();</TD></TR><TR><TD CLASS="l">745</TD><TD>        }finally {</TD></TR><TR CLASS="z"><TD CLASS="l">746</TD><TD>            session.unlock();</TD></TR><TR><TD CLASS="l">747</TD><TD>        }</TD></TR><TR><TD CLASS="l">748</TD><TD>    }</TD></TR><TR><TD CLASS="l">749</TD><TD> </TD></TR><TR><TD CLASS="l">750</TD><TD>    /**</TD></TR><TR><TD CLASS="l">751</TD><TD>     * Load sessions from other cluster node.</TD></TR><TR><TD CLASS="l">752</TD><TD>     * FIXME replace currently sessions with same id without notifcation.</TD></TR><TR><TD CLASS="l">753</TD><TD>     * FIXME SSO handling is not really correct with the session replacement!</TD></TR><TR><TD CLASS="l">754</TD><TD>     * @exception ClassNotFoundException</TD></TR><TR><TD CLASS="l">755</TD><TD>     *                if a serialized class cannot be found during the reload</TD></TR><TR><TD CLASS="l">756</TD><TD>     * @exception IOException</TD></TR><TR><TD CLASS="l">757</TD><TD>     *                if an input/output error occurs</TD></TR><TR><TD CLASS="l">758</TD><TD>     */</TD></TR><TR><TD CLASS="l">759</TD><TD>    protected void deserializeSessions(byte[] data) throws ClassNotFoundException,IOException {</TD></TR><TR><TD CLASS="l"><A NAME="d">760</A></TD><TD> </TD></TR><TR><TD CLASS="l">761</TD><TD>        // Initialize our internal data structures</TD></TR><TR><TD CLASS="l">762</TD><TD>        //sessions.clear(); //should not do this</TD></TR><TR><TD CLASS="l">763</TD><TD>        // Open an input stream to the specified pathname, if any</TD></TR><TR CLASS="z"><TD CLASS="l">764</TD><TD>        ClassLoader originalLoader = Thread.currentThread().getContextClassLoader();</TD></TR><TR CLASS="z"><TD CLASS="l">765</TD><TD>        ObjectInputStream ois = null;</TD></TR><TR><TD CLASS="l">766</TD><TD>        // Load the previously unloaded active sessions</TD></TR><TR><TD CLASS="l">767</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">768</TD><TD>            ois = getReplicationStream(data);</TD></TR><TR CLASS="z"><TD CLASS="l">769</TD><TD>            Integer count = (Integer) ois.readObject();</TD></TR><TR CLASS="z"><TD CLASS="l">770</TD><TD>            int n = count.intValue();</TD></TR><TR CLASS="z"><TD CLASS="l">771</TD><TD>            for (int i = 0; i &lt; n; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">772</TD><TD>                DeltaSession session = (DeltaSession) createEmptySession();</TD></TR><TR CLASS="z"><TD CLASS="l">773</TD><TD>                session.readObjectData(ois);</TD></TR><TR CLASS="z"><TD CLASS="l">774</TD><TD>                session.setManager(this);</TD></TR><TR CLASS="z"><TD CLASS="l">775</TD><TD>                session.setValid(true);</TD></TR><TR CLASS="z"><TD CLASS="l">776</TD><TD>                session.setPrimarySession(false);</TD></TR><TR><TD CLASS="l">777</TD><TD>                //in case the nodes in the cluster are out of</TD></TR><TR><TD CLASS="l">778</TD><TD>                //time synch, this will make sure that we have the</TD></TR><TR><TD CLASS="l">779</TD><TD>                //correct timestamp, isValid returns true, cause</TD></TR><TR><TD CLASS="l">780</TD><TD>                // accessCount=1</TD></TR><TR CLASS="z"><TD CLASS="l">781</TD><TD>                session.access();</TD></TR><TR><TD CLASS="l">782</TD><TD>                //make sure that the session gets ready to expire if</TD></TR><TR><TD CLASS="l">783</TD><TD>                // needed</TD></TR><TR CLASS="z"><TD CLASS="l">784</TD><TD>                session.setAccessCount(0);</TD></TR><TR CLASS="z"><TD CLASS="l">785</TD><TD>                session.resetDeltaRequest();</TD></TR><TR><TD CLASS="l">786</TD><TD>                // FIXME How inform other session id cache like SingleSignOn</TD></TR><TR><TD CLASS="l">787</TD><TD>                // increment sessionCounter to correct stats report</TD></TR><TR CLASS="z"><TD CLASS="l">788</TD><TD>                if (findSession(session.getIdInternal()) == null ) {</TD></TR><TR CLASS="z"><TD CLASS="l">789</TD><TD>                    sessionCounter++;</TD></TR><TR><TD CLASS="l">790</TD><TD>                } else {</TD></TR><TR CLASS="z"><TD CLASS="l">791</TD><TD>                    sessionReplaceCounter++;</TD></TR><TR><TD CLASS="l">792</TD><TD>                    // FIXME better is to grap this sessions again !</TD></TR><TR CLASS="z"><TD CLASS="l">793</TD><TD>                    if (log.isWarnEnabled()) log.warn(sm.getString(&#34;deltaManager.loading.existing.session&#34;,session.getIdInternal()));</TD></TR><TR><TD CLASS="l">794</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">795</TD><TD>                add(session);</TD></TR><TR CLASS="z"><TD CLASS="l">796</TD><TD>                if (notifySessionListenersOnReplication) {</TD></TR><TR CLASS="z"><TD CLASS="l">797</TD><TD>                    session.tellNew();</TD></TR><TR><TD CLASS="l">798</TD><TD>                }</TD></TR><TR><TD CLASS="l">799</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">800</TD><TD>        } catch (ClassNotFoundException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">801</TD><TD>            log.error(sm.getString(&#34;deltaManager.loading.cnfe&#34;, e), e);</TD></TR><TR CLASS="z"><TD CLASS="l">802</TD><TD>            throw e;</TD></TR><TR CLASS="z"><TD CLASS="l">803</TD><TD>        } catch (IOException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">804</TD><TD>            log.error(sm.getString(&#34;deltaManager.loading.ioe&#34;, e), e);</TD></TR><TR CLASS="z"><TD CLASS="l">805</TD><TD>            throw e;</TD></TR><TR><TD CLASS="l">806</TD><TD>        } finally {</TD></TR><TR><TD CLASS="l">807</TD><TD>            // Close the input stream</TD></TR><TR CLASS="z"><TD CLASS="l">808</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">809</TD><TD>                if (ois != null) ois.close();</TD></TR><TR CLASS="z"><TD CLASS="l">810</TD><TD>            } catch (IOException f) {</TD></TR><TR><TD CLASS="l">811</TD><TD>                // ignored</TD></TR><TR CLASS="z"><TD CLASS="l">812</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">813</TD><TD>            ois = null;</TD></TR><TR CLASS="z"><TD CLASS="l">814</TD><TD>            if (originalLoader != null) Thread.currentThread().setContextClassLoader(originalLoader);</TD></TR><TR CLASS="z"><TD CLASS="l">815</TD><TD>        }</TD></TR><TR><TD CLASS="l">816</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">817</TD><TD>    }</TD></TR><TR><TD CLASS="l">818</TD><TD> </TD></TR><TR><TD CLASS="l">819</TD><TD>    </TD></TR><TR><TD CLASS="l">820</TD><TD> </TD></TR><TR><TD CLASS="l">821</TD><TD>    /**</TD></TR><TR><TD CLASS="l">822</TD><TD>     * Save any currently active sessions in the appropriate persistence</TD></TR><TR><TD CLASS="l">823</TD><TD>     * mechanism, if any. If persistence is not supported, this method returns</TD></TR><TR><TD CLASS="l">824</TD><TD>     * without doing anything.</TD></TR><TR><TD CLASS="l">825</TD><TD>     * </TD></TR><TR><TD CLASS="l">826</TD><TD>     * @exception IOException</TD></TR><TR><TD CLASS="l">827</TD><TD>     *                if an input/output error occurs</TD></TR><TR><TD CLASS="l"><A NAME="52">828</A></TD><TD>     */</TD></TR><TR><TD CLASS="l">829</TD><TD>    protected byte[] serializeSessions(Session[] currentSessions) throws IOException {</TD></TR><TR><TD CLASS="l">830</TD><TD> </TD></TR><TR><TD CLASS="l">831</TD><TD>        // Open an output stream to the specified pathname, if any</TD></TR><TR CLASS="z"><TD CLASS="l">832</TD><TD>        ByteArrayOutputStream fos = null;</TD></TR><TR CLASS="z"><TD CLASS="l">833</TD><TD>        ObjectOutputStream oos = null;</TD></TR><TR><TD CLASS="l">834</TD><TD> </TD></TR><TR><TD CLASS="l">835</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">836</TD><TD>            fos = new ByteArrayOutputStream();</TD></TR><TR CLASS="z"><TD CLASS="l">837</TD><TD>            oos = new ObjectOutputStream(new BufferedOutputStream(fos));</TD></TR><TR CLASS="z"><TD CLASS="l">838</TD><TD>            oos.writeObject(new Integer(currentSessions.length));</TD></TR><TR CLASS="z"><TD CLASS="l">839</TD><TD>            for(int i=0 ; i &lt; currentSessions.length;i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">840</TD><TD>                ((DeltaSession)currentSessions[i]).writeObjectData(oos);                </TD></TR><TR><TD CLASS="l">841</TD><TD>            }</TD></TR><TR><TD CLASS="l">842</TD><TD>            // Flush and close the output stream</TD></TR><TR CLASS="z"><TD CLASS="l">843</TD><TD>            oos.flush();</TD></TR><TR CLASS="z"><TD CLASS="l">844</TD><TD>        } catch (IOException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">845</TD><TD>            log.error(sm.getString(&#34;deltaManager.unloading.ioe&#34;, e), e);</TD></TR><TR CLASS="z"><TD CLASS="l">846</TD><TD>            throw e;</TD></TR><TR><TD CLASS="l">847</TD><TD>        } finally {</TD></TR><TR CLASS="z"><TD CLASS="l">848</TD><TD>            if (oos != null) {</TD></TR><TR><TD CLASS="l">849</TD><TD>                try {</TD></TR><TR CLASS="z"><TD CLASS="l">850</TD><TD>                    oos.close();</TD></TR><TR CLASS="z"><TD CLASS="l">851</TD><TD>                } catch (IOException f) {</TD></TR><TR><TD CLASS="l">852</TD><TD>                    ;</TD></TR><TR CLASS="z"><TD CLASS="l">853</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">854</TD><TD>                oos = null;</TD></TR><TR><TD CLASS="l">855</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">856</TD><TD>        }</TD></TR><TR><TD CLASS="l">857</TD><TD>        // send object data as byte[]</TD></TR><TR CLASS="z"><TD CLASS="l">858</TD><TD>        return fos.toByteArray();</TD></TR><TR><TD CLASS="l">859</TD><TD>    }</TD></TR><TR><TD CLASS="l">860</TD><TD> </TD></TR><TR><TD CLASS="l">861</TD><TD>    // ------------------------------------------------------ Lifecycle Methods</TD></TR><TR><TD CLASS="l">862</TD><TD> </TD></TR><TR><TD CLASS="l">863</TD><TD>    /**</TD></TR><TR><TD CLASS="l">864</TD><TD>     * Add a lifecycle event listener to this component.</TD></TR><TR><TD CLASS="l">865</TD><TD>     * </TD></TR><TR><TD CLASS="l"><A NAME="3">866</A></TD><TD>     * @param listener</TD></TR><TR><TD CLASS="l">867</TD><TD>     *            The listener to add</TD></TR><TR><TD CLASS="l">868</TD><TD>     */</TD></TR><TR><TD CLASS="l">869</TD><TD>    public void addLifecycleListener(LifecycleListener listener) {</TD></TR><TR CLASS="z"><TD CLASS="l">870</TD><TD>        lifecycle.addLifecycleListener(listener);</TD></TR><TR CLASS="z"><TD CLASS="l">871</TD><TD>    }</TD></TR><TR><TD CLASS="l">872</TD><TD> </TD></TR><TR><TD CLASS="l">873</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="10">874</A></TD><TD>     * Get the lifecycle listeners associated with this lifecycle. If this</TD></TR><TR><TD CLASS="l">875</TD><TD>     * Lifecycle has no listeners registered, a zero-length array is returned.</TD></TR><TR><TD CLASS="l">876</TD><TD>     */</TD></TR><TR><TD CLASS="l">877</TD><TD>    public LifecycleListener[] findLifecycleListeners() {</TD></TR><TR CLASS="z"><TD CLASS="l">878</TD><TD>        return lifecycle.findLifecycleListeners();</TD></TR><TR><TD CLASS="l">879</TD><TD>    }</TD></TR><TR><TD CLASS="l">880</TD><TD> </TD></TR><TR><TD CLASS="l">881</TD><TD>    /**</TD></TR><TR><TD CLASS="l">882</TD><TD>     * Remove a lifecycle event listener from this component.</TD></TR><TR><TD CLASS="l">883</TD><TD>     * </TD></TR><TR><TD CLASS="l"><A NAME="49">884</A></TD><TD>     * @param listener</TD></TR><TR><TD CLASS="l">885</TD><TD>     *            The listener to remove</TD></TR><TR><TD CLASS="l">886</TD><TD>     */</TD></TR><TR><TD CLASS="l">887</TD><TD>    public void removeLifecycleListener(LifecycleListener listener) {</TD></TR><TR CLASS="z"><TD CLASS="l">888</TD><TD>        lifecycle.removeLifecycleListener(listener);</TD></TR><TR CLASS="z"><TD CLASS="l">889</TD><TD>    }</TD></TR><TR><TD CLASS="l">890</TD><TD> </TD></TR><TR><TD CLASS="l">891</TD><TD>    /**</TD></TR><TR><TD CLASS="l">892</TD><TD>     * Prepare for the beginning of active use of the public methods of this</TD></TR><TR><TD CLASS="l">893</TD><TD>     * component. This method should be called after &lt;code&gt;configure()&lt;/code&gt;,</TD></TR><TR><TD CLASS="l">894</TD><TD>     * and before any of the public methods of the component are utilized.</TD></TR><TR><TD CLASS="l">895</TD><TD>     * </TD></TR><TR><TD CLASS="l">896</TD><TD>     * @exception LifecycleException</TD></TR><TR><TD CLASS="l"><A NAME="66">897</A></TD><TD>     *                if this component detects a fatal error that prevents this</TD></TR><TR><TD CLASS="l">898</TD><TD>     *                component from being used</TD></TR><TR><TD CLASS="l">899</TD><TD>     */</TD></TR><TR><TD CLASS="l">900</TD><TD>    public void start() throws LifecycleException {</TD></TR><TR CLASS="z"><TD CLASS="l">901</TD><TD>        if (!initialized) init();</TD></TR><TR><TD CLASS="l">902</TD><TD> </TD></TR><TR><TD CLASS="l">903</TD><TD>        // Validate and update our current component state</TD></TR><TR CLASS="z"><TD CLASS="l">904</TD><TD>        if (started) {</TD></TR><TR CLASS="z"><TD CLASS="l">905</TD><TD>            return;</TD></TR><TR><TD CLASS="l">906</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">907</TD><TD>        started = true;</TD></TR><TR CLASS="z"><TD CLASS="l">908</TD><TD>        lifecycle.fireLifecycleEvent(START_EVENT, null);</TD></TR><TR><TD CLASS="l">909</TD><TD> </TD></TR><TR><TD CLASS="l">910</TD><TD>        // Force initialization of the random number generator</TD></TR><TR CLASS="z"><TD CLASS="l">911</TD><TD>        generateSessionId();</TD></TR><TR><TD CLASS="l">912</TD><TD> </TD></TR><TR><TD CLASS="l">913</TD><TD>        // Load unloaded sessions, if any</TD></TR><TR><TD CLASS="l">914</TD><TD>        try {</TD></TR><TR><TD CLASS="l">915</TD><TD>            //the channel is already running</TD></TR><TR CLASS="z"><TD CLASS="l">916</TD><TD>            Cluster cluster = getCluster() ;</TD></TR><TR><TD CLASS="l">917</TD><TD>            // stop remove cluster binding</TD></TR><TR><TD CLASS="l">918</TD><TD>            //wow, how many nested levels of if statements can we have ;)</TD></TR><TR CLASS="z"><TD CLASS="l">919</TD><TD>            if(cluster == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">920</TD><TD>                Container context = getContainer();</TD></TR><TR CLASS="z"><TD CLASS="l">921</TD><TD>                Container host = context.getParent() ;</TD></TR><TR CLASS="z"><TD CLASS="l">922</TD><TD>                if (host instanceof Host) {</TD></TR><TR CLASS="z"><TD CLASS="l">923</TD><TD>                    cluster = host.getCluster();</TD></TR><TR CLASS="z"><TD CLASS="l">924</TD><TD>                    if (cluster instanceof CatalinaCluster) {</TD></TR><TR CLASS="z"><TD CLASS="l">925</TD><TD>                        setCluster((CatalinaCluster) cluster) ;</TD></TR><TR><TD CLASS="l">926</TD><TD>                    } else {</TD></TR><TR CLASS="z"><TD CLASS="l">927</TD><TD>                        Container engine = host.getParent() ;</TD></TR><TR CLASS="z"><TD CLASS="l">928</TD><TD>                        if (engine instanceof Engine) {</TD></TR><TR CLASS="z"><TD CLASS="l">929</TD><TD>                            cluster = engine.getCluster();</TD></TR><TR CLASS="z"><TD CLASS="l">930</TD><TD>                            if (cluster instanceof CatalinaCluster) {</TD></TR><TR CLASS="z"><TD CLASS="l">931</TD><TD>                                setCluster((CatalinaCluster) cluster) ;</TD></TR><TR><TD CLASS="l">932</TD><TD>                            }</TD></TR><TR><TD CLASS="l">933</TD><TD>                        } else {</TD></TR><TR CLASS="z"><TD CLASS="l">934</TD><TD>                            cluster = null ;</TD></TR><TR><TD CLASS="l">935</TD><TD>                        }</TD></TR><TR><TD CLASS="l">936</TD><TD>                    }</TD></TR><TR><TD CLASS="l">937</TD><TD>                }</TD></TR><TR><TD CLASS="l">938</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">939</TD><TD>            if (cluster == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">940</TD><TD>                log.error(sm.getString(&#34;deltaManager.noCluster&#34;, getName()));</TD></TR><TR CLASS="z"><TD CLASS="l">941</TD><TD>                return;</TD></TR><TR><TD CLASS="l">942</TD><TD>            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">943</TD><TD>                if (log.isInfoEnabled()) {</TD></TR><TR CLASS="z"><TD CLASS="l">944</TD><TD>                    String type = &#34;unknown&#34; ;</TD></TR><TR CLASS="z"><TD CLASS="l">945</TD><TD>                    if( cluster.getContainer() instanceof Host){</TD></TR><TR CLASS="z"><TD CLASS="l">946</TD><TD>                        type = &#34;Host&#34; ;</TD></TR><TR CLASS="z"><TD CLASS="l">947</TD><TD>                    } else if( cluster.getContainer() instanceof Engine){</TD></TR><TR CLASS="z"><TD CLASS="l">948</TD><TD>                        type = &#34;Engine&#34; ;</TD></TR><TR><TD CLASS="l">949</TD><TD>                    }</TD></TR><TR CLASS="z"><TD CLASS="l">950</TD><TD>                    log.info(sm.getString(&#34;deltaManager.registerCluster&#34;, getName(), type, cluster.getClusterName()));</TD></TR><TR><TD CLASS="l">951</TD><TD>                }</TD></TR><TR><TD CLASS="l">952</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">953</TD><TD>            if (log.isInfoEnabled()) log.info(sm.getString(&#34;deltaManager.startClustering&#34;, getName()));</TD></TR><TR><TD CLASS="l">954</TD><TD>            //to survice context reloads, as only a stop/start is called, not</TD></TR><TR><TD CLASS="l">955</TD><TD>            // createManager</TD></TR><TR CLASS="z"><TD CLASS="l">956</TD><TD>            cluster.registerManager(this);</TD></TR><TR><TD CLASS="l">957</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">958</TD><TD>            getAllClusterSessions();</TD></TR><TR><TD CLASS="l">959</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">960</TD><TD>        } catch (Throwable t) {</TD></TR><TR CLASS="z"><TD CLASS="l">961</TD><TD>            log.error(sm.getString(&#34;deltaManager.managerLoad&#34;), t);</TD></TR><TR CLASS="z"><TD CLASS="l">962</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">963</TD><TD>    }</TD></TR><TR><TD CLASS="l">964</TD><TD> </TD></TR><TR><TD CLASS="l">965</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="12">966</A></TD><TD>     * get from first session master the backup from all clustered sessions</TD></TR><TR><TD CLASS="l">967</TD><TD>     * @see #findSessionMasterMember()</TD></TR><TR><TD CLASS="l">968</TD><TD>     */</TD></TR><TR><TD CLASS="l">969</TD><TD>    public synchronized void getAllClusterSessions() {</TD></TR><TR CLASS="z"><TD CLASS="l">970</TD><TD>        if (cluster != null &amp;&amp; cluster.getMembers().length &gt; 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">971</TD><TD>            long beforeSendTime = System.currentTimeMillis();</TD></TR><TR CLASS="z"><TD CLASS="l">972</TD><TD>            Member mbr = findSessionMasterMember();</TD></TR><TR CLASS="z"><TD CLASS="l">973</TD><TD>            if(mbr == null) { // No domain member found</TD></TR><TR CLASS="z"><TD CLASS="l">974</TD><TD>                 return;</TD></TR><TR><TD CLASS="l">975</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">976</TD><TD>            SessionMessage msg = new SessionMessageImpl(this.getName(),SessionMessage.EVT_GET_ALL_SESSIONS, null, &#34;GET-ALL&#34;,&#34;GET-ALL-&#34; + getName());</TD></TR><TR><TD CLASS="l">977</TD><TD>            // set reference time</TD></TR><TR CLASS="z"><TD CLASS="l">978</TD><TD>            stateTransferCreateSendTime = beforeSendTime ;</TD></TR><TR><TD CLASS="l">979</TD><TD>            // request session state</TD></TR><TR CLASS="z"><TD CLASS="l">980</TD><TD>            counterSend_EVT_GET_ALL_SESSIONS++;</TD></TR><TR CLASS="z"><TD CLASS="l">981</TD><TD>            stateTransfered = false ;</TD></TR><TR><TD CLASS="l">982</TD><TD>            // FIXME This send call block the deploy thread, when sender waitForAck is enabled</TD></TR><TR><TD CLASS="l">983</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">984</TD><TD>                synchronized(receivedMessageQueue) {</TD></TR><TR CLASS="z"><TD CLASS="l">985</TD><TD>                     receiverQueue = true ;</TD></TR><TR CLASS="z"><TD CLASS="l">986</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">987</TD><TD>                cluster.send(msg, mbr);</TD></TR><TR CLASS="z"><TD CLASS="l">988</TD><TD>                if (log.isWarnEnabled()) log.warn(sm.getString(&#34;deltaManager.waitForSessionState&#34;,getName(), mbr,getStateTransferTimeout()));</TD></TR><TR><TD CLASS="l">989</TD><TD>                // FIXME At sender ack mode this method check only the state transfer and resend is a problem!</TD></TR><TR CLASS="z"><TD CLASS="l">990</TD><TD>                waitForSendAllSessions(beforeSendTime);</TD></TR><TR CLASS="z"><TD CLASS="l">991</TD><TD>            } finally {</TD></TR><TR CLASS="z"><TD CLASS="l">992</TD><TD>                synchronized(receivedMessageQueue) {</TD></TR><TR CLASS="z"><TD CLASS="l">993</TD><TD>                    for (Iterator iter = receivedMessageQueue.iterator(); iter.hasNext();) {</TD></TR><TR CLASS="z"><TD CLASS="l">994</TD><TD>                        SessionMessage smsg = (SessionMessage) iter.next();</TD></TR><TR CLASS="z"><TD CLASS="l">995</TD><TD>                        if (!stateTimestampDrop) {</TD></TR><TR CLASS="z"><TD CLASS="l">996</TD><TD>                            messageReceived(smsg, smsg.getAddress() != null ? (Member) smsg.getAddress() : null);</TD></TR><TR><TD CLASS="l">997</TD><TD>                        } else {</TD></TR><TR CLASS="z"><TD CLASS="l">998</TD><TD>                            if (smsg.getEventType() != SessionMessage.EVT_GET_ALL_SESSIONS &amp;&amp; smsg.getTimestamp() &gt;= stateTransferCreateSendTime) {</TD></TR><TR><TD CLASS="l">999</TD><TD>                                // FIXME handle EVT_GET_ALL_SESSIONS later</TD></TR><TR CLASS="z"><TD CLASS="l">1000</TD><TD>                                messageReceived(smsg,smsg.getAddress() != null ? (Member) smsg.getAddress() : null);</TD></TR><TR><TD CLASS="l">1001</TD><TD>                            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">1002</TD><TD>                                if (log.isWarnEnabled()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1003</TD><TD>                                    log.warn(sm.getString(&#34;deltaManager.dropMessage&#34;,getName(), smsg.getEventTypeString(),new Date(stateTransferCreateSendTime), new Date(smsg.getTimestamp())));</TD></TR><TR><TD CLASS="l">1004</TD><TD>                                }</TD></TR><TR><TD CLASS="l">1005</TD><TD>                            }</TD></TR><TR><TD CLASS="l">1006</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">1007</TD><TD>                    }        </TD></TR><TR CLASS="z"><TD CLASS="l">1008</TD><TD>                    receivedMessageQueue.clear();</TD></TR><TR CLASS="z"><TD CLASS="l">1009</TD><TD>                    receiverQueue = false ;</TD></TR><TR CLASS="z"><TD CLASS="l">1010</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1011</TD><TD>           }</TD></TR><TR CLASS="z"><TD CLASS="l">1012</TD><TD>        } else {</TD></TR><TR CLASS="z"><TD CLASS="l">1013</TD><TD>            if (log.isInfoEnabled()) log.info(sm.getString(&#34;deltaManager.noMembers&#34;, getName()));</TD></TR><TR><TD CLASS="l">1014</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1015</TD><TD>    }</TD></TR><TR><TD CLASS="l">1016</TD><TD> </TD></TR><TR><TD CLASS="l">1017</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="48">1018</A></TD><TD>     * Register cross context session at replication valve thread local</TD></TR><TR><TD CLASS="l">1019</TD><TD>     * @param session cross context session</TD></TR><TR><TD CLASS="l">1020</TD><TD>     */</TD></TR><TR><TD CLASS="l">1021</TD><TD>    protected void registerSessionAtReplicationValve(DeltaSession session) {</TD></TR><TR CLASS="z"><TD CLASS="l">1022</TD><TD>        if(replicationValve == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">1023</TD><TD>            if(container instanceof StandardContext &amp;&amp; ((StandardContext)container).getCrossContext()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1024</TD><TD>                Cluster cluster = getCluster() ;</TD></TR><TR CLASS="z"><TD CLASS="l">1025</TD><TD>                if(cluster != null &amp;&amp; cluster instanceof CatalinaCluster) {</TD></TR><TR CLASS="z"><TD CLASS="l">1026</TD><TD>                    Valve[] valves = ((CatalinaCluster)cluster).getValves();</TD></TR><TR CLASS="z"><TD CLASS="l">1027</TD><TD>                    if(valves != null &amp;&amp; valves.length &gt; 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">1028</TD><TD>                        for(int i=0; replicationValve == null &amp;&amp; i &lt; valves.length ; i++ ){</TD></TR><TR CLASS="z"><TD CLASS="l">1029</TD><TD>                            if(valves[i] instanceof ReplicationValve) replicationValve = (ReplicationValve)valves[i] ;</TD></TR><TR><TD CLASS="l">1030</TD><TD>                        }//for</TD></TR><TR><TD CLASS="l">1031</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1032</TD><TD>                        if(replicationValve == null &amp;&amp; log.isDebugEnabled()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1033</TD><TD>                            log.debug(&#34;no ReplicationValve found for CrossContext Support&#34;);</TD></TR><TR><TD CLASS="l">1034</TD><TD>                        }//endif </TD></TR><TR><TD CLASS="l">1035</TD><TD>                    }//end if</TD></TR><TR><TD CLASS="l">1036</TD><TD>                }//endif</TD></TR><TR><TD CLASS="l">1037</TD><TD>            }//end if</TD></TR><TR><TD CLASS="l">1038</TD><TD>        }//end if</TD></TR><TR CLASS="z"><TD CLASS="l">1039</TD><TD>        if(replicationValve != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">1040</TD><TD>            replicationValve.registerReplicationSession(session);</TD></TR><TR><TD CLASS="l">1041</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1042</TD><TD>    }</TD></TR><TR><TD CLASS="l">1043</TD><TD>    </TD></TR><TR><TD CLASS="l">1044</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="11">1045</A></TD><TD>     * Find the master of the session state</TD></TR><TR><TD CLASS="l">1046</TD><TD>     * @return master member of sessions </TD></TR><TR><TD CLASS="l">1047</TD><TD>     */</TD></TR><TR><TD CLASS="l">1048</TD><TD>    protected Member findSessionMasterMember() {</TD></TR><TR CLASS="z"><TD CLASS="l">1049</TD><TD>        Member mbr = null;</TD></TR><TR CLASS="z"><TD CLASS="l">1050</TD><TD>        Member mbrs[] = cluster.getMembers();</TD></TR><TR CLASS="z"><TD CLASS="l">1051</TD><TD>        if(mbrs.length != 0 ) mbr = mbrs[0];</TD></TR><TR CLASS="z"><TD CLASS="l">1052</TD><TD>        if(mbr == null &amp;&amp; log.isWarnEnabled()) log.warn(sm.getString(&#34;deltaManager.noMasterMember&#34;,getName(), &#34;&#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">1053</TD><TD>        if(mbr != null &amp;&amp; log.isDebugEnabled()) log.warn(sm.getString(&#34;deltaManager.foundMasterMember&#34;,getName(), mbr));</TD></TR><TR CLASS="z"><TD CLASS="l">1054</TD><TD>        return mbr;</TD></TR><TR><TD CLASS="l">1055</TD><TD>    }</TD></TR><TR><TD CLASS="l">1056</TD><TD> </TD></TR><TR><TD CLASS="l">1057</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="69">1058</A></TD><TD>     * Wait that cluster session state is transfer or timeout after 60 Sec</TD></TR><TR><TD CLASS="l">1059</TD><TD>     * With stateTransferTimeout == -1 wait that backup is transfered (forever mode)</TD></TR><TR><TD CLASS="l">1060</TD><TD>     */</TD></TR><TR><TD CLASS="l">1061</TD><TD>    protected void waitForSendAllSessions(long beforeSendTime) {</TD></TR><TR CLASS="z"><TD CLASS="l">1062</TD><TD>        long reqStart = System.currentTimeMillis();</TD></TR><TR CLASS="z"><TD CLASS="l">1063</TD><TD>        long reqNow = reqStart ;</TD></TR><TR CLASS="z"><TD CLASS="l">1064</TD><TD>        boolean isTimeout = false;</TD></TR><TR CLASS="z"><TD CLASS="l">1065</TD><TD>        if(getStateTransferTimeout() &gt; 0) {</TD></TR><TR><TD CLASS="l">1066</TD><TD>            // wait that state is transfered with timeout check</TD></TR><TR><TD CLASS="l">1067</TD><TD>            do {</TD></TR><TR><TD CLASS="l">1068</TD><TD>                try {</TD></TR><TR CLASS="z"><TD CLASS="l">1069</TD><TD>                    Thread.sleep(100);</TD></TR><TR CLASS="z"><TD CLASS="l">1070</TD><TD>                } catch (Exception sleep) {</TD></TR><TR><TD CLASS="l">1071</TD><TD>                    //</TD></TR><TR CLASS="z"><TD CLASS="l">1072</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1073</TD><TD>                reqNow = System.currentTimeMillis();</TD></TR><TR CLASS="z"><TD CLASS="l">1074</TD><TD>                isTimeout = ((reqNow - reqStart) &gt; (1000 * getStateTransferTimeout()));</TD></TR><TR CLASS="z"><TD CLASS="l">1075</TD><TD>            } while ((!getStateTransfered()) &amp;&amp; (!isTimeout) &amp;&amp; (!isNoContextManagerReceived()));</TD></TR><TR><TD CLASS="l">1076</TD><TD>        } else {</TD></TR><TR CLASS="z"><TD CLASS="l">1077</TD><TD>            if(getStateTransferTimeout() == -1) {</TD></TR><TR><TD CLASS="l">1078</TD><TD>                // wait that state is transfered</TD></TR><TR><TD CLASS="l">1079</TD><TD>                do {</TD></TR><TR><TD CLASS="l">1080</TD><TD>                    try {</TD></TR><TR CLASS="z"><TD CLASS="l">1081</TD><TD>                        Thread.sleep(100);</TD></TR><TR CLASS="z"><TD CLASS="l">1082</TD><TD>                    } catch (Exception sleep) {</TD></TR><TR CLASS="z"><TD CLASS="l">1083</TD><TD>                    }</TD></TR><TR CLASS="z"><TD CLASS="l">1084</TD><TD>                } while ((!getStateTransfered())&amp;&amp; (!isNoContextManagerReceived()));</TD></TR><TR CLASS="z"><TD CLASS="l">1085</TD><TD>                reqNow = System.currentTimeMillis();</TD></TR><TR><TD CLASS="l">1086</TD><TD>            }</TD></TR><TR><TD CLASS="l">1087</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1088</TD><TD>        if (isTimeout) {</TD></TR><TR CLASS="z"><TD CLASS="l">1089</TD><TD>            counterNoStateTransfered++ ;</TD></TR><TR CLASS="z"><TD CLASS="l">1090</TD><TD>            log.error(sm.getString(&#34;deltaManager.noSessionState&#34;,getName(),new Date(beforeSendTime),Long.valueOf(reqNow - beforeSendTime)));</TD></TR><TR CLASS="z"><TD CLASS="l">1091</TD><TD>        } else if (isNoContextManagerReceived()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1092</TD><TD>            if (log.isWarnEnabled())</TD></TR><TR CLASS="z"><TD CLASS="l">1093</TD><TD>                log.warn(sm.getString(&#34;deltaManager.noContextManager&#34;,getName(),new Date(beforeSendTime),Long.valueOf(reqNow - beforeSendTime)));</TD></TR><TR><TD CLASS="l">1094</TD><TD>        } else {</TD></TR><TR CLASS="z"><TD CLASS="l">1095</TD><TD>            if (log.isInfoEnabled())</TD></TR><TR CLASS="z"><TD CLASS="l">1096</TD><TD>                log.info(sm.getString(&#34;deltaManager.sessionReceived&#34;,getName(), new Date(beforeSendTime), Long.valueOf(reqNow - beforeSendTime)));</TD></TR><TR><TD CLASS="l">1097</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1098</TD><TD>    }</TD></TR><TR><TD CLASS="l">1099</TD><TD> </TD></TR><TR><TD CLASS="l">1100</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1101</TD><TD>     * Gracefully terminate the active use of the public methods of this</TD></TR><TR><TD CLASS="l">1102</TD><TD>     * component. This method should be the last one called on a given instance</TD></TR><TR><TD CLASS="l">1103</TD><TD>     * of this component.</TD></TR><TR><TD CLASS="l">1104</TD><TD>     * </TD></TR><TR><TD CLASS="l">1105</TD><TD>     * @exception LifecycleException</TD></TR><TR><TD CLASS="l">1106</TD><TD>     *                if this component detects a fatal error that needs to be</TD></TR><TR><TD CLASS="l"><A NAME="67">1107</A></TD><TD>     *                reported</TD></TR><TR><TD CLASS="l">1108</TD><TD>     */</TD></TR><TR><TD CLASS="l">1109</TD><TD>    public void stop() throws LifecycleException {</TD></TR><TR><TD CLASS="l">1110</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1111</TD><TD>        if (log.isDebugEnabled())</TD></TR><TR CLASS="z"><TD CLASS="l">1112</TD><TD>            log.debug(sm.getString(&#34;deltaManager.stopped&#34;, getName()));</TD></TR><TR><TD CLASS="l">1113</TD><TD> </TD></TR><TR><TD CLASS="l">1114</TD><TD> </TD></TR><TR><TD CLASS="l">1115</TD><TD>        // Validate and update our current component state</TD></TR><TR CLASS="z"><TD CLASS="l">1116</TD><TD>        if (!started)</TD></TR><TR CLASS="z"><TD CLASS="l">1117</TD><TD>            throw new LifecycleException(sm.getString(&#34;deltaManager.notStarted&#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">1118</TD><TD>        lifecycle.fireLifecycleEvent(STOP_EVENT, null);</TD></TR><TR CLASS="z"><TD CLASS="l">1119</TD><TD>        started = false;</TD></TR><TR><TD CLASS="l">1120</TD><TD> </TD></TR><TR><TD CLASS="l">1121</TD><TD>        // Expire all active sessions</TD></TR><TR CLASS="z"><TD CLASS="l">1122</TD><TD>        if (log.isInfoEnabled()) log.info(sm.getString(&#34;deltaManager.expireSessions&#34;, getName()));</TD></TR><TR CLASS="z"><TD CLASS="l">1123</TD><TD>        Session sessions[] = findSessions();</TD></TR><TR CLASS="z"><TD CLASS="l">1124</TD><TD>        for (int i = 0; i &lt; sessions.length; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">1125</TD><TD>            DeltaSession session = (DeltaSession) sessions[i];</TD></TR><TR CLASS="z"><TD CLASS="l">1126</TD><TD>            if (!session.isValid())</TD></TR><TR CLASS="z"><TD CLASS="l">1127</TD><TD>                continue;</TD></TR><TR><TD CLASS="l">1128</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">1129</TD><TD>                session.expire(true, isExpireSessionsOnShutdown());</TD></TR><TR CLASS="z"><TD CLASS="l">1130</TD><TD>            } catch (Throwable ignore) {</TD></TR><TR><TD CLASS="l">1131</TD><TD>                ;</TD></TR><TR CLASS="z"><TD CLASS="l">1132</TD><TD>            } </TD></TR><TR><TD CLASS="l">1133</TD><TD>        }</TD></TR><TR><TD CLASS="l">1134</TD><TD> </TD></TR><TR><TD CLASS="l">1135</TD><TD>        // Require a new random number generator if we are restarted</TD></TR><TR CLASS="z"><TD CLASS="l">1136</TD><TD>        this.random = null;</TD></TR><TR CLASS="z"><TD CLASS="l">1137</TD><TD>        getCluster().removeManager(this);</TD></TR><TR CLASS="z"><TD CLASS="l">1138</TD><TD>        replicationValve = null;</TD></TR><TR CLASS="z"><TD CLASS="l">1139</TD><TD>        if (initialized) {</TD></TR><TR CLASS="z"><TD CLASS="l">1140</TD><TD>            destroy();</TD></TR><TR><TD CLASS="l">1141</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1142</TD><TD>    }</TD></TR><TR><TD CLASS="l">1143</TD><TD> </TD></TR><TR><TD CLASS="l">1144</TD><TD>    // ----------------------------------------- PropertyChangeListener Methods</TD></TR><TR><TD CLASS="l">1145</TD><TD> </TD></TR><TR><TD CLASS="l">1146</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1147</TD><TD>     * Process property change events from our associated Context.</TD></TR><TR><TD CLASS="l">1148</TD><TD>     * </TD></TR><TR><TD CLASS="l">1149</TD><TD>     * @param event</TD></TR><TR><TD CLASS="l"><A NAME="47">1150</A></TD><TD>     *            The property change event that has occurred</TD></TR><TR><TD CLASS="l">1151</TD><TD>     */</TD></TR><TR><TD CLASS="l">1152</TD><TD>    public void propertyChange(PropertyChangeEvent event) {</TD></TR><TR><TD CLASS="l">1153</TD><TD>        // no-op</TD></TR><TR CLASS="z"><TD CLASS="l">1154</TD><TD>    }</TD></TR><TR><TD CLASS="l">1155</TD><TD> </TD></TR><TR><TD CLASS="l">1156</TD><TD>    // -------------------------------------------------------- Replication</TD></TR><TR><TD CLASS="l">1157</TD><TD>    // Methods</TD></TR><TR><TD CLASS="l">1158</TD><TD> </TD></TR><TR><TD CLASS="l">1159</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1160</TD><TD>     * A message was received from another node, this is the callback method to</TD></TR><TR><TD CLASS="l">1161</TD><TD>     * implement if you are interested in receiving replication messages.</TD></TR><TR><TD CLASS="l">1162</TD><TD>     * </TD></TR><TR><TD CLASS="l"><A NAME="45">1163</A></TD><TD>     * @param cmsg -</TD></TR><TR><TD CLASS="l">1164</TD><TD>     *            the message received.</TD></TR><TR><TD CLASS="l">1165</TD><TD>     */</TD></TR><TR><TD CLASS="l">1166</TD><TD>    public void messageDataReceived(ClusterMessage cmsg) {</TD></TR><TR CLASS="z"><TD CLASS="l">1167</TD><TD>        if (cmsg != null &amp;&amp; cmsg instanceof SessionMessage) {</TD></TR><TR CLASS="z"><TD CLASS="l">1168</TD><TD>            SessionMessage msg = (SessionMessage) cmsg;</TD></TR><TR CLASS="z"><TD CLASS="l">1169</TD><TD>            switch (msg.getEventType()) {</TD></TR><TR><TD CLASS="l">1170</TD><TD>                case SessionMessage.EVT_GET_ALL_SESSIONS:</TD></TR><TR><TD CLASS="l">1171</TD><TD>                case SessionMessage.EVT_SESSION_CREATED: </TD></TR><TR><TD CLASS="l">1172</TD><TD>                case SessionMessage.EVT_SESSION_EXPIRED: </TD></TR><TR><TD CLASS="l">1173</TD><TD>                case SessionMessage.EVT_SESSION_ACCESSED:</TD></TR><TR><TD CLASS="l">1174</TD><TD>                case SessionMessage.EVT_SESSION_DELTA:</TD></TR><TR><TD CLASS="l">1175</TD><TD>                case SessionMessage.EVT_CHANGE_SESSION_ID: {</TD></TR><TR CLASS="z"><TD CLASS="l">1176</TD><TD>                    synchronized(receivedMessageQueue) {</TD></TR><TR CLASS="z"><TD CLASS="l">1177</TD><TD>                        if(receiverQueue) {</TD></TR><TR CLASS="z"><TD CLASS="l">1178</TD><TD>                            receivedMessageQueue.add(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">1179</TD><TD>                            return ;</TD></TR><TR><TD CLASS="l">1180</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">1181</TD><TD>                    }</TD></TR><TR CLASS="z"><TD CLASS="l">1182</TD><TD>                   break;</TD></TR><TR><TD CLASS="l">1183</TD><TD>                }</TD></TR><TR><TD CLASS="l">1184</TD><TD>                default: {</TD></TR><TR><TD CLASS="l">1185</TD><TD>                    //we didn't queue, do nothing</TD></TR><TR><TD CLASS="l">1186</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">1187</TD><TD>                }</TD></TR><TR><TD CLASS="l">1188</TD><TD>            } //switch</TD></TR><TR><TD CLASS="l">1189</TD><TD>            </TD></TR><TR CLASS="z"><TD CLASS="l">1190</TD><TD>            messageReceived(msg, msg.getAddress() != null ? (Member) msg.getAddress() : null);</TD></TR><TR><TD CLASS="l">1191</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1192</TD><TD>    }</TD></TR><TR><TD CLASS="l">1193</TD><TD> </TD></TR><TR><TD CLASS="l">1194</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1195</TD><TD>     * When the request has been completed, the replication valve will notify</TD></TR><TR><TD CLASS="l">1196</TD><TD>     * the manager, and the manager will decide whether any replication is</TD></TR><TR><TD CLASS="l">1197</TD><TD>     * needed or not. If there is a need for replication, the manager will</TD></TR><TR><TD CLASS="l">1198</TD><TD>     * create a session message and that will be replicated. The cluster</TD></TR><TR><TD CLASS="l">1199</TD><TD>     * determines where it gets sent.</TD></TR><TR><TD CLASS="l">1200</TD><TD>     * </TD></TR><TR><TD CLASS="l">1201</TD><TD>     * @param sessionId -</TD></TR><TR><TD CLASS="l"><A NAME="4a">1202</A></TD><TD>     *            the sessionId that just completed.</TD></TR><TR><TD CLASS="l">1203</TD><TD>     * @return a SessionMessage to be sent,</TD></TR><TR><TD CLASS="l">1204</TD><TD>     */</TD></TR><TR><TD CLASS="l">1205</TD><TD>    public ClusterMessage requestCompleted(String sessionId) {</TD></TR><TR CLASS="z"><TD CLASS="l">1206</TD><TD>        return requestCompleted(sessionId, false);</TD></TR><TR><TD CLASS="l">1207</TD><TD>    }</TD></TR><TR><TD CLASS="l">1208</TD><TD> </TD></TR><TR><TD CLASS="l">1209</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1210</TD><TD>     * When the request has been completed, the replication valve will notify</TD></TR><TR><TD CLASS="l">1211</TD><TD>     * the manager, and the manager will decide whether any replication is</TD></TR><TR><TD CLASS="l">1212</TD><TD>     * needed or not. If there is a need for replication, the manager will</TD></TR><TR><TD CLASS="l">1213</TD><TD>     * create a session message and that will be replicated. The cluster</TD></TR><TR><TD CLASS="l">1214</TD><TD>     * determines where it gets sent.</TD></TR><TR><TD CLASS="l">1215</TD><TD>     * </TD></TR><TR><TD CLASS="l">1216</TD><TD>     * Session expiration also calls this method, but with expires == true.</TD></TR><TR><TD CLASS="l">1217</TD><TD>     * </TD></TR><TR><TD CLASS="l">1218</TD><TD>     * @param sessionId -</TD></TR><TR><TD CLASS="l">1219</TD><TD>     *            the sessionId that just completed.</TD></TR><TR><TD CLASS="l">1220</TD><TD>     * @param expires -</TD></TR><TR><TD CLASS="l"><A NAME="4b">1221</A></TD><TD>     *            whether this method has been called during session expiration</TD></TR><TR><TD CLASS="l">1222</TD><TD>     * @return a SessionMessage to be sent,</TD></TR><TR><TD CLASS="l">1223</TD><TD>     */</TD></TR><TR><TD CLASS="l">1224</TD><TD>    public ClusterMessage requestCompleted(String sessionId, boolean expires) {</TD></TR><TR CLASS="z"><TD CLASS="l">1225</TD><TD>        DeltaSession session = null;</TD></TR><TR><TD CLASS="l">1226</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1227</TD><TD>            session = (DeltaSession) findSession(sessionId);</TD></TR><TR CLASS="z"><TD CLASS="l">1228</TD><TD>            if (session == null) {</TD></TR><TR><TD CLASS="l">1229</TD><TD>                // A parallel request has called session.invalidate() which has</TD></TR><TR><TD CLASS="l">1230</TD><TD>                // remove the session from the Manager.</TD></TR><TR CLASS="z"><TD CLASS="l">1231</TD><TD>                return null;</TD></TR><TR><TD CLASS="l">1232</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">1233</TD><TD>            DeltaRequest deltaRequest = session.getDeltaRequest();</TD></TR><TR CLASS="z"><TD CLASS="l">1234</TD><TD>            session.lock();</TD></TR><TR CLASS="z"><TD CLASS="l">1235</TD><TD>            SessionMessage msg = null;</TD></TR><TR CLASS="z"><TD CLASS="l">1236</TD><TD>            boolean isDeltaRequest = false ;</TD></TR><TR CLASS="z"><TD CLASS="l">1237</TD><TD>            synchronized(deltaRequest) {</TD></TR><TR CLASS="z"><TD CLASS="l">1238</TD><TD>                isDeltaRequest = deltaRequest.getSize() &gt; 0 ;</TD></TR><TR CLASS="z"><TD CLASS="l">1239</TD><TD>                if (isDeltaRequest) {    </TD></TR><TR CLASS="z"><TD CLASS="l">1240</TD><TD>                    counterSend_EVT_SESSION_DELTA++;</TD></TR><TR CLASS="z"><TD CLASS="l">1241</TD><TD>                    byte[] data = serializeDeltaRequest(session,deltaRequest);</TD></TR><TR CLASS="z"><TD CLASS="l">1242</TD><TD>                    msg = new SessionMessageImpl(getName(),</TD></TR><TR><TD CLASS="l">1243</TD><TD>                                                 SessionMessage.EVT_SESSION_DELTA, </TD></TR><TR><TD CLASS="l">1244</TD><TD>                                                 data, </TD></TR><TR><TD CLASS="l">1245</TD><TD>                                                 sessionId,</TD></TR><TR CLASS="z"><TD CLASS="l">1246</TD><TD>                                                 sessionId + &#34;-&#34; + System.currentTimeMillis());</TD></TR><TR CLASS="z"><TD CLASS="l">1247</TD><TD>                    session.resetDeltaRequest();</TD></TR><TR><TD CLASS="l">1248</TD><TD>                }  </TD></TR><TR CLASS="z"><TD CLASS="l">1249</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">1250</TD><TD>            if(!isDeltaRequest) {</TD></TR><TR CLASS="z"><TD CLASS="l">1251</TD><TD>                if(!expires &amp;&amp; !session.isPrimarySession()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1252</TD><TD>                    counterSend_EVT_SESSION_ACCESSED++;</TD></TR><TR CLASS="z"><TD CLASS="l">1253</TD><TD>                    msg = new SessionMessageImpl(getName(),</TD></TR><TR><TD CLASS="l">1254</TD><TD>                                                 SessionMessage.EVT_SESSION_ACCESSED, </TD></TR><TR><TD CLASS="l">1255</TD><TD>                                                 null, </TD></TR><TR><TD CLASS="l">1256</TD><TD>                                                 sessionId,</TD></TR><TR CLASS="z"><TD CLASS="l">1257</TD><TD>                                                 sessionId + &#34;-&#34; + System.currentTimeMillis());</TD></TR><TR CLASS="z"><TD CLASS="l">1258</TD><TD>                    if (log.isDebugEnabled()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1259</TD><TD>                        log.debug(sm.getString(&#34;deltaManager.createMessage.accessChangePrimary&#34;,getName(), sessionId));</TD></TR><TR><TD CLASS="l">1260</TD><TD>                    }</TD></TR><TR><TD CLASS="l">1261</TD><TD>                }    </TD></TR><TR><TD CLASS="l">1262</TD><TD>            } else { // log only outside synch block!</TD></TR><TR CLASS="z"><TD CLASS="l">1263</TD><TD>                if (log.isDebugEnabled()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1264</TD><TD>                    log.debug(sm.getString(&#34;deltaManager.createMessage.delta&#34;,getName(), sessionId));</TD></TR><TR><TD CLASS="l">1265</TD><TD>                }</TD></TR><TR><TD CLASS="l">1266</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">1267</TD><TD>            if (!expires)</TD></TR><TR CLASS="z"><TD CLASS="l">1268</TD><TD>                session.setPrimarySession(true);</TD></TR><TR><TD CLASS="l">1269</TD><TD>            //check to see if we need to send out an access message</TD></TR><TR CLASS="z"><TD CLASS="l">1270</TD><TD>            if (!expires &amp;&amp; (msg == null)) {</TD></TR><TR CLASS="z"><TD CLASS="l">1271</TD><TD>                long replDelta = System.currentTimeMillis() - session.getLastTimeReplicated();</TD></TR><TR CLASS="z"><TD CLASS="l">1272</TD><TD>                if (session.getMaxInactiveInterval() &gt;=0 &amp;&amp; </TD></TR><TR CLASS="z"><TD CLASS="l">1273</TD><TD>                        replDelta &gt; (session.getMaxInactiveInterval() * 1000)) {</TD></TR><TR CLASS="z"><TD CLASS="l">1274</TD><TD>                    counterSend_EVT_SESSION_ACCESSED++;</TD></TR><TR CLASS="z"><TD CLASS="l">1275</TD><TD>                    msg = new SessionMessageImpl(getName(),</TD></TR><TR><TD CLASS="l">1276</TD><TD>                                                 SessionMessage.EVT_SESSION_ACCESSED, </TD></TR><TR><TD CLASS="l">1277</TD><TD>                                                 null,</TD></TR><TR><TD CLASS="l">1278</TD><TD>                                                 sessionId, </TD></TR><TR CLASS="z"><TD CLASS="l">1279</TD><TD>                                                 sessionId + &#34;-&#34; + System.currentTimeMillis());</TD></TR><TR CLASS="z"><TD CLASS="l">1280</TD><TD>                    if (log.isDebugEnabled()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1281</TD><TD>                        log.debug(sm.getString(&#34;deltaManager.createMessage.access&#34;, getName(),sessionId));</TD></TR><TR><TD CLASS="l">1282</TD><TD>                    }</TD></TR><TR><TD CLASS="l">1283</TD><TD>                }</TD></TR><TR><TD CLASS="l">1284</TD><TD> </TD></TR><TR><TD CLASS="l">1285</TD><TD>            }</TD></TR><TR><TD CLASS="l">1286</TD><TD> </TD></TR><TR><TD CLASS="l">1287</TD><TD>            //update last replicated time</TD></TR><TR CLASS="z"><TD CLASS="l">1288</TD><TD>            if (msg != null){</TD></TR><TR CLASS="z"><TD CLASS="l">1289</TD><TD>               session.setLastTimeReplicated(System.currentTimeMillis());</TD></TR><TR CLASS="z"><TD CLASS="l">1290</TD><TD>               msg.setTimestamp(session.getLastTimeReplicated());</TD></TR><TR><TD CLASS="l">1291</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">1292</TD><TD>            return msg;</TD></TR><TR CLASS="z"><TD CLASS="l">1293</TD><TD>        } catch (IOException x) {</TD></TR><TR CLASS="z"><TD CLASS="l">1294</TD><TD>            log.error(sm.getString(&#34;deltaManager.createMessage.unableCreateDeltaRequest&#34;,sessionId), x);</TD></TR><TR CLASS="z"><TD CLASS="l">1295</TD><TD>            return null;</TD></TR><TR><TD CLASS="l">1296</TD><TD>        }finally {</TD></TR><TR CLASS="z"><TD CLASS="l">1297</TD><TD>            if (session!=null) session.unlock();</TD></TR><TR><TD CLASS="l">1298</TD><TD>        }</TD></TR><TR><TD CLASS="l">1299</TD><TD> </TD></TR><TR><TD CLASS="l">1300</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="4c">1301</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">1302</TD><TD>     * Reset manager statistics</TD></TR><TR><TD CLASS="l">1303</TD><TD>     */</TD></TR><TR><TD CLASS="l">1304</TD><TD>    public synchronized void resetStatistics() {</TD></TR><TR CLASS="z"><TD CLASS="l">1305</TD><TD>        processingTime = 0 ;</TD></TR><TR CLASS="z"><TD CLASS="l">1306</TD><TD>        expiredSessions = 0 ;</TD></TR><TR CLASS="z"><TD CLASS="l">1307</TD><TD>        synchronized (sessionCreationTiming) {</TD></TR><TR CLASS="z"><TD CLASS="l">1308</TD><TD>            sessionCreationTiming.clear();</TD></TR><TR CLASS="z"><TD CLASS="l">1309</TD><TD>            while (sessionCreationTiming.size() &lt;</TD></TR><TR><TD CLASS="l">1310</TD><TD>                    ManagerBase.TIMING_STATS_CACHE_SIZE) {</TD></TR><TR CLASS="z"><TD CLASS="l">1311</TD><TD>                sessionCreationTiming.add(null);</TD></TR><TR><TD CLASS="l">1312</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">1313</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1314</TD><TD>        synchronized (sessionExpirationTiming) {</TD></TR><TR CLASS="z"><TD CLASS="l">1315</TD><TD>            sessionExpirationTiming.clear();</TD></TR><TR CLASS="z"><TD CLASS="l">1316</TD><TD>            while (sessionExpirationTiming.size() &lt;</TD></TR><TR><TD CLASS="l">1317</TD><TD>                    ManagerBase.TIMING_STATS_CACHE_SIZE) {</TD></TR><TR CLASS="z"><TD CLASS="l">1318</TD><TD>                sessionExpirationTiming.add(null);</TD></TR><TR><TD CLASS="l">1319</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">1320</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1321</TD><TD>        rejectedSessions = 0 ;</TD></TR><TR CLASS="z"><TD CLASS="l">1322</TD><TD>        sessionReplaceCounter = 0 ;</TD></TR><TR CLASS="z"><TD CLASS="l">1323</TD><TD>        counterNoStateTransfered = 0 ;</TD></TR><TR CLASS="z"><TD CLASS="l">1324</TD><TD>        setMaxActive(getActiveSessions());</TD></TR><TR CLASS="z"><TD CLASS="l">1325</TD><TD>        sessionCounter = getActiveSessions() ;</TD></TR><TR CLASS="z"><TD CLASS="l">1326</TD><TD>        counterReceive_EVT_ALL_SESSION_DATA = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">1327</TD><TD>        counterReceive_EVT_GET_ALL_SESSIONS = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">1328</TD><TD>        counterReceive_EVT_SESSION_ACCESSED = 0 ;</TD></TR><TR CLASS="z"><TD CLASS="l">1329</TD><TD>        counterReceive_EVT_SESSION_CREATED = 0 ;</TD></TR><TR CLASS="z"><TD CLASS="l">1330</TD><TD>        counterReceive_EVT_SESSION_DELTA = 0 ;</TD></TR><TR CLASS="z"><TD CLASS="l">1331</TD><TD>        counterReceive_EVT_SESSION_EXPIRED = 0 ;</TD></TR><TR CLASS="z"><TD CLASS="l">1332</TD><TD>        counterReceive_EVT_ALL_SESSION_TRANSFERCOMPLETE = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">1333</TD><TD>        counterReceive_EVT_CHANGE_SESSION_ID = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">1334</TD><TD>        counterSend_EVT_ALL_SESSION_DATA = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">1335</TD><TD>        counterSend_EVT_GET_ALL_SESSIONS = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">1336</TD><TD>        counterSend_EVT_SESSION_ACCESSED = 0 ;</TD></TR><TR CLASS="z"><TD CLASS="l">1337</TD><TD>        counterSend_EVT_SESSION_CREATED = 0 ;</TD></TR><TR CLASS="z"><TD CLASS="l">1338</TD><TD>        counterSend_EVT_SESSION_DELTA = 0 ;</TD></TR><TR CLASS="z"><TD CLASS="l">1339</TD><TD>        counterSend_EVT_SESSION_EXPIRED = 0 ;</TD></TR><TR CLASS="z"><TD CLASS="l">1340</TD><TD>        counterSend_EVT_ALL_SESSION_TRANSFERCOMPLETE = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">1341</TD><TD>        counterSend_EVT_CHANGE_SESSION_ID = 0;</TD></TR><TR><TD CLASS="l">1342</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">1343</TD><TD>    }</TD></TR><TR><TD CLASS="l">1344</TD><TD>   </TD></TR><TR><TD CLASS="l"><A NAME="44">1345</A></TD><TD>    //  -------------------------------------------------------- persistence handler</TD></TR><TR><TD CLASS="l">1346</TD><TD> </TD></TR><TR><TD CLASS="l">1347</TD><TD>    public void load() {</TD></TR><TR><TD CLASS="l">1348</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="68">1349</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">1350</TD><TD> </TD></TR><TR><TD CLASS="l">1351</TD><TD>    public void unload() {</TD></TR><TR><TD CLASS="l">1352</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1353</TD><TD>    }</TD></TR><TR><TD CLASS="l">1354</TD><TD> </TD></TR><TR><TD CLASS="l">1355</TD><TD>    //  -------------------------------------------------------- expire</TD></TR><TR><TD CLASS="l">1356</TD><TD> </TD></TR><TR><TD CLASS="l">1357</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1358</TD><TD>     * send session expired to other cluster nodes</TD></TR><TR><TD CLASS="l">1359</TD><TD>     * </TD></TR><TR><TD CLASS="l"><A NAME="53">1360</A></TD><TD>     * @param id</TD></TR><TR><TD CLASS="l">1361</TD><TD>     *            session id</TD></TR><TR><TD CLASS="l">1362</TD><TD>     */</TD></TR><TR><TD CLASS="l">1363</TD><TD>    protected void sessionExpired(String id) {</TD></TR><TR CLASS="z"><TD CLASS="l">1364</TD><TD>        counterSend_EVT_SESSION_EXPIRED++ ;</TD></TR><TR CLASS="z"><TD CLASS="l">1365</TD><TD>        SessionMessage msg = new SessionMessageImpl(getName(),SessionMessage.EVT_SESSION_EXPIRED, null, id, id+ &#34;-EXPIRED-MSG&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1366</TD><TD>        msg.setTimestamp(System.currentTimeMillis());</TD></TR><TR CLASS="z"><TD CLASS="l">1367</TD><TD>        if (log.isDebugEnabled()) log.debug(sm.getString(&#34;deltaManager.createMessage.expire&#34;,getName(), id));</TD></TR><TR CLASS="z"><TD CLASS="l">1368</TD><TD>        send(msg);</TD></TR><TR CLASS="z"><TD CLASS="l">1369</TD><TD>    }</TD></TR><TR><TD CLASS="l">1370</TD><TD> </TD></TR><TR><TD CLASS="l">1371</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="f">1372</A></TD><TD>     * Expire all find sessions.</TD></TR><TR><TD CLASS="l">1373</TD><TD>     */</TD></TR><TR><TD CLASS="l">1374</TD><TD>    public void expireAllLocalSessions()</TD></TR><TR><TD CLASS="l">1375</TD><TD>    {</TD></TR><TR CLASS="z"><TD CLASS="l">1376</TD><TD>        long timeNow = System.currentTimeMillis();</TD></TR><TR CLASS="z"><TD CLASS="l">1377</TD><TD>        Session sessions[] = findSessions();</TD></TR><TR CLASS="z"><TD CLASS="l">1378</TD><TD>        int expireDirect  = 0 ;</TD></TR><TR CLASS="z"><TD CLASS="l">1379</TD><TD>        int expireIndirect = 0 ;</TD></TR><TR><TD CLASS="l">1380</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">1381</TD><TD>        if(log.isDebugEnabled()) log.debug(&#34;Start expire all sessions &#34; + getName() + &#34; at &#34; + timeNow + &#34; sessioncount &#34; + sessions.length);</TD></TR><TR CLASS="z"><TD CLASS="l">1382</TD><TD>        for (int i = 0; i &lt; sessions.length; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">1383</TD><TD>            if (sessions[i] instanceof DeltaSession) {</TD></TR><TR CLASS="z"><TD CLASS="l">1384</TD><TD>                DeltaSession session = (DeltaSession) sessions[i];</TD></TR><TR CLASS="z"><TD CLASS="l">1385</TD><TD>                if (session.isPrimarySession()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1386</TD><TD>                    if (session.isValid()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1387</TD><TD>                        session.expire();</TD></TR><TR CLASS="z"><TD CLASS="l">1388</TD><TD>                        expireDirect++;</TD></TR><TR><TD CLASS="l">1389</TD><TD>                    } else {</TD></TR><TR CLASS="z"><TD CLASS="l">1390</TD><TD>                        expireIndirect++;</TD></TR><TR><TD CLASS="l">1391</TD><TD>                    }//end if</TD></TR><TR><TD CLASS="l">1392</TD><TD>                }//end if</TD></TR><TR><TD CLASS="l">1393</TD><TD>            }//end if</TD></TR><TR><TD CLASS="l">1394</TD><TD>        }//for</TD></TR><TR CLASS="z"><TD CLASS="l">1395</TD><TD>        long timeEnd = System.currentTimeMillis();</TD></TR><TR CLASS="z"><TD CLASS="l">1396</TD><TD>        if(log.isDebugEnabled()) log.debug(&#34;End expire sessions &#34; + getName() + &#34; expire processingTime &#34; + (timeEnd - timeNow) + &#34; expired direct sessions: &#34; + expireDirect + &#34; expired direct sessions: &#34; + expireIndirect);</TD></TR><TR><TD CLASS="l">1397</TD><TD>      </TD></TR><TR CLASS="z"><TD CLASS="l">1398</TD><TD>    }</TD></TR><TR><TD CLASS="l">1399</TD><TD>    </TD></TR><TR><TD CLASS="l">1400</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1401</TD><TD>     * When the manager expires session not tied to a request. The cluster will</TD></TR><TR><TD CLASS="l">1402</TD><TD>     * periodically ask for a list of sessions that should expire and that</TD></TR><TR><TD CLASS="l">1403</TD><TD>     * should be sent across the wire.</TD></TR><TR><TD CLASS="l"><A NAME="27">1404</A></TD><TD>     * </TD></TR><TR><TD CLASS="l">1405</TD><TD>     * @return The invalidated sessions array</TD></TR><TR><TD CLASS="l">1406</TD><TD>     */</TD></TR><TR><TD CLASS="l">1407</TD><TD>    public String[] getInvalidatedSessions() {</TD></TR><TR CLASS="z"><TD CLASS="l">1408</TD><TD>        return new String[0];</TD></TR><TR><TD CLASS="l">1409</TD><TD>    }</TD></TR><TR><TD CLASS="l">1410</TD><TD> </TD></TR><TR><TD CLASS="l">1411</TD><TD>    //  -------------------------------------------------------- message receive</TD></TR><TR><TD CLASS="l">1412</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="6">1413</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">1414</TD><TD>     * Test that sender and local domain is the same</TD></TR><TR><TD CLASS="l">1415</TD><TD>     */</TD></TR><TR><TD CLASS="l">1416</TD><TD>    protected boolean checkSenderDomain(SessionMessage msg,Member sender) {</TD></TR><TR CLASS="z"><TD CLASS="l">1417</TD><TD>        boolean sameDomain= true;</TD></TR><TR CLASS="z"><TD CLASS="l">1418</TD><TD>        if (!sameDomain &amp;&amp; log.isWarnEnabled()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1419</TD><TD>                log.warn(sm.getString(&#34;deltaManager.receiveMessage.fromWrongDomain&#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">1420</TD><TD>                         new Object[] {getName(), </TD></TR><TR CLASS="z"><TD CLASS="l">1421</TD><TD>                         msg.getEventTypeString(), </TD></TR><TR><TD CLASS="l">1422</TD><TD>                         sender,</TD></TR><TR><TD CLASS="l">1423</TD><TD>                         &#34;&#34;,</TD></TR><TR><TD CLASS="l">1424</TD><TD>                         &#34;&#34; }));</TD></TR><TR><TD CLASS="l">1425</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1426</TD><TD>        return sameDomain ;</TD></TR><TR><TD CLASS="l">1427</TD><TD>    }</TD></TR><TR><TD CLASS="l">1428</TD><TD> </TD></TR><TR><TD CLASS="l">1429</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1430</TD><TD>     * This method is called by the received thread when a SessionMessage has</TD></TR><TR><TD CLASS="l">1431</TD><TD>     * been received from one of the other nodes in the cluster.</TD></TR><TR><TD CLASS="l">1432</TD><TD>     * </TD></TR><TR><TD CLASS="l">1433</TD><TD>     * @param msg -</TD></TR><TR><TD CLASS="l">1434</TD><TD>     *            the message received</TD></TR><TR><TD CLASS="l">1435</TD><TD>     * @param sender -</TD></TR><TR><TD CLASS="l">1436</TD><TD>     *            the sender of the message, this is used if we receive a</TD></TR><TR><TD CLASS="l"><A NAME="46">1437</A></TD><TD>     *            EVT_GET_ALL_SESSION message, so that we only reply to the</TD></TR><TR><TD CLASS="l">1438</TD><TD>     *            requesting node</TD></TR><TR><TD CLASS="l">1439</TD><TD>     */</TD></TR><TR><TD CLASS="l">1440</TD><TD>    protected void messageReceived(SessionMessage msg, Member sender) {</TD></TR><TR CLASS="z"><TD CLASS="l">1441</TD><TD>        if(doDomainReplication() &amp;&amp; !checkSenderDomain(msg,sender)) {</TD></TR><TR CLASS="z"><TD CLASS="l">1442</TD><TD>            return;</TD></TR><TR><TD CLASS="l">1443</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1444</TD><TD>        ClassLoader contextLoader = Thread.currentThread().getContextClassLoader();</TD></TR><TR><TD CLASS="l">1445</TD><TD>        try {</TD></TR><TR><TD CLASS="l">1446</TD><TD>            </TD></TR><TR CLASS="z"><TD CLASS="l">1447</TD><TD>            ClassLoader[] loaders = getClassLoaders();</TD></TR><TR CLASS="z"><TD CLASS="l">1448</TD><TD>            if ( loaders != null &amp;&amp; loaders.length &gt; 0) Thread.currentThread().setContextClassLoader(loaders[0]);</TD></TR><TR CLASS="z"><TD CLASS="l">1449</TD><TD>            if (log.isDebugEnabled()) log.debug(sm.getString(&#34;deltaManager.receiveMessage.eventType&#34;,getName(), msg.getEventTypeString(), sender));</TD></TR><TR><TD CLASS="l">1450</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1451</TD><TD>            switch (msg.getEventType()) {</TD></TR><TR><TD CLASS="l">1452</TD><TD>                case SessionMessage.EVT_GET_ALL_SESSIONS: {</TD></TR><TR CLASS="z"><TD CLASS="l">1453</TD><TD>                    handleGET_ALL_SESSIONS(msg,sender);</TD></TR><TR CLASS="z"><TD CLASS="l">1454</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">1455</TD><TD>                }</TD></TR><TR><TD CLASS="l">1456</TD><TD>                case SessionMessage.EVT_ALL_SESSION_DATA: {</TD></TR><TR CLASS="z"><TD CLASS="l">1457</TD><TD>                    handleALL_SESSION_DATA(msg,sender);</TD></TR><TR CLASS="z"><TD CLASS="l">1458</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">1459</TD><TD>                }</TD></TR><TR><TD CLASS="l">1460</TD><TD>                case SessionMessage.EVT_ALL_SESSION_TRANSFERCOMPLETE: {</TD></TR><TR CLASS="z"><TD CLASS="l">1461</TD><TD>                    handleALL_SESSION_TRANSFERCOMPLETE(msg,sender);</TD></TR><TR CLASS="z"><TD CLASS="l">1462</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">1463</TD><TD>                }</TD></TR><TR><TD CLASS="l">1464</TD><TD>                case SessionMessage.EVT_SESSION_CREATED: {</TD></TR><TR CLASS="z"><TD CLASS="l">1465</TD><TD>                    handleSESSION_CREATED(msg,sender);</TD></TR><TR CLASS="z"><TD CLASS="l">1466</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">1467</TD><TD>                }</TD></TR><TR><TD CLASS="l">1468</TD><TD>                case SessionMessage.EVT_SESSION_EXPIRED: {</TD></TR><TR CLASS="z"><TD CLASS="l">1469</TD><TD>                    handleSESSION_EXPIRED(msg,sender);</TD></TR><TR CLASS="z"><TD CLASS="l">1470</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">1471</TD><TD>                }</TD></TR><TR><TD CLASS="l">1472</TD><TD>                case SessionMessage.EVT_SESSION_ACCESSED: {</TD></TR><TR CLASS="z"><TD CLASS="l">1473</TD><TD>                    handleSESSION_ACCESSED(msg,sender);</TD></TR><TR CLASS="z"><TD CLASS="l">1474</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">1475</TD><TD>                }</TD></TR><TR><TD CLASS="l">1476</TD><TD>                case SessionMessage.EVT_SESSION_DELTA: {</TD></TR><TR CLASS="z"><TD CLASS="l">1477</TD><TD>                   handleSESSION_DELTA(msg,sender);</TD></TR><TR CLASS="z"><TD CLASS="l">1478</TD><TD>                   break;</TD></TR><TR><TD CLASS="l">1479</TD><TD>                }</TD></TR><TR><TD CLASS="l">1480</TD><TD>                case SessionMessage.EVT_CHANGE_SESSION_ID: {</TD></TR><TR CLASS="z"><TD CLASS="l">1481</TD><TD>                    handleCHANGE_SESSION_ID(msg,sender);</TD></TR><TR CLASS="z"><TD CLASS="l">1482</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">1483</TD><TD>                 }</TD></TR><TR><TD CLASS="l">1484</TD><TD>                case SessionMessage.EVT_ALL_SESSION_NOCONTEXTMANAGER: {</TD></TR><TR CLASS="z"><TD CLASS="l">1485</TD><TD>                    handleALL_SESSION_NOCONTEXTMANAGER(msg,sender);</TD></TR><TR CLASS="z"><TD CLASS="l">1486</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">1487</TD><TD>                 }</TD></TR><TR><TD CLASS="l">1488</TD><TD>                default: {</TD></TR><TR><TD CLASS="l">1489</TD><TD>                    //we didn't recognize the message type, do nothing</TD></TR><TR><TD CLASS="l">1490</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">1491</TD><TD>                }</TD></TR><TR><TD CLASS="l">1492</TD><TD>            } //switch</TD></TR><TR CLASS="z"><TD CLASS="l">1493</TD><TD>        } catch (Exception x) {</TD></TR><TR CLASS="z"><TD CLASS="l">1494</TD><TD>            log.error(sm.getString(&#34;deltaManager.receiveMessage.error&#34;,getName()), x);</TD></TR><TR CLASS="z"><TD CLASS="l">1495</TD><TD>        } finally {</TD></TR><TR CLASS="z"><TD CLASS="l">1496</TD><TD>            Thread.currentThread().setContextClassLoader(contextLoader);</TD></TR><TR CLASS="z"><TD CLASS="l">1497</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1498</TD><TD>    }</TD></TR><TR><TD CLASS="l">1499</TD><TD> </TD></TR><TR><TD CLASS="l">1500</TD><TD>    // -------------------------------------------------------- message receiver handler</TD></TR><TR><TD CLASS="l">1501</TD><TD> </TD></TR><TR><TD CLASS="l">1502</TD><TD> </TD></TR><TR><TD CLASS="l">1503</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1504</TD><TD>     * handle receive session state is complete transfered</TD></TR><TR><TD CLASS="l"><A NAME="35">1505</A></TD><TD>     * @param msg</TD></TR><TR><TD CLASS="l">1506</TD><TD>     * @param sender</TD></TR><TR><TD CLASS="l">1507</TD><TD>     */</TD></TR><TR><TD CLASS="l">1508</TD><TD>    protected void handleALL_SESSION_TRANSFERCOMPLETE(SessionMessage msg, Member sender) {</TD></TR><TR CLASS="z"><TD CLASS="l">1509</TD><TD>        counterReceive_EVT_ALL_SESSION_TRANSFERCOMPLETE++ ;</TD></TR><TR CLASS="z"><TD CLASS="l">1510</TD><TD>        if (log.isDebugEnabled()) log.debug(sm.getString(&#34;deltaManager.receiveMessage.transfercomplete&#34;,getName(), sender.getHost(), new Integer(sender.getPort())));</TD></TR><TR CLASS="z"><TD CLASS="l">1511</TD><TD>        stateTransferCreateSendTime = msg.getTimestamp() ;</TD></TR><TR CLASS="z"><TD CLASS="l">1512</TD><TD>        stateTransfered = true ;</TD></TR><TR CLASS="z"><TD CLASS="l">1513</TD><TD>    }</TD></TR><TR><TD CLASS="l">1514</TD><TD> </TD></TR><TR><TD CLASS="l">1515</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1516</TD><TD>     * handle receive session delta</TD></TR><TR><TD CLASS="l">1517</TD><TD>     * @param msg</TD></TR><TR><TD CLASS="l">1518</TD><TD>     * @param sender</TD></TR><TR><TD CLASS="l"><A NAME="3a">1519</A></TD><TD>     * @throws IOException</TD></TR><TR><TD CLASS="l">1520</TD><TD>     * @throws ClassNotFoundException</TD></TR><TR><TD CLASS="l">1521</TD><TD>     */</TD></TR><TR><TD CLASS="l">1522</TD><TD>    protected void handleSESSION_DELTA(SessionMessage msg, Member sender) throws IOException, ClassNotFoundException {</TD></TR><TR CLASS="z"><TD CLASS="l">1523</TD><TD>        counterReceive_EVT_SESSION_DELTA++;</TD></TR><TR CLASS="z"><TD CLASS="l">1524</TD><TD>        byte[] delta = msg.getSession();</TD></TR><TR CLASS="z"><TD CLASS="l">1525</TD><TD>        DeltaSession session = (DeltaSession) findSession(msg.getSessionID());</TD></TR><TR CLASS="z"><TD CLASS="l">1526</TD><TD>        if (session != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">1527</TD><TD>            if (log.isDebugEnabled()) log.debug(sm.getString(&#34;deltaManager.receiveMessage.delta&#34;,getName(), msg.getSessionID()));</TD></TR><TR><TD CLASS="l">1528</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">1529</TD><TD>                session.lock();</TD></TR><TR CLASS="z"><TD CLASS="l">1530</TD><TD>                DeltaRequest dreq = deserializeDeltaRequest(session, delta);</TD></TR><TR CLASS="z"><TD CLASS="l">1531</TD><TD>                dreq.execute(session, notifyListenersOnReplication);</TD></TR><TR CLASS="z"><TD CLASS="l">1532</TD><TD>                session.setPrimarySession(false);</TD></TR><TR CLASS="z"><TD CLASS="l">1533</TD><TD>            }finally {</TD></TR><TR CLASS="z"><TD CLASS="l">1534</TD><TD>                session.unlock();</TD></TR><TR CLASS="z"><TD CLASS="l">1535</TD><TD>            }</TD></TR><TR><TD CLASS="l">1536</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1537</TD><TD>    }</TD></TR><TR><TD CLASS="l">1538</TD><TD> </TD></TR><TR><TD CLASS="l">1539</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1540</TD><TD>     * handle receive session is access at other node ( primary session is now false)</TD></TR><TR><TD CLASS="l">1541</TD><TD>     * @param msg</TD></TR><TR><TD CLASS="l"><A NAME="38">1542</A></TD><TD>     * @param sender</TD></TR><TR><TD CLASS="l">1543</TD><TD>     * @throws IOException</TD></TR><TR><TD CLASS="l">1544</TD><TD>     */</TD></TR><TR><TD CLASS="l">1545</TD><TD>    protected void handleSESSION_ACCESSED(SessionMessage msg,Member sender) throws IOException {</TD></TR><TR CLASS="z"><TD CLASS="l">1546</TD><TD>        counterReceive_EVT_SESSION_ACCESSED++;</TD></TR><TR CLASS="z"><TD CLASS="l">1547</TD><TD>        DeltaSession session = (DeltaSession) findSession(msg.getSessionID());</TD></TR><TR CLASS="z"><TD CLASS="l">1548</TD><TD>        if (session != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">1549</TD><TD>            if (log.isDebugEnabled()) log.debug(sm.getString(&#34;deltaManager.receiveMessage.accessed&#34;,getName(), msg.getSessionID()));</TD></TR><TR CLASS="z"><TD CLASS="l">1550</TD><TD>            session.access();</TD></TR><TR CLASS="z"><TD CLASS="l">1551</TD><TD>            session.setPrimarySession(false);</TD></TR><TR CLASS="z"><TD CLASS="l">1552</TD><TD>            session.endAccess();</TD></TR><TR><TD CLASS="l">1553</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1554</TD><TD>    }</TD></TR><TR><TD CLASS="l">1555</TD><TD> </TD></TR><TR><TD CLASS="l">1556</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1557</TD><TD>     * handle receive session is expire at other node ( expire session also here)</TD></TR><TR><TD CLASS="l">1558</TD><TD>     * @param msg</TD></TR><TR><TD CLASS="l"><A NAME="3b">1559</A></TD><TD>     * @param sender</TD></TR><TR><TD CLASS="l">1560</TD><TD>     * @throws IOException</TD></TR><TR><TD CLASS="l">1561</TD><TD>     */</TD></TR><TR><TD CLASS="l">1562</TD><TD>    protected void handleSESSION_EXPIRED(SessionMessage msg,Member sender) throws IOException {</TD></TR><TR CLASS="z"><TD CLASS="l">1563</TD><TD>        counterReceive_EVT_SESSION_EXPIRED++;</TD></TR><TR CLASS="z"><TD CLASS="l">1564</TD><TD>        DeltaSession session = (DeltaSession) findSession(msg.getSessionID());</TD></TR><TR CLASS="z"><TD CLASS="l">1565</TD><TD>        if (session != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">1566</TD><TD>            if (log.isDebugEnabled()) log.debug(sm.getString(&#34;deltaManager.receiveMessage.expired&#34;,getName(), msg.getSessionID()));</TD></TR><TR CLASS="z"><TD CLASS="l">1567</TD><TD>            session.expire(notifySessionListenersOnReplication, false);</TD></TR><TR><TD CLASS="l">1568</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1569</TD><TD>    }</TD></TR><TR><TD CLASS="l">1570</TD><TD> </TD></TR><TR><TD CLASS="l">1571</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1572</TD><TD>     * handle receive new session is created at other node (create backup - primary false)</TD></TR><TR><TD CLASS="l"><A NAME="39">1573</A></TD><TD>     * @param msg</TD></TR><TR><TD CLASS="l">1574</TD><TD>     * @param sender</TD></TR><TR><TD CLASS="l">1575</TD><TD>     */</TD></TR><TR><TD CLASS="l">1576</TD><TD>    protected void handleSESSION_CREATED(SessionMessage msg,Member sender) {</TD></TR><TR CLASS="z"><TD CLASS="l">1577</TD><TD>        counterReceive_EVT_SESSION_CREATED++;</TD></TR><TR CLASS="z"><TD CLASS="l">1578</TD><TD>        if (log.isDebugEnabled()) log.debug(sm.getString(&#34;deltaManager.receiveMessage.createNewSession&#34;,getName(), msg.getSessionID()));</TD></TR><TR CLASS="z"><TD CLASS="l">1579</TD><TD>        DeltaSession session = (DeltaSession) createEmptySession();</TD></TR><TR CLASS="z"><TD CLASS="l">1580</TD><TD>        session.setManager(this);</TD></TR><TR CLASS="z"><TD CLASS="l">1581</TD><TD>        session.setValid(true);</TD></TR><TR CLASS="z"><TD CLASS="l">1582</TD><TD>        session.setPrimarySession(false);</TD></TR><TR CLASS="z"><TD CLASS="l">1583</TD><TD>        session.setCreationTime(msg.getTimestamp());</TD></TR><TR><TD CLASS="l">1584</TD><TD>        // use container maxInactiveInterval so that session will expire correctly in case of primary transfer</TD></TR><TR CLASS="z"><TD CLASS="l">1585</TD><TD>        session.setMaxInactiveInterval(((Context) getContainer()).getSessionTimeout() * 60, false);</TD></TR><TR CLASS="z"><TD CLASS="l">1586</TD><TD>        session.access();</TD></TR><TR CLASS="z"><TD CLASS="l">1587</TD><TD>        session.setId(msg.getSessionID(), notifySessionListenersOnReplication);</TD></TR><TR CLASS="z"><TD CLASS="l">1588</TD><TD>        session.resetDeltaRequest();</TD></TR><TR CLASS="z"><TD CLASS="l">1589</TD><TD>        session.endAccess();</TD></TR><TR><TD CLASS="l">1590</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1591</TD><TD>    }</TD></TR><TR><TD CLASS="l">1592</TD><TD> </TD></TR><TR><TD CLASS="l">1593</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1594</TD><TD>     * handle receive sessions from other not ( restart )</TD></TR><TR><TD CLASS="l">1595</TD><TD>     * @param msg</TD></TR><TR><TD CLASS="l">1596</TD><TD>     * @param sender</TD></TR><TR><TD CLASS="l"><A NAME="33">1597</A></TD><TD>     * @throws ClassNotFoundException</TD></TR><TR><TD CLASS="l">1598</TD><TD>     * @throws IOException</TD></TR><TR><TD CLASS="l">1599</TD><TD>     */</TD></TR><TR><TD CLASS="l">1600</TD><TD>    protected void handleALL_SESSION_DATA(SessionMessage msg,Member sender) throws ClassNotFoundException, IOException {</TD></TR><TR CLASS="z"><TD CLASS="l">1601</TD><TD>        counterReceive_EVT_ALL_SESSION_DATA++;</TD></TR><TR CLASS="z"><TD CLASS="l">1602</TD><TD>        if (log.isDebugEnabled()) log.debug(sm.getString(&#34;deltaManager.receiveMessage.allSessionDataBegin&#34;,getName()));</TD></TR><TR CLASS="z"><TD CLASS="l">1603</TD><TD>        byte[] data = msg.getSession();</TD></TR><TR CLASS="z"><TD CLASS="l">1604</TD><TD>        deserializeSessions(data);</TD></TR><TR CLASS="z"><TD CLASS="l">1605</TD><TD>        if (log.isDebugEnabled()) log.debug(sm.getString(&#34;deltaManager.receiveMessage.allSessionDataAfter&#34;,getName()));</TD></TR><TR><TD CLASS="l">1606</TD><TD>        //stateTransferred = true;</TD></TR><TR CLASS="z"><TD CLASS="l">1607</TD><TD>    }</TD></TR><TR><TD CLASS="l">1608</TD><TD> </TD></TR><TR><TD CLASS="l">1609</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1610</TD><TD>     * handle receive that other node want all sessions ( restart )</TD></TR><TR><TD CLASS="l">1611</TD><TD>     * a) send all sessions with one message</TD></TR><TR><TD CLASS="l">1612</TD><TD>     * b) send session at blocks</TD></TR><TR><TD CLASS="l">1613</TD><TD>     * After sending send state is complete transfered</TD></TR><TR><TD CLASS="l">1614</TD><TD>     * @param msg</TD></TR><TR><TD CLASS="l"><A NAME="37">1615</A></TD><TD>     * @param sender</TD></TR><TR><TD CLASS="l">1616</TD><TD>     * @throws IOException</TD></TR><TR><TD CLASS="l">1617</TD><TD>     */</TD></TR><TR><TD CLASS="l">1618</TD><TD>    protected void handleGET_ALL_SESSIONS(SessionMessage msg, Member sender) throws IOException {</TD></TR><TR CLASS="z"><TD CLASS="l">1619</TD><TD>        counterReceive_EVT_GET_ALL_SESSIONS++;</TD></TR><TR><TD CLASS="l">1620</TD><TD>        //get a list of all the session from this manager</TD></TR><TR CLASS="z"><TD CLASS="l">1621</TD><TD>        if (log.isDebugEnabled()) log.debug(sm.getString(&#34;deltaManager.receiveMessage.unloadingBegin&#34;, getName()));</TD></TR><TR><TD CLASS="l">1622</TD><TD>        // Write the number of active sessions, followed by the details</TD></TR><TR><TD CLASS="l">1623</TD><TD>        // get all sessions and serialize without sync</TD></TR><TR CLASS="z"><TD CLASS="l">1624</TD><TD>        Session[] currentSessions = findSessions();</TD></TR><TR CLASS="z"><TD CLASS="l">1625</TD><TD>        long findSessionTimestamp = System.currentTimeMillis() ;</TD></TR><TR CLASS="z"><TD CLASS="l">1626</TD><TD>        if (isSendAllSessions()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1627</TD><TD>            sendSessions(sender, currentSessions, findSessionTimestamp);</TD></TR><TR><TD CLASS="l">1628</TD><TD>        } else {</TD></TR><TR><TD CLASS="l">1629</TD><TD>            // send session at blocks</TD></TR><TR CLASS="z"><TD CLASS="l">1630</TD><TD>            for (int i = 0; i &lt; currentSessions.length; i += getSendAllSessionsSize()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1631</TD><TD>                int len = i + getSendAllSessionsSize() &gt; currentSessions.length ? currentSessions.length - i : getSendAllSessionsSize();</TD></TR><TR CLASS="z"><TD CLASS="l">1632</TD><TD>                Session[] sendSessions = new Session[len];</TD></TR><TR CLASS="z"><TD CLASS="l">1633</TD><TD>                System.arraycopy(currentSessions, i, sendSessions, 0, len);</TD></TR><TR CLASS="z"><TD CLASS="l">1634</TD><TD>                sendSessions(sender, sendSessions,findSessionTimestamp);</TD></TR><TR CLASS="z"><TD CLASS="l">1635</TD><TD>                if (getSendAllSessionsWaitTime() &gt; 0) {</TD></TR><TR><TD CLASS="l">1636</TD><TD>                    try {</TD></TR><TR CLASS="z"><TD CLASS="l">1637</TD><TD>                        Thread.sleep(getSendAllSessionsWaitTime());</TD></TR><TR CLASS="z"><TD CLASS="l">1638</TD><TD>                    } catch (Exception sleep) {</TD></TR><TR CLASS="z"><TD CLASS="l">1639</TD><TD>                    }</TD></TR><TR><TD CLASS="l">1640</TD><TD>                }//end if</TD></TR><TR><TD CLASS="l">1641</TD><TD>            }//for</TD></TR><TR><TD CLASS="l">1642</TD><TD>        }//end if</TD></TR><TR><TD CLASS="l">1643</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">1644</TD><TD>        SessionMessage newmsg = new SessionMessageImpl(name,SessionMessage.EVT_ALL_SESSION_TRANSFERCOMPLETE, null,&#34;SESSION-STATE-TRANSFERED&#34;, &#34;SESSION-STATE-TRANSFERED&#34;+ getName());</TD></TR><TR CLASS="z"><TD CLASS="l">1645</TD><TD>        newmsg.setTimestamp(findSessionTimestamp);</TD></TR><TR CLASS="z"><TD CLASS="l">1646</TD><TD>        if (log.isDebugEnabled()) log.debug(sm.getString(&#34;deltaManager.createMessage.allSessionTransfered&#34;,getName()));</TD></TR><TR CLASS="z"><TD CLASS="l">1647</TD><TD>        counterSend_EVT_ALL_SESSION_TRANSFERCOMPLETE++;</TD></TR><TR CLASS="z"><TD CLASS="l">1648</TD><TD>        cluster.send(newmsg, sender);</TD></TR><TR CLASS="z"><TD CLASS="l">1649</TD><TD>    }</TD></TR><TR><TD CLASS="l">1650</TD><TD> </TD></TR><TR><TD CLASS="l">1651</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1652</TD><TD>     * handle receive change sessionID at other node</TD></TR><TR><TD CLASS="l">1653</TD><TD>     * @param msg</TD></TR><TR><TD CLASS="l"><A NAME="36">1654</A></TD><TD>     * @param sender</TD></TR><TR><TD CLASS="l">1655</TD><TD>     * @throws IOException</TD></TR><TR><TD CLASS="l">1656</TD><TD>     */</TD></TR><TR><TD CLASS="l">1657</TD><TD>    protected void handleCHANGE_SESSION_ID(SessionMessage msg,Member sender) throws IOException {</TD></TR><TR CLASS="z"><TD CLASS="l">1658</TD><TD>        counterReceive_EVT_CHANGE_SESSION_ID++;</TD></TR><TR CLASS="z"><TD CLASS="l">1659</TD><TD>        DeltaSession session = (DeltaSession) findSession(msg.getSessionID());</TD></TR><TR CLASS="z"><TD CLASS="l">1660</TD><TD>        if (session != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">1661</TD><TD>            String newSessionID = deserializeSessionId(msg.getSession());</TD></TR><TR CLASS="z"><TD CLASS="l">1662</TD><TD>            session.setPrimarySession(false);</TD></TR><TR CLASS="z"><TD CLASS="l">1663</TD><TD>            session.setId(newSessionID, false);</TD></TR><TR CLASS="z"><TD CLASS="l">1664</TD><TD>            if (notifyContainerListenersOnReplication) {</TD></TR><TR CLASS="z"><TD CLASS="l">1665</TD><TD>                Container c = getContainer();</TD></TR><TR CLASS="z"><TD CLASS="l">1666</TD><TD>                if (c instanceof StandardContext) {</TD></TR><TR CLASS="z"><TD CLASS="l">1667</TD><TD>                    ((StandardContext) getContainer()).fireContainerEvent(</TD></TR><TR><TD CLASS="l">1668</TD><TD>                            Context.CHANGE_SESSION_ID_EVENT,</TD></TR><TR CLASS="z"><TD CLASS="l">1669</TD><TD>                            new String[] {msg.getSessionID(), newSessionID});</TD></TR><TR><TD CLASS="l">1670</TD><TD>                }</TD></TR><TR><TD CLASS="l">1671</TD><TD>            }</TD></TR><TR><TD CLASS="l">1672</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">1673</TD><TD>    }</TD></TR><TR><TD CLASS="l">1674</TD><TD> </TD></TR><TR><TD CLASS="l">1675</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1676</TD><TD>     * handle receive no context manager.</TD></TR><TR><TD CLASS="l"><A NAME="34">1677</A></TD><TD>     * @param msg</TD></TR><TR><TD CLASS="l">1678</TD><TD>     * @param sender</TD></TR><TR><TD CLASS="l">1679</TD><TD>     */</TD></TR><TR><TD CLASS="l">1680</TD><TD>    protected void handleALL_SESSION_NOCONTEXTMANAGER(SessionMessage msg, Member sender) {</TD></TR><TR CLASS="z"><TD CLASS="l">1681</TD><TD>        counterReceive_EVT_ALL_SESSION_NOCONTEXTMANAGER++ ;</TD></TR><TR CLASS="z"><TD CLASS="l">1682</TD><TD>        if (log.isDebugEnabled()) </TD></TR><TR CLASS="z"><TD CLASS="l">1683</TD><TD>            log.debug(sm.getString(&#34;deltaManager.receiveMessage.noContextManager&#34;,getName(), sender.getHost(), Integer.valueOf(sender.getPort())));</TD></TR><TR CLASS="z"><TD CLASS="l">1684</TD><TD>        noContextManagerReceived = true ;</TD></TR><TR CLASS="z"><TD CLASS="l">1685</TD><TD>    }</TD></TR><TR><TD CLASS="l">1686</TD><TD> </TD></TR><TR><TD CLASS="l">1687</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1688</TD><TD>     * send a block of session to sender</TD></TR><TR><TD CLASS="l">1689</TD><TD>     * @param sender</TD></TR><TR><TD CLASS="l">1690</TD><TD>     * @param currentSessions</TD></TR><TR><TD CLASS="l"><A NAME="4f">1691</A></TD><TD>     * @param sendTimestamp</TD></TR><TR><TD CLASS="l">1692</TD><TD>     * @throws IOException</TD></TR><TR><TD CLASS="l">1693</TD><TD>     */</TD></TR><TR><TD CLASS="l">1694</TD><TD>    protected void sendSessions(Member sender, Session[] currentSessions,long sendTimestamp) throws IOException {</TD></TR><TR CLASS="z"><TD CLASS="l">1695</TD><TD>        byte[] data = serializeSessions(currentSessions);</TD></TR><TR CLASS="z"><TD CLASS="l">1696</TD><TD>        if (log.isDebugEnabled()) log.debug(sm.getString(&#34;deltaManager.receiveMessage.unloadingAfter&#34;,getName()));</TD></TR><TR CLASS="z"><TD CLASS="l">1697</TD><TD>        SessionMessage newmsg = new SessionMessageImpl(name,SessionMessage.EVT_ALL_SESSION_DATA, data,&#34;SESSION-STATE&#34;, &#34;SESSION-STATE-&#34; + getName());</TD></TR><TR CLASS="z"><TD CLASS="l">1698</TD><TD>        newmsg.setTimestamp(sendTimestamp);</TD></TR><TR CLASS="z"><TD CLASS="l">1699</TD><TD>        if (log.isDebugEnabled()) log.debug(sm.getString(&#34;deltaManager.createMessage.allSessionData&#34;,getName()));</TD></TR><TR CLASS="z"><TD CLASS="l">1700</TD><TD>        counterSend_EVT_ALL_SESSION_DATA++;</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="7">1701</A></TD><TD>        cluster.send(newmsg, sender);</TD></TR><TR CLASS="z"><TD CLASS="l">1702</TD><TD>    }</TD></TR><TR><TD CLASS="l">1703</TD><TD> </TD></TR><TR><TD CLASS="l">1704</TD><TD>    public ClusterManager cloneFromTemplate() {</TD></TR><TR CLASS="z"><TD CLASS="l">1705</TD><TD>        DeltaManager result = new DeltaManager();</TD></TR><TR CLASS="z"><TD CLASS="l">1706</TD><TD>        result.name = &#34;Clone-from-&#34;+name;</TD></TR><TR CLASS="z"><TD CLASS="l">1707</TD><TD>        result.cluster = cluster;</TD></TR><TR CLASS="z"><TD CLASS="l">1708</TD><TD>        result.replicationValve = replicationValve;</TD></TR><TR CLASS="z"><TD CLASS="l">1709</TD><TD>        result.maxActiveSessions = maxActiveSessions;</TD></TR><TR CLASS="z"><TD CLASS="l">1710</TD><TD>        result.expireSessionsOnShutdown = expireSessionsOnShutdown;</TD></TR><TR CLASS="z"><TD CLASS="l">1711</TD><TD>        result.notifyListenersOnReplication = notifyListenersOnReplication;</TD></TR><TR CLASS="z"><TD CLASS="l">1712</TD><TD>        result.notifySessionListenersOnReplication = notifySessionListenersOnReplication;</TD></TR><TR CLASS="z"><TD CLASS="l">1713</TD><TD>        result.notifyContainerListenersOnReplication = notifyContainerListenersOnReplication;</TD></TR><TR CLASS="z"><TD CLASS="l">1714</TD><TD>        result.stateTransferTimeout = stateTransferTimeout;</TD></TR><TR CLASS="z"><TD CLASS="l">1715</TD><TD>        result.sendAllSessions = sendAllSessions;</TD></TR><TR CLASS="z"><TD CLASS="l">1716</TD><TD>        result.sendClusterDomainOnly = sendClusterDomainOnly ;</TD></TR><TR CLASS="z"><TD CLASS="l">1717</TD><TD>        result.sendAllSessionsSize = sendAllSessionsSize;</TD></TR><TR CLASS="z"><TD CLASS="l">1718</TD><TD>        result.sendAllSessionsWaitTime = sendAllSessionsWaitTime ; </TD></TR><TR CLASS="z"><TD CLASS="l">1719</TD><TD>        result.receiverQueue = receiverQueue ;</TD></TR><TR CLASS="z"><TD CLASS="l">1720</TD><TD>        result.stateTimestampDrop = stateTimestampDrop ;</TD></TR><TR CLASS="z"><TD CLASS="l">1721</TD><TD>        result.stateTransferCreateSendTime = stateTransferCreateSendTime; </TD></TR><TR CLASS="z"><TD CLASS="l">1722</TD><TD>        result.setSessionAttributeFilter(getSessionAttributeFilter());</TD></TR><TR CLASS="z"><TD CLASS="l">1723</TD><TD>        return result;</TD></TR><TR><TD CLASS="l">1724</TD><TD>    }</TD></TR><TR><TD CLASS="l">1725</TD><TD>}</TD></TR></TABLE><P></P><TABLE WIDTH="100%" CLASS="hdft" CELLSPACING="0"><TR><TD CLASS="nv">[<A HREF="../index.html">all classes</A>][<A HREF="32.html">org.apache.catalina.ha.session</A>]</TD></TR><TR><TD CLASS="tl"><A HREF="http://sourceforge.net/projects/emma">EMMA 2.1.5320 (stable)</A> (C) Vladimir Roubtsov</TD></TR></TABLE></BODY></HTML>