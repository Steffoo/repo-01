<HTML><HEAD><META CONTENT="text/html; charset=UTF-8" HTTP-EQUIV="Content-Type"/><TITLE>EMMA Coverage Report</TITLE><STYLE TYPE="text/css"> TABLE,TD,TH {border-style:solid; border-color:black;} TD,TH {background:white;margin:0;line-height:100%;padding-left:0.5em;padding-right:0.5em;} TD {border-width:0 1px 0 0;} TH {border-width:1px 1px 1px 0;} TR TD.h {color:red;} TABLE {border-spacing:0; border-collapse:collapse;border-width:0 0 1px 1px;} P,H1,H2,H3,TH {font-family:verdana,arial,sans-serif;font-size:10pt;} TD {font-family:courier,monospace;font-size:10pt;} TABLE.hdft {border-spacing:0;border-collapse:collapse;border-style:none;} TABLE.hdft TH,TABLE.hdft TD {border-style:none;line-height:normal;} TABLE.hdft TH.tl,TABLE.hdft TD.tl {background:#6699CC;color:white;} TABLE.hdft TD.nv {background:#6633DD;color:white;} .nv A:link {color:white;} .nv A:visited {color:white;} .nv A:active {color:yellow;} TABLE.hdft A:link {color:white;} TABLE.hdft A:visited {color:white;} TABLE.hdft A:active {color:yellow;} .in {color:#356085;} TABLE.s TD {padding-left:0.25em;padding-right:0.25em;} TABLE.s TD.l {padding-left:0.25em;padding-right:0.25em;text-align:right;background:#F0F0F0;} TABLE.s TR.z TD {background:#FF9999;} TABLE.s TR.p TD {background:#FFFF88;} TABLE.s TR.c TD {background:#CCFFCC;} A:link {color:#0000EE;text-decoration:none;} A:visited {color:#0000EE;text-decoration:none;} A:hover {color:#0000EE;text-decoration:underline;} TABLE.cn {border-width:0 0 1px 0;} TABLE.s {border-width:1px 0 1px 1px;} TD.h {color:red;border-width:0 1px 0 0;} TD.f {border-width:0 1px 0 1px;} TD.hf {color:red;border-width:0 1px 0 1px;} TH.f {border-width:1px 1px 1px 1px;} TR.cis TD {background:#F0F0F0;} TR.cis TD {border-width:1px 1px 1px 0;} TR.cis TD.h {color:red;border-width:1px 1px 1px 0;} TR.cis TD.f {border-width:1px 1px 1px 1px;} TR.cis TD.hf {color:red;border-width:1px 1px 1px 1px;} TD.b {border-style:none;background:transparent;line-height:50%;}  TD.bt {border-width:1px 0 0 0;background:transparent;line-height:50%;} TR.o TD {background:#F0F0F0;}TABLE.it {border-style:none;}TABLE.it TD,TABLE.it TH {border-style:none;}</STYLE></HEAD><BODY><TABLE WIDTH="100%" CLASS="hdft" CELLSPACING="0"><TR><TH CLASS="tl"><A HREF="http://emma.sourceforge.net/">EMMA</A> Coverage Report (generated Thu Nov 16 15:09:53 CET 2017)</TH></TR><TR><TD CLASS="nv">[<A HREF="../index.html">all classes</A>][<A HREF="35.html">org.apache.jasper.compiler</A>]</TD></TR></TABLE><H2>COVERAGE SUMMARY FOR SOURCE FILE [<SPAN CLASS="in">SmapUtil.java</SPAN>]</H2><TABLE WIDTH="100%" CELLSPACING="0"><TR><TH>name</TH><TH>class, %</TH><TH>method, %</TH><TH>block, %</TH><TH>line, %</TH></TR><TR><TD>SmapUtil.java</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/58)</TD><TD CLASS="h">0%   (0/1512)</TD><TD CLASS="h">0%   (0/363)</TD></TR></TABLE><H3>COVERAGE BREAKDOWN BY CLASS AND METHOD</H3><TABLE WIDTH="100%" CLASS="cn" CELLSPACING="0"><TR><TH CLASS="f">name</TH><TH>class, %</TH><TH>method, %</TH><TH>block, %</TH><TH>line, %</TH></TR><TR><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#0">SmapUtil</A></TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/7)</TD><TD CLASS="h">0%   (0/277)</TD><TD CLASS="h">0%   (0/59)</TD></TR><TR><TD CLASS="f"><A HREF="#0">SmapUtil (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/7)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#0">access$100 (String): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#3">evaluateNodes (Node$Nodes, SmapStratum, HashMap, boolean): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/11)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#4">generateSmap (JspCompilationContext, Node$Nodes): String []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/200)</TD><TD CLASS="h">0%   (0/43)</TD></TR><TR><TD CLASS="f"><A HREF="#5">inputSmapPath (String): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/16)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#6">installSmap (String []): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/27)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR><TD CLASS="f"><A HREF="#7">unqualify (String): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/13)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#8">SmapUtil$PreScanVisitor</A></TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/34)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR><TD CLASS="f"><A HREF="#8">SmapUtil$PreScanVisitor (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/8)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#8">SmapUtil$PreScanVisitor (SmapUtil$1): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#b">doVisit (Node): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/20)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#c">getMap (): HashMap</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#d">SmapUtil$SDEInstaller</A></TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/23)</TD><TD CLASS="h">0%   (0/859)</TD><TD CLASS="h">0%   (0/181)</TD></TR><TR><TD CLASS="f"><A HREF="#e">SmapUtil$SDEInstaller (File, File, File): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/7)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#f">SmapUtil$SDEInstaller (File, byte [], File): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/62)</TD><TD CLASS="h">0%   (0/15)</TD></TR><TR><TD CLASS="f"><A HREF="#10">addSDE (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/157)</TD><TD CLASS="h">0%   (0/36)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#11">copy (int): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/28)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR><TD CLASS="f"><A HREF="#12">copyAttrs (int): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/56)</TD><TD CLASS="h">0%   (0/14)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#13">copyConstantPool (int): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/153)</TD><TD CLASS="h">0%   (0/34)</TD></TR><TR><TD CLASS="f"><A HREF="#14">copyMembers (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/57)</TD><TD CLASS="h">0%   (0/12)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#15">install (File, File): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/38)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR><TD CLASS="f"><A HREF="#16">install (File, File, File): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/8)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#17">install (File, byte []): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/38)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR><TD CLASS="f"><A HREF="#d">main (String []): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/46)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#19">randomAccessWriteU2 (int, int): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/13)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR><TD CLASS="f"><A HREF="#1a">readBytes (int): byte []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/25)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1b">readU1 (): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/13)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#1c">readU2 (): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/10)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1d">readU4 (): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/10)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#1e">readWhole (File): byte []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/35)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1f">writeAttrForSDE (int): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/24)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR><TD CLASS="f"><A HREF="#20">writeBytes (byte []): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/22)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#21">writeU1 (int): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/13)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#22">writeU2 (int): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/11)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#23">writeU4 (int): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/11)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR><TD CLASS="f"><A HREF="#24">writeUtf8ForSDE (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/22)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#25">SmapUtil$SmapGenVisitor</A></TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/24)</TD><TD CLASS="h">0%   (0/342)</TD><TD CLASS="h">0%   (0/116)</TD></TR><TR><TD CLASS="f"><A HREF="#25">SmapUtil$SmapGenVisitor (SmapStratum, boolean, HashMap): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/12)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#27">doSmap (Node): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/11)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#28">doSmap (Node, int, int, int): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/34)</TD><TD CLASS="h">0%   (0/10)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#29">doSmapText (Node): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/84)</TD><TD CLASS="h">0%   (0/27)</TD></TR><TR><TD CLASS="f"><A HREF="#2a">visit (Node$CustomTag): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/7)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2b">visit (Node$Declaration): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#2c">visit (Node$DoBodyAction): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/7)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2d">visit (Node$ELExpression): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#2e">visit (Node$Expression): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2f">visit (Node$ForwardAction): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/7)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR><TD CLASS="f"><A HREF="#30">visit (Node$GetProperty): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/7)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#31">visit (Node$IncludeAction): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/7)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR><TD CLASS="f"><A HREF="#32">visit (Node$InvokeAction): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/7)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#33">visit (Node$JspBody): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/7)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR><TD CLASS="f"><A HREF="#34">visit (Node$JspElement): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/7)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#35">visit (Node$JspText): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/7)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR><TD CLASS="f"><A HREF="#36">visit (Node$NamedAttribute): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#37">visit (Node$PlugIn): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/7)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR><TD CLASS="f"><A HREF="#38">visit (Node$Scriptlet): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#39">visit (Node$SetProperty): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/7)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR><TD CLASS="f"><A HREF="#3a">visit (Node$TemplateText): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/68)</TD><TD CLASS="h">0%   (0/16)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#3b">visit (Node$UninterpretedTag): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/7)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR><TD CLASS="f"><A HREF="#3c">visit (Node$UseBean): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/7)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#3d">visitBody (Node): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/22)</TD><TD CLASS="h">0%   (0/7)</TD></TR></TABLE><P></P><TABLE WIDTH="100%" CLASS="s" CELLSPACING="0"><TR><TD CLASS="l">1</TD><TD>/*</TD></TR><TR><TD CLASS="l">2</TD><TD> * Licensed to the Apache Software Foundation (ASF) under one or more</TD></TR><TR><TD CLASS="l">3</TD><TD> * contributor license agreements.  See the NOTICE file distributed with</TD></TR><TR><TD CLASS="l">4</TD><TD> * this work for additional information regarding copyright ownership.</TD></TR><TR><TD CLASS="l">5</TD><TD> * The ASF licenses this file to You under the Apache License, Version 2.0</TD></TR><TR><TD CLASS="l">6</TD><TD> * (the &#34;License&#34;); you may not use this file except in compliance with</TD></TR><TR><TD CLASS="l">7</TD><TD> * the License.  You may obtain a copy of the License at</TD></TR><TR><TD CLASS="l">8</TD><TD> * </TD></TR><TR><TD CLASS="l">9</TD><TD> *      http://www.apache.org/licenses/LICENSE-2.0</TD></TR><TR><TD CLASS="l">10</TD><TD> * </TD></TR><TR><TD CLASS="l">11</TD><TD> * Unless required by applicable law or agreed to in writing, software</TD></TR><TR><TD CLASS="l">12</TD><TD> * distributed under the License is distributed on an &#34;AS IS&#34; BASIS,</TD></TR><TR><TD CLASS="l">13</TD><TD> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</TD></TR><TR><TD CLASS="l">14</TD><TD> * See the License for the specific language governing permissions and</TD></TR><TR><TD CLASS="l">15</TD><TD> * limitations under the License.</TD></TR><TR><TD CLASS="l">16</TD><TD> */</TD></TR><TR><TD CLASS="l">17</TD><TD> </TD></TR><TR><TD CLASS="l">18</TD><TD>package org.apache.jasper.compiler;</TD></TR><TR><TD CLASS="l">19</TD><TD> </TD></TR><TR><TD CLASS="l">20</TD><TD>import java.io.File;</TD></TR><TR><TD CLASS="l">21</TD><TD>import java.io.FileInputStream;</TD></TR><TR><TD CLASS="l">22</TD><TD>import java.io.FileNotFoundException;</TD></TR><TR><TD CLASS="l">23</TD><TD>import java.io.FileOutputStream;</TD></TR><TR><TD CLASS="l">24</TD><TD>import java.io.IOException;</TD></TR><TR><TD CLASS="l">25</TD><TD>import java.io.OutputStreamWriter;</TD></TR><TR><TD CLASS="l">26</TD><TD>import java.io.PrintWriter;</TD></TR><TR><TD CLASS="l">27</TD><TD>import java.io.UnsupportedEncodingException;</TD></TR><TR><TD CLASS="l">28</TD><TD>import java.util.HashMap;</TD></TR><TR><TD CLASS="l">29</TD><TD>import java.util.Iterator;</TD></TR><TR><TD CLASS="l">30</TD><TD>import java.util.Map;</TD></TR><TR><TD CLASS="l">31</TD><TD> </TD></TR><TR><TD CLASS="l">32</TD><TD>import org.apache.jasper.JasperException;</TD></TR><TR><TD CLASS="l">33</TD><TD>import org.apache.jasper.JspCompilationContext;</TD></TR><TR><TD CLASS="l">34</TD><TD> </TD></TR><TR><TD CLASS="l">35</TD><TD>/**</TD></TR><TR><TD CLASS="l">36</TD><TD> * Contains static utilities for generating SMAP data based on the</TD></TR><TR><TD CLASS="l">37</TD><TD> * current version of Jasper.</TD></TR><TR><TD CLASS="l">38</TD><TD> * </TD></TR><TR><TD CLASS="l">39</TD><TD> * @author Jayson Falkner</TD></TR><TR><TD CLASS="l">40</TD><TD> * @author Shawn Bayern</TD></TR><TR><TD CLASS="l"><A NAME="0">41</A></TD><TD> * @author Robert Field (inner SDEInstaller class)</TD></TR><TR><TD CLASS="l">42</TD><TD> * @author Mark Roth</TD></TR><TR><TD CLASS="l">43</TD><TD> * @author Kin-man Chung</TD></TR><TR><TD CLASS="l">44</TD><TD> */</TD></TR><TR CLASS="z"><TD CLASS="l">45</TD><TD>public class SmapUtil {</TD></TR><TR><TD CLASS="l">46</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">47</TD><TD>    private org.apache.juli.logging.Log log=</TD></TR><TR CLASS="z"><TD CLASS="l">48</TD><TD>        org.apache.juli.logging.LogFactory.getLog( SmapUtil.class );</TD></TR><TR><TD CLASS="l">49</TD><TD> </TD></TR><TR><TD CLASS="l">50</TD><TD>    //*********************************************************************</TD></TR><TR><TD CLASS="l">51</TD><TD>    // Constants</TD></TR><TR><TD CLASS="l">52</TD><TD> </TD></TR><TR><TD CLASS="l">53</TD><TD>    public static final String SMAP_ENCODING = &#34;UTF-8&#34;;</TD></TR><TR><TD CLASS="l">54</TD><TD> </TD></TR><TR><TD CLASS="l">55</TD><TD>    //*********************************************************************</TD></TR><TR><TD CLASS="l">56</TD><TD>    // Public entry points</TD></TR><TR><TD CLASS="l">57</TD><TD> </TD></TR><TR><TD CLASS="l">58</TD><TD>    /**</TD></TR><TR><TD CLASS="l">59</TD><TD>     * Generates an appropriate SMAP representing the current compilation</TD></TR><TR><TD CLASS="l">60</TD><TD>     * context.  (JSR-045.)</TD></TR><TR><TD CLASS="l">61</TD><TD>     *</TD></TR><TR><TD CLASS="l">62</TD><TD>     * @param ctxt Current compilation context</TD></TR><TR><TD CLASS="l">63</TD><TD>     * @param pageNodes The current JSP page</TD></TR><TR><TD CLASS="l">64</TD><TD>     * @return a SMAP for the page</TD></TR><TR><TD CLASS="l">65</TD><TD>     */</TD></TR><TR><TD CLASS="l">66</TD><TD>    public static String[] generateSmap(</TD></TR><TR><TD CLASS="l">67</TD><TD>        JspCompilationContext ctxt,</TD></TR><TR><TD CLASS="l"><A NAME="4">68</A></TD><TD>        Node.Nodes pageNodes)</TD></TR><TR><TD CLASS="l">69</TD><TD>        throws IOException {</TD></TR><TR><TD CLASS="l">70</TD><TD> </TD></TR><TR><TD CLASS="l">71</TD><TD>        // Scan the nodes for presence of Jasper generated inner classes</TD></TR><TR CLASS="z"><TD CLASS="l">72</TD><TD>        PreScanVisitor psVisitor = new PreScanVisitor();</TD></TR><TR><TD CLASS="l">73</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">74</TD><TD>            pageNodes.visit(psVisitor);</TD></TR><TR CLASS="z"><TD CLASS="l">75</TD><TD>        } catch (JasperException ex) {</TD></TR><TR CLASS="z"><TD CLASS="l">76</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">77</TD><TD>        HashMap map = psVisitor.getMap();</TD></TR><TR><TD CLASS="l">78</TD><TD> </TD></TR><TR><TD CLASS="l">79</TD><TD>        // set up our SMAP generator</TD></TR><TR CLASS="z"><TD CLASS="l">80</TD><TD>        SmapGenerator g = new SmapGenerator();</TD></TR><TR><TD CLASS="l">81</TD><TD>        </TD></TR><TR><TD CLASS="l">82</TD><TD>        /** Disable reading of input SMAP because:</TD></TR><TR><TD CLASS="l">83</TD><TD>            1. There is a bug here: getRealPath() is null if .jsp is in a jar</TD></TR><TR><TD CLASS="l">84</TD><TD>                Bugzilla 14660.</TD></TR><TR><TD CLASS="l">85</TD><TD>            2. Mappings from other sources into .jsp files are not supported.</TD></TR><TR><TD CLASS="l">86</TD><TD>            TODO: fix 1. if 2. is not true.</TD></TR><TR><TD CLASS="l">87</TD><TD>        // determine if we have an input SMAP</TD></TR><TR><TD CLASS="l">88</TD><TD>        String smapPath = inputSmapPath(ctxt.getRealPath(ctxt.getJspFile()));</TD></TR><TR><TD CLASS="l">89</TD><TD>            File inputSmap = new File(smapPath);</TD></TR><TR><TD CLASS="l">90</TD><TD>            if (inputSmap.exists()) {</TD></TR><TR><TD CLASS="l">91</TD><TD>                byte[] embeddedSmap = null;</TD></TR><TR><TD CLASS="l">92</TD><TD>            byte[] subSmap = SDEInstaller.readWhole(inputSmap);</TD></TR><TR><TD CLASS="l">93</TD><TD>            String subSmapString = new String(subSmap, SMAP_ENCODING);</TD></TR><TR><TD CLASS="l">94</TD><TD>            g.addSmap(subSmapString, &#34;JSP&#34;);</TD></TR><TR><TD CLASS="l">95</TD><TD>        }</TD></TR><TR><TD CLASS="l">96</TD><TD>        **/</TD></TR><TR><TD CLASS="l">97</TD><TD> </TD></TR><TR><TD CLASS="l">98</TD><TD>        // now, assemble info about our own stratum (JSP) using JspLineMap</TD></TR><TR CLASS="z"><TD CLASS="l">99</TD><TD>        SmapStratum s = new SmapStratum(&#34;JSP&#34;);</TD></TR><TR><TD CLASS="l">100</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">101</TD><TD>        g.setOutputFileName(unqualify(ctxt.getServletJavaFileName()));</TD></TR><TR><TD CLASS="l">102</TD><TD> </TD></TR><TR><TD CLASS="l">103</TD><TD>        // Map out Node.Nodes</TD></TR><TR CLASS="z"><TD CLASS="l">104</TD><TD>        evaluateNodes(pageNodes, s, map, ctxt.getOptions().getMappedFile());</TD></TR><TR CLASS="z"><TD CLASS="l">105</TD><TD>        s.optimizeLineSection();</TD></TR><TR CLASS="z"><TD CLASS="l">106</TD><TD>        g.addStratum(s, true);</TD></TR><TR><TD CLASS="l">107</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">108</TD><TD>        if (ctxt.getOptions().isSmapDumped()) {</TD></TR><TR CLASS="z"><TD CLASS="l">109</TD><TD>            File outSmap = new File(ctxt.getClassFileName() + &#34;.smap&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">110</TD><TD>            PrintWriter so =</TD></TR><TR><TD CLASS="l">111</TD><TD>                new PrintWriter(</TD></TR><TR><TD CLASS="l">112</TD><TD>                    new OutputStreamWriter(</TD></TR><TR><TD CLASS="l">113</TD><TD>                        new FileOutputStream(outSmap),</TD></TR><TR><TD CLASS="l">114</TD><TD>                        SMAP_ENCODING));</TD></TR><TR CLASS="z"><TD CLASS="l">115</TD><TD>            so.print(g.getString());</TD></TR><TR CLASS="z"><TD CLASS="l">116</TD><TD>            so.close();</TD></TR><TR><TD CLASS="l">117</TD><TD>        }</TD></TR><TR><TD CLASS="l">118</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">119</TD><TD>        String classFileName = ctxt.getClassFileName();</TD></TR><TR CLASS="z"><TD CLASS="l">120</TD><TD>        int innerClassCount = map.size();</TD></TR><TR CLASS="z"><TD CLASS="l">121</TD><TD>        String [] smapInfo = new String[2 + innerClassCount*2];</TD></TR><TR CLASS="z"><TD CLASS="l">122</TD><TD>        smapInfo[0] = classFileName;</TD></TR><TR CLASS="z"><TD CLASS="l">123</TD><TD>        smapInfo[1] = g.getString();</TD></TR><TR><TD CLASS="l">124</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">125</TD><TD>        int count = 2;</TD></TR><TR CLASS="z"><TD CLASS="l">126</TD><TD>        Iterator iter = map.entrySet().iterator();</TD></TR><TR CLASS="z"><TD CLASS="l">127</TD><TD>        while (iter.hasNext()) {</TD></TR><TR CLASS="z"><TD CLASS="l">128</TD><TD>            Map.Entry entry = (Map.Entry) iter.next();</TD></TR><TR CLASS="z"><TD CLASS="l">129</TD><TD>            String innerClass = (String) entry.getKey();</TD></TR><TR CLASS="z"><TD CLASS="l">130</TD><TD>            s = (SmapStratum) entry.getValue();</TD></TR><TR CLASS="z"><TD CLASS="l">131</TD><TD>            s.optimizeLineSection();</TD></TR><TR CLASS="z"><TD CLASS="l">132</TD><TD>            g = new SmapGenerator();</TD></TR><TR CLASS="z"><TD CLASS="l">133</TD><TD>            g.setOutputFileName(unqualify(ctxt.getServletJavaFileName()));</TD></TR><TR CLASS="z"><TD CLASS="l">134</TD><TD>            g.addStratum(s, true);</TD></TR><TR><TD CLASS="l">135</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">136</TD><TD>            String innerClassFileName =</TD></TR><TR CLASS="z"><TD CLASS="l">137</TD><TD>                classFileName.substring(0, classFileName.indexOf(&#34;.class&#34;)) +</TD></TR><TR><TD CLASS="l">138</TD><TD>                '$' + innerClass + &#34;.class&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">139</TD><TD>            if (ctxt.getOptions().isSmapDumped()) {</TD></TR><TR CLASS="z"><TD CLASS="l">140</TD><TD>                File outSmap = new File(innerClassFileName + &#34;.smap&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">141</TD><TD>                PrintWriter so =</TD></TR><TR><TD CLASS="l">142</TD><TD>                    new PrintWriter(</TD></TR><TR><TD CLASS="l">143</TD><TD>                        new OutputStreamWriter(</TD></TR><TR><TD CLASS="l">144</TD><TD>                            new FileOutputStream(outSmap),</TD></TR><TR><TD CLASS="l">145</TD><TD>                            SMAP_ENCODING));</TD></TR><TR CLASS="z"><TD CLASS="l">146</TD><TD>                so.print(g.getString());</TD></TR><TR CLASS="z"><TD CLASS="l">147</TD><TD>                so.close();</TD></TR><TR><TD CLASS="l">148</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">149</TD><TD>            smapInfo[count] = innerClassFileName;</TD></TR><TR CLASS="z"><TD CLASS="l">150</TD><TD>            smapInfo[count+1] = g.getString();</TD></TR><TR CLASS="z"><TD CLASS="l">151</TD><TD>            count += 2;</TD></TR><TR CLASS="z"><TD CLASS="l">152</TD><TD>        }</TD></TR><TR><TD CLASS="l">153</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">154</TD><TD>        return smapInfo;</TD></TR><TR><TD CLASS="l"><A NAME="6">155</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">156</TD><TD> </TD></TR><TR><TD CLASS="l">157</TD><TD>    public static void installSmap(String[] smap)</TD></TR><TR><TD CLASS="l">158</TD><TD>        throws IOException {</TD></TR><TR CLASS="z"><TD CLASS="l">159</TD><TD>        if (smap == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">160</TD><TD>            return;</TD></TR><TR><TD CLASS="l">161</TD><TD>        }</TD></TR><TR><TD CLASS="l">162</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">163</TD><TD>        for (int i = 0; i &lt; smap.length; i += 2) {</TD></TR><TR CLASS="z"><TD CLASS="l">164</TD><TD>            File outServlet = new File(smap[i]);</TD></TR><TR CLASS="z"><TD CLASS="l">165</TD><TD>            SDEInstaller.install(outServlet, smap[i+1].getBytes());</TD></TR><TR><TD CLASS="l">166</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">167</TD><TD>    }</TD></TR><TR><TD CLASS="l">168</TD><TD> </TD></TR><TR><TD CLASS="l">169</TD><TD>    //*********************************************************************</TD></TR><TR><TD CLASS="l">170</TD><TD>    // Private utilities</TD></TR><TR><TD CLASS="l">171</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="7">172</A></TD><TD>    /**</TD></TR><TR><TD CLASS="l">173</TD><TD>     * Returns an unqualified version of the given file path.</TD></TR><TR><TD CLASS="l">174</TD><TD>     */</TD></TR><TR><TD CLASS="l">175</TD><TD>    private static String unqualify(String path) {</TD></TR><TR CLASS="z"><TD CLASS="l">176</TD><TD>        path = path.replace('\\', '/');</TD></TR><TR CLASS="z"><TD CLASS="l">177</TD><TD>        return path.substring(path.lastIndexOf('/') + 1);</TD></TR><TR><TD CLASS="l">178</TD><TD>    }</TD></TR><TR><TD CLASS="l">179</TD><TD> </TD></TR><TR><TD CLASS="l">180</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="5">181</A></TD><TD>     * Returns a file path corresponding to a potential SMAP input</TD></TR><TR><TD CLASS="l">182</TD><TD>     * for the given compilation input (JSP file).</TD></TR><TR><TD CLASS="l">183</TD><TD>     */</TD></TR><TR><TD CLASS="l">184</TD><TD>    private static String inputSmapPath(String path) {</TD></TR><TR CLASS="z"><TD CLASS="l">185</TD><TD>        return path.substring(0, path.lastIndexOf('.') + 1) + &#34;smap&#34;;</TD></TR><TR><TD CLASS="l">186</TD><TD>    }</TD></TR><TR><TD CLASS="l">187</TD><TD> </TD></TR><TR><TD CLASS="l">188</TD><TD>    //*********************************************************************</TD></TR><TR><TD CLASS="l">189</TD><TD>    // Installation logic (from Robert Field, JSR-045 spec lead)</TD></TR><TR><TD CLASS="l">190</TD><TD>    private static class SDEInstaller {</TD></TR><TR><TD CLASS="l">191</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">192</TD><TD>        private org.apache.juli.logging.Log log=</TD></TR><TR CLASS="z"><TD CLASS="l">193</TD><TD>            org.apache.juli.logging.LogFactory.getLog( SDEInstaller.class );</TD></TR><TR><TD CLASS="l">194</TD><TD> </TD></TR><TR><TD CLASS="l">195</TD><TD>        static final String nameSDE = &#34;SourceDebugExtension&#34;;</TD></TR><TR><TD CLASS="l">196</TD><TD> </TD></TR><TR><TD CLASS="l">197</TD><TD>        byte[] orig;</TD></TR><TR><TD CLASS="l">198</TD><TD>        byte[] sdeAttr;</TD></TR><TR><TD CLASS="l">199</TD><TD>        byte[] gen;</TD></TR><TR><TD CLASS="l">200</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">201</TD><TD>        int origPos = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">202</TD><TD>        int genPos = 0;</TD></TR><TR><TD CLASS="l"><A NAME="d">203</A></TD><TD> </TD></TR><TR><TD CLASS="l">204</TD><TD>        int sdeIndex;</TD></TR><TR><TD CLASS="l">205</TD><TD> </TD></TR><TR><TD CLASS="l">206</TD><TD>        public static void main(String[] args) throws IOException {</TD></TR><TR CLASS="z"><TD CLASS="l">207</TD><TD>            if (args.length == 2) {</TD></TR><TR CLASS="z"><TD CLASS="l">208</TD><TD>                install(new File(args[0]), new File(args[1]));</TD></TR><TR CLASS="z"><TD CLASS="l">209</TD><TD>            } else if (args.length == 3) {</TD></TR><TR CLASS="z"><TD CLASS="l">210</TD><TD>                install(</TD></TR><TR><TD CLASS="l">211</TD><TD>                    new File(args[0]),</TD></TR><TR><TD CLASS="l">212</TD><TD>                    new File(args[1]),</TD></TR><TR><TD CLASS="l">213</TD><TD>                    new File(args[2]));</TD></TR><TR><TD CLASS="l">214</TD><TD>            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">215</TD><TD>                System.err.println(</TD></TR><TR><TD CLASS="l">216</TD><TD>                    &#34;Usage: &lt;command&gt; &lt;input class file&gt; &#34;</TD></TR><TR><TD CLASS="l">217</TD><TD>                        + &#34;&lt;attribute file&gt; &lt;output class file name&gt;\n&#34;</TD></TR><TR><TD CLASS="l">218</TD><TD>                        + &#34;&lt;command&gt; &lt;input/output class file&gt; &lt;attribute file&gt;&#34;);</TD></TR><TR><TD CLASS="l">219</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="16">220</A></TD><TD>        }</TD></TR><TR><TD CLASS="l">221</TD><TD> </TD></TR><TR><TD CLASS="l">222</TD><TD>        static void install(File inClassFile, File attrFile, File outClassFile)</TD></TR><TR><TD CLASS="l">223</TD><TD>            throws IOException {</TD></TR><TR CLASS="z"><TD CLASS="l">224</TD><TD>            new SDEInstaller(inClassFile, attrFile, outClassFile);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="15">225</A></TD><TD>        }</TD></TR><TR><TD CLASS="l">226</TD><TD> </TD></TR><TR><TD CLASS="l">227</TD><TD>        static void install(File inOutClassFile, File attrFile)</TD></TR><TR><TD CLASS="l">228</TD><TD>            throws IOException {</TD></TR><TR CLASS="z"><TD CLASS="l">229</TD><TD>            File tmpFile = new File(inOutClassFile.getPath() + &#34;tmp&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">230</TD><TD>            new SDEInstaller(inOutClassFile, attrFile, tmpFile);</TD></TR><TR CLASS="z"><TD CLASS="l">231</TD><TD>            if (!inOutClassFile.delete()) {</TD></TR><TR CLASS="z"><TD CLASS="l">232</TD><TD>                throw new IOException(&#34;inOutClassFile.delete() failed&#34;);</TD></TR><TR><TD CLASS="l">233</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">234</TD><TD>            if (!tmpFile.renameTo(inOutClassFile)) {</TD></TR><TR CLASS="z"><TD CLASS="l">235</TD><TD>                throw new IOException(&#34;tmpFile.renameTo(inOutClassFile) failed&#34;);</TD></TR><TR><TD CLASS="l"><A NAME="17">236</A></TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">237</TD><TD>        }</TD></TR><TR><TD CLASS="l">238</TD><TD> </TD></TR><TR><TD CLASS="l">239</TD><TD>        static void install(File classFile, byte[] smap) throws IOException {</TD></TR><TR CLASS="z"><TD CLASS="l">240</TD><TD>            File tmpFile = new File(classFile.getPath() + &#34;tmp&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">241</TD><TD>            new SDEInstaller(classFile, smap, tmpFile);</TD></TR><TR CLASS="z"><TD CLASS="l">242</TD><TD>            if (!classFile.delete()) {</TD></TR><TR CLASS="z"><TD CLASS="l">243</TD><TD>                throw new IOException(&#34;classFile.delete() failed&#34;);</TD></TR><TR><TD CLASS="l">244</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">245</TD><TD>            if (!tmpFile.renameTo(classFile)) {</TD></TR><TR CLASS="z"><TD CLASS="l">246</TD><TD>                throw new IOException(&#34;tmpFile.renameTo(classFile) failed&#34;);</TD></TR><TR><TD CLASS="l"><A NAME="f">247</A></TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">248</TD><TD>        }</TD></TR><TR><TD CLASS="l">249</TD><TD> </TD></TR><TR><TD CLASS="l">250</TD><TD>        SDEInstaller(File inClassFile, byte[] sdeAttr, File outClassFile)</TD></TR><TR CLASS="z"><TD CLASS="l">251</TD><TD>            throws IOException {</TD></TR><TR CLASS="z"><TD CLASS="l">252</TD><TD>            if (!inClassFile.exists()) {</TD></TR><TR CLASS="z"><TD CLASS="l">253</TD><TD>                throw new FileNotFoundException(&#34;no such file: &#34; + inClassFile);</TD></TR><TR><TD CLASS="l">254</TD><TD>            }</TD></TR><TR><TD CLASS="l">255</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">256</TD><TD>            this.sdeAttr = sdeAttr;</TD></TR><TR><TD CLASS="l">257</TD><TD>            // get the bytes</TD></TR><TR CLASS="z"><TD CLASS="l">258</TD><TD>            orig = readWhole(inClassFile);</TD></TR><TR CLASS="z"><TD CLASS="l">259</TD><TD>            gen = new byte[orig.length + sdeAttr.length + 100];</TD></TR><TR><TD CLASS="l">260</TD><TD> </TD></TR><TR><TD CLASS="l">261</TD><TD>            // do it</TD></TR><TR CLASS="z"><TD CLASS="l">262</TD><TD>            addSDE();</TD></TR><TR><TD CLASS="l">263</TD><TD> </TD></TR><TR><TD CLASS="l">264</TD><TD>            // write result</TD></TR><TR CLASS="z"><TD CLASS="l">265</TD><TD>            FileOutputStream outStream = new FileOutputStream(outClassFile);</TD></TR><TR CLASS="z"><TD CLASS="l">266</TD><TD>            outStream.write(gen, 0, genPos);</TD></TR><TR CLASS="z"><TD CLASS="l">267</TD><TD>            outStream.close();</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="e">268</A></TD><TD>        }</TD></TR><TR><TD CLASS="l">269</TD><TD> </TD></TR><TR><TD CLASS="l">270</TD><TD>        SDEInstaller(File inClassFile, File attrFile, File outClassFile)</TD></TR><TR><TD CLASS="l">271</TD><TD>            throws IOException {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="1e">272</A></TD><TD>            this(inClassFile, readWhole(attrFile), outClassFile);</TD></TR><TR CLASS="z"><TD CLASS="l">273</TD><TD>        }</TD></TR><TR><TD CLASS="l">274</TD><TD> </TD></TR><TR><TD CLASS="l">275</TD><TD>        static byte[] readWhole(File input) throws IOException {</TD></TR><TR CLASS="z"><TD CLASS="l">276</TD><TD>            FileInputStream inStream = new FileInputStream(input);</TD></TR><TR CLASS="z"><TD CLASS="l">277</TD><TD>            int len = (int)input.length();</TD></TR><TR CLASS="z"><TD CLASS="l">278</TD><TD>            byte[] bytes = new byte[len];</TD></TR><TR CLASS="z"><TD CLASS="l">279</TD><TD>            if (inStream.read(bytes, 0, len) != len) {</TD></TR><TR CLASS="z"><TD CLASS="l">280</TD><TD>                throw new IOException(&#34;expected size: &#34; + len);</TD></TR><TR><TD CLASS="l">281</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">282</TD><TD>            inStream.close();</TD></TR><TR CLASS="z"><TD CLASS="l">283</TD><TD>            return bytes;</TD></TR><TR><TD CLASS="l"><A NAME="10">284</A></TD><TD>        }</TD></TR><TR><TD CLASS="l">285</TD><TD> </TD></TR><TR><TD CLASS="l">286</TD><TD>        void addSDE() throws UnsupportedEncodingException, IOException {</TD></TR><TR><TD CLASS="l">287</TD><TD>            int i;</TD></TR><TR CLASS="z"><TD CLASS="l">288</TD><TD>            copy(4 + 2 + 2); // magic min/maj version</TD></TR><TR CLASS="z"><TD CLASS="l">289</TD><TD>            int constantPoolCountPos = genPos;</TD></TR><TR CLASS="z"><TD CLASS="l">290</TD><TD>            int constantPoolCount = readU2();</TD></TR><TR CLASS="z"><TD CLASS="l">291</TD><TD>            if (log.isDebugEnabled())</TD></TR><TR CLASS="z"><TD CLASS="l">292</TD><TD>                log.debug(&#34;constant pool count: &#34; + constantPoolCount);</TD></TR><TR CLASS="z"><TD CLASS="l">293</TD><TD>            writeU2(constantPoolCount);</TD></TR><TR><TD CLASS="l">294</TD><TD> </TD></TR><TR><TD CLASS="l">295</TD><TD>            // copy old constant pool return index of SDE symbol, if found</TD></TR><TR CLASS="z"><TD CLASS="l">296</TD><TD>            sdeIndex = copyConstantPool(constantPoolCount);</TD></TR><TR CLASS="z"><TD CLASS="l">297</TD><TD>            if (sdeIndex &lt; 0) {</TD></TR><TR><TD CLASS="l">298</TD><TD>                // if &#34;SourceDebugExtension&#34; symbol not there add it</TD></TR><TR CLASS="z"><TD CLASS="l">299</TD><TD>                writeUtf8ForSDE();</TD></TR><TR><TD CLASS="l">300</TD><TD> </TD></TR><TR><TD CLASS="l">301</TD><TD>                // increment the countantPoolCount</TD></TR><TR CLASS="z"><TD CLASS="l">302</TD><TD>                sdeIndex = constantPoolCount;</TD></TR><TR CLASS="z"><TD CLASS="l">303</TD><TD>                ++constantPoolCount;</TD></TR><TR CLASS="z"><TD CLASS="l">304</TD><TD>                randomAccessWriteU2(constantPoolCountPos, constantPoolCount);</TD></TR><TR><TD CLASS="l">305</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">306</TD><TD>                if (log.isDebugEnabled())</TD></TR><TR CLASS="z"><TD CLASS="l">307</TD><TD>                    log.debug(&#34;SourceDebugExtension not found, installed at: &#34; + sdeIndex);</TD></TR><TR><TD CLASS="l">308</TD><TD>            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">309</TD><TD>                if (log.isDebugEnabled())</TD></TR><TR CLASS="z"><TD CLASS="l">310</TD><TD>                    log.debug(&#34;SourceDebugExtension found at: &#34; + sdeIndex);</TD></TR><TR><TD CLASS="l">311</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">312</TD><TD>            copy(2 + 2 + 2); // access, this, super</TD></TR><TR CLASS="z"><TD CLASS="l">313</TD><TD>            int interfaceCount = readU2();</TD></TR><TR CLASS="z"><TD CLASS="l">314</TD><TD>            writeU2(interfaceCount);</TD></TR><TR CLASS="z"><TD CLASS="l">315</TD><TD>            if (log.isDebugEnabled())</TD></TR><TR CLASS="z"><TD CLASS="l">316</TD><TD>                log.debug(&#34;interfaceCount: &#34; + interfaceCount);</TD></TR><TR CLASS="z"><TD CLASS="l">317</TD><TD>            copy(interfaceCount * 2);</TD></TR><TR CLASS="z"><TD CLASS="l">318</TD><TD>            copyMembers(); // fields</TD></TR><TR CLASS="z"><TD CLASS="l">319</TD><TD>            copyMembers(); // methods</TD></TR><TR CLASS="z"><TD CLASS="l">320</TD><TD>            int attrCountPos = genPos;</TD></TR><TR CLASS="z"><TD CLASS="l">321</TD><TD>            int attrCount = readU2();</TD></TR><TR CLASS="z"><TD CLASS="l">322</TD><TD>            writeU2(attrCount);</TD></TR><TR CLASS="z"><TD CLASS="l">323</TD><TD>            if (log.isDebugEnabled())</TD></TR><TR CLASS="z"><TD CLASS="l">324</TD><TD>                log.debug(&#34;class attrCount: &#34; + attrCount);</TD></TR><TR><TD CLASS="l">325</TD><TD>            // copy the class attributes, return true if SDE attr found (not copied)</TD></TR><TR CLASS="z"><TD CLASS="l">326</TD><TD>            if (!copyAttrs(attrCount)) {</TD></TR><TR><TD CLASS="l">327</TD><TD>                // we will be adding SDE and it isn't already counted</TD></TR><TR CLASS="z"><TD CLASS="l">328</TD><TD>                ++attrCount;</TD></TR><TR CLASS="z"><TD CLASS="l">329</TD><TD>                randomAccessWriteU2(attrCountPos, attrCount);</TD></TR><TR CLASS="z"><TD CLASS="l">330</TD><TD>                if (log.isDebugEnabled())</TD></TR><TR CLASS="z"><TD CLASS="l">331</TD><TD>                    log.debug(&#34;class attrCount incremented&#34;);</TD></TR><TR><TD CLASS="l">332</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="14">333</A></TD><TD>            writeAttrForSDE(sdeIndex);</TD></TR><TR CLASS="z"><TD CLASS="l">334</TD><TD>        }</TD></TR><TR><TD CLASS="l">335</TD><TD> </TD></TR><TR><TD CLASS="l">336</TD><TD>        void copyMembers() {</TD></TR><TR CLASS="z"><TD CLASS="l">337</TD><TD>            int count = readU2();</TD></TR><TR CLASS="z"><TD CLASS="l">338</TD><TD>            writeU2(count);</TD></TR><TR CLASS="z"><TD CLASS="l">339</TD><TD>            if (log.isDebugEnabled())</TD></TR><TR CLASS="z"><TD CLASS="l">340</TD><TD>                log.debug(&#34;members count: &#34; + count);</TD></TR><TR CLASS="z"><TD CLASS="l">341</TD><TD>            for (int i = 0; i &lt; count; ++i) {</TD></TR><TR CLASS="z"><TD CLASS="l">342</TD><TD>                copy(6); // access, name, descriptor</TD></TR><TR CLASS="z"><TD CLASS="l">343</TD><TD>                int attrCount = readU2();</TD></TR><TR CLASS="z"><TD CLASS="l">344</TD><TD>                writeU2(attrCount);</TD></TR><TR CLASS="z"><TD CLASS="l">345</TD><TD>                if (log.isDebugEnabled())</TD></TR><TR CLASS="z"><TD CLASS="l">346</TD><TD>                    log.debug(&#34;member attr count: &#34; + attrCount);</TD></TR><TR CLASS="z"><TD CLASS="l">347</TD><TD>                copyAttrs(attrCount);</TD></TR><TR><TD CLASS="l"><A NAME="12">348</A></TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">349</TD><TD>        }</TD></TR><TR><TD CLASS="l">350</TD><TD> </TD></TR><TR><TD CLASS="l">351</TD><TD>        boolean copyAttrs(int attrCount) {</TD></TR><TR CLASS="z"><TD CLASS="l">352</TD><TD>            boolean sdeFound = false;</TD></TR><TR CLASS="z"><TD CLASS="l">353</TD><TD>            for (int i = 0; i &lt; attrCount; ++i) {</TD></TR><TR CLASS="z"><TD CLASS="l">354</TD><TD>                int nameIndex = readU2();</TD></TR><TR><TD CLASS="l">355</TD><TD>                // don't write old SDE</TD></TR><TR CLASS="z"><TD CLASS="l">356</TD><TD>                if (nameIndex == sdeIndex) {</TD></TR><TR CLASS="z"><TD CLASS="l">357</TD><TD>                    sdeFound = true;</TD></TR><TR CLASS="z"><TD CLASS="l">358</TD><TD>                    if (log.isDebugEnabled())</TD></TR><TR CLASS="z"><TD CLASS="l">359</TD><TD>                        log.debug(&#34;SDE attr found&#34;);</TD></TR><TR><TD CLASS="l">360</TD><TD>                } else {</TD></TR><TR CLASS="z"><TD CLASS="l">361</TD><TD>                    writeU2(nameIndex); // name</TD></TR><TR CLASS="z"><TD CLASS="l">362</TD><TD>                    int len = readU4();</TD></TR><TR CLASS="z"><TD CLASS="l">363</TD><TD>                    writeU4(len);</TD></TR><TR CLASS="z"><TD CLASS="l">364</TD><TD>                    copy(len);</TD></TR><TR CLASS="z"><TD CLASS="l">365</TD><TD>                    if (log.isDebugEnabled())</TD></TR><TR CLASS="z"><TD CLASS="l">366</TD><TD>                        log.debug(&#34;attr len: &#34; + len);</TD></TR><TR><TD CLASS="l">367</TD><TD>                }</TD></TR><TR><TD CLASS="l">368</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="1f">369</A></TD><TD>            return sdeFound;</TD></TR><TR><TD CLASS="l">370</TD><TD>        }</TD></TR><TR><TD CLASS="l">371</TD><TD> </TD></TR><TR><TD CLASS="l">372</TD><TD>        void writeAttrForSDE(int index) {</TD></TR><TR CLASS="z"><TD CLASS="l">373</TD><TD>            writeU2(index);</TD></TR><TR CLASS="z"><TD CLASS="l">374</TD><TD>            writeU4(sdeAttr.length);</TD></TR><TR CLASS="z"><TD CLASS="l">375</TD><TD>            for (int i = 0; i &lt; sdeAttr.length; ++i) {</TD></TR><TR CLASS="z"><TD CLASS="l">376</TD><TD>                writeU1(sdeAttr[i]);</TD></TR><TR><TD CLASS="l"><A NAME="19">377</A></TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">378</TD><TD>        }</TD></TR><TR><TD CLASS="l">379</TD><TD> </TD></TR><TR><TD CLASS="l">380</TD><TD>        void randomAccessWriteU2(int pos, int val) {</TD></TR><TR CLASS="z"><TD CLASS="l">381</TD><TD>            int savePos = genPos;</TD></TR><TR CLASS="z"><TD CLASS="l">382</TD><TD>            genPos = pos;</TD></TR><TR CLASS="z"><TD CLASS="l">383</TD><TD>            writeU2(val);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="1b">384</A></TD><TD>            genPos = savePos;</TD></TR><TR CLASS="z"><TD CLASS="l">385</TD><TD>        }</TD></TR><TR><TD CLASS="l">386</TD><TD> </TD></TR><TR><TD CLASS="l">387</TD><TD>        int readU1() {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="1c">388</A></TD><TD>            return ((int)orig[origPos++]) &amp; 0xFF;</TD></TR><TR><TD CLASS="l">389</TD><TD>        }</TD></TR><TR><TD CLASS="l">390</TD><TD> </TD></TR><TR><TD CLASS="l">391</TD><TD>        int readU2() {</TD></TR><TR CLASS="z"><TD CLASS="l">392</TD><TD>            int res = readU1();</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="1d">393</A></TD><TD>            return (res &lt;&lt; 8) + readU1();</TD></TR><TR><TD CLASS="l">394</TD><TD>        }</TD></TR><TR><TD CLASS="l">395</TD><TD> </TD></TR><TR><TD CLASS="l">396</TD><TD>        int readU4() {</TD></TR><TR CLASS="z"><TD CLASS="l">397</TD><TD>            int res = readU2();</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="21">398</A></TD><TD>            return (res &lt;&lt; 16) + readU2();</TD></TR><TR><TD CLASS="l">399</TD><TD>        }</TD></TR><TR><TD CLASS="l">400</TD><TD> </TD></TR><TR><TD CLASS="l">401</TD><TD>        void writeU1(int val) {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="22">402</A></TD><TD>            gen[genPos++] = (byte)val;</TD></TR><TR CLASS="z"><TD CLASS="l">403</TD><TD>        }</TD></TR><TR><TD CLASS="l">404</TD><TD> </TD></TR><TR><TD CLASS="l">405</TD><TD>        void writeU2(int val) {</TD></TR><TR CLASS="z"><TD CLASS="l">406</TD><TD>            writeU1(val &gt;&gt; 8);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="23">407</A></TD><TD>            writeU1(val &amp; 0xFF);</TD></TR><TR CLASS="z"><TD CLASS="l">408</TD><TD>        }</TD></TR><TR><TD CLASS="l">409</TD><TD> </TD></TR><TR><TD CLASS="l">410</TD><TD>        void writeU4(int val) {</TD></TR><TR CLASS="z"><TD CLASS="l">411</TD><TD>            writeU2(val &gt;&gt; 16);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="11">412</A></TD><TD>            writeU2(val &amp; 0xFFFF);</TD></TR><TR CLASS="z"><TD CLASS="l">413</TD><TD>        }</TD></TR><TR><TD CLASS="l">414</TD><TD> </TD></TR><TR><TD CLASS="l">415</TD><TD>        void copy(int count) {</TD></TR><TR CLASS="z"><TD CLASS="l">416</TD><TD>            for (int i = 0; i &lt; count; ++i) {</TD></TR><TR CLASS="z"><TD CLASS="l">417</TD><TD>                gen[genPos++] = orig[origPos++];</TD></TR><TR><TD CLASS="l"><A NAME="1a">418</A></TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">419</TD><TD>        }</TD></TR><TR><TD CLASS="l">420</TD><TD> </TD></TR><TR><TD CLASS="l">421</TD><TD>        byte[] readBytes(int count) {</TD></TR><TR CLASS="z"><TD CLASS="l">422</TD><TD>            byte[] bytes = new byte[count];</TD></TR><TR CLASS="z"><TD CLASS="l">423</TD><TD>            for (int i = 0; i &lt; count; ++i) {</TD></TR><TR CLASS="z"><TD CLASS="l">424</TD><TD>                bytes[i] = orig[origPos++];</TD></TR><TR><TD CLASS="l">425</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="20">426</A></TD><TD>            return bytes;</TD></TR><TR><TD CLASS="l">427</TD><TD>        }</TD></TR><TR><TD CLASS="l">428</TD><TD> </TD></TR><TR><TD CLASS="l">429</TD><TD>        void writeBytes(byte[] bytes) {</TD></TR><TR CLASS="z"><TD CLASS="l">430</TD><TD>            for (int i = 0; i &lt; bytes.length; ++i) {</TD></TR><TR CLASS="z"><TD CLASS="l">431</TD><TD>                gen[genPos++] = bytes[i];</TD></TR><TR><TD CLASS="l">432</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="13">433</A></TD><TD>        }</TD></TR><TR><TD CLASS="l">434</TD><TD> </TD></TR><TR><TD CLASS="l">435</TD><TD>        int copyConstantPool(int constantPoolCount)</TD></TR><TR><TD CLASS="l">436</TD><TD>            throws UnsupportedEncodingException, IOException {</TD></TR><TR CLASS="z"><TD CLASS="l">437</TD><TD>            int sdeIndex = -1;</TD></TR><TR><TD CLASS="l">438</TD><TD>            // copy const pool index zero not in class file</TD></TR><TR CLASS="z"><TD CLASS="l">439</TD><TD>            for (int i = 1; i &lt; constantPoolCount; ++i) {</TD></TR><TR CLASS="z"><TD CLASS="l">440</TD><TD>                int tag = readU1();</TD></TR><TR CLASS="z"><TD CLASS="l">441</TD><TD>                writeU1(tag);</TD></TR><TR CLASS="z"><TD CLASS="l">442</TD><TD>                switch (tag) {</TD></TR><TR><TD CLASS="l">443</TD><TD>                    case 7 :  // Class</TD></TR><TR><TD CLASS="l">444</TD><TD>                    case 8 :  // String</TD></TR><TR><TD CLASS="l">445</TD><TD>                    case 16 : // MethodType</TD></TR><TR CLASS="z"><TD CLASS="l">446</TD><TD>                        if (log.isDebugEnabled())</TD></TR><TR CLASS="z"><TD CLASS="l">447</TD><TD>                            log.debug(i + &#34; copying 2 bytes&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">448</TD><TD>                        copy(2);</TD></TR><TR CLASS="z"><TD CLASS="l">449</TD><TD>                        break;</TD></TR><TR><TD CLASS="l">450</TD><TD>                    case 15 : // MethodHandle</TD></TR><TR CLASS="z"><TD CLASS="l">451</TD><TD>                        if (log.isDebugEnabled())</TD></TR><TR CLASS="z"><TD CLASS="l">452</TD><TD>                            log.debug(i + &#34; copying 3 bytes&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">453</TD><TD>                        copy(3);</TD></TR><TR CLASS="z"><TD CLASS="l">454</TD><TD>                        break;</TD></TR><TR><TD CLASS="l">455</TD><TD>                    case 9 :  // Field</TD></TR><TR><TD CLASS="l">456</TD><TD>                    case 10 : // Method</TD></TR><TR><TD CLASS="l">457</TD><TD>                    case 11 : // InterfaceMethod</TD></TR><TR><TD CLASS="l">458</TD><TD>                    case 3 :  // Integer</TD></TR><TR><TD CLASS="l">459</TD><TD>                    case 4 :  // Float</TD></TR><TR><TD CLASS="l">460</TD><TD>                    case 12 : // NameAndType</TD></TR><TR><TD CLASS="l">461</TD><TD>                    case 18 : // InvokeDynamic</TD></TR><TR CLASS="z"><TD CLASS="l">462</TD><TD>                        if (log.isDebugEnabled())</TD></TR><TR CLASS="z"><TD CLASS="l">463</TD><TD>                            log.debug(i + &#34; copying 4 bytes&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">464</TD><TD>                        copy(4);</TD></TR><TR CLASS="z"><TD CLASS="l">465</TD><TD>                        break;</TD></TR><TR><TD CLASS="l">466</TD><TD>                    case 5 : // Long</TD></TR><TR><TD CLASS="l">467</TD><TD>                    case 6 : // Double</TD></TR><TR CLASS="z"><TD CLASS="l">468</TD><TD>                        if (log.isDebugEnabled())</TD></TR><TR CLASS="z"><TD CLASS="l">469</TD><TD>                            log.debug(i + &#34; copying 8 bytes&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">470</TD><TD>                        copy(8);</TD></TR><TR CLASS="z"><TD CLASS="l">471</TD><TD>                        i++;</TD></TR><TR CLASS="z"><TD CLASS="l">472</TD><TD>                        break;</TD></TR><TR><TD CLASS="l">473</TD><TD>                    case 1 : // Utf8</TD></TR><TR CLASS="z"><TD CLASS="l">474</TD><TD>                        int len = readU2();</TD></TR><TR CLASS="z"><TD CLASS="l">475</TD><TD>                        writeU2(len);</TD></TR><TR CLASS="z"><TD CLASS="l">476</TD><TD>                        byte[] utf8 = readBytes(len);</TD></TR><TR CLASS="z"><TD CLASS="l">477</TD><TD>                        String str = new String(utf8, &#34;UTF-8&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">478</TD><TD>                        if (log.isDebugEnabled())</TD></TR><TR CLASS="z"><TD CLASS="l">479</TD><TD>                            log.debug(i + &#34; read class attr -- '&#34; + str + &#34;'&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">480</TD><TD>                        if (str.equals(nameSDE)) {</TD></TR><TR CLASS="z"><TD CLASS="l">481</TD><TD>                            sdeIndex = i;</TD></TR><TR><TD CLASS="l">482</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">483</TD><TD>                        writeBytes(utf8);</TD></TR><TR CLASS="z"><TD CLASS="l">484</TD><TD>                        break;</TD></TR><TR><TD CLASS="l">485</TD><TD>                    default :</TD></TR><TR CLASS="z"><TD CLASS="l">486</TD><TD>                        throw new IOException(&#34;unexpected tag: &#34; + tag);</TD></TR><TR><TD CLASS="l">487</TD><TD>                }</TD></TR><TR><TD CLASS="l">488</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="24">489</A></TD><TD>            return sdeIndex;</TD></TR><TR><TD CLASS="l">490</TD><TD>        }</TD></TR><TR><TD CLASS="l">491</TD><TD> </TD></TR><TR><TD CLASS="l">492</TD><TD>        void writeUtf8ForSDE() {</TD></TR><TR CLASS="z"><TD CLASS="l">493</TD><TD>            int len = nameSDE.length();</TD></TR><TR CLASS="z"><TD CLASS="l">494</TD><TD>            writeU1(1); // Utf8 tag</TD></TR><TR CLASS="z"><TD CLASS="l">495</TD><TD>            writeU2(len);</TD></TR><TR CLASS="z"><TD CLASS="l">496</TD><TD>            for (int i = 0; i &lt; len; ++i) {</TD></TR><TR CLASS="z"><TD CLASS="l">497</TD><TD>                writeU1(nameSDE.charAt(i));</TD></TR><TR><TD CLASS="l">498</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">499</TD><TD>        }</TD></TR><TR><TD CLASS="l">500</TD><TD>    }</TD></TR><TR><TD CLASS="l">501</TD><TD> </TD></TR><TR><TD CLASS="l">502</TD><TD>    public static void evaluateNodes(</TD></TR><TR><TD CLASS="l">503</TD><TD>        Node.Nodes nodes,</TD></TR><TR><TD CLASS="l"><A NAME="3">504</A></TD><TD>        SmapStratum s,</TD></TR><TR><TD CLASS="l">505</TD><TD>        HashMap innerClassMap,</TD></TR><TR><TD CLASS="l">506</TD><TD>        boolean breakAtLF) {</TD></TR><TR><TD CLASS="l">507</TD><TD>        try {</TD></TR><TR CLASS="z"><TD CLASS="l">508</TD><TD>            nodes.visit(new SmapGenVisitor(s, breakAtLF, innerClassMap));</TD></TR><TR CLASS="z"><TD CLASS="l">509</TD><TD>        } catch (JasperException ex) {</TD></TR><TR CLASS="z"><TD CLASS="l">510</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">511</TD><TD>    }</TD></TR><TR><TD CLASS="l">512</TD><TD> </TD></TR><TR><TD CLASS="l">513</TD><TD>    static class SmapGenVisitor extends Node.Visitor {</TD></TR><TR><TD CLASS="l">514</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="25">515</A></TD><TD>        private SmapStratum smap;</TD></TR><TR><TD CLASS="l">516</TD><TD>        private boolean breakAtLF;</TD></TR><TR><TD CLASS="l">517</TD><TD>        private HashMap innerClassMap;</TD></TR><TR><TD CLASS="l">518</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">519</TD><TD>        SmapGenVisitor(SmapStratum s, boolean breakAtLF, HashMap map) {</TD></TR><TR CLASS="z"><TD CLASS="l">520</TD><TD>            this.smap = s;</TD></TR><TR CLASS="z"><TD CLASS="l">521</TD><TD>            this.breakAtLF = breakAtLF;</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="3d">522</A></TD><TD>            this.innerClassMap = map;</TD></TR><TR CLASS="z"><TD CLASS="l">523</TD><TD>        }</TD></TR><TR><TD CLASS="l">524</TD><TD> </TD></TR><TR><TD CLASS="l">525</TD><TD>        public void visitBody(Node n) throws JasperException {</TD></TR><TR CLASS="z"><TD CLASS="l">526</TD><TD>            SmapStratum smapSave = smap;</TD></TR><TR CLASS="z"><TD CLASS="l">527</TD><TD>            String innerClass = n.getInnerClassName();</TD></TR><TR CLASS="z"><TD CLASS="l">528</TD><TD>            if (innerClass != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">529</TD><TD>                this.smap = (SmapStratum) innerClassMap.get(innerClass);</TD></TR><TR><TD CLASS="l">530</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">531</TD><TD>            super.visitBody(n);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="2b">532</A></TD><TD>            smap = smapSave;</TD></TR><TR CLASS="z"><TD CLASS="l">533</TD><TD>        }</TD></TR><TR><TD CLASS="l">534</TD><TD> </TD></TR><TR><TD CLASS="l">535</TD><TD>        public void visit(Node.Declaration n) throws JasperException {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="2e">536</A></TD><TD>            doSmapText(n);</TD></TR><TR CLASS="z"><TD CLASS="l">537</TD><TD>        }</TD></TR><TR><TD CLASS="l">538</TD><TD> </TD></TR><TR><TD CLASS="l">539</TD><TD>        public void visit(Node.Expression n) throws JasperException {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="38">540</A></TD><TD>            doSmapText(n);</TD></TR><TR CLASS="z"><TD CLASS="l">541</TD><TD>        }</TD></TR><TR><TD CLASS="l">542</TD><TD> </TD></TR><TR><TD CLASS="l">543</TD><TD>        public void visit(Node.Scriptlet n) throws JasperException {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="31">544</A></TD><TD>            doSmapText(n);</TD></TR><TR CLASS="z"><TD CLASS="l">545</TD><TD>        }</TD></TR><TR><TD CLASS="l">546</TD><TD> </TD></TR><TR><TD CLASS="l">547</TD><TD>        public void visit(Node.IncludeAction n) throws JasperException {</TD></TR><TR CLASS="z"><TD CLASS="l">548</TD><TD>            doSmap(n);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="2f">549</A></TD><TD>            visitBody(n);</TD></TR><TR CLASS="z"><TD CLASS="l">550</TD><TD>        }</TD></TR><TR><TD CLASS="l">551</TD><TD> </TD></TR><TR><TD CLASS="l">552</TD><TD>        public void visit(Node.ForwardAction n) throws JasperException {</TD></TR><TR CLASS="z"><TD CLASS="l">553</TD><TD>            doSmap(n);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="30">554</A></TD><TD>            visitBody(n);</TD></TR><TR CLASS="z"><TD CLASS="l">555</TD><TD>        }</TD></TR><TR><TD CLASS="l">556</TD><TD> </TD></TR><TR><TD CLASS="l">557</TD><TD>        public void visit(Node.GetProperty n) throws JasperException {</TD></TR><TR CLASS="z"><TD CLASS="l">558</TD><TD>            doSmap(n);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="39">559</A></TD><TD>            visitBody(n);</TD></TR><TR CLASS="z"><TD CLASS="l">560</TD><TD>        }</TD></TR><TR><TD CLASS="l">561</TD><TD> </TD></TR><TR><TD CLASS="l">562</TD><TD>        public void visit(Node.SetProperty n) throws JasperException {</TD></TR><TR CLASS="z"><TD CLASS="l">563</TD><TD>            doSmap(n);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="3c">564</A></TD><TD>            visitBody(n);</TD></TR><TR CLASS="z"><TD CLASS="l">565</TD><TD>        }</TD></TR><TR><TD CLASS="l">566</TD><TD> </TD></TR><TR><TD CLASS="l">567</TD><TD>        public void visit(Node.UseBean n) throws JasperException {</TD></TR><TR CLASS="z"><TD CLASS="l">568</TD><TD>            doSmap(n);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="37">569</A></TD><TD>            visitBody(n);</TD></TR><TR CLASS="z"><TD CLASS="l">570</TD><TD>        }</TD></TR><TR><TD CLASS="l">571</TD><TD> </TD></TR><TR><TD CLASS="l">572</TD><TD>        public void visit(Node.PlugIn n) throws JasperException {</TD></TR><TR CLASS="z"><TD CLASS="l">573</TD><TD>            doSmap(n);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="2a">574</A></TD><TD>            visitBody(n);</TD></TR><TR CLASS="z"><TD CLASS="l">575</TD><TD>        }</TD></TR><TR><TD CLASS="l">576</TD><TD> </TD></TR><TR><TD CLASS="l">577</TD><TD>        public void visit(Node.CustomTag n) throws JasperException {</TD></TR><TR CLASS="z"><TD CLASS="l">578</TD><TD>            doSmap(n);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="3b">579</A></TD><TD>            visitBody(n);</TD></TR><TR CLASS="z"><TD CLASS="l">580</TD><TD>        }</TD></TR><TR><TD CLASS="l">581</TD><TD> </TD></TR><TR><TD CLASS="l">582</TD><TD>        public void visit(Node.UninterpretedTag n) throws JasperException {</TD></TR><TR CLASS="z"><TD CLASS="l">583</TD><TD>            doSmap(n);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="34">584</A></TD><TD>            visitBody(n);</TD></TR><TR CLASS="z"><TD CLASS="l">585</TD><TD>        }</TD></TR><TR><TD CLASS="l">586</TD><TD> </TD></TR><TR><TD CLASS="l">587</TD><TD>        public void visit(Node.JspElement n) throws JasperException {</TD></TR><TR CLASS="z"><TD CLASS="l">588</TD><TD>            doSmap(n);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="35">589</A></TD><TD>            visitBody(n);</TD></TR><TR CLASS="z"><TD CLASS="l">590</TD><TD>        }</TD></TR><TR><TD CLASS="l">591</TD><TD> </TD></TR><TR><TD CLASS="l">592</TD><TD>        public void visit(Node.JspText n) throws JasperException {</TD></TR><TR CLASS="z"><TD CLASS="l">593</TD><TD>            doSmap(n);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="36">594</A></TD><TD>            visitBody(n);</TD></TR><TR CLASS="z"><TD CLASS="l">595</TD><TD>        }</TD></TR><TR><TD CLASS="l">596</TD><TD> </TD></TR><TR><TD CLASS="l">597</TD><TD>        public void visit(Node.NamedAttribute n) throws JasperException {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="33">598</A></TD><TD>            visitBody(n);</TD></TR><TR CLASS="z"><TD CLASS="l">599</TD><TD>        }</TD></TR><TR><TD CLASS="l">600</TD><TD> </TD></TR><TR><TD CLASS="l">601</TD><TD>        public void visit(Node.JspBody n) throws JasperException {</TD></TR><TR CLASS="z"><TD CLASS="l">602</TD><TD>            doSmap(n);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="32">603</A></TD><TD>            visitBody(n);</TD></TR><TR CLASS="z"><TD CLASS="l">604</TD><TD>        }</TD></TR><TR><TD CLASS="l">605</TD><TD> </TD></TR><TR><TD CLASS="l">606</TD><TD>        public void visit(Node.InvokeAction n) throws JasperException {</TD></TR><TR CLASS="z"><TD CLASS="l">607</TD><TD>            doSmap(n);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="2c">608</A></TD><TD>            visitBody(n);</TD></TR><TR CLASS="z"><TD CLASS="l">609</TD><TD>        }</TD></TR><TR><TD CLASS="l">610</TD><TD> </TD></TR><TR><TD CLASS="l">611</TD><TD>        public void visit(Node.DoBodyAction n) throws JasperException {</TD></TR><TR CLASS="z"><TD CLASS="l">612</TD><TD>            doSmap(n);</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="2d">613</A></TD><TD>            visitBody(n);</TD></TR><TR CLASS="z"><TD CLASS="l">614</TD><TD>        }</TD></TR><TR><TD CLASS="l">615</TD><TD> </TD></TR><TR><TD CLASS="l">616</TD><TD>        public void visit(Node.ELExpression n) throws JasperException {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="3a">617</A></TD><TD>            doSmap(n);</TD></TR><TR CLASS="z"><TD CLASS="l">618</TD><TD>        }</TD></TR><TR><TD CLASS="l">619</TD><TD> </TD></TR><TR><TD CLASS="l">620</TD><TD>        public void visit(Node.TemplateText n) throws JasperException {</TD></TR><TR CLASS="z"><TD CLASS="l">621</TD><TD>            Mark mark = n.getStart();</TD></TR><TR CLASS="z"><TD CLASS="l">622</TD><TD>            if (mark == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">623</TD><TD>                return;</TD></TR><TR><TD CLASS="l">624</TD><TD>            }</TD></TR><TR><TD CLASS="l">625</TD><TD> </TD></TR><TR><TD CLASS="l">626</TD><TD>            //Add the file information</TD></TR><TR CLASS="z"><TD CLASS="l">627</TD><TD>            String fileName = mark.getFile();</TD></TR><TR CLASS="z"><TD CLASS="l">628</TD><TD>            smap.addFile(unqualify(fileName), fileName);</TD></TR><TR><TD CLASS="l">629</TD><TD> </TD></TR><TR><TD CLASS="l">630</TD><TD>            //Add a LineInfo that corresponds to the beginning of this node</TD></TR><TR CLASS="z"><TD CLASS="l">631</TD><TD>            int iInputStartLine = mark.getLineNumber();</TD></TR><TR CLASS="z"><TD CLASS="l">632</TD><TD>            int iOutputStartLine = n.getBeginJavaLine();</TD></TR><TR CLASS="z"><TD CLASS="l">633</TD><TD>            int iOutputLineIncrement = breakAtLF? 1: 0;</TD></TR><TR CLASS="z"><TD CLASS="l">634</TD><TD>            smap.addLineData(iInputStartLine, fileName, 1, iOutputStartLine, </TD></TR><TR><TD CLASS="l">635</TD><TD>                             iOutputLineIncrement);</TD></TR><TR><TD CLASS="l">636</TD><TD> </TD></TR><TR><TD CLASS="l">637</TD><TD>            // Output additional mappings in the text</TD></TR><TR CLASS="z"><TD CLASS="l">638</TD><TD>            java.util.ArrayList extraSmap = n.getExtraSmap();</TD></TR><TR><TD CLASS="l">639</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">640</TD><TD>            if (extraSmap != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">641</TD><TD>                for (int i = 0; i &lt; extraSmap.size(); i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">642</TD><TD>                    iOutputStartLine += iOutputLineIncrement;</TD></TR><TR CLASS="z"><TD CLASS="l">643</TD><TD>                    smap.addLineData(</TD></TR><TR CLASS="z"><TD CLASS="l">644</TD><TD>                        iInputStartLine+((Integer)extraSmap.get(i)).intValue(),</TD></TR><TR><TD CLASS="l">645</TD><TD>                        fileName,</TD></TR><TR><TD CLASS="l">646</TD><TD>                        1,</TD></TR><TR><TD CLASS="l">647</TD><TD>                        iOutputStartLine,</TD></TR><TR><TD CLASS="l">648</TD><TD>                        iOutputLineIncrement);</TD></TR><TR><TD CLASS="l">649</TD><TD>                }</TD></TR><TR><TD CLASS="l">650</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">651</TD><TD>        }</TD></TR><TR><TD CLASS="l">652</TD><TD> </TD></TR><TR><TD CLASS="l">653</TD><TD>        private void doSmap(</TD></TR><TR><TD CLASS="l"><A NAME="28">654</A></TD><TD>            Node n,</TD></TR><TR><TD CLASS="l">655</TD><TD>            int inLineCount,</TD></TR><TR><TD CLASS="l">656</TD><TD>            int outIncrement,</TD></TR><TR><TD CLASS="l">657</TD><TD>            int skippedLines) {</TD></TR><TR CLASS="z"><TD CLASS="l">658</TD><TD>            Mark mark = n.getStart();</TD></TR><TR CLASS="z"><TD CLASS="l">659</TD><TD>            if (mark == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">660</TD><TD>                return;</TD></TR><TR><TD CLASS="l">661</TD><TD>            }</TD></TR><TR><TD CLASS="l">662</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">663</TD><TD>            String unqualifiedName = unqualify(mark.getFile());</TD></TR><TR CLASS="z"><TD CLASS="l">664</TD><TD>            smap.addFile(unqualifiedName, mark.getFile());</TD></TR><TR CLASS="z"><TD CLASS="l">665</TD><TD>            smap.addLineData(</TD></TR><TR CLASS="z"><TD CLASS="l">666</TD><TD>                mark.getLineNumber() + skippedLines,</TD></TR><TR CLASS="z"><TD CLASS="l">667</TD><TD>                mark.getFile(),</TD></TR><TR><TD CLASS="l">668</TD><TD>                inLineCount - skippedLines,</TD></TR><TR CLASS="z"><TD CLASS="l">669</TD><TD>                n.getBeginJavaLine() + skippedLines,</TD></TR><TR><TD CLASS="l"><A NAME="27">670</A></TD><TD>                outIncrement);</TD></TR><TR CLASS="z"><TD CLASS="l">671</TD><TD>        }</TD></TR><TR><TD CLASS="l">672</TD><TD> </TD></TR><TR><TD CLASS="l">673</TD><TD>        private void doSmap(Node n) {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="29">674</A></TD><TD>            doSmap(n, 1, n.getEndJavaLine() - n.getBeginJavaLine(), 0);</TD></TR><TR CLASS="z"><TD CLASS="l">675</TD><TD>        }</TD></TR><TR><TD CLASS="l">676</TD><TD> </TD></TR><TR><TD CLASS="l">677</TD><TD>        private void doSmapText(Node n) {</TD></TR><TR CLASS="z"><TD CLASS="l">678</TD><TD>            String text = n.getText();</TD></TR><TR CLASS="z"><TD CLASS="l">679</TD><TD>            int index = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">680</TD><TD>            int next = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">681</TD><TD>            int lineCount = 1;</TD></TR><TR CLASS="z"><TD CLASS="l">682</TD><TD>            int skippedLines = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">683</TD><TD>            boolean slashStarSeen = false;</TD></TR><TR CLASS="z"><TD CLASS="l">684</TD><TD>            boolean beginning = true;</TD></TR><TR><TD CLASS="l">685</TD><TD> </TD></TR><TR><TD CLASS="l">686</TD><TD>            // Count lines inside text, but skipping comment lines at the</TD></TR><TR><TD CLASS="l">687</TD><TD>            // beginning of the text.</TD></TR><TR CLASS="z"><TD CLASS="l">688</TD><TD>            while ((next = text.indexOf('\n', index)) &gt; -1) {</TD></TR><TR CLASS="z"><TD CLASS="l">689</TD><TD>                if (beginning) {</TD></TR><TR CLASS="z"><TD CLASS="l">690</TD><TD>                    String line = text.substring(index, next).trim();</TD></TR><TR CLASS="z"><TD CLASS="l">691</TD><TD>                    if (!slashStarSeen &amp;&amp; line.startsWith(&#34;/*&#34;)) {</TD></TR><TR CLASS="z"><TD CLASS="l">692</TD><TD>                        slashStarSeen = true;</TD></TR><TR><TD CLASS="l">693</TD><TD>                    }</TD></TR><TR CLASS="z"><TD CLASS="l">694</TD><TD>                    if (slashStarSeen) {</TD></TR><TR CLASS="z"><TD CLASS="l">695</TD><TD>                        skippedLines++;</TD></TR><TR CLASS="z"><TD CLASS="l">696</TD><TD>                        int endIndex = line.indexOf(&#34;*/&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">697</TD><TD>                        if (endIndex &gt;= 0) {</TD></TR><TR><TD CLASS="l">698</TD><TD>                            // End of /* */ comment</TD></TR><TR CLASS="z"><TD CLASS="l">699</TD><TD>                            slashStarSeen = false;</TD></TR><TR CLASS="z"><TD CLASS="l">700</TD><TD>                            if (endIndex &lt; line.length() - 2) {</TD></TR><TR><TD CLASS="l">701</TD><TD>                                // Some executable code after comment</TD></TR><TR CLASS="z"><TD CLASS="l">702</TD><TD>                                skippedLines--;</TD></TR><TR CLASS="z"><TD CLASS="l">703</TD><TD>                                beginning = false;</TD></TR><TR><TD CLASS="l">704</TD><TD>                            }</TD></TR><TR><TD CLASS="l">705</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">706</TD><TD>                    } else if (line.length() == 0 || line.startsWith(&#34;//&#34;)) {</TD></TR><TR CLASS="z"><TD CLASS="l">707</TD><TD>                        skippedLines++;</TD></TR><TR><TD CLASS="l">708</TD><TD>                    } else {</TD></TR><TR CLASS="z"><TD CLASS="l">709</TD><TD>                        beginning = false;</TD></TR><TR><TD CLASS="l">710</TD><TD>                    }</TD></TR><TR><TD CLASS="l">711</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">712</TD><TD>                lineCount++;</TD></TR><TR CLASS="z"><TD CLASS="l">713</TD><TD>                index = next + 1;</TD></TR><TR><TD CLASS="l">714</TD><TD>            }</TD></TR><TR><TD CLASS="l">715</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="8">716</A></TD><TD>            doSmap(n, lineCount, 1, skippedLines);</TD></TR><TR CLASS="z"><TD CLASS="l">717</TD><TD>        }</TD></TR><TR><TD CLASS="l">718</TD><TD>    }</TD></TR><TR><TD CLASS="l">719</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">720</TD><TD>    private static class PreScanVisitor extends Node.Visitor {</TD></TR><TR><TD CLASS="l"><A NAME="b">721</A></TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">722</TD><TD>        HashMap map = new HashMap();</TD></TR><TR><TD CLASS="l">723</TD><TD> </TD></TR><TR><TD CLASS="l">724</TD><TD>        public void doVisit(Node n) {</TD></TR><TR CLASS="z"><TD CLASS="l">725</TD><TD>            String inner = n.getInnerClassName();</TD></TR><TR CLASS="z"><TD CLASS="l">726</TD><TD>            if (inner != null &amp;&amp; !map.containsKey(inner)) {</TD></TR><TR CLASS="z"><TD CLASS="l">727</TD><TD>                map.put(inner, new SmapStratum(&#34;JSP&#34;));</TD></TR><TR><TD CLASS="l"><A NAME="c">728</A></TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">729</TD><TD>        }</TD></TR><TR><TD CLASS="l">730</TD><TD> </TD></TR><TR><TD CLASS="l">731</TD><TD>        HashMap getMap() {</TD></TR><TR CLASS="z"><TD CLASS="l">732</TD><TD>            return map;</TD></TR><TR><TD CLASS="l">733</TD><TD>        }</TD></TR><TR><TD CLASS="l">734</TD><TD>    }</TD></TR><TR><TD CLASS="l">735</TD><TD>    </TD></TR><TR><TD CLASS="l">736</TD><TD>}</TD></TR></TABLE><P></P><TABLE WIDTH="100%" CLASS="hdft" CELLSPACING="0"><TR><TD CLASS="nv">[<A HREF="../index.html">all classes</A>][<A HREF="35.html">org.apache.jasper.compiler</A>]</TD></TR><TR><TD CLASS="tl"><A HREF="http://sourceforge.net/projects/emma">EMMA 2.1.5320 (stable)</A> (C) Vladimir Roubtsov</TD></TR></TABLE></BODY></HTML>