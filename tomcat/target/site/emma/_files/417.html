<HTML><HEAD><META CONTENT="text/html; charset=UTF-8" HTTP-EQUIV="Content-Type"/><TITLE>EMMA Coverage Report</TITLE><STYLE TYPE="text/css"> TABLE,TD,TH {border-style:solid; border-color:black;} TD,TH {background:white;margin:0;line-height:100%;padding-left:0.5em;padding-right:0.5em;} TD {border-width:0 1px 0 0;} TH {border-width:1px 1px 1px 0;} TR TD.h {color:red;} TABLE {border-spacing:0; border-collapse:collapse;border-width:0 0 1px 1px;} P,H1,H2,H3,TH {font-family:verdana,arial,sans-serif;font-size:10pt;} TD {font-family:courier,monospace;font-size:10pt;} TABLE.hdft {border-spacing:0;border-collapse:collapse;border-style:none;} TABLE.hdft TH,TABLE.hdft TD {border-style:none;line-height:normal;} TABLE.hdft TH.tl,TABLE.hdft TD.tl {background:#6699CC;color:white;} TABLE.hdft TD.nv {background:#6633DD;color:white;} .nv A:link {color:white;} .nv A:visited {color:white;} .nv A:active {color:yellow;} TABLE.hdft A:link {color:white;} TABLE.hdft A:visited {color:white;} TABLE.hdft A:active {color:yellow;} .in {color:#356085;} TABLE.s TD {padding-left:0.25em;padding-right:0.25em;} TABLE.s TD.l {padding-left:0.25em;padding-right:0.25em;text-align:right;background:#F0F0F0;} TABLE.s TR.z TD {background:#FF9999;} TABLE.s TR.p TD {background:#FFFF88;} TABLE.s TR.c TD {background:#CCFFCC;} A:link {color:#0000EE;text-decoration:none;} A:visited {color:#0000EE;text-decoration:none;} A:hover {color:#0000EE;text-decoration:underline;} TABLE.cn {border-width:0 0 1px 0;} TABLE.s {border-width:1px 0 1px 1px;} TD.h {color:red;border-width:0 1px 0 0;} TD.f {border-width:0 1px 0 1px;} TD.hf {color:red;border-width:0 1px 0 1px;} TH.f {border-width:1px 1px 1px 1px;} TR.cis TD {background:#F0F0F0;} TR.cis TD {border-width:1px 1px 1px 0;} TR.cis TD.h {color:red;border-width:1px 1px 1px 0;} TR.cis TD.f {border-width:1px 1px 1px 1px;} TR.cis TD.hf {color:red;border-width:1px 1px 1px 1px;} TD.b {border-style:none;background:transparent;line-height:50%;}  TD.bt {border-width:1px 0 0 0;background:transparent;line-height:50%;} TR.o TD {background:#F0F0F0;}TABLE.it {border-style:none;}TABLE.it TD,TABLE.it TH {border-style:none;}</STYLE></HEAD><BODY><TABLE WIDTH="100%" CLASS="hdft" CELLSPACING="0"><TR><TH CLASS="tl"><A HREF="http://emma.sourceforge.net/">EMMA</A> Coverage Report (generated Thu Nov 16 15:09:53 CET 2017)</TH></TR><TR><TD CLASS="nv">[<A HREF="../index.html">all classes</A>][<A HREF="64.html">org.apache.juli</A>]</TD></TR></TABLE><H2>COVERAGE SUMMARY FOR SOURCE FILE [<SPAN CLASS="in">ClassLoaderLogManager.java</SPAN>]</H2><TABLE WIDTH="100%" CELLSPACING="0"><TR><TH>name</TH><TH>class, %</TH><TH>method, %</TH><TH>block, %</TH><TH>line, %</TH></TR><TR><TD>ClassLoaderLogManager.java</TD><TD CLASS="h">88%  (7/8)</TD><TD>85%  (29/34)</TD><TD>83%  (901/1088)</TD><TD>83%  (242/293)</TD></TR></TABLE><H3>COVERAGE BREAKDOWN BY CLASS AND METHOD</H3><TABLE WIDTH="100%" CLASS="cn" CELLSPACING="0"><TR><TH CLASS="f">name</TH><TH>class, %</TH><TH>method, %</TH><TH>block, %</TH><TH>line, %</TH></TR><TR><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#0">ClassLoaderLogManager$1</A></TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/2)</TD><TD CLASS="h">0%   (0/21)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR><TD CLASS="f"><A HREF="#0">ClassLoaderLogManager$1 (ClassLoaderLogManager, Logger, String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/12)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2">run (): Object</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/9)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#3">ClassLoaderLogManager</A></TD><TD>100% (1/1)</TD><TD>83%  (15/18)</TD><TD>83%  (717/866)</TD><TD>82%  (191/234)</TD></TR><TR><TD CLASS="f"><A HREF="#4">isUseShutdownHook (): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#5">readConfiguration (InputStream): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/10)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR><TD CLASS="f"><A HREF="#6">setUseShutdownHook (boolean): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#7">readConfiguration (ClassLoader): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">53%  (88/167)</TD><TD CLASS="h">61%  (25/41)</TD></TR><TR><TD CLASS="f"><A HREF="#8">readConfiguration (InputStream, ClassLoader): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>82%  (102/125)</TD><TD CLASS="h">75%  (29,4/39)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#9">addLogger (Logger): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>91%  (164/181)</TD><TD>87%  (41/47)</TD></TR><TR><TD CLASS="f"><A HREF="#a">resetLoggers (ClassLoaderLogManager$ClassLoaderLogInfo): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>91%  (62/68)</TD><TD>90%  (12,5/14)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#b">findProperty (String): String</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>93%  (51/55)</TD><TD>94%  (15/16)</TD></TR><TR><TD CLASS="f"><A HREF="#c">getClassLoaderInfo (ClassLoader): ClassLoaderLogManager$ClassLoaderLogInfo</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>93%  (27/29)</TD><TD>88%  (7/8)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#3">ClassLoaderLogManager (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>96%  (24/25)</TD><TD>88%  (7/8)</TD></TR><TR><TD CLASS="f"><A HREF="#e">doSetParentLogger (Logger, Logger): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (8/8)</TD><TD>100% (2/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#f">getLogger (String): Logger</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (11/11)</TD><TD>100% (3/3)</TD></TR><TR><TD CLASS="f"><A HREF="#10">getLoggerNames (): Enumeration</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (10/10)</TD><TD>100% (3/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#11">getProperty (String): String</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (34/34)</TD><TD>100% (9/9)</TD></TR><TR><TD CLASS="f"><A HREF="#12">readConfiguration (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (7/7)</TD><TD>100% (3/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#13">replace (String): String</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (90/90)</TD><TD>100% (22/22)</TD></TR><TR><TD CLASS="f"><A HREF="#14">reset (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (22/22)</TD><TD>100% (8/8)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#15">shutdown (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (17/17)</TD><TD>100% (4/4)</TD></TR><TR><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#16">ClassLoaderLogManager$LogNode</A></TD><TD>100% (1/1)</TD><TD>100% (5/5)</TD><TD>87%  (104/120)</TD><TD>87%  (33/38)</TD></TR><TR><TD CLASS="f"><A HREF="#17">setParentLogger (Logger): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">36%  (9/25)</TD><TD CLASS="h">38%  (3/8)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#18">ClassLoaderLogManager$LogNode (ClassLoaderLogManager$LogNode): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (5/5)</TD><TD>100% (2/2)</TD></TR><TR><TD CLASS="f"><A HREF="#16">ClassLoaderLogManager$LogNode (ClassLoaderLogManager$LogNode, Logger): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (14/14)</TD><TD>100% (5/5)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1a">findNode (String): ClassLoaderLogManager$LogNode</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (58/58)</TD><TD>100% (17/17)</TD></TR><TR><TD CLASS="f"><A HREF="#1b">findParentLogger (): Logger</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (18/18)</TD><TD>100% (6/6)</TD></TR><TR><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#1c">ClassLoaderLogManager$2</A></TD><TD>100% (1/1)</TD><TD>100% (2/2)</TD><TD>94%  (17/18)</TD><TD>80%  (4/5)</TD></TR><TR><TD CLASS="f"><A HREF="#1d">run (): Object</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>89%  (8/9)</TD><TD CLASS="h">75%  (3/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1c">ClassLoaderLogManager$2 (ClassLoaderLogManager, ClassLoader): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (9/9)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#e">ClassLoaderLogManager$3</A></TD><TD>100% (1/1)</TD><TD>100% (2/2)</TD><TD>100% (16/16)</TD><TD>100% (3/3)</TD></TR><TR><TD CLASS="f"><A HREF="#e">ClassLoaderLogManager$3 (Logger, Logger): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (9/9)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#21">run (): Object</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (7/7)</TD><TD>100% (2/2)</TD></TR><TR><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#22">ClassLoaderLogManager$ClassLoaderLogInfo</A></TD><TD>100% (1/1)</TD><TD>100% (1/1)</TD><TD>100% (21/21)</TD><TD>100% (6/6)</TD></TR><TR><TD CLASS="f"><A HREF="#22">ClassLoaderLogManager$ClassLoaderLogInfo (ClassLoaderLogManager$LogNode): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (21/21)</TD><TD>100% (6/6)</TD></TR><TR><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#24">ClassLoaderLogManager$Cleaner</A></TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (18/18)</TD><TD>100% (4/4)</TD></TR><TR><TD CLASS="f"><A HREF="#24">ClassLoaderLogManager$Cleaner (ClassLoaderLogManager): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (6/6)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#24">ClassLoaderLogManager$Cleaner (ClassLoaderLogManager, ClassLoaderLogManager$1...</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (4/4)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#27">run (): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (8/8)</TD><TD>100% (3/3)</TD></TR><TR><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#28">ClassLoaderLogManager$RootLogger</A></TD><TD>100% (1/1)</TD><TD>100% (1/1)</TD><TD>100% (8/8)</TD><TD>100% (3/3)</TD></TR><TR><TD CLASS="f"><A HREF="#28">ClassLoaderLogManager$RootLogger (ClassLoaderLogManager): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (8/8)</TD><TD>100% (3/3)</TD></TR></TABLE><P></P><TABLE WIDTH="100%" CLASS="s" CELLSPACING="0"><TR><TD CLASS="l">1</TD><TD>/*</TD></TR><TR><TD CLASS="l">2</TD><TD> * Licensed to the Apache Software Foundation (ASF) under one or more</TD></TR><TR><TD CLASS="l">3</TD><TD> * contributor license agreements.  See the NOTICE file distributed with</TD></TR><TR><TD CLASS="l">4</TD><TD> * this work for additional information regarding copyright ownership.</TD></TR><TR><TD CLASS="l">5</TD><TD> * The ASF licenses this file to You under the Apache License, Version 2.0</TD></TR><TR><TD CLASS="l">6</TD><TD> * (the &#34;License&#34;); you may not use this file except in compliance with</TD></TR><TR><TD CLASS="l">7</TD><TD> * the License.  You may obtain a copy of the License at</TD></TR><TR><TD CLASS="l">8</TD><TD> * </TD></TR><TR><TD CLASS="l">9</TD><TD> *      http://www.apache.org/licenses/LICENSE-2.0</TD></TR><TR><TD CLASS="l">10</TD><TD> * </TD></TR><TR><TD CLASS="l">11</TD><TD> * Unless required by applicable law or agreed to in writing, software</TD></TR><TR><TD CLASS="l">12</TD><TD> * distributed under the License is distributed on an &#34;AS IS&#34; BASIS,</TD></TR><TR><TD CLASS="l">13</TD><TD> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</TD></TR><TR><TD CLASS="l">14</TD><TD> * See the License for the specific language governing permissions and</TD></TR><TR><TD CLASS="l">15</TD><TD> * limitations under the License.</TD></TR><TR><TD CLASS="l">16</TD><TD> */</TD></TR><TR><TD CLASS="l">17</TD><TD> </TD></TR><TR><TD CLASS="l">18</TD><TD>package org.apache.juli;</TD></TR><TR><TD CLASS="l">19</TD><TD> </TD></TR><TR><TD CLASS="l">20</TD><TD>import java.io.File;</TD></TR><TR><TD CLASS="l">21</TD><TD>import java.io.FileInputStream;</TD></TR><TR><TD CLASS="l">22</TD><TD>import java.io.FilePermission;</TD></TR><TR><TD CLASS="l">23</TD><TD>import java.io.IOException;</TD></TR><TR><TD CLASS="l">24</TD><TD>import java.io.InputStream;</TD></TR><TR><TD CLASS="l">25</TD><TD>import java.net.URLClassLoader;</TD></TR><TR><TD CLASS="l">26</TD><TD>import java.security.AccessControlException;</TD></TR><TR><TD CLASS="l">27</TD><TD>import java.security.AccessController;</TD></TR><TR><TD CLASS="l">28</TD><TD>import java.security.Permission;</TD></TR><TR><TD CLASS="l">29</TD><TD>import java.security.PrivilegedAction;</TD></TR><TR><TD CLASS="l">30</TD><TD>import java.util.Collections;</TD></TR><TR><TD CLASS="l">31</TD><TD>import java.util.Enumeration;</TD></TR><TR><TD CLASS="l">32</TD><TD>import java.util.HashMap;</TD></TR><TR><TD CLASS="l">33</TD><TD>import java.util.Iterator;</TD></TR><TR><TD CLASS="l">34</TD><TD>import java.util.Map;</TD></TR><TR><TD CLASS="l">35</TD><TD>import java.util.Properties;</TD></TR><TR><TD CLASS="l">36</TD><TD>import java.util.StringTokenizer;</TD></TR><TR><TD CLASS="l">37</TD><TD>import java.util.WeakHashMap;</TD></TR><TR><TD CLASS="l">38</TD><TD>import java.util.concurrent.ConcurrentHashMap;</TD></TR><TR><TD CLASS="l">39</TD><TD>import java.util.logging.Handler;</TD></TR><TR><TD CLASS="l">40</TD><TD>import java.util.logging.Level;</TD></TR><TR><TD CLASS="l">41</TD><TD>import java.util.logging.LogManager;</TD></TR><TR><TD CLASS="l">42</TD><TD>import java.util.logging.Logger;</TD></TR><TR><TD CLASS="l">43</TD><TD> </TD></TR><TR><TD CLASS="l">44</TD><TD> </TD></TR><TR><TD CLASS="l">45</TD><TD>/**</TD></TR><TR><TD CLASS="l"><A NAME="24">46</A></TD><TD> * Per classloader LogManager implementation.</TD></TR><TR><TD CLASS="l">47</TD><TD> */</TD></TR><TR><TD CLASS="l">48</TD><TD>public class ClassLoaderLogManager extends LogManager {</TD></TR><TR><TD CLASS="l">49</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="27">50</A></TD><TD>    private final class Cleaner extends Thread {</TD></TR><TR><TD CLASS="l">51</TD><TD>        </TD></TR><TR><TD CLASS="l">52</TD><TD>        @Override</TD></TR><TR><TD CLASS="l">53</TD><TD>        public void run() {</TD></TR><TR CLASS="c"><TD CLASS="l">54</TD><TD>            if (useShutdownHook) {</TD></TR><TR CLASS="c"><TD CLASS="l">55</TD><TD>                shutdown();</TD></TR><TR><TD CLASS="l">56</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">57</TD><TD>        }</TD></TR><TR><TD CLASS="l">58</TD><TD> </TD></TR><TR><TD CLASS="l">59</TD><TD>    }</TD></TR><TR><TD CLASS="l">60</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="3">61</A></TD><TD>    </TD></TR><TR><TD CLASS="l">62</TD><TD>    // ------------------------------------------------------------Constructors</TD></TR><TR><TD CLASS="l">63</TD><TD> </TD></TR><TR><TD CLASS="l">64</TD><TD>    public ClassLoaderLogManager() {</TD></TR><TR CLASS="c"><TD CLASS="l">65</TD><TD>        super();</TD></TR><TR><TD CLASS="l">66</TD><TD>        try { </TD></TR><TR CLASS="c"><TD CLASS="l">67</TD><TD>            Runtime.getRuntime().addShutdownHook(new Cleaner());</TD></TR><TR CLASS="z"><TD CLASS="l">68</TD><TD>        } catch (IllegalStateException ise) {</TD></TR><TR><TD CLASS="l">69</TD><TD>            // We are probably already being shutdown. Ignore this error.</TD></TR><TR CLASS="c"><TD CLASS="l">70</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">71</TD><TD>    }</TD></TR><TR><TD CLASS="l">72</TD><TD> </TD></TR><TR><TD CLASS="l">73</TD><TD> </TD></TR><TR><TD CLASS="l">74</TD><TD>    // -------------------------------------------------------------- Variables</TD></TR><TR><TD CLASS="l">75</TD><TD> </TD></TR><TR><TD CLASS="l">76</TD><TD> </TD></TR><TR><TD CLASS="l">77</TD><TD>    /**</TD></TR><TR><TD CLASS="l">78</TD><TD>     * Map containing the classloader information, keyed per classloader. A</TD></TR><TR><TD CLASS="l">79</TD><TD>     * weak hashmap is used to ensure no classloader reference is leaked from </TD></TR><TR><TD CLASS="l">80</TD><TD>     * application redeployment.</TD></TR><TR><TD CLASS="l">81</TD><TD>     */</TD></TR><TR CLASS="c"><TD CLASS="l">82</TD><TD>    protected final Map&lt;ClassLoader, ClassLoaderLogInfo&gt; classLoaderLoggers = </TD></TR><TR><TD CLASS="l">83</TD><TD>        new WeakHashMap&lt;ClassLoader, ClassLoaderLogInfo&gt;();</TD></TR><TR><TD CLASS="l">84</TD><TD> </TD></TR><TR><TD CLASS="l">85</TD><TD>    </TD></TR><TR><TD CLASS="l">86</TD><TD>    /**</TD></TR><TR><TD CLASS="l">87</TD><TD>     * This prefix is used to allow using prefixes for the properties names</TD></TR><TR><TD CLASS="l">88</TD><TD>     * of handlers and their subcomponents.</TD></TR><TR><TD CLASS="l">89</TD><TD>     */</TD></TR><TR CLASS="c"><TD CLASS="l">90</TD><TD>    protected ThreadLocal&lt;String&gt; prefix = new ThreadLocal&lt;String&gt;();</TD></TR><TR><TD CLASS="l">91</TD><TD> </TD></TR><TR><TD CLASS="l">92</TD><TD> </TD></TR><TR><TD CLASS="l">93</TD><TD>    /**</TD></TR><TR><TD CLASS="l">94</TD><TD>     * Determines if the shutdown hook is used to perform any necessary</TD></TR><TR><TD CLASS="l">95</TD><TD>     * clean-up such as flushing buffered handlers on JVM shutdown. Defaults to</TD></TR><TR><TD CLASS="l">96</TD><TD>     * &lt;code&gt;true&lt;/code&gt; but may be set to false if another component ensures</TD></TR><TR><TD CLASS="l">97</TD><TD>     * that {@link #shutdown()} is called.</TD></TR><TR><TD CLASS="l">98</TD><TD>     */</TD></TR><TR CLASS="c"><TD CLASS="l">99</TD><TD>    protected volatile boolean useShutdownHook = true;</TD></TR><TR><TD CLASS="l">100</TD><TD> </TD></TR><TR><TD CLASS="l">101</TD><TD>    </TD></TR><TR><TD CLASS="l"><A NAME="4">102</A></TD><TD>    // ------------------------------------------------------------- Properties</TD></TR><TR><TD CLASS="l">103</TD><TD> </TD></TR><TR><TD CLASS="l">104</TD><TD> </TD></TR><TR><TD CLASS="l">105</TD><TD>    public boolean isUseShutdownHook() {</TD></TR><TR CLASS="z"><TD CLASS="l">106</TD><TD>        return useShutdownHook;</TD></TR><TR><TD CLASS="l"><A NAME="6">107</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">108</TD><TD> </TD></TR><TR><TD CLASS="l">109</TD><TD> </TD></TR><TR><TD CLASS="l">110</TD><TD>    public void setUseShutdownHook(boolean useShutdownHook) {</TD></TR><TR CLASS="z"><TD CLASS="l">111</TD><TD>        this.useShutdownHook = useShutdownHook;</TD></TR><TR CLASS="z"><TD CLASS="l">112</TD><TD>    }</TD></TR><TR><TD CLASS="l">113</TD><TD> </TD></TR><TR><TD CLASS="l">114</TD><TD> </TD></TR><TR><TD CLASS="l">115</TD><TD>    // --------------------------------------------------------- Public Methods</TD></TR><TR><TD CLASS="l">116</TD><TD> </TD></TR><TR><TD CLASS="l">117</TD><TD> </TD></TR><TR><TD CLASS="l">118</TD><TD>    /**</TD></TR><TR><TD CLASS="l">119</TD><TD>     * Add the specified logger to the classloader local configuration.</TD></TR><TR><TD CLASS="l">120</TD><TD>     * </TD></TR><TR><TD CLASS="l"><A NAME="9">121</A></TD><TD>     * @param logger The logger to be added</TD></TR><TR><TD CLASS="l">122</TD><TD>     */</TD></TR><TR><TD CLASS="l">123</TD><TD>    public synchronized boolean addLogger(final Logger logger) {</TD></TR><TR><TD CLASS="l">124</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">125</TD><TD>        final String loggerName = logger.getName();</TD></TR><TR><TD CLASS="l">126</TD><TD> </TD></TR><TR><TD CLASS="l">127</TD><TD>        ClassLoader classLoader = </TD></TR><TR CLASS="c"><TD CLASS="l">128</TD><TD>            Thread.currentThread().getContextClassLoader();</TD></TR><TR CLASS="c"><TD CLASS="l">129</TD><TD>        ClassLoaderLogInfo info = getClassLoaderInfo(classLoader);</TD></TR><TR CLASS="c"><TD CLASS="l">130</TD><TD>        if (info.loggers.containsKey(loggerName)) {</TD></TR><TR CLASS="c"><TD CLASS="l">131</TD><TD>            return false;</TD></TR><TR><TD CLASS="l">132</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">133</TD><TD>        info.loggers.put(loggerName, logger);</TD></TR><TR><TD CLASS="l">134</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="0">135</A></TD><TD>        // Apply initial level for new logger</TD></TR><TR CLASS="c"><TD CLASS="l">136</TD><TD>        final String levelString = getProperty(loggerName + &#34;.level&#34;);</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="2">137</A></TD><TD>        if (levelString != null) {</TD></TR><TR><TD CLASS="l">138</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">139</TD><TD>                AccessController.doPrivileged(new PrivilegedAction() {</TD></TR><TR><TD CLASS="l">140</TD><TD>                    public Object run() {</TD></TR><TR CLASS="z"><TD CLASS="l">141</TD><TD>                        logger.setLevel(Level.parse(levelString.trim()));</TD></TR><TR CLASS="z"><TD CLASS="l">142</TD><TD>                        return null;</TD></TR><TR><TD CLASS="l">143</TD><TD>                    }</TD></TR><TR><TD CLASS="l">144</TD><TD>                });</TD></TR><TR CLASS="z"><TD CLASS="l">145</TD><TD>            } catch (IllegalArgumentException e) {</TD></TR><TR><TD CLASS="l">146</TD><TD>                // Leave level set to null</TD></TR><TR CLASS="z"><TD CLASS="l">147</TD><TD>            }</TD></TR><TR><TD CLASS="l">148</TD><TD>        }</TD></TR><TR><TD CLASS="l">149</TD><TD> </TD></TR><TR><TD CLASS="l">150</TD><TD>        // If any parent loggers have levels definied, make sure they are</TD></TR><TR><TD CLASS="l">151</TD><TD>        // instantiated</TD></TR><TR CLASS="c"><TD CLASS="l">152</TD><TD>        int dotIndex = loggerName.lastIndexOf('.');</TD></TR><TR CLASS="c"><TD CLASS="l">153</TD><TD>        while (dotIndex &gt;= 0) {</TD></TR><TR CLASS="c"><TD CLASS="l">154</TD><TD>            final String parentName = loggerName.substring(0, dotIndex);</TD></TR><TR CLASS="c"><TD CLASS="l">155</TD><TD>            if (getProperty(parentName + &#34;.level&#34;) != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">156</TD><TD>                Logger.getLogger(parentName);</TD></TR><TR CLASS="z"><TD CLASS="l">157</TD><TD>                break;</TD></TR><TR><TD CLASS="l">158</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">159</TD><TD>            dotIndex = loggerName.lastIndexOf('.', dotIndex - 1);</TD></TR><TR CLASS="c"><TD CLASS="l">160</TD><TD>        }</TD></TR><TR><TD CLASS="l">161</TD><TD> </TD></TR><TR><TD CLASS="l">162</TD><TD>        // Find associated node</TD></TR><TR CLASS="c"><TD CLASS="l">163</TD><TD>        LogNode node = info.rootNode.findNode(loggerName);</TD></TR><TR CLASS="c"><TD CLASS="l">164</TD><TD>        node.logger = logger;</TD></TR><TR><TD CLASS="l">165</TD><TD> </TD></TR><TR><TD CLASS="l">166</TD><TD>        // Set parent logger</TD></TR><TR CLASS="c"><TD CLASS="l">167</TD><TD>        Logger parentLogger = node.findParentLogger();</TD></TR><TR CLASS="c"><TD CLASS="l">168</TD><TD>        if (parentLogger != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">169</TD><TD>            doSetParentLogger(logger, parentLogger);</TD></TR><TR><TD CLASS="l">170</TD><TD>        }</TD></TR><TR><TD CLASS="l">171</TD><TD> </TD></TR><TR><TD CLASS="l">172</TD><TD>        // Tell children we are their new parent</TD></TR><TR CLASS="c"><TD CLASS="l">173</TD><TD>        node.setParentLogger(logger);</TD></TR><TR><TD CLASS="l">174</TD><TD> </TD></TR><TR><TD CLASS="l">175</TD><TD>        // Add associated handlers, if any are defined using the .handlers property.</TD></TR><TR><TD CLASS="l">176</TD><TD>        // In this case, handlers of the parent logger(s) will not be used</TD></TR><TR CLASS="c"><TD CLASS="l">177</TD><TD>        String handlers = getProperty(loggerName + &#34;.handlers&#34;);</TD></TR><TR CLASS="c"><TD CLASS="l">178</TD><TD>        if (handlers != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">179</TD><TD>            logger.setUseParentHandlers(false);</TD></TR><TR CLASS="c"><TD CLASS="l">180</TD><TD>            StringTokenizer tok = new StringTokenizer(handlers, &#34;,&#34;);</TD></TR><TR CLASS="c"><TD CLASS="l">181</TD><TD>            while (tok.hasMoreTokens()) {</TD></TR><TR CLASS="c"><TD CLASS="l">182</TD><TD>                String handlerName = (tok.nextToken().trim());</TD></TR><TR CLASS="c"><TD CLASS="l">183</TD><TD>                Handler handler = null;</TD></TR><TR CLASS="c"><TD CLASS="l">184</TD><TD>                ClassLoader current = classLoader;</TD></TR><TR CLASS="c"><TD CLASS="l">185</TD><TD>                while (current != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">186</TD><TD>                    info = classLoaderLoggers.get(current);</TD></TR><TR CLASS="c"><TD CLASS="l">187</TD><TD>                    if (info != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">188</TD><TD>                        handler = info.handlers.get(handlerName);</TD></TR><TR CLASS="c"><TD CLASS="l">189</TD><TD>                        if (handler != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">190</TD><TD>                            break;</TD></TR><TR><TD CLASS="l">191</TD><TD>                        }</TD></TR><TR><TD CLASS="l">192</TD><TD>                    }</TD></TR><TR CLASS="c"><TD CLASS="l">193</TD><TD>                    current = current.getParent();</TD></TR><TR><TD CLASS="l">194</TD><TD>                }</TD></TR><TR CLASS="c"><TD CLASS="l">195</TD><TD>                if (handler != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">196</TD><TD>                    logger.addHandler(handler);</TD></TR><TR><TD CLASS="l">197</TD><TD>                }</TD></TR><TR CLASS="c"><TD CLASS="l">198</TD><TD>            }</TD></TR><TR><TD CLASS="l">199</TD><TD>        }</TD></TR><TR><TD CLASS="l">200</TD><TD> </TD></TR><TR><TD CLASS="l">201</TD><TD>        // Parse useParentHandlers to set if the logger should delegate to its parent.</TD></TR><TR><TD CLASS="l">202</TD><TD>        // Unlike java.util.logging, the default is to not delegate if a list of handlers</TD></TR><TR><TD CLASS="l">203</TD><TD>        // has been specified for the logger.</TD></TR><TR CLASS="c"><TD CLASS="l">204</TD><TD>        String useParentHandlersString = getProperty(loggerName + &#34;.useParentHandlers&#34;);</TD></TR><TR CLASS="c"><TD CLASS="l">205</TD><TD>        if (Boolean.valueOf(useParentHandlersString).booleanValue()) {</TD></TR><TR CLASS="z"><TD CLASS="l">206</TD><TD>            logger.setUseParentHandlers(true);</TD></TR><TR><TD CLASS="l">207</TD><TD>        }</TD></TR><TR><TD CLASS="l">208</TD><TD>        </TD></TR><TR CLASS="c"><TD CLASS="l">209</TD><TD>        return true;</TD></TR><TR><TD CLASS="l">210</TD><TD>    }</TD></TR><TR><TD CLASS="l">211</TD><TD> </TD></TR><TR><TD CLASS="l">212</TD><TD>    </TD></TR><TR><TD CLASS="l">213</TD><TD>    /**</TD></TR><TR><TD CLASS="l">214</TD><TD>     * Get the logger associated with the specified name inside </TD></TR><TR><TD CLASS="l">215</TD><TD>     * the classloader local configuration. If this returns null,</TD></TR><TR><TD CLASS="l">216</TD><TD>     * and the call originated for Logger.getLogger, a new</TD></TR><TR><TD CLASS="l">217</TD><TD>     * logger with the specified name will be instantiated and</TD></TR><TR><TD CLASS="l">218</TD><TD>     * added using addLogger.</TD></TR><TR><TD CLASS="l"><A NAME="f">219</A></TD><TD>     * </TD></TR><TR><TD CLASS="l">220</TD><TD>     * @param name The name of the logger to retrieve</TD></TR><TR><TD CLASS="l">221</TD><TD>     */</TD></TR><TR><TD CLASS="l">222</TD><TD>    public synchronized Logger getLogger(final String name) {</TD></TR><TR CLASS="c"><TD CLASS="l">223</TD><TD>        ClassLoader classLoader = Thread.currentThread()</TD></TR><TR CLASS="c"><TD CLASS="l">224</TD><TD>                .getContextClassLoader();</TD></TR><TR CLASS="c"><TD CLASS="l">225</TD><TD>        return getClassLoaderInfo(classLoader).loggers.get(name);</TD></TR><TR><TD CLASS="l">226</TD><TD>    }</TD></TR><TR><TD CLASS="l">227</TD><TD>    </TD></TR><TR><TD CLASS="l">228</TD><TD>    </TD></TR><TR><TD CLASS="l">229</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="10">230</A></TD><TD>     * Get an enumeration of the logger names currently defined in the </TD></TR><TR><TD CLASS="l">231</TD><TD>     * classloader local configuration.</TD></TR><TR><TD CLASS="l">232</TD><TD>     */</TD></TR><TR><TD CLASS="l">233</TD><TD>    public synchronized Enumeration&lt;String&gt; getLoggerNames() {</TD></TR><TR CLASS="c"><TD CLASS="l">234</TD><TD>        ClassLoader classLoader = Thread.currentThread()</TD></TR><TR CLASS="c"><TD CLASS="l">235</TD><TD>                .getContextClassLoader();</TD></TR><TR CLASS="c"><TD CLASS="l">236</TD><TD>        return Collections.enumeration(getClassLoaderInfo(classLoader).loggers.keySet());</TD></TR><TR><TD CLASS="l">237</TD><TD>    }</TD></TR><TR><TD CLASS="l">238</TD><TD> </TD></TR><TR><TD CLASS="l">239</TD><TD>    </TD></TR><TR><TD CLASS="l">240</TD><TD>    /**</TD></TR><TR><TD CLASS="l">241</TD><TD>     * Get the value of the specified property in the classloader local</TD></TR><TR><TD CLASS="l">242</TD><TD>     * configuration.</TD></TR><TR><TD CLASS="l"><A NAME="11">243</A></TD><TD>     * </TD></TR><TR><TD CLASS="l">244</TD><TD>     * @param name The property name</TD></TR><TR><TD CLASS="l">245</TD><TD>     */    </TD></TR><TR><TD CLASS="l">246</TD><TD>    public String getProperty(String name) {</TD></TR><TR CLASS="c"><TD CLASS="l">247</TD><TD>        String prefix = this.prefix.get();</TD></TR><TR CLASS="c"><TD CLASS="l">248</TD><TD>        String result = null;</TD></TR><TR><TD CLASS="l">249</TD><TD> </TD></TR><TR><TD CLASS="l">250</TD><TD>        // If a prefix is defined look for a prefixed property first</TD></TR><TR CLASS="c"><TD CLASS="l">251</TD><TD>        if (prefix != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">252</TD><TD>            result = findProperty(prefix + name);</TD></TR><TR><TD CLASS="l">253</TD><TD>        }</TD></TR><TR><TD CLASS="l">254</TD><TD> </TD></TR><TR><TD CLASS="l">255</TD><TD>        // If there is no prefix or no property match with the prefix try just</TD></TR><TR><TD CLASS="l">256</TD><TD>        // the name</TD></TR><TR CLASS="c"><TD CLASS="l">257</TD><TD>        if (result == null) {</TD></TR><TR CLASS="c"><TD CLASS="l">258</TD><TD>            result = findProperty(name);</TD></TR><TR><TD CLASS="l">259</TD><TD>        }</TD></TR><TR><TD CLASS="l">260</TD><TD> </TD></TR><TR><TD CLASS="l">261</TD><TD>        // Simple property replacement (mostly for folder names)</TD></TR><TR CLASS="c"><TD CLASS="l">262</TD><TD>        if (result != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">263</TD><TD>            result = replace(result);</TD></TR><TR><TD CLASS="l">264</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">265</TD><TD>        return result;</TD></TR><TR><TD CLASS="l"><A NAME="b">266</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">267</TD><TD> </TD></TR><TR><TD CLASS="l">268</TD><TD> </TD></TR><TR><TD CLASS="l">269</TD><TD>    private String findProperty(String name) {</TD></TR><TR CLASS="c"><TD CLASS="l">270</TD><TD>        ClassLoader classLoader = Thread.currentThread()</TD></TR><TR CLASS="c"><TD CLASS="l">271</TD><TD>                .getContextClassLoader();</TD></TR><TR CLASS="c"><TD CLASS="l">272</TD><TD>        ClassLoaderLogInfo info = getClassLoaderInfo(classLoader);</TD></TR><TR CLASS="c"><TD CLASS="l">273</TD><TD>        String result = info.props.getProperty(name);</TD></TR><TR><TD CLASS="l">274</TD><TD>        // If the property was not found, and the current classloader had no </TD></TR><TR><TD CLASS="l">275</TD><TD>        // configuration (property list is empty), look for the parent classloader</TD></TR><TR><TD CLASS="l">276</TD><TD>        // properties.</TD></TR><TR CLASS="c"><TD CLASS="l">277</TD><TD>        if ((result == null) &amp;&amp; (info.props.isEmpty())) {</TD></TR><TR CLASS="c"><TD CLASS="l">278</TD><TD>            ClassLoader current = classLoader.getParent();</TD></TR><TR CLASS="c"><TD CLASS="l">279</TD><TD>            while (current != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">280</TD><TD>                info = classLoaderLoggers.get(current);</TD></TR><TR CLASS="c"><TD CLASS="l">281</TD><TD>                if (info != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">282</TD><TD>                    result = info.props.getProperty(name);</TD></TR><TR CLASS="c"><TD CLASS="l">283</TD><TD>                    if ((result != null) || (!info.props.isEmpty())) {</TD></TR><TR CLASS="c"><TD CLASS="l">284</TD><TD>                        break;</TD></TR><TR><TD CLASS="l">285</TD><TD>                    }</TD></TR><TR><TD CLASS="l">286</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">287</TD><TD>                current = current.getParent();</TD></TR><TR><TD CLASS="l">288</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">289</TD><TD>            if (result == null) {</TD></TR><TR CLASS="c"><TD CLASS="l">290</TD><TD>                result = super.getProperty(name);</TD></TR><TR><TD CLASS="l">291</TD><TD>            }</TD></TR><TR><TD CLASS="l">292</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">293</TD><TD>        return result;</TD></TR><TR><TD CLASS="l">294</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="12">295</A></TD><TD> </TD></TR><TR><TD CLASS="l">296</TD><TD>    public void readConfiguration()</TD></TR><TR><TD CLASS="l">297</TD><TD>        throws IOException, SecurityException {</TD></TR><TR><TD CLASS="l">298</TD><TD>        </TD></TR><TR CLASS="c"><TD CLASS="l">299</TD><TD>        checkAccess();</TD></TR><TR><TD CLASS="l">300</TD><TD>        </TD></TR><TR CLASS="c"><TD CLASS="l">301</TD><TD>        readConfiguration(Thread.currentThread().getContextClassLoader());</TD></TR><TR><TD CLASS="l">302</TD><TD>        </TD></TR><TR CLASS="c"><TD CLASS="l">303</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="5">304</A></TD><TD>        </TD></TR><TR><TD CLASS="l">305</TD><TD>    public void readConfiguration(InputStream is)</TD></TR><TR><TD CLASS="l">306</TD><TD>        throws IOException, SecurityException {</TD></TR><TR><TD CLASS="l">307</TD><TD>        </TD></TR><TR CLASS="z"><TD CLASS="l">308</TD><TD>        checkAccess();</TD></TR><TR CLASS="z"><TD CLASS="l">309</TD><TD>        reset();</TD></TR><TR><TD CLASS="l">310</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">311</TD><TD>        readConfiguration(is, Thread.currentThread().getContextClassLoader());</TD></TR><TR><TD CLASS="l">312</TD><TD>    </TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="14">313</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">314</TD><TD> </TD></TR><TR><TD CLASS="l">315</TD><TD>    @Override</TD></TR><TR><TD CLASS="l">316</TD><TD>    public void reset() throws SecurityException {</TD></TR><TR CLASS="c"><TD CLASS="l">317</TD><TD>        Thread thread = Thread.currentThread();</TD></TR><TR CLASS="c"><TD CLASS="l">318</TD><TD>        if (thread.getClass().getName().startsWith(</TD></TR><TR><TD CLASS="l">319</TD><TD>                &#34;java.util.logging.LogManager$&#34;)) {</TD></TR><TR><TD CLASS="l">320</TD><TD>            // Ignore the call from java.util.logging.LogManager.Cleaner,</TD></TR><TR><TD CLASS="l">321</TD><TD>            // because we have our own shutdown hook</TD></TR><TR CLASS="c"><TD CLASS="l">322</TD><TD>            return;</TD></TR><TR><TD CLASS="l">323</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">324</TD><TD>        ClassLoader classLoader = thread.getContextClassLoader();</TD></TR><TR CLASS="c"><TD CLASS="l">325</TD><TD>        ClassLoaderLogInfo clLogInfo = getClassLoaderInfo(classLoader);</TD></TR><TR CLASS="c"><TD CLASS="l">326</TD><TD>        resetLoggers(clLogInfo);</TD></TR><TR CLASS="c"><TD CLASS="l">327</TD><TD>        super.reset();</TD></TR><TR CLASS="c"><TD CLASS="l">328</TD><TD>    }</TD></TR><TR><TD CLASS="l">329</TD><TD> </TD></TR><TR><TD CLASS="l">330</TD><TD>    /**</TD></TR><TR><TD CLASS="l">331</TD><TD>     * Shuts down the logging system.</TD></TR><TR><TD CLASS="l"><A NAME="15">332</A></TD><TD>     */</TD></TR><TR><TD CLASS="l">333</TD><TD>    public void shutdown() {</TD></TR><TR><TD CLASS="l">334</TD><TD>        // The JVM us being shutdown. Make sure all loggers for all class</TD></TR><TR><TD CLASS="l">335</TD><TD>        // loaders are shutdown</TD></TR><TR CLASS="c"><TD CLASS="l">336</TD><TD>        for (ClassLoaderLogInfo clLogInfo : classLoaderLoggers.values()) {</TD></TR><TR CLASS="c"><TD CLASS="l">337</TD><TD>            resetLoggers(clLogInfo);</TD></TR><TR CLASS="c"><TD CLASS="l">338</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">339</TD><TD>    }</TD></TR><TR><TD CLASS="l">340</TD><TD> </TD></TR><TR><TD CLASS="l">341</TD><TD>    // -------------------------------------------------------- Private Methods</TD></TR><TR><TD CLASS="l">342</TD><TD>    private void resetLoggers(ClassLoaderLogInfo clLogInfo) {</TD></TR><TR><TD CLASS="l">343</TD><TD>        // This differs from LogManager#resetLogger() in that we close not all</TD></TR><TR><TD CLASS="l">344</TD><TD>        // handlers of all loggers, but only those that are present in our</TD></TR><TR><TD CLASS="l"><A NAME="a">345</A></TD><TD>        // ClassLoaderLogInfo#handlers list. That is because our #addLogger(..)</TD></TR><TR><TD CLASS="l">346</TD><TD>        // method can use handlers from the parent class loaders, and closing</TD></TR><TR><TD CLASS="l">347</TD><TD>        // handlers that the current class loader does not own would be not</TD></TR><TR><TD CLASS="l">348</TD><TD>        // good.</TD></TR><TR CLASS="c"><TD CLASS="l">349</TD><TD>        synchronized (clLogInfo) {</TD></TR><TR CLASS="c"><TD CLASS="l">350</TD><TD>            for (Logger logger : clLogInfo.loggers.values()) {</TD></TR><TR CLASS="c"><TD CLASS="l">351</TD><TD>                Handler[] handlers = logger.getHandlers();</TD></TR><TR CLASS="c"><TD CLASS="l">352</TD><TD>                for (Handler handler : handlers) {</TD></TR><TR CLASS="c"><TD CLASS="l">353</TD><TD>                    logger.removeHandler(handler);</TD></TR><TR><TD CLASS="l">354</TD><TD>                }</TD></TR><TR CLASS="c"><TD CLASS="l">355</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">356</TD><TD>            for (Handler handler : clLogInfo.handlers.values()) {</TD></TR><TR><TD CLASS="l">357</TD><TD>                try {</TD></TR><TR CLASS="c"><TD CLASS="l">358</TD><TD>                    handler.close();</TD></TR><TR CLASS="z"><TD CLASS="l">359</TD><TD>                } catch (Exception e) {</TD></TR><TR><TD CLASS="l">360</TD><TD>                    // Ignore</TD></TR><TR CLASS="c"><TD CLASS="l">361</TD><TD>                }</TD></TR><TR CLASS="c"><TD CLASS="l">362</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">363</TD><TD>            clLogInfo.handlers.clear();</TD></TR><TR CLASS="p"><TD TITLE="55% line coverage (6 out of 11 instructions)" CLASS="l">364</TD><TD TITLE="55% line coverage (6 out of 11 instructions)">        }</TD></TR><TR CLASS="c"><TD CLASS="l">365</TD><TD>    }</TD></TR><TR><TD CLASS="l">366</TD><TD> </TD></TR><TR><TD CLASS="l">367</TD><TD>    // ------------------------------------------------------ Protected Methods</TD></TR><TR><TD CLASS="l">368</TD><TD> </TD></TR><TR><TD CLASS="l">369</TD><TD> </TD></TR><TR><TD CLASS="l">370</TD><TD>    /**</TD></TR><TR><TD CLASS="l">371</TD><TD>     * Retrieve the configuration associated with the specified classloader. If</TD></TR><TR><TD CLASS="l">372</TD><TD>     * it does not exist, it will be created.</TD></TR><TR><TD CLASS="l">373</TD><TD>     * </TD></TR><TR><TD CLASS="l">374</TD><TD>     * @param classLoader The classloader for which we will retrieve or build the </TD></TR><TR><TD CLASS="l"><A NAME="c">375</A></TD><TD>     *                    configuration</TD></TR><TR><TD CLASS="l">376</TD><TD>     */</TD></TR><TR><TD CLASS="l">377</TD><TD>    protected ClassLoaderLogInfo getClassLoaderInfo(ClassLoader classLoader) {</TD></TR><TR><TD CLASS="l">378</TD><TD>        </TD></TR><TR CLASS="c"><TD CLASS="l">379</TD><TD>        if (classLoader == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">380</TD><TD>            classLoader = ClassLoader.getSystemClassLoader();</TD></TR><TR><TD CLASS="l"><A NAME="1c">381</A></TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">382</TD><TD>        ClassLoaderLogInfo info = classLoaderLoggers.get(classLoader);</TD></TR><TR CLASS="c"><TD CLASS="l">383</TD><TD>        if (info == null) {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="1d">384</A></TD><TD>            final ClassLoader classLoaderParam = classLoader;</TD></TR><TR CLASS="c"><TD CLASS="l">385</TD><TD>            AccessController.doPrivileged(new PrivilegedAction() {</TD></TR><TR><TD CLASS="l">386</TD><TD>                public Object run() {</TD></TR><TR><TD CLASS="l">387</TD><TD>                    try {</TD></TR><TR CLASS="c"><TD CLASS="l">388</TD><TD>                        readConfiguration(classLoaderParam);</TD></TR><TR CLASS="z"><TD CLASS="l">389</TD><TD>                    } catch (IOException e) {</TD></TR><TR><TD CLASS="l">390</TD><TD>                        // Ignore</TD></TR><TR CLASS="c"><TD CLASS="l">391</TD><TD>                    }</TD></TR><TR CLASS="c"><TD CLASS="l">392</TD><TD>                    return null;</TD></TR><TR><TD CLASS="l">393</TD><TD>                }</TD></TR><TR><TD CLASS="l">394</TD><TD>            });</TD></TR><TR CLASS="c"><TD CLASS="l">395</TD><TD>            info = classLoaderLoggers.get(classLoader);</TD></TR><TR><TD CLASS="l">396</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">397</TD><TD>        return info;</TD></TR><TR><TD CLASS="l">398</TD><TD>    }</TD></TR><TR><TD CLASS="l">399</TD><TD> </TD></TR><TR><TD CLASS="l">400</TD><TD>    </TD></TR><TR><TD CLASS="l">401</TD><TD>    /**</TD></TR><TR><TD CLASS="l">402</TD><TD>     * Read configuration for the specified classloader.</TD></TR><TR><TD CLASS="l">403</TD><TD>     * </TD></TR><TR><TD CLASS="l">404</TD><TD>     * @param classLoader </TD></TR><TR><TD CLASS="l">405</TD><TD>     * @throws IOException Errot</TD></TR><TR><TD CLASS="l"><A NAME="7">406</A></TD><TD>     */</TD></TR><TR><TD CLASS="l">407</TD><TD>    protected void readConfiguration(ClassLoader classLoader)</TD></TR><TR><TD CLASS="l">408</TD><TD>        throws IOException {</TD></TR><TR><TD CLASS="l">409</TD><TD>        </TD></TR><TR CLASS="c"><TD CLASS="l">410</TD><TD>        InputStream is = null;</TD></TR><TR><TD CLASS="l">411</TD><TD>        // Special case for URL classloaders which are used in containers: </TD></TR><TR><TD CLASS="l">412</TD><TD>        // only look in the local repositories to avoid redefining loggers 20 times</TD></TR><TR><TD CLASS="l">413</TD><TD>        try {</TD></TR><TR CLASS="c"><TD CLASS="l">414</TD><TD>            if ((classLoader instanceof URLClassLoader) </TD></TR><TR CLASS="c"><TD CLASS="l">415</TD><TD>                    &amp;&amp; (((URLClassLoader) classLoader).findResource(&#34;logging.properties&#34;) != null)) {</TD></TR><TR CLASS="z"><TD CLASS="l">416</TD><TD>                is = classLoader.getResourceAsStream(&#34;logging.properties&#34;);</TD></TR><TR><TD CLASS="l">417</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">418</TD><TD>        } catch (AccessControlException ace) {</TD></TR><TR><TD CLASS="l">419</TD><TD>            // No permission to configure logging in context</TD></TR><TR><TD CLASS="l">420</TD><TD>            // Log and carry on</TD></TR><TR CLASS="z"><TD CLASS="l">421</TD><TD>            ClassLoaderLogInfo info = classLoaderLoggers.get(ClassLoader.getSystemClassLoader());</TD></TR><TR CLASS="z"><TD CLASS="l">422</TD><TD>            if (info != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">423</TD><TD>                Logger log = info.loggers.get(&#34;&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">424</TD><TD>                if (log != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">425</TD><TD>                    Permission perm = ace.getPermission();</TD></TR><TR CLASS="z"><TD CLASS="l">426</TD><TD>                    if (perm instanceof FilePermission &amp;&amp; perm.getActions().equals(&#34;read&#34;)) {</TD></TR><TR CLASS="z"><TD CLASS="l">427</TD><TD>                        log.warning(&#34;Reading &#34; + perm.getName() + &#34; is not permitted. See \&#34;per context logging\&#34; in the default catalina.policy file.&#34;);</TD></TR><TR><TD CLASS="l">428</TD><TD>                    }</TD></TR><TR><TD CLASS="l">429</TD><TD>                    else {</TD></TR><TR CLASS="z"><TD CLASS="l">430</TD><TD>                        log.warning(&#34;Reading logging.properties is not permitted in some context. See \&#34;per context logging\&#34; in the default catalina.policy file.&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">431</TD><TD>                        log.warning(&#34;Original error was: &#34; + ace.getMessage());</TD></TR><TR><TD CLASS="l">432</TD><TD>                    }</TD></TR><TR><TD CLASS="l">433</TD><TD>                }</TD></TR><TR><TD CLASS="l">434</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">435</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">436</TD><TD>        if ((is == null) &amp;&amp; (classLoader == ClassLoader.getSystemClassLoader())) {</TD></TR><TR CLASS="c"><TD CLASS="l">437</TD><TD>            String configFileStr = System.getProperty(&#34;java.util.logging.config.file&#34;);</TD></TR><TR CLASS="c"><TD CLASS="l">438</TD><TD>            if (configFileStr != null) {</TD></TR><TR><TD CLASS="l">439</TD><TD>                try {</TD></TR><TR CLASS="c"><TD CLASS="l">440</TD><TD>                    is = new FileInputStream(replace(configFileStr));</TD></TR><TR CLASS="z"><TD CLASS="l">441</TD><TD>                } catch (IOException e) {</TD></TR><TR><TD CLASS="l">442</TD><TD>                    // Ignore</TD></TR><TR CLASS="c"><TD CLASS="l">443</TD><TD>                }</TD></TR><TR><TD CLASS="l">444</TD><TD>            }</TD></TR><TR><TD CLASS="l">445</TD><TD>            // Try the default JVM configuration</TD></TR><TR CLASS="c"><TD CLASS="l">446</TD><TD>            if (is == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">447</TD><TD>                File defaultFile = new File(new File(System.getProperty(&#34;java.home&#34;), &#34;lib&#34;), </TD></TR><TR><TD CLASS="l">448</TD><TD>                    &#34;logging.properties&#34;);</TD></TR><TR><TD CLASS="l">449</TD><TD>                try {</TD></TR><TR CLASS="z"><TD CLASS="l">450</TD><TD>                    is = new FileInputStream(defaultFile);</TD></TR><TR CLASS="z"><TD CLASS="l">451</TD><TD>                } catch (IOException e) {</TD></TR><TR><TD CLASS="l">452</TD><TD>                    // Critical problem, do something ...</TD></TR><TR CLASS="z"><TD CLASS="l">453</TD><TD>                }</TD></TR><TR><TD CLASS="l">454</TD><TD>            }</TD></TR><TR><TD CLASS="l">455</TD><TD>        }</TD></TR><TR><TD CLASS="l">456</TD><TD>        </TD></TR><TR CLASS="c"><TD CLASS="l">457</TD><TD>        Logger localRootLogger = new RootLogger();</TD></TR><TR CLASS="c"><TD CLASS="l">458</TD><TD>        if (is == null) {</TD></TR><TR><TD CLASS="l">459</TD><TD>            // Retrieve the root logger of the parent classloader instead</TD></TR><TR CLASS="c"><TD CLASS="l">460</TD><TD>            ClassLoader current = classLoader.getParent();</TD></TR><TR CLASS="c"><TD CLASS="l">461</TD><TD>            ClassLoaderLogInfo info = null;</TD></TR><TR CLASS="c"><TD CLASS="l">462</TD><TD>            while (current != null &amp;&amp; info == null) {</TD></TR><TR CLASS="c"><TD CLASS="l">463</TD><TD>                info = getClassLoaderInfo(current);</TD></TR><TR CLASS="c"><TD CLASS="l">464</TD><TD>                current = current.getParent();</TD></TR><TR><TD CLASS="l">465</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">466</TD><TD>            if (info != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">467</TD><TD>                localRootLogger.setParent(info.rootNode.logger);</TD></TR><TR><TD CLASS="l">468</TD><TD>            }</TD></TR><TR><TD CLASS="l">469</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">470</TD><TD>        ClassLoaderLogInfo info = </TD></TR><TR><TD CLASS="l">471</TD><TD>            new ClassLoaderLogInfo(new LogNode(null, localRootLogger));</TD></TR><TR CLASS="c"><TD CLASS="l">472</TD><TD>        classLoaderLoggers.put(classLoader, info);</TD></TR><TR><TD CLASS="l">473</TD><TD>        </TD></TR><TR CLASS="c"><TD CLASS="l">474</TD><TD>        if (is != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">475</TD><TD>            readConfiguration(is, classLoader);</TD></TR><TR><TD CLASS="l">476</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">477</TD><TD>        addLogger(localRootLogger);</TD></TR><TR><TD CLASS="l">478</TD><TD>        </TD></TR><TR CLASS="c"><TD CLASS="l">479</TD><TD>    }</TD></TR><TR><TD CLASS="l">480</TD><TD>    </TD></TR><TR><TD CLASS="l">481</TD><TD>    </TD></TR><TR><TD CLASS="l">482</TD><TD>    /**</TD></TR><TR><TD CLASS="l">483</TD><TD>     * Load specified configuration.</TD></TR><TR><TD CLASS="l">484</TD><TD>     * </TD></TR><TR><TD CLASS="l">485</TD><TD>     * @param is InputStream to the properties file</TD></TR><TR><TD CLASS="l">486</TD><TD>     * @param classLoader for which the configuration will be loaded</TD></TR><TR><TD CLASS="l">487</TD><TD>     * @throws IOException If something wrong happens during loading</TD></TR><TR><TD CLASS="l"><A NAME="8">488</A></TD><TD>     */</TD></TR><TR><TD CLASS="l">489</TD><TD>    protected void readConfiguration(InputStream is, ClassLoader classLoader)</TD></TR><TR><TD CLASS="l">490</TD><TD>        throws IOException {</TD></TR><TR><TD CLASS="l">491</TD><TD>        </TD></TR><TR CLASS="c"><TD CLASS="l">492</TD><TD>        ClassLoaderLogInfo info = classLoaderLoggers.get(classLoader);</TD></TR><TR><TD CLASS="l">493</TD><TD>        </TD></TR><TR><TD CLASS="l">494</TD><TD>        try {</TD></TR><TR CLASS="c"><TD CLASS="l">495</TD><TD>            info.props.load(is);</TD></TR><TR CLASS="p"><TD TITLE="61% line coverage (11 out of 18 instructions)" CLASS="l">496</TD><TD TITLE="61% line coverage (11 out of 18 instructions)">        } catch (IOException e) {</TD></TR><TR><TD CLASS="l">497</TD><TD>            // Report error</TD></TR><TR CLASS="z"><TD CLASS="l">498</TD><TD>            System.err.println(&#34;Configuration error&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">499</TD><TD>            e.printStackTrace();</TD></TR><TR CLASS="z"><TD CLASS="l">500</TD><TD>        } finally {</TD></TR><TR CLASS="p"><TD TITLE="50% line coverage (4 out of 8 instructions)" CLASS="l">501</TD><TD TITLE="50% line coverage (4 out of 8 instructions)">            try {</TD></TR><TR CLASS="c"><TD CLASS="l">502</TD><TD>                is.close();</TD></TR><TR CLASS="p"><TD TITLE="83% line coverage (5 out of 6 instructions)" CLASS="l">503</TD><TD TITLE="83% line coverage (5 out of 6 instructions)">            } catch (Throwable t) {}</TD></TR><TR CLASS="p"><TD TITLE="50% line coverage (1 out of 2 instructions)" CLASS="l">504</TD><TD TITLE="50% line coverage (1 out of 2 instructions)">        }</TD></TR><TR><TD CLASS="l">505</TD><TD>        </TD></TR><TR><TD CLASS="l">506</TD><TD>        // Create handlers for the root logger of this classloader</TD></TR><TR CLASS="c"><TD CLASS="l">507</TD><TD>        String rootHandlers = info.props.getProperty(&#34;.handlers&#34;);</TD></TR><TR CLASS="c"><TD CLASS="l">508</TD><TD>        String handlers = info.props.getProperty(&#34;handlers&#34;);</TD></TR><TR CLASS="c"><TD CLASS="l">509</TD><TD>        Logger localRootLogger = info.rootNode.logger;</TD></TR><TR CLASS="c"><TD CLASS="l">510</TD><TD>        if (handlers != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">511</TD><TD>            StringTokenizer tok = new StringTokenizer(handlers, &#34;,&#34;);</TD></TR><TR CLASS="c"><TD CLASS="l">512</TD><TD>            while (tok.hasMoreTokens()) {</TD></TR><TR CLASS="c"><TD CLASS="l">513</TD><TD>                String handlerName = (tok.nextToken().trim());</TD></TR><TR CLASS="c"><TD CLASS="l">514</TD><TD>                String handlerClassName = handlerName;</TD></TR><TR CLASS="c"><TD CLASS="l">515</TD><TD>                String prefix = &#34;&#34;;</TD></TR><TR CLASS="c"><TD CLASS="l">516</TD><TD>                if (handlerClassName.length() &lt;= 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">517</TD><TD>                    continue;</TD></TR><TR><TD CLASS="l">518</TD><TD>                }</TD></TR><TR><TD CLASS="l">519</TD><TD>                // Parse and remove a prefix (prefix start with a digit, such as </TD></TR><TR><TD CLASS="l">520</TD><TD>                // &#34;10WebappFooHanlder.&#34;)</TD></TR><TR CLASS="c"><TD CLASS="l">521</TD><TD>                if (Character.isDigit(handlerClassName.charAt(0))) {</TD></TR><TR CLASS="c"><TD CLASS="l">522</TD><TD>                    int pos = handlerClassName.indexOf('.');</TD></TR><TR CLASS="c"><TD CLASS="l">523</TD><TD>                    if (pos &gt;= 0) {</TD></TR><TR CLASS="c"><TD CLASS="l">524</TD><TD>                        prefix = handlerClassName.substring(0, pos + 1);</TD></TR><TR CLASS="c"><TD CLASS="l">525</TD><TD>                        handlerClassName = handlerClassName.substring(pos + 1);</TD></TR><TR><TD CLASS="l">526</TD><TD>                    }</TD></TR><TR><TD CLASS="l">527</TD><TD>                }</TD></TR><TR><TD CLASS="l">528</TD><TD>                try {</TD></TR><TR CLASS="c"><TD CLASS="l">529</TD><TD>                    this.prefix.set(prefix);</TD></TR><TR CLASS="c"><TD CLASS="l">530</TD><TD>                    Handler handler = </TD></TR><TR CLASS="c"><TD CLASS="l">531</TD><TD>                        (Handler) classLoader.loadClass(handlerClassName).newInstance();</TD></TR><TR><TD CLASS="l">532</TD><TD>                    // The specification strongly implies all configuration should be done </TD></TR><TR><TD CLASS="l">533</TD><TD>                    // during the creation of the handler object.</TD></TR><TR><TD CLASS="l">534</TD><TD>                    // This includes setting level, filter, formatter and encoding.</TD></TR><TR CLASS="c"><TD CLASS="l">535</TD><TD>                    this.prefix.set(null);</TD></TR><TR CLASS="c"><TD CLASS="l">536</TD><TD>                    info.handlers.put(handlerName, handler);</TD></TR><TR CLASS="c"><TD CLASS="l">537</TD><TD>                    if (rootHandlers == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">538</TD><TD>                        localRootLogger.addHandler(handler);</TD></TR><TR><TD CLASS="l">539</TD><TD>                    }</TD></TR><TR CLASS="z"><TD CLASS="l">540</TD><TD>                } catch (Exception e) {</TD></TR><TR><TD CLASS="l">541</TD><TD>                    // Report error</TD></TR><TR CLASS="z"><TD CLASS="l">542</TD><TD>                    System.err.println(&#34;Handler error&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">543</TD><TD>                    e.printStackTrace();</TD></TR><TR CLASS="c"><TD CLASS="l">544</TD><TD>                }</TD></TR><TR CLASS="c"><TD CLASS="l">545</TD><TD>            }</TD></TR><TR><TD CLASS="l">546</TD><TD>            </TD></TR><TR><TD CLASS="l">547</TD><TD>        }</TD></TR><TR><TD CLASS="l">548</TD><TD>        </TD></TR><TR CLASS="c"><TD CLASS="l">549</TD><TD>    }</TD></TR><TR><TD CLASS="l">550</TD><TD>    </TD></TR><TR><TD CLASS="l">551</TD><TD>    </TD></TR><TR><TD CLASS="l">552</TD><TD>    /**</TD></TR><TR><TD CLASS="l">553</TD><TD>     * Set parent child relationship between the two specified loggers.</TD></TR><TR><TD CLASS="l">554</TD><TD>     * </TD></TR><TR><TD CLASS="l">555</TD><TD>     * @param logger</TD></TR><TR><TD CLASS="l"><A NAME="e">556</A></TD><TD>     * @param parent</TD></TR><TR><TD CLASS="l">557</TD><TD>     */</TD></TR><TR><TD CLASS="l"><A NAME="21">558</A></TD><TD>    protected static void doSetParentLogger(final Logger logger,</TD></TR><TR><TD CLASS="l">559</TD><TD>            final Logger parent) {</TD></TR><TR CLASS="c"><TD CLASS="l">560</TD><TD>        AccessController.doPrivileged(new PrivilegedAction() {</TD></TR><TR><TD CLASS="l">561</TD><TD>            public Object run() {</TD></TR><TR CLASS="c"><TD CLASS="l">562</TD><TD>                logger.setParent(parent);</TD></TR><TR CLASS="c"><TD CLASS="l">563</TD><TD>                return null;</TD></TR><TR><TD CLASS="l">564</TD><TD>            }</TD></TR><TR><TD CLASS="l">565</TD><TD>        });</TD></TR><TR CLASS="c"><TD CLASS="l">566</TD><TD>    }</TD></TR><TR><TD CLASS="l">567</TD><TD> </TD></TR><TR><TD CLASS="l">568</TD><TD>    </TD></TR><TR><TD CLASS="l">569</TD><TD>    /**</TD></TR><TR><TD CLASS="l">570</TD><TD>     * System property replacement in the given string.</TD></TR><TR><TD CLASS="l">571</TD><TD>     * </TD></TR><TR><TD CLASS="l"><A NAME="13">572</A></TD><TD>     * @param str The original string</TD></TR><TR><TD CLASS="l">573</TD><TD>     * @return the modified string</TD></TR><TR><TD CLASS="l">574</TD><TD>     */</TD></TR><TR><TD CLASS="l">575</TD><TD>    protected String replace(String str) {</TD></TR><TR CLASS="c"><TD CLASS="l">576</TD><TD>        String result = str;</TD></TR><TR CLASS="c"><TD CLASS="l">577</TD><TD>        int pos_start = str.indexOf(&#34;${&#34;);</TD></TR><TR CLASS="c"><TD CLASS="l">578</TD><TD>        if (pos_start &gt;= 0) {</TD></TR><TR CLASS="c"><TD CLASS="l">579</TD><TD>            StringBuilder builder = new StringBuilder();</TD></TR><TR CLASS="c"><TD CLASS="l">580</TD><TD>            int pos_end = -1;</TD></TR><TR CLASS="c"><TD CLASS="l">581</TD><TD>            while (pos_start &gt;= 0) {</TD></TR><TR CLASS="c"><TD CLASS="l">582</TD><TD>                builder.append(str, pos_end + 1, pos_start);</TD></TR><TR CLASS="c"><TD CLASS="l">583</TD><TD>                pos_end = str.indexOf('}', pos_start + 2);</TD></TR><TR CLASS="c"><TD CLASS="l">584</TD><TD>                if (pos_end &lt; 0) {</TD></TR><TR CLASS="c"><TD CLASS="l">585</TD><TD>                    pos_end = pos_start - 1;</TD></TR><TR CLASS="c"><TD CLASS="l">586</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">587</TD><TD>                }</TD></TR><TR CLASS="c"><TD CLASS="l">588</TD><TD>                String propName = str.substring(pos_start + 2, pos_end);</TD></TR><TR CLASS="c"><TD CLASS="l">589</TD><TD>                String replacement = propName.length() &gt; 0 ? System</TD></TR><TR CLASS="c"><TD CLASS="l">590</TD><TD>                        .getProperty(propName) : null;</TD></TR><TR CLASS="c"><TD CLASS="l">591</TD><TD>                if (replacement != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">592</TD><TD>                    builder.append(replacement);</TD></TR><TR><TD CLASS="l">593</TD><TD>                } else {</TD></TR><TR CLASS="c"><TD CLASS="l">594</TD><TD>                    builder.append(str, pos_start, pos_end + 1);</TD></TR><TR><TD CLASS="l">595</TD><TD>                }</TD></TR><TR CLASS="c"><TD CLASS="l">596</TD><TD>                pos_start = str.indexOf(&#34;${&#34;, pos_end + 1);</TD></TR><TR CLASS="c"><TD CLASS="l">597</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">598</TD><TD>            builder.append(str, pos_end + 1, str.length());</TD></TR><TR CLASS="c"><TD CLASS="l">599</TD><TD>            result = builder.toString();</TD></TR><TR><TD CLASS="l">600</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">601</TD><TD>        return result;</TD></TR><TR><TD CLASS="l">602</TD><TD>    }</TD></TR><TR><TD CLASS="l">603</TD><TD>    </TD></TR><TR><TD CLASS="l">604</TD><TD> </TD></TR><TR><TD CLASS="l">605</TD><TD>    // ---------------------------------------------------- LogNode Inner Class</TD></TR><TR><TD CLASS="l">606</TD><TD> </TD></TR><TR><TD CLASS="l">607</TD><TD> </TD></TR><TR><TD CLASS="l">608</TD><TD>    protected static final class LogNode {</TD></TR><TR><TD CLASS="l">609</TD><TD>        Logger logger;</TD></TR><TR><TD CLASS="l">610</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">611</TD><TD>        protected final Map&lt;String, LogNode&gt; children = </TD></TR><TR><TD CLASS="l"><A NAME="16">612</A></TD><TD>            new HashMap&lt;String, LogNode&gt;();</TD></TR><TR><TD CLASS="l">613</TD><TD> </TD></TR><TR><TD CLASS="l">614</TD><TD>        protected final LogNode parent;</TD></TR><TR><TD CLASS="l">615</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">616</TD><TD>        LogNode(final LogNode parent, final Logger logger) {</TD></TR><TR CLASS="c"><TD CLASS="l">617</TD><TD>            this.parent = parent;</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="18">618</A></TD><TD>            this.logger = logger;</TD></TR><TR CLASS="c"><TD CLASS="l">619</TD><TD>        }</TD></TR><TR><TD CLASS="l">620</TD><TD> </TD></TR><TR><TD CLASS="l">621</TD><TD>        LogNode(final LogNode parent) {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="1a">622</A></TD><TD>            this(parent, null);</TD></TR><TR CLASS="c"><TD CLASS="l">623</TD><TD>        }</TD></TR><TR><TD CLASS="l">624</TD><TD> </TD></TR><TR><TD CLASS="l">625</TD><TD>        LogNode findNode(String name) {</TD></TR><TR CLASS="c"><TD CLASS="l">626</TD><TD>            LogNode currentNode = this;</TD></TR><TR CLASS="c"><TD CLASS="l">627</TD><TD>            if (logger.getName().equals(name)) {</TD></TR><TR CLASS="c"><TD CLASS="l">628</TD><TD>                return this;</TD></TR><TR><TD CLASS="l">629</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">630</TD><TD>            while (name != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">631</TD><TD>                final int dotIndex = name.indexOf('.');</TD></TR><TR><TD CLASS="l">632</TD><TD>                final String nextName;</TD></TR><TR CLASS="c"><TD CLASS="l">633</TD><TD>                if (dotIndex &lt; 0) {</TD></TR><TR CLASS="c"><TD CLASS="l">634</TD><TD>                    nextName = name;</TD></TR><TR CLASS="c"><TD CLASS="l">635</TD><TD>                    name = null;</TD></TR><TR><TD CLASS="l">636</TD><TD>                } else {</TD></TR><TR CLASS="c"><TD CLASS="l">637</TD><TD>                    nextName = name.substring(0, dotIndex);</TD></TR><TR CLASS="c"><TD CLASS="l">638</TD><TD>                    name = name.substring(dotIndex + 1);</TD></TR><TR><TD CLASS="l">639</TD><TD>                }</TD></TR><TR CLASS="c"><TD CLASS="l">640</TD><TD>                LogNode childNode = currentNode.children.get(nextName);</TD></TR><TR CLASS="c"><TD CLASS="l">641</TD><TD>                if (childNode == null) {</TD></TR><TR CLASS="c"><TD CLASS="l">642</TD><TD>                    childNode = new LogNode(currentNode);</TD></TR><TR CLASS="c"><TD CLASS="l">643</TD><TD>                    currentNode.children.put(nextName, childNode);</TD></TR><TR><TD CLASS="l">644</TD><TD>                }</TD></TR><TR CLASS="c"><TD CLASS="l">645</TD><TD>                currentNode = childNode;</TD></TR><TR CLASS="c"><TD CLASS="l">646</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="1b">647</A></TD><TD>            return currentNode;</TD></TR><TR><TD CLASS="l">648</TD><TD>        }</TD></TR><TR><TD CLASS="l">649</TD><TD> </TD></TR><TR><TD CLASS="l">650</TD><TD>        Logger findParentLogger() {</TD></TR><TR CLASS="c"><TD CLASS="l">651</TD><TD>            Logger logger = null;</TD></TR><TR CLASS="c"><TD CLASS="l">652</TD><TD>            LogNode node = parent;</TD></TR><TR CLASS="c"><TD CLASS="l">653</TD><TD>            while (node != null &amp;&amp; logger == null) {</TD></TR><TR CLASS="c"><TD CLASS="l">654</TD><TD>                logger = node.logger;</TD></TR><TR CLASS="c"><TD CLASS="l">655</TD><TD>                node = node.parent;</TD></TR><TR><TD CLASS="l">656</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="17">657</A></TD><TD>            return logger;</TD></TR><TR><TD CLASS="l">658</TD><TD>        }</TD></TR><TR><TD CLASS="l">659</TD><TD> </TD></TR><TR><TD CLASS="l">660</TD><TD>        void setParentLogger(final Logger parent) {</TD></TR><TR CLASS="c"><TD CLASS="l">661</TD><TD>            for (final Iterator iter = children.values().iterator(); iter</TD></TR><TR CLASS="c"><TD CLASS="l">662</TD><TD>                    .hasNext();) {</TD></TR><TR CLASS="z"><TD CLASS="l">663</TD><TD>                final LogNode childNode = (LogNode) iter.next();</TD></TR><TR CLASS="z"><TD CLASS="l">664</TD><TD>                if (childNode.logger == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">665</TD><TD>                    childNode.setParentLogger(parent);</TD></TR><TR><TD CLASS="l">666</TD><TD>                } else {</TD></TR><TR CLASS="z"><TD CLASS="l">667</TD><TD>                    doSetParentLogger(childNode.logger, parent);</TD></TR><TR><TD CLASS="l">668</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">669</TD><TD>            }</TD></TR><TR CLASS="c"><TD CLASS="l">670</TD><TD>        }</TD></TR><TR><TD CLASS="l">671</TD><TD> </TD></TR><TR><TD CLASS="l">672</TD><TD>    }</TD></TR><TR><TD CLASS="l">673</TD><TD> </TD></TR><TR><TD CLASS="l">674</TD><TD> </TD></TR><TR><TD CLASS="l">675</TD><TD>    // -------------------------------------------- ClassLoaderInfo Inner Class</TD></TR><TR><TD CLASS="l">676</TD><TD> </TD></TR><TR><TD CLASS="l">677</TD><TD> </TD></TR><TR><TD CLASS="l">678</TD><TD>    protected static final class ClassLoaderLogInfo {</TD></TR><TR><TD CLASS="l">679</TD><TD>        final LogNode rootNode;</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="22">680</A></TD><TD>        final Map&lt;String, Logger&gt; loggers = new ConcurrentHashMap&lt;String, Logger&gt;();</TD></TR><TR CLASS="c"><TD CLASS="l">681</TD><TD>        final Map&lt;String, Handler&gt; handlers = new HashMap&lt;String, Handler&gt;();</TD></TR><TR CLASS="c"><TD CLASS="l">682</TD><TD>        final Properties props = new Properties();</TD></TR><TR><TD CLASS="l">683</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">684</TD><TD>        ClassLoaderLogInfo(final LogNode rootNode) {</TD></TR><TR CLASS="c"><TD CLASS="l">685</TD><TD>            this.rootNode = rootNode;</TD></TR><TR CLASS="c"><TD CLASS="l">686</TD><TD>        }</TD></TR><TR><TD CLASS="l">687</TD><TD> </TD></TR><TR><TD CLASS="l">688</TD><TD>    }</TD></TR><TR><TD CLASS="l">689</TD><TD> </TD></TR><TR><TD CLASS="l">690</TD><TD> </TD></TR><TR><TD CLASS="l">691</TD><TD>    // ------------------------------------------------- RootLogger Inner Class</TD></TR><TR><TD CLASS="l">692</TD><TD> </TD></TR><TR><TD CLASS="l">693</TD><TD> </TD></TR><TR><TD CLASS="l">694</TD><TD>    /**</TD></TR><TR><TD CLASS="l"><A NAME="28">695</A></TD><TD>     * This class is needed to instantiate the root of each per classloader </TD></TR><TR><TD CLASS="l">696</TD><TD>     * hierarchy.</TD></TR><TR><TD CLASS="l">697</TD><TD>     */</TD></TR><TR><TD CLASS="l">698</TD><TD>    protected class RootLogger extends Logger {</TD></TR><TR CLASS="c"><TD CLASS="l">699</TD><TD>        public RootLogger() {</TD></TR><TR CLASS="c"><TD CLASS="l">700</TD><TD>            super(&#34;&#34;, null);</TD></TR><TR CLASS="c"><TD CLASS="l">701</TD><TD>        }</TD></TR><TR><TD CLASS="l">702</TD><TD>    }</TD></TR><TR><TD CLASS="l">703</TD><TD> </TD></TR><TR><TD CLASS="l">704</TD><TD> </TD></TR><TR><TD CLASS="l">705</TD><TD>}</TD></TR></TABLE><P></P><TABLE WIDTH="100%" CLASS="hdft" CELLSPACING="0"><TR><TD CLASS="nv">[<A HREF="../index.html">all classes</A>][<A HREF="64.html">org.apache.juli</A>]</TD></TR><TR><TD CLASS="tl"><A HREF="http://sourceforge.net/projects/emma">EMMA 2.1.5320 (stable)</A> (C) Vladimir Roubtsov</TD></TR></TABLE></BODY></HTML>