<HTML><HEAD><META CONTENT="text/html; charset=UTF-8" HTTP-EQUIV="Content-Type"/><TITLE>EMMA Coverage Report</TITLE><STYLE TYPE="text/css"> TABLE,TD,TH {border-style:solid; border-color:black;} TD,TH {background:white;margin:0;line-height:100%;padding-left:0.5em;padding-right:0.5em;} TD {border-width:0 1px 0 0;} TH {border-width:1px 1px 1px 0;} TR TD.h {color:red;} TABLE {border-spacing:0; border-collapse:collapse;border-width:0 0 1px 1px;} P,H1,H2,H3,TH {font-family:verdana,arial,sans-serif;font-size:10pt;} TD {font-family:courier,monospace;font-size:10pt;} TABLE.hdft {border-spacing:0;border-collapse:collapse;border-style:none;} TABLE.hdft TH,TABLE.hdft TD {border-style:none;line-height:normal;} TABLE.hdft TH.tl,TABLE.hdft TD.tl {background:#6699CC;color:white;} TABLE.hdft TD.nv {background:#6633DD;color:white;} .nv A:link {color:white;} .nv A:visited {color:white;} .nv A:active {color:yellow;} TABLE.hdft A:link {color:white;} TABLE.hdft A:visited {color:white;} TABLE.hdft A:active {color:yellow;} .in {color:#356085;} TABLE.s TD {padding-left:0.25em;padding-right:0.25em;} TABLE.s TD.l {padding-left:0.25em;padding-right:0.25em;text-align:right;background:#F0F0F0;} TABLE.s TR.z TD {background:#FF9999;} TABLE.s TR.p TD {background:#FFFF88;} TABLE.s TR.c TD {background:#CCFFCC;} A:link {color:#0000EE;text-decoration:none;} A:visited {color:#0000EE;text-decoration:none;} A:hover {color:#0000EE;text-decoration:underline;} TABLE.cn {border-width:0 0 1px 0;} TABLE.s {border-width:1px 0 1px 1px;} TD.h {color:red;border-width:0 1px 0 0;} TD.f {border-width:0 1px 0 1px;} TD.hf {color:red;border-width:0 1px 0 1px;} TH.f {border-width:1px 1px 1px 1px;} TR.cis TD {background:#F0F0F0;} TR.cis TD {border-width:1px 1px 1px 0;} TR.cis TD.h {color:red;border-width:1px 1px 1px 0;} TR.cis TD.f {border-width:1px 1px 1px 1px;} TR.cis TD.hf {color:red;border-width:1px 1px 1px 1px;} TD.b {border-style:none;background:transparent;line-height:50%;}  TD.bt {border-width:1px 0 0 0;background:transparent;line-height:50%;} TR.o TD {background:#F0F0F0;}TABLE.it {border-style:none;}TABLE.it TD,TABLE.it TH {border-style:none;}</STYLE></HEAD><BODY><TABLE WIDTH="100%" CLASS="hdft" CELLSPACING="0"><TR><TH CLASS="tl"><A HREF="http://emma.sourceforge.net/">EMMA</A> Coverage Report (generated Thu Nov 16 15:09:53 CET 2017)</TH></TR><TR><TD CLASS="nv">[<A HREF="../index.html">all classes</A>][<A HREF="13.html">org.apache.catalina.servlets</A>]</TD></TR></TABLE><H2>COVERAGE SUMMARY FOR SOURCE FILE [<SPAN CLASS="in">CGIServlet.java</SPAN>]</H2><TABLE WIDTH="100%" CELLSPACING="0"><TR><TH>name</TH><TH>class, %</TH><TH>method, %</TH><TH>block, %</TH><TH>line, %</TH></TR><TR><TD>CGIServlet.java</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/50)</TD><TD CLASS="h">0%   (0/3087)</TD><TD CLASS="h">0%   (0/616)</TD></TR></TABLE><H3>COVERAGE BREAKDOWN BY CLASS AND METHOD</H3><TABLE WIDTH="100%" CLASS="cn" CELLSPACING="0"><TR><TH CLASS="f">name</TH><TH>class, %</TH><TH>method, %</TH><TH>block, %</TH><TH>line, %</TH></TR><TR><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#0">CGIServlet</A></TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/20)</TD><TD CLASS="h">0%   (0/1061)</TD><TD CLASS="h">0%   (0/163)</TD></TR><TR><TD CLASS="f"><A HREF="#1">&lt;static initializer&gt;</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/14)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#0">CGIServlet (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/29)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR><TD CLASS="f"><A HREF="#0">access$000 (CGIServlet): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#0">access$100 (): Log</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/2)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#0">access$1100 (CGIServlet, HttpServletResponse, int): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#0">access$1200 (CGIServlet): long</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#0">access$200 (): StringManager</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/2)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#0">access$300 (CGIServlet): Hashtable</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#0">access$400 (CGIServlet): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#0">access$500 (CGIServlet): Pattern</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#0">access$600 (): Object</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/2)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#0">access$700 (): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/2)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#0">access$800 (CGIServlet): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#0">access$900 (CGIServlet): List</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#f">doGet (HttpServletRequest, HttpServletResponse): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/82)</TD><TD CLASS="h">0%   (0/20)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#10">doPost (HttpServletRequest, HttpServletResponse): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#11">init (ServletConfig): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/120)</TD><TD CLASS="h">0%   (0/29)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#12">printServletEnvironment (HttpServletRequest): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/760)</TD><TD CLASS="h">0%   (0/92)</TD></TR><TR><TD CLASS="f"><A HREF="#13">printServletEnvironment (ServletOutputStream, HttpServletRequest, HttpServlet...</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#14">setStatus (HttpServletResponse, int): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/13)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#15">CGIServlet$CGIEnvironment</A></TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/15)</TD><TD CLASS="h">0%   (0/1223)</TD><TD CLASS="h">0%   (0/257)</TD></TR><TR><TD CLASS="f"><A HREF="#15">CGIServlet$CGIEnvironment (CGIServlet, HttpServletRequest, ServletContext): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/66)</TD><TD CLASS="h">0%   (0/18)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#17">blanksToString (String, String): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/10)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#18">expandCGIScript (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/252)</TD><TD CLASS="h">0%   (0/56)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#19">findCGI (String, String, String, String, String): String []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/228)</TD><TD CLASS="h">0%   (0/37)</TD></TR><TR><TD CLASS="f"><A HREF="#1a">getCommand (): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1b">getEnvironment (): Hashtable</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#1c">getParameters (): ArrayList</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1d">getWorkingDirectory (): File</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#1e">isValid (): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1f">nullsToBlanks (String): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#20">nullsToString (String, String): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/6)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#21">setCGIEnvironment (HttpServletRequest): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/329)</TD><TD CLASS="h">0%   (0/66)</TD></TR><TR><TD CLASS="f"><A HREF="#22">setupFromContext (ServletContext): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/15)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#23">setupFromRequest (HttpServletRequest): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/102)</TD><TD CLASS="h">0%   (0/24)</TD></TR><TR><TD CLASS="f"><A HREF="#24">toString (): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/195)</TD><TD CLASS="h">0%   (0/44)</TD></TR><TR><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#25">CGIServlet$CGIRunner</A></TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/11)</TD><TD CLASS="h">0%   (0/728)</TD><TD CLASS="h">0%   (0/169)</TD></TR><TR><TD CLASS="f"><A HREF="#26">CGIServlet$CGIRunner (CGIServlet, String, Hashtable, File, ArrayList): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/29)</TD><TD CLASS="h">0%   (0/10)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#25">access$1000 (CGIServlet$CGIRunner, BufferedReader): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/4)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#28">getSCFromCGIStatusHeader (String): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/42)</TD><TD CLASS="h">0%   (0/10)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#29">getSCFromHttpStatusLine (String): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/55)</TD><TD CLASS="h">0%   (0/11)</TD></TR><TR><TD CLASS="f"><A HREF="#2a">hashToStringArray (Hashtable): String []</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/40)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2b">isReady (): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#2c">run (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/456)</TD><TD CLASS="h">0%   (0/100)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2d">sendToLog (BufferedReader): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/64)</TD><TD CLASS="h">0%   (0/17)</TD></TR><TR><TD CLASS="f"><A HREF="#2e">setInput (InputStream): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/6)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2f">setResponse (HttpServletResponse): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/6)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR><TD CLASS="f"><A HREF="#30">updateReadyStatus (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/23)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#31">CGIServlet$CGIRunner$1</A></TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/2)</TD><TD CLASS="h">0%   (0/15)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR><TD CLASS="f"><A HREF="#31">CGIServlet$CGIRunner$1 (CGIServlet$CGIRunner, BufferedReader): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/9)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#33">run (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/6)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#34">CGIServlet$HTTPHeaderInputStream</A></TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/2)</TD><TD CLASS="h">0%   (0/60)</TD><TD CLASS="h">0%   (0/25)</TD></TR><TR><TD CLASS="f"><A HREF="#34">CGIServlet$HTTPHeaderInputStream (InputStream): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/9)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#36">read (): int</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/51)</TD><TD CLASS="h">0%   (0/21)</TD></TR></TABLE><P></P><TABLE WIDTH="100%" CLASS="s" CELLSPACING="0"><TR><TD CLASS="l">1</TD><TD>/*</TD></TR><TR><TD CLASS="l">2</TD><TD> * Licensed to the Apache Software Foundation (ASF) under one or more</TD></TR><TR><TD CLASS="l">3</TD><TD> * contributor license agreements.  See the NOTICE file distributed with</TD></TR><TR><TD CLASS="l">4</TD><TD> * this work for additional information regarding copyright ownership.</TD></TR><TR><TD CLASS="l">5</TD><TD> * The ASF licenses this file to You under the Apache License, Version 2.0</TD></TR><TR><TD CLASS="l">6</TD><TD> * (the &#34;License&#34;); you may not use this file except in compliance with</TD></TR><TR><TD CLASS="l">7</TD><TD> * the License.  You may obtain a copy of the License at</TD></TR><TR><TD CLASS="l">8</TD><TD> *</TD></TR><TR><TD CLASS="l">9</TD><TD> *      http://www.apache.org/licenses/LICENSE-2.0</TD></TR><TR><TD CLASS="l">10</TD><TD> *</TD></TR><TR><TD CLASS="l">11</TD><TD> * Unless required by applicable law or agreed to in writing, software</TD></TR><TR><TD CLASS="l">12</TD><TD> * distributed under the License is distributed on an &#34;AS IS&#34; BASIS,</TD></TR><TR><TD CLASS="l">13</TD><TD> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</TD></TR><TR><TD CLASS="l">14</TD><TD> * See the License for the specific language governing permissions and</TD></TR><TR><TD CLASS="l">15</TD><TD> * limitations under the License.</TD></TR><TR><TD CLASS="l">16</TD><TD> */</TD></TR><TR><TD CLASS="l">17</TD><TD>package org.apache.catalina.servlets;</TD></TR><TR><TD CLASS="l">18</TD><TD> </TD></TR><TR><TD CLASS="l">19</TD><TD>import java.io.BufferedOutputStream;</TD></TR><TR><TD CLASS="l">20</TD><TD>import java.io.BufferedReader;</TD></TR><TR><TD CLASS="l">21</TD><TD>import java.io.File;</TD></TR><TR><TD CLASS="l">22</TD><TD>import java.io.FileOutputStream;</TD></TR><TR><TD CLASS="l">23</TD><TD>import java.io.IOException;</TD></TR><TR><TD CLASS="l">24</TD><TD>import java.io.InputStream;</TD></TR><TR><TD CLASS="l">25</TD><TD>import java.io.InputStreamReader;</TD></TR><TR><TD CLASS="l">26</TD><TD>import java.io.OutputStream;</TD></TR><TR><TD CLASS="l">27</TD><TD>import java.io.UnsupportedEncodingException;</TD></TR><TR><TD CLASS="l">28</TD><TD>import java.net.URLDecoder;</TD></TR><TR><TD CLASS="l">29</TD><TD>import java.util.ArrayList;</TD></TR><TR><TD CLASS="l">30</TD><TD>import java.util.Date;</TD></TR><TR><TD CLASS="l">31</TD><TD>import java.util.Enumeration;</TD></TR><TR><TD CLASS="l">32</TD><TD>import java.util.Hashtable;</TD></TR><TR><TD CLASS="l">33</TD><TD>import java.util.List;</TD></TR><TR><TD CLASS="l">34</TD><TD>import java.util.Locale;</TD></TR><TR><TD CLASS="l">35</TD><TD>import java.util.Map.Entry;</TD></TR><TR><TD CLASS="l">36</TD><TD>import java.util.StringTokenizer;</TD></TR><TR><TD CLASS="l">37</TD><TD>import java.util.Vector;</TD></TR><TR><TD CLASS="l">38</TD><TD>import java.util.regex.Pattern;</TD></TR><TR><TD CLASS="l">39</TD><TD> </TD></TR><TR><TD CLASS="l">40</TD><TD>import javax.servlet.RequestDispatcher;</TD></TR><TR><TD CLASS="l">41</TD><TD>import javax.servlet.ServletConfig;</TD></TR><TR><TD CLASS="l">42</TD><TD>import javax.servlet.ServletContext;</TD></TR><TR><TD CLASS="l">43</TD><TD>import javax.servlet.ServletException;</TD></TR><TR><TD CLASS="l">44</TD><TD>import javax.servlet.ServletOutputStream;</TD></TR><TR><TD CLASS="l">45</TD><TD>import javax.servlet.UnavailableException;</TD></TR><TR><TD CLASS="l">46</TD><TD>import javax.servlet.http.Cookie;</TD></TR><TR><TD CLASS="l">47</TD><TD>import javax.servlet.http.HttpServlet;</TD></TR><TR><TD CLASS="l">48</TD><TD>import javax.servlet.http.HttpServletRequest;</TD></TR><TR><TD CLASS="l">49</TD><TD>import javax.servlet.http.HttpServletResponse;</TD></TR><TR><TD CLASS="l">50</TD><TD>import javax.servlet.http.HttpSession;</TD></TR><TR><TD CLASS="l">51</TD><TD> </TD></TR><TR><TD CLASS="l">52</TD><TD>import org.apache.catalina.Globals;</TD></TR><TR><TD CLASS="l">53</TD><TD>import org.apache.catalina.util.IOTools;</TD></TR><TR><TD CLASS="l">54</TD><TD>import org.apache.juli.logging.Log;</TD></TR><TR><TD CLASS="l">55</TD><TD>import org.apache.juli.logging.LogFactory;</TD></TR><TR><TD CLASS="l">56</TD><TD>import org.apache.tomcat.util.res.StringManager;</TD></TR><TR><TD CLASS="l">57</TD><TD> </TD></TR><TR><TD CLASS="l">58</TD><TD> </TD></TR><TR><TD CLASS="l">59</TD><TD>/**</TD></TR><TR><TD CLASS="l">60</TD><TD> *  CGI-invoking servlet for web applications, used to execute scripts which</TD></TR><TR><TD CLASS="l">61</TD><TD> *  comply to the Common Gateway Interface (CGI) specification and are named</TD></TR><TR><TD CLASS="l">62</TD><TD> *  in the path-info used to invoke this servlet.</TD></TR><TR><TD CLASS="l">63</TD><TD> *</TD></TR><TR><TD CLASS="l">64</TD><TD> * &lt;p&gt;</TD></TR><TR><TD CLASS="l">65</TD><TD> * &lt;i&gt;Note: This code compiles and even works for simple CGI cases.</TD></TR><TR><TD CLASS="l">66</TD><TD> *          Exhaustive testing has not been done.  Please consider it beta</TD></TR><TR><TD CLASS="l">67</TD><TD> *          quality.  Feedback is appreciated to the author (see below).&lt;/i&gt;</TD></TR><TR><TD CLASS="l">68</TD><TD> * &lt;/p&gt;</TD></TR><TR><TD CLASS="l">69</TD><TD> * &lt;p&gt;</TD></TR><TR><TD CLASS="l">70</TD><TD> *</TD></TR><TR><TD CLASS="l">71</TD><TD> * &lt;b&gt;Example&lt;/b&gt;:&lt;br&gt;</TD></TR><TR><TD CLASS="l">72</TD><TD> * If an instance of this servlet was mapped (using</TD></TR><TR><TD CLASS="l">73</TD><TD> *       &lt;code&gt;&amp;lt;web-app&amp;gt;/WEB-INF/web.xml&lt;/code&gt;) to:</TD></TR><TR><TD CLASS="l">74</TD><TD> * &lt;/p&gt;</TD></TR><TR><TD CLASS="l">75</TD><TD> * &lt;p&gt;</TD></TR><TR><TD CLASS="l">76</TD><TD> * &lt;code&gt;</TD></TR><TR><TD CLASS="l">77</TD><TD> * &amp;lt;web-app&amp;gt;/cgi-bin/*</TD></TR><TR><TD CLASS="l">78</TD><TD> * &lt;/code&gt;</TD></TR><TR><TD CLASS="l">79</TD><TD> * &lt;/p&gt;</TD></TR><TR><TD CLASS="l">80</TD><TD> * &lt;p&gt;</TD></TR><TR><TD CLASS="l">81</TD><TD> * then the following request:</TD></TR><TR><TD CLASS="l">82</TD><TD> * &lt;/p&gt;</TD></TR><TR><TD CLASS="l">83</TD><TD> * &lt;p&gt;</TD></TR><TR><TD CLASS="l">84</TD><TD> * &lt;code&gt;</TD></TR><TR><TD CLASS="l">85</TD><TD> * http://localhost:8080/&amp;lt;web-app&amp;gt;/cgi-bin/dir1/script/pathinfo1</TD></TR><TR><TD CLASS="l">86</TD><TD> * &lt;/code&gt;</TD></TR><TR><TD CLASS="l">87</TD><TD> * &lt;/p&gt;</TD></TR><TR><TD CLASS="l">88</TD><TD> * &lt;p&gt;</TD></TR><TR><TD CLASS="l">89</TD><TD> * would result in the execution of the script</TD></TR><TR><TD CLASS="l">90</TD><TD> * &lt;/p&gt;</TD></TR><TR><TD CLASS="l">91</TD><TD> * &lt;p&gt;</TD></TR><TR><TD CLASS="l">92</TD><TD> * &lt;code&gt;</TD></TR><TR><TD CLASS="l">93</TD><TD> * &amp;lt;web-app-root&amp;gt;/WEB-INF/cgi/dir1/script</TD></TR><TR><TD CLASS="l">94</TD><TD> * &lt;/code&gt;</TD></TR><TR><TD CLASS="l">95</TD><TD> * &lt;/p&gt;</TD></TR><TR><TD CLASS="l">96</TD><TD> * &lt;p&gt;</TD></TR><TR><TD CLASS="l">97</TD><TD> * with the script's &lt;code&gt;PATH_INFO&lt;/code&gt; set to &lt;code&gt;/pathinfo1&lt;/code&gt;.</TD></TR><TR><TD CLASS="l">98</TD><TD> * &lt;/p&gt;</TD></TR><TR><TD CLASS="l">99</TD><TD> * &lt;p&gt;</TD></TR><TR><TD CLASS="l">100</TD><TD> * Recommendation:  House all your CGI scripts under</TD></TR><TR><TD CLASS="l">101</TD><TD> * &lt;code&gt;&amp;lt;webapp&amp;gt;/WEB-INF/cgi&lt;/code&gt;.  This will ensure that you do not</TD></TR><TR><TD CLASS="l">102</TD><TD> * accidentally expose your cgi scripts' code to the outside world and that</TD></TR><TR><TD CLASS="l">103</TD><TD> * your cgis will be cleanly ensconced underneath the WEB-INF (i.e.,</TD></TR><TR><TD CLASS="l">104</TD><TD> * non-content) area.</TD></TR><TR><TD CLASS="l">105</TD><TD> * &lt;/p&gt;</TD></TR><TR><TD CLASS="l">106</TD><TD> * &lt;p&gt;</TD></TR><TR><TD CLASS="l">107</TD><TD> * The default CGI location is mentioned above.  You have the flexibility to</TD></TR><TR><TD CLASS="l">108</TD><TD> * put CGIs wherever you want, however:</TD></TR><TR><TD CLASS="l">109</TD><TD> * &lt;/p&gt;</TD></TR><TR><TD CLASS="l">110</TD><TD> * &lt;p&gt;</TD></TR><TR><TD CLASS="l">111</TD><TD> *   The CGI search path will start at</TD></TR><TR><TD CLASS="l">112</TD><TD> *   webAppRootDir + File.separator + cgiPathPrefix</TD></TR><TR><TD CLASS="l">113</TD><TD> *   (or webAppRootDir alone if cgiPathPrefix is</TD></TR><TR><TD CLASS="l">114</TD><TD> *   null).</TD></TR><TR><TD CLASS="l">115</TD><TD> * &lt;/p&gt;</TD></TR><TR><TD CLASS="l">116</TD><TD> * &lt;p&gt;</TD></TR><TR><TD CLASS="l">117</TD><TD> *   cgiPathPrefix is defined by setting</TD></TR><TR><TD CLASS="l">118</TD><TD> *   this servlet's cgiPathPrefix init parameter</TD></TR><TR><TD CLASS="l">119</TD><TD> * &lt;/p&gt;</TD></TR><TR><TD CLASS="l">120</TD><TD> *</TD></TR><TR><TD CLASS="l">121</TD><TD> * &lt;p&gt;</TD></TR><TR><TD CLASS="l">122</TD><TD> *</TD></TR><TR><TD CLASS="l">123</TD><TD> * &lt;B&gt;CGI Specification&lt;/B&gt;:&lt;br&gt; derived from</TD></TR><TR><TD CLASS="l">124</TD><TD> * &lt;a href=&#34;http://cgi-spec.golux.com&#34;&gt;http://cgi-spec.golux.com&lt;/a&gt;.</TD></TR><TR><TD CLASS="l">125</TD><TD> * A work-in-progress &amp;amp; expired Internet Draft.  Note no actual RFC describing</TD></TR><TR><TD CLASS="l">126</TD><TD> * the CGI specification exists.  Where the behavior of this servlet differs</TD></TR><TR><TD CLASS="l">127</TD><TD> * from the specification cited above, it is either documented here, a bug,</TD></TR><TR><TD CLASS="l">128</TD><TD> * or an instance where the specification cited differs from Best</TD></TR><TR><TD CLASS="l">129</TD><TD> * Community Practice (BCP).</TD></TR><TR><TD CLASS="l">130</TD><TD> * Such instances should be well-documented here.  Please email the</TD></TR><TR><TD CLASS="l">131</TD><TD> * &lt;a href=&#34;http://tomcat.apache.org/lists.html&#34;&gt;Tomcat group&lt;/a&gt;</TD></TR><TR><TD CLASS="l">132</TD><TD> * with amendments.</TD></TR><TR><TD CLASS="l">133</TD><TD> *</TD></TR><TR><TD CLASS="l">134</TD><TD> * &lt;/p&gt;</TD></TR><TR><TD CLASS="l">135</TD><TD> * &lt;p&gt;</TD></TR><TR><TD CLASS="l">136</TD><TD> *</TD></TR><TR><TD CLASS="l">137</TD><TD> * &lt;b&gt;Canonical metavariables&lt;/b&gt;:&lt;br&gt;</TD></TR><TR><TD CLASS="l">138</TD><TD> * The CGI specification defines the following canonical metavariables:</TD></TR><TR><TD CLASS="l">139</TD><TD> * &lt;br&gt;</TD></TR><TR><TD CLASS="l">140</TD><TD> * [excerpt from CGI specification]</TD></TR><TR><TD CLASS="l">141</TD><TD> * &lt;PRE&gt;</TD></TR><TR><TD CLASS="l">142</TD><TD> *  AUTH_TYPE</TD></TR><TR><TD CLASS="l">143</TD><TD> *  CONTENT_LENGTH</TD></TR><TR><TD CLASS="l">144</TD><TD> *  CONTENT_TYPE</TD></TR><TR><TD CLASS="l">145</TD><TD> *  GATEWAY_INTERFACE</TD></TR><TR><TD CLASS="l">146</TD><TD> *  PATH_INFO</TD></TR><TR><TD CLASS="l">147</TD><TD> *  PATH_TRANSLATED</TD></TR><TR><TD CLASS="l">148</TD><TD> *  QUERY_STRING</TD></TR><TR><TD CLASS="l">149</TD><TD> *  REMOTE_ADDR</TD></TR><TR><TD CLASS="l">150</TD><TD> *  REMOTE_HOST</TD></TR><TR><TD CLASS="l">151</TD><TD> *  REMOTE_IDENT</TD></TR><TR><TD CLASS="l">152</TD><TD> *  REMOTE_USER</TD></TR><TR><TD CLASS="l">153</TD><TD> *  REQUEST_METHOD</TD></TR><TR><TD CLASS="l">154</TD><TD> *  SCRIPT_NAME</TD></TR><TR><TD CLASS="l">155</TD><TD> *  SERVER_NAME</TD></TR><TR><TD CLASS="l">156</TD><TD> *  SERVER_PORT</TD></TR><TR><TD CLASS="l">157</TD><TD> *  SERVER_PROTOCOL</TD></TR><TR><TD CLASS="l">158</TD><TD> *  SERVER_SOFTWARE</TD></TR><TR><TD CLASS="l">159</TD><TD> * &lt;/PRE&gt;</TD></TR><TR><TD CLASS="l">160</TD><TD> * &lt;p&gt;</TD></TR><TR><TD CLASS="l">161</TD><TD> * Metavariables with names beginning with the protocol name (&lt;EM&gt;e.g.&lt;/EM&gt;,</TD></TR><TR><TD CLASS="l">162</TD><TD> * &#34;HTTP_ACCEPT&#34;) are also canonical in their description of request header</TD></TR><TR><TD CLASS="l">163</TD><TD> * fields.  The number and meaning of these fields may change independently</TD></TR><TR><TD CLASS="l">164</TD><TD> * of this specification.  (See also section 6.1.5 [of the CGI specification].)</TD></TR><TR><TD CLASS="l">165</TD><TD> * &lt;/p&gt;</TD></TR><TR><TD CLASS="l">166</TD><TD> * [end excerpt]</TD></TR><TR><TD CLASS="l">167</TD><TD> *</TD></TR><TR><TD CLASS="l">168</TD><TD> * &lt;h2&gt; Implementation notes&lt;/h2&gt;</TD></TR><TR><TD CLASS="l">169</TD><TD> * &lt;p&gt;</TD></TR><TR><TD CLASS="l">170</TD><TD> *</TD></TR><TR><TD CLASS="l">171</TD><TD> * &lt;b&gt;standard input handling&lt;/b&gt;: If your script accepts standard input,</TD></TR><TR><TD CLASS="l">172</TD><TD> * then the client must start sending input within a certain timeout period,</TD></TR><TR><TD CLASS="l">173</TD><TD> * otherwise the servlet will assume no input is coming and carry on running</TD></TR><TR><TD CLASS="l">174</TD><TD> * the script.  The script's the standard input will be closed and handling of</TD></TR><TR><TD CLASS="l">175</TD><TD> * any further input from the client is undefined.  Most likely it will be</TD></TR><TR><TD CLASS="l">176</TD><TD> * ignored.  If this behavior becomes undesirable, then this servlet needs</TD></TR><TR><TD CLASS="l">177</TD><TD> * to be enhanced to handle threading of the spawned process' stdin, stdout,</TD></TR><TR><TD CLASS="l">178</TD><TD> * and stderr (which should not be too hard).</TD></TR><TR><TD CLASS="l">179</TD><TD> * &lt;br&gt;</TD></TR><TR><TD CLASS="l">180</TD><TD> * If you find your cgi scripts are timing out receiving input, you can set</TD></TR><TR><TD CLASS="l">181</TD><TD> * the init parameter &lt;code&gt;stderrTimeout&lt;/code&gt; of your webapps' cgi-handling</TD></TR><TR><TD CLASS="l">182</TD><TD> * servlet.</TD></TR><TR><TD CLASS="l">183</TD><TD> * &lt;/p&gt;</TD></TR><TR><TD CLASS="l">184</TD><TD> * &lt;p&gt;</TD></TR><TR><TD CLASS="l">185</TD><TD> *</TD></TR><TR><TD CLASS="l">186</TD><TD> * &lt;b&gt;Metavariable Values&lt;/b&gt;: According to the CGI specification,</TD></TR><TR><TD CLASS="l">187</TD><TD> * implementations may choose to represent both null or missing values in an</TD></TR><TR><TD CLASS="l">188</TD><TD> * implementation-specific manner, but must define that manner.  This</TD></TR><TR><TD CLASS="l">189</TD><TD> * implementation chooses to always define all required metavariables, but</TD></TR><TR><TD CLASS="l">190</TD><TD> * set the value to &#34;&#34; for all metavariables whose value is either null or</TD></TR><TR><TD CLASS="l">191</TD><TD> * undefined.  PATH_TRANSLATED is the sole exception to this rule, as per the</TD></TR><TR><TD CLASS="l">192</TD><TD> * CGI Specification.</TD></TR><TR><TD CLASS="l">193</TD><TD> *</TD></TR><TR><TD CLASS="l">194</TD><TD> * &lt;/p&gt;</TD></TR><TR><TD CLASS="l">195</TD><TD> * &lt;p&gt;</TD></TR><TR><TD CLASS="l">196</TD><TD> *</TD></TR><TR><TD CLASS="l">197</TD><TD> * &lt;b&gt;NPH --  Non-parsed-header implementation&lt;/b&gt;:  This implementation does</TD></TR><TR><TD CLASS="l">198</TD><TD> * not support the CGI NPH concept, whereby server ensures that the data</TD></TR><TR><TD CLASS="l">199</TD><TD> * supplied to the script are precisely as supplied by the client and</TD></TR><TR><TD CLASS="l">200</TD><TD> * unaltered by the server.</TD></TR><TR><TD CLASS="l">201</TD><TD> * &lt;/p&gt;</TD></TR><TR><TD CLASS="l">202</TD><TD> * &lt;p&gt;</TD></TR><TR><TD CLASS="l">203</TD><TD> * The function of a servlet container (including Tomcat) is specifically</TD></TR><TR><TD CLASS="l">204</TD><TD> * designed to parse and possible alter CGI-specific variables, and as</TD></TR><TR><TD CLASS="l">205</TD><TD> * such makes NPH functionality difficult to support.</TD></TR><TR><TD CLASS="l">206</TD><TD> * &lt;/p&gt;</TD></TR><TR><TD CLASS="l">207</TD><TD> * &lt;p&gt;</TD></TR><TR><TD CLASS="l">208</TD><TD> * The CGI specification states that compliant servers MAY support NPH output.</TD></TR><TR><TD CLASS="l">209</TD><TD> * It does not state servers MUST support NPH output to be unconditionally</TD></TR><TR><TD CLASS="l">210</TD><TD> * compliant.  Thus, this implementation maintains unconditional compliance</TD></TR><TR><TD CLASS="l">211</TD><TD> * with the specification though NPH support is not present.</TD></TR><TR><TD CLASS="l">212</TD><TD> * &lt;/p&gt;</TD></TR><TR><TD CLASS="l">213</TD><TD> * &lt;p&gt;</TD></TR><TR><TD CLASS="l">214</TD><TD> *</TD></TR><TR><TD CLASS="l">215</TD><TD> * The CGI specification is located at</TD></TR><TR><TD CLASS="l">216</TD><TD> * &lt;a href=&#34;http://cgi-spec.golux.com&#34;&gt;http://cgi-spec.golux.com&lt;/a&gt;.</TD></TR><TR><TD CLASS="l">217</TD><TD> *</TD></TR><TR><TD CLASS="l">218</TD><TD> * &lt;/p&gt;</TD></TR><TR><TD CLASS="l">219</TD><TD> * &lt;h3&gt;TODO:&lt;/h3&gt;</TD></TR><TR><TD CLASS="l">220</TD><TD> * &lt;ul&gt;</TD></TR><TR><TD CLASS="l">221</TD><TD> * &lt;li&gt; Support for setting headers (for example, Location headers don't work)</TD></TR><TR><TD CLASS="l">222</TD><TD> * &lt;li&gt; Support for collapsing multiple header lines (per RFC 2616)</TD></TR><TR><TD CLASS="l">223</TD><TD> * &lt;li&gt; Ensure handling of POST method does not interfere with 2.3 Filters</TD></TR><TR><TD CLASS="l">224</TD><TD> * &lt;li&gt; Refactor some debug code out of core</TD></TR><TR><TD CLASS="l">225</TD><TD> * &lt;li&gt; Ensure header handling preserves encoding</TD></TR><TR><TD CLASS="l">226</TD><TD> * &lt;li&gt; Possibly rewrite CGIRunner.run()?</TD></TR><TR><TD CLASS="l">227</TD><TD> * &lt;li&gt; Possibly refactor CGIRunner and CGIEnvironment as non-inner classes?</TD></TR><TR><TD CLASS="l">228</TD><TD> * &lt;li&gt; Document handling of cgi stdin when there is no stdin</TD></TR><TR><TD CLASS="l">229</TD><TD> * &lt;li&gt; Revisit IOException handling in CGIRunner.run()</TD></TR><TR><TD CLASS="l">230</TD><TD> * &lt;li&gt; Better documentation</TD></TR><TR><TD CLASS="l">231</TD><TD> * &lt;li&gt; Confirm use of ServletInputStream.available() in CGIRunner.run() is</TD></TR><TR><TD CLASS="l">232</TD><TD> *      not needed</TD></TR><TR><TD CLASS="l">233</TD><TD> * &lt;li&gt; [add more to this TODO list]</TD></TR><TR><TD CLASS="l">234</TD><TD> * &lt;/ul&gt;</TD></TR><TR><TD CLASS="l"><A NAME="0">235</A></TD><TD> *</TD></TR><TR><TD CLASS="l">236</TD><TD> * @author Martin T Dengler [root@martindengler.com]</TD></TR><TR><TD CLASS="l"><A NAME="1">237</A></TD><TD> * @author Amy Roh</TD></TR><TR><TD CLASS="l">238</TD><TD> */</TD></TR><TR CLASS="z"><TD CLASS="l">239</TD><TD>public final class CGIServlet extends HttpServlet {</TD></TR><TR><TD CLASS="l">240</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">241</TD><TD>    private static final Log log = LogFactory.getLog(CGIServlet.class);</TD></TR><TR CLASS="z"><TD CLASS="l">242</TD><TD>    private static final StringManager sm = StringManager.getManager(Constants.Package);</TD></TR><TR><TD CLASS="l">243</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">244</TD><TD>    private static final String LINE_SEP = System.getProperty(&#34;line.separator&#34;);</TD></TR><TR><TD CLASS="l">245</TD><TD>    </TD></TR><TR><TD CLASS="l">246</TD><TD>    /* some vars below copied from Craig R. McClanahan's InvokerServlet */</TD></TR><TR><TD CLASS="l">247</TD><TD> </TD></TR><TR><TD CLASS="l">248</TD><TD>    private static final long serialVersionUID = 1L;</TD></TR><TR><TD CLASS="l">249</TD><TD> </TD></TR><TR><TD CLASS="l">250</TD><TD>    /**</TD></TR><TR><TD CLASS="l">251</TD><TD>     *  The CGI search path will start at</TD></TR><TR><TD CLASS="l">252</TD><TD>     *    webAppRootDir + File.separator + cgiPathPrefix</TD></TR><TR><TD CLASS="l">253</TD><TD>     *    (or webAppRootDir alone if cgiPathPrefix is</TD></TR><TR><TD CLASS="l">254</TD><TD>     *    null)</TD></TR><TR><TD CLASS="l">255</TD><TD>     */</TD></TR><TR CLASS="z"><TD CLASS="l">256</TD><TD>    private String cgiPathPrefix = null;</TD></TR><TR><TD CLASS="l">257</TD><TD> </TD></TR><TR><TD CLASS="l">258</TD><TD>    /** the executable to use with the script */</TD></TR><TR CLASS="z"><TD CLASS="l">259</TD><TD>    private String cgiExecutable = &#34;perl&#34;;</TD></TR><TR><TD CLASS="l">260</TD><TD> </TD></TR><TR><TD CLASS="l">261</TD><TD>    /** additional arguments for the executable */</TD></TR><TR CLASS="z"><TD CLASS="l">262</TD><TD>    private List&lt;String&gt; cgiExecutableArgs = null;</TD></TR><TR><TD CLASS="l">263</TD><TD> </TD></TR><TR><TD CLASS="l">264</TD><TD>    /** the encoding to use for parameters */</TD></TR><TR CLASS="z"><TD CLASS="l">265</TD><TD>    private String parameterEncoding =</TD></TR><TR CLASS="z"><TD CLASS="l">266</TD><TD>        System.getProperty(&#34;file.encoding&#34;, &#34;UTF-8&#34;);</TD></TR><TR><TD CLASS="l">267</TD><TD> </TD></TR><TR><TD CLASS="l">268</TD><TD>    /**</TD></TR><TR><TD CLASS="l">269</TD><TD>     * The time (in milliseconds) to wait for the reading of stderr to complete</TD></TR><TR><TD CLASS="l">270</TD><TD>     * before terminating the CGI process.</TD></TR><TR><TD CLASS="l">271</TD><TD>     */</TD></TR><TR CLASS="z"><TD CLASS="l">272</TD><TD>    private long stderrTimeout = 2000;</TD></TR><TR><TD CLASS="l">273</TD><TD> </TD></TR><TR><TD CLASS="l">274</TD><TD>    /**</TD></TR><TR><TD CLASS="l">275</TD><TD>     * The regular expression used to select HTTP headers to be passed to the</TD></TR><TR><TD CLASS="l">276</TD><TD>     * CGI process as environment variables. The name of the environment</TD></TR><TR><TD CLASS="l">277</TD><TD>     * variable will be the name of the HTTP header converter to upper case,</TD></TR><TR><TD CLASS="l">278</TD><TD>     * prefixed with &lt;code&gt;HTTP_&lt;/code&gt; and with all &lt;code&gt;-&lt;/code&gt; characters</TD></TR><TR><TD CLASS="l">279</TD><TD>     * converted to &lt;code&gt;_&lt;/code&gt;.</TD></TR><TR><TD CLASS="l">280</TD><TD>     */</TD></TR><TR CLASS="z"><TD CLASS="l">281</TD><TD>    private Pattern envHttpHeadersPattern = Pattern.compile(</TD></TR><TR><TD CLASS="l">282</TD><TD>            &#34;ACCEPT[-0-9A-Z]*|CACHE-CONTROL|COOKIE|HOST|IF-[-0-9A-Z]*|REFERER|USER-AGENT&#34;);</TD></TR><TR><TD CLASS="l">283</TD><TD> </TD></TR><TR><TD CLASS="l">284</TD><TD>    /** object used to ensure multiple threads don't try to expand same file */</TD></TR><TR CLASS="z"><TD CLASS="l">285</TD><TD>    private static final Object expandFileLock = new Object();</TD></TR><TR><TD CLASS="l">286</TD><TD> </TD></TR><TR><TD CLASS="l">287</TD><TD>    /** the shell environment variables to be passed to the CGI script */</TD></TR><TR CLASS="z"><TD CLASS="l">288</TD><TD>    private final Hashtable&lt;String,String&gt; shellEnv = new Hashtable&lt;String,String&gt;();</TD></TR><TR><TD CLASS="l">289</TD><TD> </TD></TR><TR><TD CLASS="l">290</TD><TD>    /**</TD></TR><TR><TD CLASS="l">291</TD><TD>     * Sets instance variables.</TD></TR><TR><TD CLASS="l">292</TD><TD>     * &lt;P&gt;</TD></TR><TR><TD CLASS="l">293</TD><TD>     * Modified from Craig R. McClanahan's InvokerServlet</TD></TR><TR><TD CLASS="l">294</TD><TD>     * &lt;/P&gt;</TD></TR><TR><TD CLASS="l">295</TD><TD>     *</TD></TR><TR><TD CLASS="l">296</TD><TD>     * @param config                    a &lt;code&gt;ServletConfig&lt;/code&gt; object</TD></TR><TR><TD CLASS="l">297</TD><TD>     *                                  containing the servlet's</TD></TR><TR><TD CLASS="l">298</TD><TD>     *                                  configuration and initialization</TD></TR><TR><TD CLASS="l">299</TD><TD>     *                                  parameters</TD></TR><TR><TD CLASS="l">300</TD><TD>     *</TD></TR><TR><TD CLASS="l">301</TD><TD>     * @exception ServletException      if an exception has occurred that</TD></TR><TR><TD CLASS="l">302</TD><TD>     *                                  interferes with the servlet's normal</TD></TR><TR><TD CLASS="l">303</TD><TD>     *                                  operation</TD></TR><TR><TD CLASS="l"><A NAME="11">304</A></TD><TD>     */</TD></TR><TR><TD CLASS="l">305</TD><TD>    @Override</TD></TR><TR><TD CLASS="l">306</TD><TD>    public void init(ServletConfig config) throws ServletException {</TD></TR><TR><TD CLASS="l">307</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">308</TD><TD>        super.init(config);</TD></TR><TR><TD CLASS="l">309</TD><TD> </TD></TR><TR><TD CLASS="l">310</TD><TD>        // Verify that we were not accessed using the invoker servlet</TD></TR><TR CLASS="z"><TD CLASS="l">311</TD><TD>        String servletName = getServletConfig().getServletName();</TD></TR><TR CLASS="z"><TD CLASS="l">312</TD><TD>        if (servletName == null)</TD></TR><TR CLASS="z"><TD CLASS="l">313</TD><TD>            servletName = &#34;&#34;;</TD></TR><TR CLASS="z"><TD CLASS="l">314</TD><TD>        if (servletName.startsWith(&#34;org.apache.catalina.INVOKER.&#34;))</TD></TR><TR CLASS="z"><TD CLASS="l">315</TD><TD>            throw new UnavailableException</TD></TR><TR><TD CLASS="l">316</TD><TD>                (&#34;Cannot invoke CGIServlet through the invoker&#34;);</TD></TR><TR><TD CLASS="l">317</TD><TD> </TD></TR><TR><TD CLASS="l">318</TD><TD>        // Set our properties from the initialization parameters</TD></TR><TR CLASS="z"><TD CLASS="l">319</TD><TD>        cgiPathPrefix = getServletConfig().getInitParameter(&#34;cgiPathPrefix&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">320</TD><TD>        boolean passShellEnvironment =</TD></TR><TR CLASS="z"><TD CLASS="l">321</TD><TD>            Boolean.parseBoolean(getServletConfig().getInitParameter(&#34;passShellEnvironment&#34;));</TD></TR><TR><TD CLASS="l">322</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">323</TD><TD>        if (passShellEnvironment) {</TD></TR><TR CLASS="z"><TD CLASS="l">324</TD><TD>            shellEnv.putAll(System.getenv());</TD></TR><TR><TD CLASS="l">325</TD><TD>        }</TD></TR><TR><TD CLASS="l">326</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">327</TD><TD>        if (getServletConfig().getInitParameter(&#34;executable&#34;) != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">328</TD><TD>            cgiExecutable = getServletConfig().getInitParameter(&#34;executable&#34;);</TD></TR><TR><TD CLASS="l">329</TD><TD>        }</TD></TR><TR><TD CLASS="l">330</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">331</TD><TD>        if (getServletConfig().getInitParameter(&#34;executable-arg-1&#34;) != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">332</TD><TD>            List&lt;String&gt; args = new ArrayList&lt;String&gt;();</TD></TR><TR CLASS="z"><TD CLASS="l">333</TD><TD>            for (int i = 1;; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">334</TD><TD>                String arg = getServletConfig().getInitParameter(</TD></TR><TR><TD CLASS="l">335</TD><TD>                        &#34;executable-arg-&#34; + i);</TD></TR><TR CLASS="z"><TD CLASS="l">336</TD><TD>                if (arg == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">337</TD><TD>                    break;</TD></TR><TR><TD CLASS="l">338</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">339</TD><TD>                args.add(arg);</TD></TR><TR><TD CLASS="l">340</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">341</TD><TD>            cgiExecutableArgs = args;</TD></TR><TR><TD CLASS="l">342</TD><TD>        }</TD></TR><TR><TD CLASS="l">343</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">344</TD><TD>        if (getServletConfig().getInitParameter(&#34;parameterEncoding&#34;) != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">345</TD><TD>            parameterEncoding = getServletConfig().getInitParameter(&#34;parameterEncoding&#34;);</TD></TR><TR><TD CLASS="l">346</TD><TD>        }</TD></TR><TR><TD CLASS="l">347</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">348</TD><TD>        if (getServletConfig().getInitParameter(&#34;stderrTimeout&#34;) != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">349</TD><TD>            stderrTimeout = Long.parseLong(getServletConfig().getInitParameter(</TD></TR><TR><TD CLASS="l">350</TD><TD>                    &#34;stderrTimeout&#34;));</TD></TR><TR><TD CLASS="l">351</TD><TD>        }</TD></TR><TR><TD CLASS="l">352</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">353</TD><TD>        if (getServletConfig().getInitParameter(&#34;envHttpHeaders&#34;) != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">354</TD><TD>            envHttpHeadersPattern =</TD></TR><TR CLASS="z"><TD CLASS="l">355</TD><TD>                    Pattern.compile(getServletConfig().getInitParameter(&#34;envHttpHeaders&#34;));</TD></TR><TR><TD CLASS="l">356</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">357</TD><TD>    }</TD></TR><TR><TD CLASS="l">358</TD><TD> </TD></TR><TR><TD CLASS="l">359</TD><TD> </TD></TR><TR><TD CLASS="l">360</TD><TD>    /**</TD></TR><TR><TD CLASS="l">361</TD><TD>     * Logs important Servlet API and container information.</TD></TR><TR><TD CLASS="l">362</TD><TD>     *</TD></TR><TR><TD CLASS="l">363</TD><TD>     * &lt;p&gt;</TD></TR><TR><TD CLASS="l">364</TD><TD>     * Copied from SnoopAllServlet by Craig R. McClanahan</TD></TR><TR><TD CLASS="l">365</TD><TD>     * &lt;/p&gt;</TD></TR><TR><TD CLASS="l">366</TD><TD>     *</TD></TR><TR><TD CLASS="l">367</TD><TD>     * @param  out    Unused</TD></TR><TR><TD CLASS="l">368</TD><TD>     * @param  req    HttpServletRequest object used as source of information</TD></TR><TR><TD CLASS="l">369</TD><TD>     * @param  res    Unused</TD></TR><TR><TD CLASS="l">370</TD><TD>     *</TD></TR><TR><TD CLASS="l">371</TD><TD>     * @exception  IOException  if a write operation exception occurs</TD></TR><TR><TD CLASS="l">372</TD><TD>     *</TD></TR><TR><TD CLASS="l">373</TD><TD>     * @deprecated Use {@link #printServletEnvironment(HttpServletRequest)}.</TD></TR><TR><TD CLASS="l">374</TD><TD>     *             This will be removed in Tomcat 8.5.X onwards</TD></TR><TR><TD CLASS="l"><A NAME="13">375</A></TD><TD>     */</TD></TR><TR><TD CLASS="l">376</TD><TD>    @Deprecated</TD></TR><TR><TD CLASS="l">377</TD><TD>    protected void printServletEnvironment(ServletOutputStream out,</TD></TR><TR><TD CLASS="l">378</TD><TD>            HttpServletRequest req, HttpServletResponse res) throws IOException {</TD></TR><TR CLASS="z"><TD CLASS="l">379</TD><TD>        printServletEnvironment(req);</TD></TR><TR CLASS="z"><TD CLASS="l">380</TD><TD>    }</TD></TR><TR><TD CLASS="l">381</TD><TD> </TD></TR><TR><TD CLASS="l">382</TD><TD>    /**</TD></TR><TR><TD CLASS="l">383</TD><TD>     * Logs important Servlet API and container information.</TD></TR><TR><TD CLASS="l">384</TD><TD>     *</TD></TR><TR><TD CLASS="l">385</TD><TD>     * &lt;p&gt;</TD></TR><TR><TD CLASS="l">386</TD><TD>     * Based on SnoopAllServlet by Craig R. McClanahan</TD></TR><TR><TD CLASS="l">387</TD><TD>     * &lt;/p&gt;</TD></TR><TR><TD CLASS="l">388</TD><TD>     *</TD></TR><TR><TD CLASS="l">389</TD><TD>     * @param  req    HttpServletRequest object used as source of information</TD></TR><TR><TD CLASS="l">390</TD><TD>     *</TD></TR><TR><TD CLASS="l">391</TD><TD>     * @exception  IOException  if a write operation exception occurs</TD></TR><TR><TD CLASS="l"><A NAME="12">392</A></TD><TD>     */</TD></TR><TR><TD CLASS="l">393</TD><TD>    private void printServletEnvironment(HttpServletRequest req) throws IOException {</TD></TR><TR><TD CLASS="l">394</TD><TD> </TD></TR><TR><TD CLASS="l">395</TD><TD>        // Document the properties from ServletRequest</TD></TR><TR CLASS="z"><TD CLASS="l">396</TD><TD>        log.trace(&#34;ServletRequest Properties&#34;);</TD></TR><TR><TD CLASS="l">397</TD><TD>        @SuppressWarnings(&#34;unchecked&#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">398</TD><TD>        Enumeration&lt;String&gt; attrs = req.getAttributeNames();</TD></TR><TR CLASS="z"><TD CLASS="l">399</TD><TD>        while (attrs.hasMoreElements()) {</TD></TR><TR CLASS="z"><TD CLASS="l">400</TD><TD>            String attr = attrs.nextElement();</TD></TR><TR CLASS="z"><TD CLASS="l">401</TD><TD>            log.trace(&#34;Request Attribute: &#34; + attr + &#34;: [ &#34; + req.getAttribute(attr) +&#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">402</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">403</TD><TD>        log.trace(&#34;Character Encoding: [&#34; + req.getCharacterEncoding() + &#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">404</TD><TD>        log.trace(&#34;Content Length: [&#34; + req.getContentLength() + &#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">405</TD><TD>        log.trace(&#34;Content Type: [&#34; + req.getContentType() + &#34;]&#34;);</TD></TR><TR><TD CLASS="l">406</TD><TD>        @SuppressWarnings(&#34;unchecked&#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">407</TD><TD>        Enumeration&lt;Locale&gt; locales = req.getLocales();</TD></TR><TR CLASS="z"><TD CLASS="l">408</TD><TD>        while (locales.hasMoreElements()) {</TD></TR><TR CLASS="z"><TD CLASS="l">409</TD><TD>            Locale locale = locales.nextElement();</TD></TR><TR CLASS="z"><TD CLASS="l">410</TD><TD>            log.trace(&#34;Locale: [&#34; +locale + &#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">411</TD><TD>        }</TD></TR><TR><TD CLASS="l">412</TD><TD>        @SuppressWarnings(&#34;unchecked&#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">413</TD><TD>        Enumeration&lt;String&gt; params = req.getParameterNames();</TD></TR><TR CLASS="z"><TD CLASS="l">414</TD><TD>        while (params.hasMoreElements()) {</TD></TR><TR CLASS="z"><TD CLASS="l">415</TD><TD>            String param = params.nextElement();</TD></TR><TR CLASS="z"><TD CLASS="l">416</TD><TD>            for (String value : req.getParameterValues(param)) {</TD></TR><TR CLASS="z"><TD CLASS="l">417</TD><TD>                log.trace(&#34;Request Parameter: &#34; + param + &#34;:  [&#34; + value + &#34;]&#34;);</TD></TR><TR><TD CLASS="l">418</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">419</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">420</TD><TD>        log.trace(&#34;Protocol: [&#34; + req.getProtocol() + &#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">421</TD><TD>        log.trace(&#34;Remote Address: [&#34; + req.getRemoteAddr() + &#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">422</TD><TD>        log.trace(&#34;Remote Host: [&#34; + req.getRemoteHost() + &#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">423</TD><TD>        log.trace(&#34;Scheme: [&#34; + req.getScheme() + &#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">424</TD><TD>        log.trace(&#34;Secure: [&#34; + req.isSecure() + &#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">425</TD><TD>        log.trace(&#34;Server Name: [&#34; + req.getServerName() + &#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">426</TD><TD>        log.trace(&#34;Server Port: [&#34; + req.getServerPort() + &#34;]&#34;);</TD></TR><TR><TD CLASS="l">427</TD><TD> </TD></TR><TR><TD CLASS="l">428</TD><TD>        // Document the properties from HttpServletRequest</TD></TR><TR CLASS="z"><TD CLASS="l">429</TD><TD>        log.trace(&#34;HttpServletRequest Properties&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">430</TD><TD>        log.trace(&#34;Auth Type: [&#34; + req.getAuthType() + &#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">431</TD><TD>        log.trace(&#34;Context Path: [&#34; + req.getContextPath() + &#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">432</TD><TD>        Cookie cookies[] = req.getCookies();</TD></TR><TR CLASS="z"><TD CLASS="l">433</TD><TD>        if (cookies != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">434</TD><TD>            for (Cookie cookie : cookies) {</TD></TR><TR CLASS="z"><TD CLASS="l">435</TD><TD>                log.trace(&#34;Cookie: &#34; + cookie.getName() + &#34;: [&#34; + cookie.getValue() + &#34;]&#34;);</TD></TR><TR><TD CLASS="l">436</TD><TD>            }</TD></TR><TR><TD CLASS="l">437</TD><TD>        }</TD></TR><TR><TD CLASS="l">438</TD><TD>        @SuppressWarnings(&#34;unchecked&#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">439</TD><TD>        Enumeration&lt;String&gt; headers = req.getHeaderNames();</TD></TR><TR CLASS="z"><TD CLASS="l">440</TD><TD>        while (headers.hasMoreElements()) {</TD></TR><TR CLASS="z"><TD CLASS="l">441</TD><TD>            String header = headers.nextElement();</TD></TR><TR CLASS="z"><TD CLASS="l">442</TD><TD>            log.trace(&#34;HTTP Header: &#34; + header + &#34;: [&#34; + req.getHeader(header) + &#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">443</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">444</TD><TD>        log.trace(&#34;Method: [&#34; + req.getMethod() + &#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">445</TD><TD>        log.trace(&#34;Path Info: [&#34; + req.getPathInfo() + &#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">446</TD><TD>        log.trace(&#34;Path Translated: [&#34; + req.getPathTranslated() + &#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">447</TD><TD>        log.trace(&#34;Query String: [&#34; + req.getQueryString() + &#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">448</TD><TD>        log.trace(&#34;Remote User: [&#34; + req.getRemoteUser() + &#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">449</TD><TD>        log.trace(&#34;Requested Session ID: [&#34; + req.getRequestedSessionId() + &#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">450</TD><TD>        log.trace(&#34;Requested Session ID From Cookie: [&#34; +</TD></TR><TR CLASS="z"><TD CLASS="l">451</TD><TD>                req.isRequestedSessionIdFromCookie() + &#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">452</TD><TD>        log.trace(&#34;Requested Session ID From URL: [&#34; + req.isRequestedSessionIdFromURL() + &#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">453</TD><TD>        log.trace(&#34;Requested Session ID Valid: [&#34; + req.isRequestedSessionIdValid() + &#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">454</TD><TD>        log.trace(&#34;Request URI: [&#34; + req.getRequestURI() + &#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">455</TD><TD>        log.trace(&#34;Servlet Path: [&#34; + req.getServletPath() + &#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">456</TD><TD>        log.trace(&#34;User Principal: [&#34; + req.getUserPrincipal() + &#34;]&#34;);</TD></TR><TR><TD CLASS="l">457</TD><TD> </TD></TR><TR><TD CLASS="l">458</TD><TD>        // Process the current session (if there is one)</TD></TR><TR CLASS="z"><TD CLASS="l">459</TD><TD>        HttpSession session = req.getSession(false);</TD></TR><TR CLASS="z"><TD CLASS="l">460</TD><TD>        if (session != null) {</TD></TR><TR><TD CLASS="l">461</TD><TD> </TD></TR><TR><TD CLASS="l">462</TD><TD>            // Document the session properties</TD></TR><TR CLASS="z"><TD CLASS="l">463</TD><TD>            log.trace(&#34;HttpSession Properties&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">464</TD><TD>            log.trace(&#34;ID: [&#34; + session.getId() + &#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">465</TD><TD>            log.trace(&#34;Creation Time: [&#34; + new Date(session.getCreationTime()) + &#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">466</TD><TD>            log.trace(&#34;Last Accessed Time: [&#34; + new Date(session.getLastAccessedTime()) + &#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">467</TD><TD>            log.trace(&#34;Max Inactive Interval: [&#34; + session.getMaxInactiveInterval() + &#34;]&#34;);</TD></TR><TR><TD CLASS="l">468</TD><TD> </TD></TR><TR><TD CLASS="l">469</TD><TD>            // Document the session attributes</TD></TR><TR CLASS="z"><TD CLASS="l">470</TD><TD>            attrs = session.getAttributeNames();</TD></TR><TR CLASS="z"><TD CLASS="l">471</TD><TD>            while (attrs.hasMoreElements()) {</TD></TR><TR CLASS="z"><TD CLASS="l">472</TD><TD>                String attr = attrs.nextElement();</TD></TR><TR CLASS="z"><TD CLASS="l">473</TD><TD>                log.trace(&#34;Session Attribute: &#34; + attr + &#34;: [&#34; + session.getAttribute(attr) + &#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">474</TD><TD>            }</TD></TR><TR><TD CLASS="l">475</TD><TD>        }</TD></TR><TR><TD CLASS="l">476</TD><TD> </TD></TR><TR><TD CLASS="l">477</TD><TD>        // Document the servlet configuration properties</TD></TR><TR CLASS="z"><TD CLASS="l">478</TD><TD>        log.trace(&#34;ServletConfig Properties&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">479</TD><TD>        log.trace(&#34;Servlet Name: [&#34; + getServletConfig().getServletName() + &#34;]&#34;);</TD></TR><TR><TD CLASS="l">480</TD><TD> </TD></TR><TR><TD CLASS="l">481</TD><TD>        // Document the servlet configuration initialization parameters</TD></TR><TR CLASS="z"><TD CLASS="l">482</TD><TD>        params = getServletConfig().getInitParameterNames();</TD></TR><TR CLASS="z"><TD CLASS="l">483</TD><TD>        while (params.hasMoreElements()) {</TD></TR><TR CLASS="z"><TD CLASS="l">484</TD><TD>            String param = params.nextElement();</TD></TR><TR CLASS="z"><TD CLASS="l">485</TD><TD>            String value = getServletConfig().getInitParameter(param);</TD></TR><TR CLASS="z"><TD CLASS="l">486</TD><TD>            log.trace(&#34;Servlet Init Param: &#34; + param + &#34;: [&#34; + value + &#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">487</TD><TD>        }</TD></TR><TR><TD CLASS="l">488</TD><TD> </TD></TR><TR><TD CLASS="l">489</TD><TD>        // Document the servlet context properties</TD></TR><TR CLASS="z"><TD CLASS="l">490</TD><TD>        log.trace(&#34;ServletContext Properties&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">491</TD><TD>        log.trace(&#34;Major Version: [&#34; + getServletContext().getMajorVersion() + &#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">492</TD><TD>        log.trace(&#34;Minor Version: [&#34; + getServletContext().getMinorVersion() + &#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">493</TD><TD>        log.trace(&#34;Real Path for '/': [&#34; + getServletContext().getRealPath(&#34;/&#34;) + &#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">494</TD><TD>        log.trace(&#34;Server Info: [&#34; + getServletContext().getServerInfo() + &#34;]&#34;);</TD></TR><TR><TD CLASS="l">495</TD><TD> </TD></TR><TR><TD CLASS="l">496</TD><TD>        // Document the servlet context initialization parameters</TD></TR><TR CLASS="z"><TD CLASS="l">497</TD><TD>        log.trace(&#34;ServletContext Initialization Parameters&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">498</TD><TD>        params = getServletContext().getInitParameterNames();</TD></TR><TR CLASS="z"><TD CLASS="l">499</TD><TD>        while (params.hasMoreElements()) {</TD></TR><TR CLASS="z"><TD CLASS="l">500</TD><TD>            String param = params.nextElement();</TD></TR><TR CLASS="z"><TD CLASS="l">501</TD><TD>            String value = getServletContext().getInitParameter(param);</TD></TR><TR CLASS="z"><TD CLASS="l">502</TD><TD>            log.trace(&#34;Servlet Context Init Param: &#34; + param + &#34;: [&#34; + value + &#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">503</TD><TD>        }</TD></TR><TR><TD CLASS="l">504</TD><TD> </TD></TR><TR><TD CLASS="l">505</TD><TD>        // Document the servlet context attributes</TD></TR><TR CLASS="z"><TD CLASS="l">506</TD><TD>        log.trace(&#34;ServletContext Attributes&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">507</TD><TD>        attrs = getServletContext().getAttributeNames();</TD></TR><TR CLASS="z"><TD CLASS="l">508</TD><TD>        while (attrs.hasMoreElements()) {</TD></TR><TR CLASS="z"><TD CLASS="l">509</TD><TD>            String attr = attrs.nextElement();</TD></TR><TR CLASS="z"><TD CLASS="l">510</TD><TD>            log.trace(&#34;Servlet Context Attribute: &#34; + attr +</TD></TR><TR CLASS="z"><TD CLASS="l">511</TD><TD>                    &#34;: [&#34; + getServletContext().getAttribute(attr) + &#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">512</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">513</TD><TD>    }</TD></TR><TR><TD CLASS="l">514</TD><TD> </TD></TR><TR><TD CLASS="l">515</TD><TD> </TD></TR><TR><TD CLASS="l">516</TD><TD>    /**</TD></TR><TR><TD CLASS="l">517</TD><TD>     * Provides CGI Gateway service -- delegates to</TD></TR><TR><TD CLASS="l">518</TD><TD>     * {@link #doGet(HttpServletRequest, HttpServletResponse)}.</TD></TR><TR><TD CLASS="l">519</TD><TD>     *</TD></TR><TR><TD CLASS="l">520</TD><TD>     * @param  req   HttpServletRequest passed in by servlet container</TD></TR><TR><TD CLASS="l">521</TD><TD>     * @param  res   HttpServletResponse passed in by servlet container</TD></TR><TR><TD CLASS="l">522</TD><TD>     *</TD></TR><TR><TD CLASS="l">523</TD><TD>     * @exception  ServletException  if a servlet-specific exception occurs</TD></TR><TR><TD CLASS="l">524</TD><TD>     * @exception  IOException  if a read/write exception occurs</TD></TR><TR><TD CLASS="l"><A NAME="10">525</A></TD><TD>     */</TD></TR><TR><TD CLASS="l">526</TD><TD>    @Override</TD></TR><TR><TD CLASS="l">527</TD><TD>    protected void doPost(HttpServletRequest req, HttpServletResponse res)</TD></TR><TR><TD CLASS="l">528</TD><TD>        throws IOException, ServletException {</TD></TR><TR CLASS="z"><TD CLASS="l">529</TD><TD>        doGet(req, res);</TD></TR><TR CLASS="z"><TD CLASS="l">530</TD><TD>    }</TD></TR><TR><TD CLASS="l">531</TD><TD> </TD></TR><TR><TD CLASS="l">532</TD><TD> </TD></TR><TR><TD CLASS="l">533</TD><TD>    /**</TD></TR><TR><TD CLASS="l">534</TD><TD>     * Provides CGI Gateway service.</TD></TR><TR><TD CLASS="l">535</TD><TD>     *</TD></TR><TR><TD CLASS="l">536</TD><TD>     * @param  req   HttpServletRequest passed in by servlet container</TD></TR><TR><TD CLASS="l">537</TD><TD>     * @param  res   HttpServletResponse passed in by servlet container</TD></TR><TR><TD CLASS="l">538</TD><TD>     *</TD></TR><TR><TD CLASS="l">539</TD><TD>     * @exception  ServletException  if a servlet-specific exception occurs</TD></TR><TR><TD CLASS="l">540</TD><TD>     * @exception  IOException  if a read/write exception occurs</TD></TR><TR><TD CLASS="l">541</TD><TD>     */</TD></TR><TR><TD CLASS="l">542</TD><TD>    @Override</TD></TR><TR><TD CLASS="l"><A NAME="f">543</A></TD><TD>    protected void doGet(HttpServletRequest req, HttpServletResponse res)</TD></TR><TR><TD CLASS="l">544</TD><TD>        throws ServletException, IOException {</TD></TR><TR><TD CLASS="l">545</TD><TD> </TD></TR><TR><TD CLASS="l">546</TD><TD>        // Verify that we were not accessed using the invoker servlet</TD></TR><TR CLASS="z"><TD CLASS="l">547</TD><TD>        if (req.getAttribute(Globals.INVOKED_ATTR) != null)</TD></TR><TR CLASS="z"><TD CLASS="l">548</TD><TD>            throw new UnavailableException</TD></TR><TR><TD CLASS="l">549</TD><TD>                (&#34;Cannot invoke CGIServlet through the invoker&#34;);</TD></TR><TR><TD CLASS="l">550</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">551</TD><TD>        CGIEnvironment cgiEnv = new CGIEnvironment(req, getServletContext());</TD></TR><TR><TD CLASS="l">552</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">553</TD><TD>        if (cgiEnv.isValid()) {</TD></TR><TR CLASS="z"><TD CLASS="l">554</TD><TD>            CGIRunner cgi = new CGIRunner(cgiEnv.getCommand(),</TD></TR><TR CLASS="z"><TD CLASS="l">555</TD><TD>                                          cgiEnv.getEnvironment(),</TD></TR><TR CLASS="z"><TD CLASS="l">556</TD><TD>                                          cgiEnv.getWorkingDirectory(),</TD></TR><TR CLASS="z"><TD CLASS="l">557</TD><TD>                                          cgiEnv.getParameters());</TD></TR><TR><TD CLASS="l">558</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">559</TD><TD>            if (&#34;POST&#34;.equals(req.getMethod())) {</TD></TR><TR CLASS="z"><TD CLASS="l">560</TD><TD>                cgi.setInput(req.getInputStream());</TD></TR><TR><TD CLASS="l">561</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">562</TD><TD>            cgi.setResponse(res);</TD></TR><TR CLASS="z"><TD CLASS="l">563</TD><TD>            cgi.run();</TD></TR><TR CLASS="z"><TD CLASS="l">564</TD><TD>        } else {</TD></TR><TR CLASS="z"><TD CLASS="l">565</TD><TD>            res.sendError(404);</TD></TR><TR><TD CLASS="l">566</TD><TD>        }</TD></TR><TR><TD CLASS="l">567</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">568</TD><TD>        if (log.isTraceEnabled()) {</TD></TR><TR CLASS="z"><TD CLASS="l">569</TD><TD>            String[] cgiEnvLines = cgiEnv.toString().split(LINE_SEP);</TD></TR><TR CLASS="z"><TD CLASS="l">570</TD><TD>            for (String cgiEnvLine : cgiEnvLines) {</TD></TR><TR CLASS="z"><TD CLASS="l">571</TD><TD>                log.trace(cgiEnvLine);</TD></TR><TR><TD CLASS="l">572</TD><TD>            }</TD></TR><TR><TD CLASS="l">573</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">574</TD><TD>            printServletEnvironment(req);</TD></TR><TR><TD CLASS="l">575</TD><TD>        }</TD></TR><TR CLASS="z"><TD CLASS="l">576</TD><TD>    }</TD></TR><TR><TD CLASS="l">577</TD><TD> </TD></TR><TR><TD CLASS="l">578</TD><TD> </TD></TR><TR><TD CLASS="l">579</TD><TD>    /**</TD></TR><TR><TD CLASS="l">580</TD><TD>     * Behaviour depends on the status code.</TD></TR><TR><TD CLASS="l">581</TD><TD>     *</TD></TR><TR><TD CLASS="l">582</TD><TD>     * Status &lt; 400  - Calls setStatus. Returns false. CGI servlet will provide</TD></TR><TR><TD CLASS="l">583</TD><TD>     *                 the response body.</TD></TR><TR><TD CLASS="l"><A NAME="14">584</A></TD><TD>     * Status &gt;= 400 - Calls sendError(status), returns true. Standard error</TD></TR><TR><TD CLASS="l">585</TD><TD>     *                 page mechanism will provide the response body.</TD></TR><TR><TD CLASS="l">586</TD><TD>     */</TD></TR><TR><TD CLASS="l">587</TD><TD>    private boolean setStatus(HttpServletResponse response, int status) throws IOException {</TD></TR><TR CLASS="z"><TD CLASS="l">588</TD><TD>        if (status &gt;= HttpServletResponse.SC_BAD_REQUEST) {</TD></TR><TR CLASS="z"><TD CLASS="l">589</TD><TD>            response.sendError(status);</TD></TR><TR CLASS="z"><TD CLASS="l">590</TD><TD>            return true;</TD></TR><TR><TD CLASS="l">591</TD><TD>        } else {</TD></TR><TR CLASS="z"><TD CLASS="l">592</TD><TD>            response.setStatus(status);</TD></TR><TR CLASS="z"><TD CLASS="l">593</TD><TD>            return false;</TD></TR><TR><TD CLASS="l">594</TD><TD>        }</TD></TR><TR><TD CLASS="l">595</TD><TD>    }</TD></TR><TR><TD CLASS="l">596</TD><TD> </TD></TR><TR><TD CLASS="l">597</TD><TD> </TD></TR><TR><TD CLASS="l">598</TD><TD>    /**</TD></TR><TR><TD CLASS="l">599</TD><TD>     * Encapsulates the CGI environment and rules to derive</TD></TR><TR><TD CLASS="l">600</TD><TD>     * that environment from the servlet container and request information.</TD></TR><TR><TD CLASS="l">601</TD><TD>     */</TD></TR><TR><TD CLASS="l">602</TD><TD>    protected class CGIEnvironment {</TD></TR><TR><TD CLASS="l">603</TD><TD> </TD></TR><TR><TD CLASS="l">604</TD><TD> </TD></TR><TR><TD CLASS="l">605</TD><TD>        /** context of the enclosing servlet */</TD></TR><TR CLASS="z"><TD CLASS="l">606</TD><TD>        private ServletContext context = null;</TD></TR><TR><TD CLASS="l">607</TD><TD> </TD></TR><TR><TD CLASS="l">608</TD><TD>        /** context path of enclosing servlet */</TD></TR><TR CLASS="z"><TD CLASS="l">609</TD><TD>        private String contextPath = null;</TD></TR><TR><TD CLASS="l">610</TD><TD> </TD></TR><TR><TD CLASS="l">611</TD><TD>        /** servlet URI of the enclosing servlet */</TD></TR><TR CLASS="z"><TD CLASS="l">612</TD><TD>        private String servletPath = null;</TD></TR><TR><TD CLASS="l">613</TD><TD> </TD></TR><TR><TD CLASS="l">614</TD><TD>        /** pathInfo for the current request */</TD></TR><TR CLASS="z"><TD CLASS="l">615</TD><TD>        private String pathInfo = null;</TD></TR><TR><TD CLASS="l">616</TD><TD> </TD></TR><TR><TD CLASS="l">617</TD><TD>        /** real file system directory of the enclosing servlet's web app */</TD></TR><TR CLASS="z"><TD CLASS="l">618</TD><TD>        private String webAppRootDir = null;</TD></TR><TR><TD CLASS="l">619</TD><TD> </TD></TR><TR><TD CLASS="l">620</TD><TD>        /** tempdir for context - used to expand scripts in unexpanded wars */</TD></TR><TR CLASS="z"><TD CLASS="l">621</TD><TD>        private File tmpDir = null;</TD></TR><TR><TD CLASS="l">622</TD><TD> </TD></TR><TR><TD CLASS="l">623</TD><TD>        /** derived cgi environment */</TD></TR><TR CLASS="z"><TD CLASS="l">624</TD><TD>        private Hashtable&lt;String, String&gt; env = null;</TD></TR><TR><TD CLASS="l">625</TD><TD> </TD></TR><TR><TD CLASS="l">626</TD><TD>        /** cgi command to be invoked */</TD></TR><TR CLASS="z"><TD CLASS="l">627</TD><TD>        private String command = null;</TD></TR><TR><TD CLASS="l">628</TD><TD> </TD></TR><TR><TD CLASS="l">629</TD><TD>        /** cgi command's desired working directory */</TD></TR><TR><TD CLASS="l">630</TD><TD>        private final File workingDirectory;</TD></TR><TR><TD CLASS="l">631</TD><TD> </TD></TR><TR><TD CLASS="l">632</TD><TD>        /** cgi command's command line parameters */</TD></TR><TR CLASS="z"><TD CLASS="l">633</TD><TD>        private final ArrayList&lt;String&gt; cmdLineParameters = new ArrayList&lt;String&gt;();</TD></TR><TR><TD CLASS="l">634</TD><TD> </TD></TR><TR><TD CLASS="l">635</TD><TD>        /** whether or not this object is valid or not */</TD></TR><TR><TD CLASS="l">636</TD><TD>        private final boolean valid;</TD></TR><TR><TD CLASS="l">637</TD><TD> </TD></TR><TR><TD CLASS="l">638</TD><TD> </TD></TR><TR><TD CLASS="l">639</TD><TD>        /**</TD></TR><TR><TD CLASS="l">640</TD><TD>         * Creates a CGIEnvironment and derives the necessary environment,</TD></TR><TR><TD CLASS="l">641</TD><TD>         * query parameters, working directory, cgi command, etc.</TD></TR><TR><TD CLASS="l">642</TD><TD>         *</TD></TR><TR><TD CLASS="l">643</TD><TD>         * @param  req       HttpServletRequest for information provided by</TD></TR><TR><TD CLASS="l">644</TD><TD>         *                   the Servlet API</TD></TR><TR><TD CLASS="l">645</TD><TD>         * @param  context   ServletContext for information provided by the</TD></TR><TR><TD CLASS="l"><A NAME="15">646</A></TD><TD>         *                   Servlet API</TD></TR><TR><TD CLASS="l">647</TD><TD>         * @throws IOException an IO error occurred</TD></TR><TR><TD CLASS="l">648</TD><TD>         */</TD></TR><TR><TD CLASS="l">649</TD><TD>        protected CGIEnvironment(HttpServletRequest req,</TD></TR><TR CLASS="z"><TD CLASS="l">650</TD><TD>                                 ServletContext context) throws IOException {</TD></TR><TR CLASS="z"><TD CLASS="l">651</TD><TD>            setupFromContext(context);</TD></TR><TR CLASS="z"><TD CLASS="l">652</TD><TD>            setupFromRequest(req);</TD></TR><TR><TD CLASS="l">653</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">654</TD><TD>            this.valid = setCGIEnvironment(req);</TD></TR><TR><TD CLASS="l">655</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">656</TD><TD>            if (this.valid) {</TD></TR><TR CLASS="z"><TD CLASS="l">657</TD><TD>                workingDirectory = new File(command.substring(0,</TD></TR><TR CLASS="z"><TD CLASS="l">658</TD><TD>                      command.lastIndexOf(File.separator)));</TD></TR><TR><TD CLASS="l">659</TD><TD>            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">660</TD><TD>                workingDirectory = null;</TD></TR><TR><TD CLASS="l">661</TD><TD>            }</TD></TR><TR><TD CLASS="l">662</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">663</TD><TD>        }</TD></TR><TR><TD CLASS="l">664</TD><TD> </TD></TR><TR><TD CLASS="l">665</TD><TD> </TD></TR><TR><TD CLASS="l">666</TD><TD>        /**</TD></TR><TR><TD CLASS="l">667</TD><TD>         * Uses the ServletContext to set some CGI variables</TD></TR><TR><TD CLASS="l">668</TD><TD>         *</TD></TR><TR><TD CLASS="l"><A NAME="22">669</A></TD><TD>         * @param  context   ServletContext for information provided by the</TD></TR><TR><TD CLASS="l">670</TD><TD>         *                   Servlet API</TD></TR><TR><TD CLASS="l">671</TD><TD>         */</TD></TR><TR><TD CLASS="l">672</TD><TD>        protected void setupFromContext(ServletContext context) {</TD></TR><TR CLASS="z"><TD CLASS="l">673</TD><TD>            this.context = context;</TD></TR><TR CLASS="z"><TD CLASS="l">674</TD><TD>            this.webAppRootDir = context.getRealPath(&#34;/&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">675</TD><TD>            this.tmpDir = (File) context.getAttribute(Globals.WORK_DIR_ATTR);</TD></TR><TR CLASS="z"><TD CLASS="l">676</TD><TD>        }</TD></TR><TR><TD CLASS="l">677</TD><TD> </TD></TR><TR><TD CLASS="l">678</TD><TD> </TD></TR><TR><TD CLASS="l">679</TD><TD>        /**</TD></TR><TR><TD CLASS="l">680</TD><TD>         * Uses the HttpServletRequest to set most CGI variables</TD></TR><TR><TD CLASS="l">681</TD><TD>         *</TD></TR><TR><TD CLASS="l">682</TD><TD>         * @param  req   HttpServletRequest for information provided by</TD></TR><TR><TD CLASS="l">683</TD><TD>         *               the Servlet API</TD></TR><TR><TD CLASS="l">684</TD><TD>         * @throws UnsupportedEncodingException Unknown encoding</TD></TR><TR><TD CLASS="l"><A NAME="23">685</A></TD><TD>         */</TD></TR><TR><TD CLASS="l">686</TD><TD>        protected void setupFromRequest(HttpServletRequest req)</TD></TR><TR><TD CLASS="l">687</TD><TD>                throws UnsupportedEncodingException {</TD></TR><TR><TD CLASS="l">688</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">689</TD><TD>            boolean isIncluded = false;</TD></TR><TR><TD CLASS="l">690</TD><TD> </TD></TR><TR><TD CLASS="l">691</TD><TD>            // Look to see if this request is an include</TD></TR><TR CLASS="z"><TD CLASS="l">692</TD><TD>            if (req.getAttribute(Globals.INCLUDE_REQUEST_URI_ATTR) != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">693</TD><TD>                isIncluded = true;</TD></TR><TR><TD CLASS="l">694</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">695</TD><TD>            if (isIncluded) {</TD></TR><TR CLASS="z"><TD CLASS="l">696</TD><TD>                this.contextPath = (String) req.getAttribute(</TD></TR><TR><TD CLASS="l">697</TD><TD>                        Globals.INCLUDE_CONTEXT_PATH_ATTR);</TD></TR><TR CLASS="z"><TD CLASS="l">698</TD><TD>                this.servletPath = (String) req.getAttribute(</TD></TR><TR><TD CLASS="l">699</TD><TD>                        Globals.INCLUDE_SERVLET_PATH_ATTR);</TD></TR><TR CLASS="z"><TD CLASS="l">700</TD><TD>                this.pathInfo = (String) req.getAttribute(</TD></TR><TR><TD CLASS="l">701</TD><TD>                        Globals.INCLUDE_PATH_INFO_ATTR);</TD></TR><TR><TD CLASS="l">702</TD><TD>            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">703</TD><TD>                this.contextPath = req.getContextPath();</TD></TR><TR CLASS="z"><TD CLASS="l">704</TD><TD>                this.servletPath = req.getServletPath();</TD></TR><TR CLASS="z"><TD CLASS="l">705</TD><TD>                this.pathInfo = req.getPathInfo();</TD></TR><TR><TD CLASS="l">706</TD><TD>            }</TD></TR><TR><TD CLASS="l">707</TD><TD>            // If getPathInfo() returns null, must be using extension mapping</TD></TR><TR><TD CLASS="l">708</TD><TD>            // In this case, pathInfo should be same as servletPath</TD></TR><TR CLASS="z"><TD CLASS="l">709</TD><TD>            if (this.pathInfo == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">710</TD><TD>                this.pathInfo = this.servletPath;</TD></TR><TR><TD CLASS="l">711</TD><TD>            }</TD></TR><TR><TD CLASS="l">712</TD><TD> </TD></TR><TR><TD CLASS="l">713</TD><TD>            // If the request method is GET, POST or HEAD and the query string</TD></TR><TR><TD CLASS="l">714</TD><TD>            // does not contain an unencoded &#34;=&#34; this is an indexed query.</TD></TR><TR><TD CLASS="l">715</TD><TD>            // The parsed query string becomes the command line parameters</TD></TR><TR><TD CLASS="l">716</TD><TD>            // for the cgi command.</TD></TR><TR CLASS="z"><TD CLASS="l">717</TD><TD>            if (req.getMethod().equals(&#34;GET&#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">718</TD><TD>                || req.getMethod().equals(&#34;POST&#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">719</TD><TD>                || req.getMethod().equals(&#34;HEAD&#34;)) {</TD></TR><TR><TD CLASS="l">720</TD><TD>                String qs;</TD></TR><TR CLASS="z"><TD CLASS="l">721</TD><TD>                if (isIncluded) {</TD></TR><TR CLASS="z"><TD CLASS="l">722</TD><TD>                    qs = (String) req.getAttribute(</TD></TR><TR><TD CLASS="l">723</TD><TD>                            Globals.INCLUDE_QUERY_STRING_ATTR);</TD></TR><TR><TD CLASS="l">724</TD><TD>                } else {</TD></TR><TR CLASS="z"><TD CLASS="l">725</TD><TD>                    qs = req.getQueryString();</TD></TR><TR><TD CLASS="l">726</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">727</TD><TD>                if (qs != null &amp;&amp; qs.indexOf('=') == -1) {</TD></TR><TR CLASS="z"><TD CLASS="l">728</TD><TD>                    StringTokenizer qsTokens = new StringTokenizer(qs, &#34;+&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">729</TD><TD>                    while ( qsTokens.hasMoreTokens() ) {</TD></TR><TR CLASS="z"><TD CLASS="l">730</TD><TD>                        cmdLineParameters.add(URLDecoder.decode(qsTokens.nextToken(),</TD></TR><TR CLASS="z"><TD CLASS="l">731</TD><TD>                                              parameterEncoding));</TD></TR><TR><TD CLASS="l">732</TD><TD>                    }</TD></TR><TR><TD CLASS="l">733</TD><TD>                }</TD></TR><TR><TD CLASS="l">734</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">735</TD><TD>        }</TD></TR><TR><TD CLASS="l">736</TD><TD> </TD></TR><TR><TD CLASS="l">737</TD><TD> </TD></TR><TR><TD CLASS="l">738</TD><TD>        /**</TD></TR><TR><TD CLASS="l">739</TD><TD>         * Resolves core information about the cgi script.</TD></TR><TR><TD CLASS="l">740</TD><TD>         *</TD></TR><TR><TD CLASS="l">741</TD><TD>         * &lt;p&gt;</TD></TR><TR><TD CLASS="l">742</TD><TD>         * Example URI:</TD></TR><TR><TD CLASS="l">743</TD><TD>         * &lt;/p&gt;</TD></TR><TR><TD CLASS="l">744</TD><TD>         * &lt;PRE&gt; /servlet/cgigateway/dir1/realCGIscript/pathinfo1 &lt;/PRE&gt;</TD></TR><TR><TD CLASS="l">745</TD><TD>         * &lt;ul&gt;</TD></TR><TR><TD CLASS="l">746</TD><TD>         * &lt;LI&gt;&lt;b&gt;path&lt;/b&gt; = $CATALINA_HOME/mywebapp/dir1/realCGIscript</TD></TR><TR><TD CLASS="l">747</TD><TD>         * &lt;LI&gt;&lt;b&gt;scriptName&lt;/b&gt; = /servlet/cgigateway/dir1/realCGIscript</TD></TR><TR><TD CLASS="l">748</TD><TD>         * &lt;LI&gt;&lt;b&gt;cgiName&lt;/b&gt; = /dir1/realCGIscript</TD></TR><TR><TD CLASS="l">749</TD><TD>         * &lt;LI&gt;&lt;b&gt;name&lt;/b&gt; = realCGIscript</TD></TR><TR><TD CLASS="l">750</TD><TD>         * &lt;/ul&gt;</TD></TR><TR><TD CLASS="l">751</TD><TD>         * &lt;p&gt;</TD></TR><TR><TD CLASS="l">752</TD><TD>         * CGI search algorithm: search the real path below</TD></TR><TR><TD CLASS="l">753</TD><TD>         *    &amp;lt;my-webapp-root&amp;gt; and find the first non-directory in</TD></TR><TR><TD CLASS="l">754</TD><TD>         *    the getPathTranslated(&#34;/&#34;), reading/searching from left-to-right.</TD></TR><TR><TD CLASS="l">755</TD><TD>         *&lt;/p&gt;</TD></TR><TR><TD CLASS="l">756</TD><TD>         *&lt;p&gt;</TD></TR><TR><TD CLASS="l">757</TD><TD>         *   The CGI search path will start at</TD></TR><TR><TD CLASS="l">758</TD><TD>         *   webAppRootDir + File.separator + cgiPathPrefix</TD></TR><TR><TD CLASS="l">759</TD><TD>         *   (or webAppRootDir alone if cgiPathPrefix is</TD></TR><TR><TD CLASS="l">760</TD><TD>         *   null).</TD></TR><TR><TD CLASS="l">761</TD><TD>         *&lt;/p&gt;</TD></TR><TR><TD CLASS="l">762</TD><TD>         *&lt;p&gt;</TD></TR><TR><TD CLASS="l">763</TD><TD>         *   cgiPathPrefix is defined by setting</TD></TR><TR><TD CLASS="l">764</TD><TD>         *   this servlet's cgiPathPrefix init parameter</TD></TR><TR><TD CLASS="l">765</TD><TD>         *</TD></TR><TR><TD CLASS="l">766</TD><TD>         *&lt;/p&gt;</TD></TR><TR><TD CLASS="l">767</TD><TD>         *</TD></TR><TR><TD CLASS="l">768</TD><TD>         * @param pathInfo       String from HttpServletRequest.getPathInfo()</TD></TR><TR><TD CLASS="l">769</TD><TD>         * @param webAppRootDir  String from context.getRealPath(&#34;/&#34;)</TD></TR><TR><TD CLASS="l">770</TD><TD>         * @param contextPath    String as from</TD></TR><TR><TD CLASS="l">771</TD><TD>         *                       HttpServletRequest.getContextPath()</TD></TR><TR><TD CLASS="l">772</TD><TD>         * @param servletPath    String as from</TD></TR><TR><TD CLASS="l">773</TD><TD>         *                       HttpServletRequest.getServletPath()</TD></TR><TR><TD CLASS="l">774</TD><TD>         * @param cgiPathPrefix  subdirectory of webAppRootDir below which</TD></TR><TR><TD CLASS="l">775</TD><TD>         *                       the web app's CGIs may be stored; can be null.</TD></TR><TR><TD CLASS="l">776</TD><TD>         *                       The CGI search path will start at</TD></TR><TR><TD CLASS="l">777</TD><TD>         *                       webAppRootDir + File.separator + cgiPathPrefix</TD></TR><TR><TD CLASS="l">778</TD><TD>         *                       (or webAppRootDir alone if cgiPathPrefix is</TD></TR><TR><TD CLASS="l">779</TD><TD>         *                       null).  cgiPathPrefix is defined by setting</TD></TR><TR><TD CLASS="l">780</TD><TD>         *                       the servlet's cgiPathPrefix init parameter.</TD></TR><TR><TD CLASS="l">781</TD><TD>         *</TD></TR><TR><TD CLASS="l">782</TD><TD>         *</TD></TR><TR><TD CLASS="l">783</TD><TD>         * @return</TD></TR><TR><TD CLASS="l">784</TD><TD>         * &lt;ul&gt;</TD></TR><TR><TD CLASS="l">785</TD><TD>         * &lt;li&gt;</TD></TR><TR><TD CLASS="l">786</TD><TD>         * &lt;code&gt;path&lt;/code&gt; -    full file-system path to valid cgi script,</TD></TR><TR><TD CLASS="l">787</TD><TD>         *                        or null if no cgi was found</TD></TR><TR><TD CLASS="l">788</TD><TD>         * &lt;li&gt;</TD></TR><TR><TD CLASS="l">789</TD><TD>         * &lt;code&gt;scriptName&lt;/code&gt; -</TD></TR><TR><TD CLASS="l">790</TD><TD>         *                        CGI variable SCRIPT_NAME; the full URL path</TD></TR><TR><TD CLASS="l">791</TD><TD>         *                        to valid cgi script or null if no cgi was</TD></TR><TR><TD CLASS="l">792</TD><TD>         *                        found</TD></TR><TR><TD CLASS="l">793</TD><TD>         * &lt;li&gt;</TD></TR><TR><TD CLASS="l">794</TD><TD>         * &lt;code&gt;cgiName&lt;/code&gt; - servlet pathInfo fragment corresponding to</TD></TR><TR><TD CLASS="l">795</TD><TD>         *                        the cgi script itself, or null if not found</TD></TR><TR><TD CLASS="l">796</TD><TD>         * &lt;li&gt;</TD></TR><TR><TD CLASS="l">797</TD><TD>         * &lt;code&gt;name&lt;/code&gt; -    simple name (no directories) of the</TD></TR><TR><TD CLASS="l">798</TD><TD>         *                        cgi script, or null if no cgi was found</TD></TR><TR><TD CLASS="l">799</TD><TD>         * &lt;/ul&gt;</TD></TR><TR><TD CLASS="l"><A NAME="19">800</A></TD><TD>         */</TD></TR><TR><TD CLASS="l">801</TD><TD>        protected String[] findCGI(String pathInfo, String webAppRootDir,</TD></TR><TR><TD CLASS="l">802</TD><TD>                                   String contextPath, String servletPath,</TD></TR><TR><TD CLASS="l">803</TD><TD>                                   String cgiPathPrefix) {</TD></TR><TR CLASS="z"><TD CLASS="l">804</TD><TD>            String path = null;</TD></TR><TR CLASS="z"><TD CLASS="l">805</TD><TD>            String name = null;</TD></TR><TR CLASS="z"><TD CLASS="l">806</TD><TD>            String scriptname = null;</TD></TR><TR><TD CLASS="l">807</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">808</TD><TD>            if (webAppRootDir != null &amp;&amp;</TD></TR><TR CLASS="z"><TD CLASS="l">809</TD><TD>                    webAppRootDir.lastIndexOf(File.separator) == (webAppRootDir.length() - 1)) {</TD></TR><TR><TD CLASS="l">810</TD><TD>                //strip the trailing &#34;/&#34; from the webAppRootDir</TD></TR><TR CLASS="z"><TD CLASS="l">811</TD><TD>                webAppRootDir = webAppRootDir.substring(0, (webAppRootDir.length() - 1));</TD></TR><TR><TD CLASS="l">812</TD><TD>            }</TD></TR><TR><TD CLASS="l">813</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">814</TD><TD>            if (cgiPathPrefix != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">815</TD><TD>                webAppRootDir = webAppRootDir + File.separator + cgiPathPrefix;</TD></TR><TR><TD CLASS="l">816</TD><TD>            }</TD></TR><TR><TD CLASS="l">817</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">818</TD><TD>            if (log.isDebugEnabled()) {</TD></TR><TR CLASS="z"><TD CLASS="l">819</TD><TD>                log.debug(sm.getString(&#34;cgiServlet.find.path&#34;, pathInfo, webAppRootDir));</TD></TR><TR><TD CLASS="l">820</TD><TD>            }</TD></TR><TR><TD CLASS="l">821</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">822</TD><TD>            File currentLocation = new File(webAppRootDir);</TD></TR><TR CLASS="z"><TD CLASS="l">823</TD><TD>            StringTokenizer dirWalker = new StringTokenizer(pathInfo, &#34;/&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">824</TD><TD>            if (log.isDebugEnabled()) {</TD></TR><TR CLASS="z"><TD CLASS="l">825</TD><TD>                log.debug(sm.getString(&#34;cgiServlet.find.location&#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">826</TD><TD>                        currentLocation.getAbsolutePath()));</TD></TR><TR><TD CLASS="l">827</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">828</TD><TD>            StringBuilder cginameBuilder = new StringBuilder();</TD></TR><TR CLASS="z"><TD CLASS="l">829</TD><TD>            while (!currentLocation.isFile() &amp;&amp; dirWalker.hasMoreElements()) {</TD></TR><TR CLASS="z"><TD CLASS="l">830</TD><TD>                String nextElement = (String) dirWalker.nextElement();</TD></TR><TR CLASS="z"><TD CLASS="l">831</TD><TD>                currentLocation = new File(currentLocation, nextElement);</TD></TR><TR CLASS="z"><TD CLASS="l">832</TD><TD>                cginameBuilder.append('/').append(nextElement);</TD></TR><TR CLASS="z"><TD CLASS="l">833</TD><TD>                if (log.isDebugEnabled()) {</TD></TR><TR CLASS="z"><TD CLASS="l">834</TD><TD>                    log.debug(sm.getString(&#34;cgiServlet.find.location&#34;,</TD></TR><TR CLASS="z"><TD CLASS="l">835</TD><TD>                            currentLocation.getAbsolutePath()));</TD></TR><TR><TD CLASS="l">836</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">837</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">838</TD><TD>            String cginame = cginameBuilder.toString();</TD></TR><TR CLASS="z"><TD CLASS="l">839</TD><TD>            if (!currentLocation.isFile()) {</TD></TR><TR CLASS="z"><TD CLASS="l">840</TD><TD>                return new String[] { null, null, null, null };</TD></TR><TR><TD CLASS="l">841</TD><TD>                }</TD></TR><TR><TD CLASS="l">842</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">843</TD><TD>                path = currentLocation.getAbsolutePath();</TD></TR><TR CLASS="z"><TD CLASS="l">844</TD><TD>                name = currentLocation.getName();</TD></TR><TR><TD CLASS="l">845</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">846</TD><TD>                if (&#34;.&#34;.equals(contextPath)) {</TD></TR><TR CLASS="z"><TD CLASS="l">847</TD><TD>                    scriptname = servletPath;</TD></TR><TR><TD CLASS="l">848</TD><TD>                } else {</TD></TR><TR CLASS="z"><TD CLASS="l">849</TD><TD>                    scriptname = contextPath + servletPath;</TD></TR><TR><TD CLASS="l">850</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">851</TD><TD>                if (!servletPath.equals(cginame)) {</TD></TR><TR CLASS="z"><TD CLASS="l">852</TD><TD>                    scriptname = scriptname + cginame;</TD></TR><TR><TD CLASS="l">853</TD><TD>                }</TD></TR><TR><TD CLASS="l">854</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">855</TD><TD>            if (log.isDebugEnabled()) {</TD></TR><TR CLASS="z"><TD CLASS="l">856</TD><TD>                log.debug(sm.getString(&#34;cgiServlet.find.found&#34;, name, path, scriptname, cginame));</TD></TR><TR><TD CLASS="l">857</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">858</TD><TD>            return new String[] { path, scriptname, cginame, name };</TD></TR><TR><TD CLASS="l">859</TD><TD>        }</TD></TR><TR><TD CLASS="l">860</TD><TD> </TD></TR><TR><TD CLASS="l">861</TD><TD>        /**</TD></TR><TR><TD CLASS="l">862</TD><TD>         * Constructs the CGI environment to be supplied to the invoked CGI</TD></TR><TR><TD CLASS="l">863</TD><TD>         * script; relies heavily on Servlet API methods and findCGI</TD></TR><TR><TD CLASS="l">864</TD><TD>         *</TD></TR><TR><TD CLASS="l">865</TD><TD>         * @param    req request associated with the CGI</TD></TR><TR><TD CLASS="l">866</TD><TD>         *           Invocation</TD></TR><TR><TD CLASS="l">867</TD><TD>         *</TD></TR><TR><TD CLASS="l">868</TD><TD>         * @return   true if environment was set OK, false if there</TD></TR><TR><TD CLASS="l">869</TD><TD>         *           was a problem and no environment was set</TD></TR><TR><TD CLASS="l">870</TD><TD>         * @throws IOException an IO error occurred</TD></TR><TR><TD CLASS="l">871</TD><TD>         */</TD></TR><TR><TD CLASS="l">872</TD><TD>        protected boolean setCGIEnvironment(HttpServletRequest req) throws IOException {</TD></TR><TR><TD CLASS="l">873</TD><TD> </TD></TR><TR><TD CLASS="l">874</TD><TD>            /*</TD></TR><TR><TD CLASS="l">875</TD><TD>             * This method is slightly ugly; c'est la vie.</TD></TR><TR><TD CLASS="l"><A NAME="21">876</A></TD><TD>             * &#34;You cannot stop [ugliness], you can only hope to contain [it]&#34;</TD></TR><TR><TD CLASS="l">877</TD><TD>             * (apologies to Marv Albert regarding MJ)</TD></TR><TR><TD CLASS="l">878</TD><TD>             */</TD></TR><TR><TD CLASS="l">879</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">880</TD><TD>            Hashtable&lt;String,String&gt; envp = new Hashtable&lt;String,String&gt;();</TD></TR><TR><TD CLASS="l">881</TD><TD> </TD></TR><TR><TD CLASS="l">882</TD><TD>            // Add the shell environment variables (if any)</TD></TR><TR CLASS="z"><TD CLASS="l">883</TD><TD>            envp.putAll(shellEnv);</TD></TR><TR><TD CLASS="l">884</TD><TD> </TD></TR><TR><TD CLASS="l">885</TD><TD>            // Add the CGI environment variables</TD></TR><TR CLASS="z"><TD CLASS="l">886</TD><TD>            String sPathInfoOrig = null;</TD></TR><TR CLASS="z"><TD CLASS="l">887</TD><TD>            String sPathInfoCGI = null;</TD></TR><TR CLASS="z"><TD CLASS="l">888</TD><TD>            String sPathTranslatedCGI = null;</TD></TR><TR CLASS="z"><TD CLASS="l">889</TD><TD>            String sCGIFullPath = null;</TD></TR><TR CLASS="z"><TD CLASS="l">890</TD><TD>            String sCGIScriptName = null;</TD></TR><TR CLASS="z"><TD CLASS="l">891</TD><TD>            String sCGIFullName = null;</TD></TR><TR CLASS="z"><TD CLASS="l">892</TD><TD>            String sCGIName = null;</TD></TR><TR><TD CLASS="l">893</TD><TD>            String[] sCGINames;</TD></TR><TR><TD CLASS="l">894</TD><TD> </TD></TR><TR><TD CLASS="l">895</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">896</TD><TD>            sPathInfoOrig = this.pathInfo;</TD></TR><TR CLASS="z"><TD CLASS="l">897</TD><TD>            sPathInfoOrig = sPathInfoOrig == null ? &#34;&#34; : sPathInfoOrig;</TD></TR><TR><TD CLASS="l">898</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">899</TD><TD>            if (webAppRootDir == null ) {</TD></TR><TR><TD CLASS="l">900</TD><TD>                // The app has not been deployed in exploded form</TD></TR><TR CLASS="z"><TD CLASS="l">901</TD><TD>                webAppRootDir = tmpDir.toString();</TD></TR><TR CLASS="z"><TD CLASS="l">902</TD><TD>                expandCGIScript();</TD></TR><TR><TD CLASS="l">903</TD><TD>            }</TD></TR><TR><TD CLASS="l">904</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">905</TD><TD>            sCGINames = findCGI(sPathInfoOrig,</TD></TR><TR><TD CLASS="l">906</TD><TD>                                webAppRootDir,</TD></TR><TR><TD CLASS="l">907</TD><TD>                                contextPath,</TD></TR><TR><TD CLASS="l">908</TD><TD>                                servletPath,</TD></TR><TR CLASS="z"><TD CLASS="l">909</TD><TD>                                cgiPathPrefix);</TD></TR><TR><TD CLASS="l">910</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">911</TD><TD>            sCGIFullPath = sCGINames[0];</TD></TR><TR CLASS="z"><TD CLASS="l">912</TD><TD>            sCGIScriptName = sCGINames[1];</TD></TR><TR CLASS="z"><TD CLASS="l">913</TD><TD>            sCGIFullName = sCGINames[2];</TD></TR><TR CLASS="z"><TD CLASS="l">914</TD><TD>            sCGIName = sCGINames[3];</TD></TR><TR><TD CLASS="l">915</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">916</TD><TD>            if (sCGIFullPath == null</TD></TR><TR><TD CLASS="l">917</TD><TD>                || sCGIScriptName == null</TD></TR><TR><TD CLASS="l">918</TD><TD>                || sCGIFullName == null</TD></TR><TR><TD CLASS="l">919</TD><TD>                || sCGIName == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">920</TD><TD>                return false;</TD></TR><TR><TD CLASS="l">921</TD><TD>            }</TD></TR><TR><TD CLASS="l">922</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">923</TD><TD>            envp.put(&#34;SERVER_SOFTWARE&#34;, &#34;TOMCAT&#34;);</TD></TR><TR><TD CLASS="l">924</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">925</TD><TD>            envp.put(&#34;SERVER_NAME&#34;, nullsToBlanks(req.getServerName()));</TD></TR><TR><TD CLASS="l">926</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">927</TD><TD>            envp.put(&#34;GATEWAY_INTERFACE&#34;, &#34;CGI/1.1&#34;);</TD></TR><TR><TD CLASS="l">928</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">929</TD><TD>            envp.put(&#34;SERVER_PROTOCOL&#34;, nullsToBlanks(req.getProtocol()));</TD></TR><TR><TD CLASS="l">930</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">931</TD><TD>            int port = req.getServerPort();</TD></TR><TR CLASS="z"><TD CLASS="l">932</TD><TD>            Integer iPort =</TD></TR><TR CLASS="z"><TD CLASS="l">933</TD><TD>                (port == 0 ? Integer.valueOf(-1) : Integer.valueOf(port));</TD></TR><TR CLASS="z"><TD CLASS="l">934</TD><TD>            envp.put(&#34;SERVER_PORT&#34;, iPort.toString());</TD></TR><TR><TD CLASS="l">935</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">936</TD><TD>            envp.put(&#34;REQUEST_METHOD&#34;, nullsToBlanks(req.getMethod()));</TD></TR><TR><TD CLASS="l">937</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">938</TD><TD>            envp.put(&#34;REQUEST_URI&#34;, nullsToBlanks(req.getRequestURI()));</TD></TR><TR><TD CLASS="l">939</TD><TD> </TD></TR><TR><TD CLASS="l">940</TD><TD> </TD></TR><TR><TD CLASS="l">941</TD><TD>            /*-</TD></TR><TR><TD CLASS="l">942</TD><TD>             * PATH_INFO should be determined by using sCGIFullName:</TD></TR><TR><TD CLASS="l">943</TD><TD>             * 1) Let sCGIFullName not end in a &#34;/&#34; (see method findCGI)</TD></TR><TR><TD CLASS="l">944</TD><TD>             * 2) Let sCGIFullName equal the pathInfo fragment which</TD></TR><TR><TD CLASS="l">945</TD><TD>             *    corresponds to the actual cgi script.</TD></TR><TR><TD CLASS="l">946</TD><TD>             * 3) Thus, PATH_INFO = request.getPathInfo().substring(</TD></TR><TR><TD CLASS="l">947</TD><TD>             *                      sCGIFullName.length())</TD></TR><TR><TD CLASS="l">948</TD><TD>             *</TD></TR><TR><TD CLASS="l">949</TD><TD>             * (see method findCGI, where the real work is done)</TD></TR><TR><TD CLASS="l">950</TD><TD>             *</TD></TR><TR><TD CLASS="l">951</TD><TD>             */</TD></TR><TR CLASS="z"><TD CLASS="l">952</TD><TD>            if (pathInfo == null</TD></TR><TR CLASS="z"><TD CLASS="l">953</TD><TD>                || (pathInfo.substring(sCGIFullName.length()).length() &lt;= 0)) {</TD></TR><TR CLASS="z"><TD CLASS="l">954</TD><TD>                sPathInfoCGI = &#34;&#34;;</TD></TR><TR><TD CLASS="l">955</TD><TD>            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">956</TD><TD>                sPathInfoCGI = pathInfo.substring(sCGIFullName.length());</TD></TR><TR><TD CLASS="l">957</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">958</TD><TD>            envp.put(&#34;PATH_INFO&#34;, sPathInfoCGI);</TD></TR><TR><TD CLASS="l">959</TD><TD> </TD></TR><TR><TD CLASS="l">960</TD><TD> </TD></TR><TR><TD CLASS="l">961</TD><TD>            /*-</TD></TR><TR><TD CLASS="l">962</TD><TD>             * PATH_TRANSLATED must be determined after PATH_INFO (and the</TD></TR><TR><TD CLASS="l">963</TD><TD>             * implied real cgi-script) has been taken into account.</TD></TR><TR><TD CLASS="l">964</TD><TD>             *</TD></TR><TR><TD CLASS="l">965</TD><TD>             * The following example demonstrates:</TD></TR><TR><TD CLASS="l">966</TD><TD>             *</TD></TR><TR><TD CLASS="l">967</TD><TD>             * servlet info   = /servlet/cgigw/dir1/dir2/cgi1/trans1/trans2</TD></TR><TR><TD CLASS="l">968</TD><TD>             * cgifullpath    = /servlet/cgigw/dir1/dir2/cgi1</TD></TR><TR><TD CLASS="l">969</TD><TD>             * path_info      = /trans1/trans2</TD></TR><TR><TD CLASS="l">970</TD><TD>             * webAppRootDir  = servletContext.getRealPath(&#34;/&#34;)</TD></TR><TR><TD CLASS="l">971</TD><TD>             *</TD></TR><TR><TD CLASS="l">972</TD><TD>             * path_translated = servletContext.getRealPath(&#34;/trans1/trans2&#34;)</TD></TR><TR><TD CLASS="l">973</TD><TD>             *</TD></TR><TR><TD CLASS="l">974</TD><TD>             * That is, PATH_TRANSLATED = webAppRootDir + sPathInfoCGI</TD></TR><TR><TD CLASS="l">975</TD><TD>             * (unless sPathInfoCGI is null or blank, then the CGI</TD></TR><TR><TD CLASS="l">976</TD><TD>             * specification dictates that the PATH_TRANSLATED metavariable</TD></TR><TR><TD CLASS="l">977</TD><TD>             * SHOULD NOT be defined.</TD></TR><TR><TD CLASS="l">978</TD><TD>             *</TD></TR><TR><TD CLASS="l">979</TD><TD>             */</TD></TR><TR CLASS="z"><TD CLASS="l">980</TD><TD>            if (!(&#34;&#34;.equals(sPathInfoCGI))) {</TD></TR><TR CLASS="z"><TD CLASS="l">981</TD><TD>                sPathTranslatedCGI = context.getRealPath(sPathInfoCGI);</TD></TR><TR><TD CLASS="l">982</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">983</TD><TD>            if (sPathTranslatedCGI == null || &#34;&#34;.equals(sPathTranslatedCGI)) {</TD></TR><TR><TD CLASS="l">984</TD><TD>                //NOOP</TD></TR><TR><TD CLASS="l">985</TD><TD>            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">986</TD><TD>                envp.put(&#34;PATH_TRANSLATED&#34;, nullsToBlanks(sPathTranslatedCGI));</TD></TR><TR><TD CLASS="l">987</TD><TD>            }</TD></TR><TR><TD CLASS="l">988</TD><TD> </TD></TR><TR><TD CLASS="l">989</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">990</TD><TD>            envp.put(&#34;SCRIPT_NAME&#34;, nullsToBlanks(sCGIScriptName));</TD></TR><TR><TD CLASS="l">991</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">992</TD><TD>            envp.put(&#34;QUERY_STRING&#34;, nullsToBlanks(req.getQueryString()));</TD></TR><TR><TD CLASS="l">993</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">994</TD><TD>            envp.put(&#34;REMOTE_HOST&#34;, nullsToBlanks(req.getRemoteHost()));</TD></TR><TR><TD CLASS="l">995</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">996</TD><TD>            envp.put(&#34;REMOTE_ADDR&#34;, nullsToBlanks(req.getRemoteAddr()));</TD></TR><TR><TD CLASS="l">997</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">998</TD><TD>            envp.put(&#34;AUTH_TYPE&#34;, nullsToBlanks(req.getAuthType()));</TD></TR><TR><TD CLASS="l">999</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1000</TD><TD>            envp.put(&#34;REMOTE_USER&#34;, nullsToBlanks(req.getRemoteUser()));</TD></TR><TR><TD CLASS="l">1001</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1002</TD><TD>            envp.put(&#34;REMOTE_IDENT&#34;, &#34;&#34;); //not necessary for full compliance</TD></TR><TR><TD CLASS="l">1003</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1004</TD><TD>            envp.put(&#34;CONTENT_TYPE&#34;, nullsToBlanks(req.getContentType()));</TD></TR><TR><TD CLASS="l">1005</TD><TD> </TD></TR><TR><TD CLASS="l">1006</TD><TD> </TD></TR><TR><TD CLASS="l">1007</TD><TD>            /* Note CGI spec says CONTENT_LENGTH must be NULL (&#34;&#34;) or undefined</TD></TR><TR><TD CLASS="l">1008</TD><TD>             * if there is no content, so we cannot put 0 or -1 in as per the</TD></TR><TR><TD CLASS="l">1009</TD><TD>             * Servlet API spec.</TD></TR><TR><TD CLASS="l">1010</TD><TD>             */</TD></TR><TR CLASS="z"><TD CLASS="l">1011</TD><TD>            int contentLength = req.getContentLength();</TD></TR><TR CLASS="z"><TD CLASS="l">1012</TD><TD>            String sContentLength = (contentLength &lt;= 0 ? &#34;&#34; :</TD></TR><TR CLASS="z"><TD CLASS="l">1013</TD><TD>                Integer.toString(contentLength));</TD></TR><TR CLASS="z"><TD CLASS="l">1014</TD><TD>            envp.put(&#34;CONTENT_LENGTH&#34;, sContentLength);</TD></TR><TR><TD CLASS="l">1015</TD><TD> </TD></TR><TR><TD CLASS="l">1016</TD><TD> </TD></TR><TR><TD CLASS="l">1017</TD><TD>            @SuppressWarnings(&#34;unchecked&#34;)</TD></TR><TR CLASS="z"><TD CLASS="l">1018</TD><TD>            Enumeration&lt;String&gt; headers = req.getHeaderNames();</TD></TR><TR CLASS="z"><TD CLASS="l">1019</TD><TD>            String header = null;</TD></TR><TR CLASS="z"><TD CLASS="l">1020</TD><TD>            while (headers.hasMoreElements()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1021</TD><TD>                header = null;</TD></TR><TR CLASS="z"><TD CLASS="l">1022</TD><TD>                header = headers.nextElement().toUpperCase(Locale.ENGLISH);</TD></TR><TR><TD CLASS="l">1023</TD><TD>                //REMIND: rewrite multiple headers as if received as single</TD></TR><TR><TD CLASS="l">1024</TD><TD>                //REMIND: change character set</TD></TR><TR><TD CLASS="l">1025</TD><TD>                //REMIND: I forgot what the previous REMIND means</TD></TR><TR CLASS="z"><TD CLASS="l">1026</TD><TD>                if (envHttpHeadersPattern.matcher(header).matches()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1027</TD><TD>                    envp.put(&#34;HTTP_&#34; + header.replace('-', '_'), req.getHeader(header));</TD></TR><TR><TD CLASS="l">1028</TD><TD>                }</TD></TR><TR><TD CLASS="l">1029</TD><TD>            }</TD></TR><TR><TD CLASS="l">1030</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1031</TD><TD>            File fCGIFullPath = new File(sCGIFullPath);</TD></TR><TR CLASS="z"><TD CLASS="l">1032</TD><TD>            command = fCGIFullPath.getCanonicalPath();</TD></TR><TR><TD CLASS="l">1033</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1034</TD><TD>            envp.put(&#34;X_TOMCAT_SCRIPT_PATH&#34;, command);  //for kicks</TD></TR><TR><TD CLASS="l">1035</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1036</TD><TD>            envp.put(&#34;SCRIPT_FILENAME&#34;, command);  //for PHP</TD></TR><TR><TD CLASS="l">1037</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1038</TD><TD>            this.env = envp;</TD></TR><TR><TD CLASS="l">1039</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1040</TD><TD>            return true;</TD></TR><TR><TD CLASS="l">1041</TD><TD> </TD></TR><TR><TD CLASS="l">1042</TD><TD>        }</TD></TR><TR><TD CLASS="l">1043</TD><TD> </TD></TR><TR><TD CLASS="l">1044</TD><TD>        /**</TD></TR><TR><TD CLASS="l"><A NAME="18">1045</A></TD><TD>         * Extracts requested resource from web app archive to context work</TD></TR><TR><TD CLASS="l">1046</TD><TD>         * directory to enable CGI script to be executed.</TD></TR><TR><TD CLASS="l">1047</TD><TD>         */</TD></TR><TR><TD CLASS="l">1048</TD><TD>        protected void expandCGIScript() {</TD></TR><TR CLASS="z"><TD CLASS="l">1049</TD><TD>            StringBuilder srcPath = new StringBuilder();</TD></TR><TR CLASS="z"><TD CLASS="l">1050</TD><TD>            StringBuilder destPath = new StringBuilder();</TD></TR><TR CLASS="z"><TD CLASS="l">1051</TD><TD>            InputStream is = null;</TD></TR><TR><TD CLASS="l">1052</TD><TD> </TD></TR><TR><TD CLASS="l">1053</TD><TD>            // paths depend on mapping</TD></TR><TR CLASS="z"><TD CLASS="l">1054</TD><TD>            if (cgiPathPrefix == null ) {</TD></TR><TR CLASS="z"><TD CLASS="l">1055</TD><TD>                srcPath.append(pathInfo);</TD></TR><TR CLASS="z"><TD CLASS="l">1056</TD><TD>                is = context.getResourceAsStream(srcPath.toString());</TD></TR><TR CLASS="z"><TD CLASS="l">1057</TD><TD>                destPath.append(tmpDir);</TD></TR><TR CLASS="z"><TD CLASS="l">1058</TD><TD>                destPath.append(pathInfo);</TD></TR><TR><TD CLASS="l">1059</TD><TD>            } else {</TD></TR><TR><TD CLASS="l">1060</TD><TD>                // essentially same search algorithm as findCGI()</TD></TR><TR CLASS="z"><TD CLASS="l">1061</TD><TD>                srcPath.append(cgiPathPrefix);</TD></TR><TR CLASS="z"><TD CLASS="l">1062</TD><TD>                StringTokenizer pathWalker =</TD></TR><TR><TD CLASS="l">1063</TD><TD>                        new StringTokenizer (pathInfo, &#34;/&#34;);</TD></TR><TR><TD CLASS="l">1064</TD><TD>                // start with first element</TD></TR><TR CLASS="z"><TD CLASS="l">1065</TD><TD>                while (pathWalker.hasMoreElements() &amp;&amp; (is == null)) {</TD></TR><TR CLASS="z"><TD CLASS="l">1066</TD><TD>                    srcPath.append(&#34;/&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1067</TD><TD>                    srcPath.append(pathWalker.nextElement());</TD></TR><TR CLASS="z"><TD CLASS="l">1068</TD><TD>                    is = context.getResourceAsStream(srcPath.toString());</TD></TR><TR><TD CLASS="l">1069</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1070</TD><TD>                destPath.append(tmpDir);</TD></TR><TR CLASS="z"><TD CLASS="l">1071</TD><TD>                destPath.append(&#34;/&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1072</TD><TD>                destPath.append(srcPath);</TD></TR><TR><TD CLASS="l">1073</TD><TD>            }</TD></TR><TR><TD CLASS="l">1074</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1075</TD><TD>            if (is == null) {</TD></TR><TR><TD CLASS="l">1076</TD><TD>                // didn't find anything, give up now</TD></TR><TR CLASS="z"><TD CLASS="l">1077</TD><TD>                log.warn(sm.getString(&#34;cgiServlet.expandNotFound&#34;, srcPath));</TD></TR><TR CLASS="z"><TD CLASS="l">1078</TD><TD>                return;</TD></TR><TR><TD CLASS="l">1079</TD><TD>            }</TD></TR><TR><TD CLASS="l">1080</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1081</TD><TD>            File f = new File(destPath.toString());</TD></TR><TR CLASS="z"><TD CLASS="l">1082</TD><TD>            if (f.exists()) {</TD></TR><TR><TD CLASS="l">1083</TD><TD>                try {</TD></TR><TR CLASS="z"><TD CLASS="l">1084</TD><TD>                    is.close();</TD></TR><TR CLASS="z"><TD CLASS="l">1085</TD><TD>                } catch (IOException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1086</TD><TD>                    log.warn(sm.getString(&#34;cgiServlet.expandCloseFail&#34;, srcPath), e);</TD></TR><TR CLASS="z"><TD CLASS="l">1087</TD><TD>                }</TD></TR><TR><TD CLASS="l">1088</TD><TD>                // Don't need to expand if it already exists</TD></TR><TR CLASS="z"><TD CLASS="l">1089</TD><TD>                return;</TD></TR><TR><TD CLASS="l">1090</TD><TD>            }</TD></TR><TR><TD CLASS="l">1091</TD><TD> </TD></TR><TR><TD CLASS="l">1092</TD><TD>            // create directories</TD></TR><TR CLASS="z"><TD CLASS="l">1093</TD><TD>            File dir = f.getParentFile();</TD></TR><TR CLASS="z"><TD CLASS="l">1094</TD><TD>            if (!dir.mkdirs() &amp;&amp; !dir.isDirectory()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1095</TD><TD>                log.warn(sm.getString(&#34;cgiServlet.expandCreateDirFail&#34;, dir.getAbsolutePath()));</TD></TR><TR CLASS="z"><TD CLASS="l">1096</TD><TD>                return;</TD></TR><TR><TD CLASS="l">1097</TD><TD>            }</TD></TR><TR><TD CLASS="l">1098</TD><TD> </TD></TR><TR><TD CLASS="l">1099</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">1100</TD><TD>                synchronized (expandFileLock) {</TD></TR><TR><TD CLASS="l">1101</TD><TD>                    // make sure file doesn't exist</TD></TR><TR CLASS="z"><TD CLASS="l">1102</TD><TD>                    if (f.exists()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1103</TD><TD>                        return;</TD></TR><TR><TD CLASS="l">1104</TD><TD>                    }</TD></TR><TR><TD CLASS="l">1105</TD><TD> </TD></TR><TR><TD CLASS="l">1106</TD><TD>                    // create file</TD></TR><TR CLASS="z"><TD CLASS="l">1107</TD><TD>                    if (!f.createNewFile()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1108</TD><TD>                        return;</TD></TR><TR><TD CLASS="l">1109</TD><TD>                    }</TD></TR><TR CLASS="z"><TD CLASS="l">1110</TD><TD>                    FileOutputStream fos = new FileOutputStream(f);</TD></TR><TR><TD CLASS="l">1111</TD><TD> </TD></TR><TR><TD CLASS="l">1112</TD><TD>                    try {</TD></TR><TR><TD CLASS="l">1113</TD><TD>                    // copy data</TD></TR><TR CLASS="z"><TD CLASS="l">1114</TD><TD>                    IOTools.flow(is, fos);</TD></TR><TR CLASS="z"><TD CLASS="l">1115</TD><TD>                    } finally {</TD></TR><TR CLASS="z"><TD CLASS="l">1116</TD><TD>                        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1117</TD><TD>                            is.close();</TD></TR><TR CLASS="z"><TD CLASS="l">1118</TD><TD>                        } catch (IOException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1119</TD><TD>                            log.warn(sm.getString(&#34;cgiServlet.expandError&#34;), e);</TD></TR><TR CLASS="z"><TD CLASS="l">1120</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">1121</TD><TD>                        fos.close();</TD></TR><TR CLASS="z"><TD CLASS="l">1122</TD><TD>                    }</TD></TR><TR CLASS="z"><TD CLASS="l">1123</TD><TD>                    if (log.isDebugEnabled()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1124</TD><TD>                        log.debug(sm.getString(&#34;cgiServlet.expandOk&#34;, srcPath, destPath));</TD></TR><TR><TD CLASS="l">1125</TD><TD>                    }</TD></TR><TR CLASS="z"><TD CLASS="l">1126</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1127</TD><TD>            } catch (IOException ioe) {</TD></TR><TR CLASS="z"><TD CLASS="l">1128</TD><TD>                log.warn(sm.getString(&#34;cgiServlet.expandFail&#34;, srcPath, destPath), ioe);</TD></TR><TR><TD CLASS="l">1129</TD><TD>                // delete in case file is corrupted</TD></TR><TR CLASS="z"><TD CLASS="l">1130</TD><TD>                if (f.exists()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1131</TD><TD>                    if (!f.delete()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1132</TD><TD>                        log.warn(sm.getString(&#34;cgiServlet.expandDeleteFail&#34;, f.getAbsolutePath()));</TD></TR><TR><TD CLASS="l">1133</TD><TD>                    }</TD></TR><TR><TD CLASS="l">1134</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1135</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">1136</TD><TD>        }</TD></TR><TR><TD CLASS="l">1137</TD><TD> </TD></TR><TR><TD CLASS="l">1138</TD><TD> </TD></TR><TR><TD CLASS="l">1139</TD><TD>        /**</TD></TR><TR><TD CLASS="l">1140</TD><TD>         * Returns important CGI environment information in a multi-line text</TD></TR><TR><TD CLASS="l">1141</TD><TD>         * format.</TD></TR><TR><TD CLASS="l">1142</TD><TD>         *</TD></TR><TR><TD CLASS="l">1143</TD><TD>         * @return CGI environment info</TD></TR><TR><TD CLASS="l"><A NAME="24">1144</A></TD><TD>         */</TD></TR><TR><TD CLASS="l">1145</TD><TD>        @Override</TD></TR><TR><TD CLASS="l">1146</TD><TD>        public String toString() {</TD></TR><TR><TD CLASS="l">1147</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1148</TD><TD>            StringBuilder sb = new StringBuilder();</TD></TR><TR><TD CLASS="l">1149</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1150</TD><TD>            sb.append(&#34;CGIEnvironment Info:&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1151</TD><TD>            sb.append(LINE_SEP);</TD></TR><TR><TD CLASS="l">1152</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1153</TD><TD>            if (isValid()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1154</TD><TD>                sb.append(&#34;Validity: [true]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1155</TD><TD>                sb.append(LINE_SEP);</TD></TR><TR><TD CLASS="l">1156</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1157</TD><TD>                sb.append(&#34;Environment values:&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1158</TD><TD>                sb.append(LINE_SEP);</TD></TR><TR CLASS="z"><TD CLASS="l">1159</TD><TD>                for (Entry&lt;String,String&gt; entry : env.entrySet()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1160</TD><TD>                    sb.append(&#34;  &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1161</TD><TD>                    sb.append(entry.getKey());</TD></TR><TR CLASS="z"><TD CLASS="l">1162</TD><TD>                    sb.append(&#34;: [&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1163</TD><TD>                    sb.append(blanksToString(entry.getValue(), &#34;will be set to blank&#34;));</TD></TR><TR CLASS="z"><TD CLASS="l">1164</TD><TD>                    sb.append(&#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1165</TD><TD>                    sb.append(LINE_SEP);</TD></TR><TR CLASS="z"><TD CLASS="l">1166</TD><TD>                }</TD></TR><TR><TD CLASS="l">1167</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1168</TD><TD>                sb.append(&#34;Derived Command :[&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1169</TD><TD>                sb.append(nullsToBlanks(command));</TD></TR><TR CLASS="z"><TD CLASS="l">1170</TD><TD>                sb.append(&#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1171</TD><TD>                sb.append(LINE_SEP);</TD></TR><TR><TD CLASS="l">1172</TD><TD> </TD></TR><TR><TD CLASS="l">1173</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1174</TD><TD>                sb.append(&#34;Working Directory: [&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1175</TD><TD>                if (workingDirectory != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">1176</TD><TD>                    sb.append(workingDirectory.toString());</TD></TR><TR><TD CLASS="l">1177</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1178</TD><TD>                sb.append(&#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1179</TD><TD>                sb.append(LINE_SEP);</TD></TR><TR><TD CLASS="l">1180</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1181</TD><TD>                sb.append(&#34;Command Line Params:&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1182</TD><TD>                sb.append(LINE_SEP);</TD></TR><TR CLASS="z"><TD CLASS="l">1183</TD><TD>                for (String param : cmdLineParameters) {</TD></TR><TR CLASS="z"><TD CLASS="l">1184</TD><TD>                    sb.append(&#34;  [&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1185</TD><TD>                    sb.append(param);</TD></TR><TR CLASS="z"><TD CLASS="l">1186</TD><TD>                    sb.append(&#34;]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1187</TD><TD>                    sb.append(LINE_SEP);</TD></TR><TR CLASS="z"><TD CLASS="l">1188</TD><TD>                }</TD></TR><TR><TD CLASS="l">1189</TD><TD>            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">1190</TD><TD>                sb.append(&#34;Validity: [false]&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1191</TD><TD>                sb.append(LINE_SEP);</TD></TR><TR CLASS="z"><TD CLASS="l">1192</TD><TD>                sb.append(&#34;CGI script not found or not specified.&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1193</TD><TD>                sb.append(LINE_SEP);</TD></TR><TR CLASS="z"><TD CLASS="l">1194</TD><TD>                sb.append(&#34;Check the HttpServletRequest pathInfo property to see if it is what &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1195</TD><TD>                sb.append(LINE_SEP);</TD></TR><TR CLASS="z"><TD CLASS="l">1196</TD><TD>                sb.append(&#34;you meant it to be. You must specify an existant and executable file &#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1197</TD><TD>                sb.append(LINE_SEP);</TD></TR><TR CLASS="z"><TD CLASS="l">1198</TD><TD>                sb.append(&#34;as part of the path-info.&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">1199</TD><TD>                sb.append(LINE_SEP);</TD></TR><TR><TD CLASS="l">1200</TD><TD>            }</TD></TR><TR><TD CLASS="l">1201</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1202</TD><TD>            return sb.toString();</TD></TR><TR><TD CLASS="l">1203</TD><TD>        }</TD></TR><TR><TD CLASS="l">1204</TD><TD> </TD></TR><TR><TD CLASS="l">1205</TD><TD> </TD></TR><TR><TD CLASS="l">1206</TD><TD>        /**</TD></TR><TR><TD CLASS="l">1207</TD><TD>         * Gets derived command string</TD></TR><TR><TD CLASS="l">1208</TD><TD>         *</TD></TR><TR><TD CLASS="l"><A NAME="1a">1209</A></TD><TD>         * @return  command string</TD></TR><TR><TD CLASS="l">1210</TD><TD>         *</TD></TR><TR><TD CLASS="l">1211</TD><TD>         */</TD></TR><TR><TD CLASS="l">1212</TD><TD>        protected String getCommand() {</TD></TR><TR CLASS="z"><TD CLASS="l">1213</TD><TD>            return command;</TD></TR><TR><TD CLASS="l">1214</TD><TD>        }</TD></TR><TR><TD CLASS="l">1215</TD><TD> </TD></TR><TR><TD CLASS="l">1216</TD><TD> </TD></TR><TR><TD CLASS="l">1217</TD><TD>        /**</TD></TR><TR><TD CLASS="l">1218</TD><TD>         * Gets derived CGI working directory</TD></TR><TR><TD CLASS="l">1219</TD><TD>         *</TD></TR><TR><TD CLASS="l"><A NAME="1d">1220</A></TD><TD>         * @return  working directory</TD></TR><TR><TD CLASS="l">1221</TD><TD>         *</TD></TR><TR><TD CLASS="l">1222</TD><TD>         */</TD></TR><TR><TD CLASS="l">1223</TD><TD>        protected File getWorkingDirectory() {</TD></TR><TR CLASS="z"><TD CLASS="l">1224</TD><TD>            return workingDirectory;</TD></TR><TR><TD CLASS="l">1225</TD><TD>        }</TD></TR><TR><TD CLASS="l">1226</TD><TD> </TD></TR><TR><TD CLASS="l">1227</TD><TD> </TD></TR><TR><TD CLASS="l">1228</TD><TD>        /**</TD></TR><TR><TD CLASS="l">1229</TD><TD>         * Gets derived CGI environment</TD></TR><TR><TD CLASS="l">1230</TD><TD>         *</TD></TR><TR><TD CLASS="l"><A NAME="1b">1231</A></TD><TD>         * @return   CGI environment</TD></TR><TR><TD CLASS="l">1232</TD><TD>         *</TD></TR><TR><TD CLASS="l">1233</TD><TD>         */</TD></TR><TR><TD CLASS="l">1234</TD><TD>        protected Hashtable&lt;String,String&gt; getEnvironment() {</TD></TR><TR CLASS="z"><TD CLASS="l">1235</TD><TD>            return env;</TD></TR><TR><TD CLASS="l">1236</TD><TD>        }</TD></TR><TR><TD CLASS="l">1237</TD><TD> </TD></TR><TR><TD CLASS="l">1238</TD><TD> </TD></TR><TR><TD CLASS="l">1239</TD><TD>        /**</TD></TR><TR><TD CLASS="l">1240</TD><TD>         * Gets derived CGI query parameters</TD></TR><TR><TD CLASS="l">1241</TD><TD>         *</TD></TR><TR><TD CLASS="l"><A NAME="1c">1242</A></TD><TD>         * @return   CGI query parameters</TD></TR><TR><TD CLASS="l">1243</TD><TD>         *</TD></TR><TR><TD CLASS="l">1244</TD><TD>         */</TD></TR><TR><TD CLASS="l">1245</TD><TD>        protected ArrayList&lt;String&gt; getParameters() {</TD></TR><TR CLASS="z"><TD CLASS="l">1246</TD><TD>            return cmdLineParameters;</TD></TR><TR><TD CLASS="l">1247</TD><TD>        }</TD></TR><TR><TD CLASS="l">1248</TD><TD> </TD></TR><TR><TD CLASS="l">1249</TD><TD> </TD></TR><TR><TD CLASS="l">1250</TD><TD>        /**</TD></TR><TR><TD CLASS="l">1251</TD><TD>         * Gets validity status</TD></TR><TR><TD CLASS="l">1252</TD><TD>         *</TD></TR><TR><TD CLASS="l">1253</TD><TD>         * @return   true if this environment is valid, false</TD></TR><TR><TD CLASS="l"><A NAME="1e">1254</A></TD><TD>         *           otherwise</TD></TR><TR><TD CLASS="l">1255</TD><TD>         *</TD></TR><TR><TD CLASS="l">1256</TD><TD>         */</TD></TR><TR><TD CLASS="l">1257</TD><TD>        protected boolean isValid() {</TD></TR><TR CLASS="z"><TD CLASS="l">1258</TD><TD>            return valid;</TD></TR><TR><TD CLASS="l">1259</TD><TD>        }</TD></TR><TR><TD CLASS="l">1260</TD><TD> </TD></TR><TR><TD CLASS="l">1261</TD><TD> </TD></TR><TR><TD CLASS="l">1262</TD><TD>        /**</TD></TR><TR><TD CLASS="l">1263</TD><TD>         * Converts null strings to blank strings (&#34;&#34;)</TD></TR><TR><TD CLASS="l">1264</TD><TD>         *</TD></TR><TR><TD CLASS="l">1265</TD><TD>         * @param    s string to be converted if necessary</TD></TR><TR><TD CLASS="l"><A NAME="1f">1266</A></TD><TD>         * @return   a non-null string, either the original or the empty string</TD></TR><TR><TD CLASS="l">1267</TD><TD>         *           (&#34;&#34;) if the original was &lt;code&gt;null&lt;/code&gt;</TD></TR><TR><TD CLASS="l">1268</TD><TD>         */</TD></TR><TR><TD CLASS="l">1269</TD><TD>        protected String nullsToBlanks(String s) {</TD></TR><TR CLASS="z"><TD CLASS="l">1270</TD><TD>            return nullsToString(s, &#34;&#34;);</TD></TR><TR><TD CLASS="l">1271</TD><TD>        }</TD></TR><TR><TD CLASS="l">1272</TD><TD> </TD></TR><TR><TD CLASS="l">1273</TD><TD> </TD></TR><TR><TD CLASS="l">1274</TD><TD>        /**</TD></TR><TR><TD CLASS="l">1275</TD><TD>         * Converts null strings to another string</TD></TR><TR><TD CLASS="l">1276</TD><TD>         *</TD></TR><TR><TD CLASS="l">1277</TD><TD>         * @param    couldBeNull string to be converted if necessary</TD></TR><TR><TD CLASS="l">1278</TD><TD>         * @param    subForNulls string to return instead of a null string</TD></TR><TR><TD CLASS="l">1279</TD><TD>         * @return   a non-null string, either the original or the substitute</TD></TR><TR><TD CLASS="l"><A NAME="20">1280</A></TD><TD>         *           string if the original was &lt;code&gt;null&lt;/code&gt;</TD></TR><TR><TD CLASS="l">1281</TD><TD>         */</TD></TR><TR><TD CLASS="l">1282</TD><TD>        protected String nullsToString(String couldBeNull,</TD></TR><TR><TD CLASS="l">1283</TD><TD>                                       String subForNulls) {</TD></TR><TR CLASS="z"><TD CLASS="l">1284</TD><TD>            return (couldBeNull == null ? subForNulls : couldBeNull);</TD></TR><TR><TD CLASS="l">1285</TD><TD>        }</TD></TR><TR><TD CLASS="l">1286</TD><TD> </TD></TR><TR><TD CLASS="l">1287</TD><TD> </TD></TR><TR><TD CLASS="l">1288</TD><TD>        /**</TD></TR><TR><TD CLASS="l">1289</TD><TD>         * Converts blank strings to another string</TD></TR><TR><TD CLASS="l">1290</TD><TD>         *</TD></TR><TR><TD CLASS="l">1291</TD><TD>         * @param    couldBeBlank string to be converted if necessary</TD></TR><TR><TD CLASS="l">1292</TD><TD>         * @param    subForBlanks string to return instead of a blank string</TD></TR><TR><TD CLASS="l">1293</TD><TD>         * @return   a non-null string, either the original or the substitute</TD></TR><TR><TD CLASS="l"><A NAME="17">1294</A></TD><TD>         *           string if the original was &lt;code&gt;null&lt;/code&gt; or empty (&#34;&#34;)</TD></TR><TR><TD CLASS="l">1295</TD><TD>         */</TD></TR><TR><TD CLASS="l">1296</TD><TD>        protected String blanksToString(String couldBeBlank,</TD></TR><TR><TD CLASS="l">1297</TD><TD>                                      String subForBlanks) {</TD></TR><TR CLASS="z"><TD CLASS="l">1298</TD><TD>            return ((&#34;&#34;.equals(couldBeBlank) || couldBeBlank == null)</TD></TR><TR><TD CLASS="l">1299</TD><TD>                    ? subForBlanks</TD></TR><TR><TD CLASS="l">1300</TD><TD>                    : couldBeBlank);</TD></TR><TR><TD CLASS="l">1301</TD><TD>        }</TD></TR><TR><TD CLASS="l">1302</TD><TD> </TD></TR><TR><TD CLASS="l">1303</TD><TD> </TD></TR><TR><TD CLASS="l">1304</TD><TD>    } //class CGIEnvironment</TD></TR><TR><TD CLASS="l">1305</TD><TD> </TD></TR><TR><TD CLASS="l">1306</TD><TD> </TD></TR><TR><TD CLASS="l">1307</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1308</TD><TD>     * Encapsulates the knowledge of how to run a CGI script, given the</TD></TR><TR><TD CLASS="l">1309</TD><TD>     * script's desired environment and (optionally) input/output streams</TD></TR><TR><TD CLASS="l">1310</TD><TD>     *</TD></TR><TR><TD CLASS="l">1311</TD><TD>     * &lt;p&gt;</TD></TR><TR><TD CLASS="l">1312</TD><TD>     *</TD></TR><TR><TD CLASS="l">1313</TD><TD>     * Exposes a &lt;code&gt;run&lt;/code&gt; method used to actually invoke the</TD></TR><TR><TD CLASS="l">1314</TD><TD>     * CGI.</TD></TR><TR><TD CLASS="l">1315</TD><TD>     *</TD></TR><TR><TD CLASS="l">1316</TD><TD>     * &lt;/p&gt;</TD></TR><TR><TD CLASS="l">1317</TD><TD>     * &lt;p&gt;</TD></TR><TR><TD CLASS="l">1318</TD><TD>     *</TD></TR><TR><TD CLASS="l">1319</TD><TD>     * The CGI environment and settings are derived from the information</TD></TR><TR><TD CLASS="l">1320</TD><TD>     * passed to the constructor.</TD></TR><TR><TD CLASS="l">1321</TD><TD>     *</TD></TR><TR><TD CLASS="l">1322</TD><TD>     * &lt;/p&gt;</TD></TR><TR><TD CLASS="l">1323</TD><TD>     * &lt;p&gt;</TD></TR><TR><TD CLASS="l">1324</TD><TD>     *</TD></TR><TR><TD CLASS="l"><A NAME="25">1325</A></TD><TD>     * The input and output streams can be set by the &lt;code&gt;setInput&lt;/code&gt;</TD></TR><TR><TD CLASS="l">1326</TD><TD>     * and &lt;code&gt;setResponse&lt;/code&gt; methods, respectively.</TD></TR><TR><TD CLASS="l">1327</TD><TD>     * &lt;/p&gt;</TD></TR><TR><TD CLASS="l">1328</TD><TD>     */</TD></TR><TR CLASS="z"><TD CLASS="l">1329</TD><TD>    protected class CGIRunner {</TD></TR><TR><TD CLASS="l">1330</TD><TD> </TD></TR><TR><TD CLASS="l">1331</TD><TD>        /** script/command to be executed */</TD></TR><TR><TD CLASS="l">1332</TD><TD>        private final String command;</TD></TR><TR><TD CLASS="l">1333</TD><TD> </TD></TR><TR><TD CLASS="l">1334</TD><TD>        /** environment used when invoking the cgi script */</TD></TR><TR><TD CLASS="l">1335</TD><TD>        private final Hashtable&lt;String,String&gt; env;</TD></TR><TR><TD CLASS="l">1336</TD><TD> </TD></TR><TR><TD CLASS="l">1337</TD><TD>        /** working directory used when invoking the cgi script */</TD></TR><TR><TD CLASS="l">1338</TD><TD>        private final File wd;</TD></TR><TR><TD CLASS="l">1339</TD><TD> </TD></TR><TR><TD CLASS="l">1340</TD><TD>        /** command line parameters to be passed to the invoked script */</TD></TR><TR><TD CLASS="l">1341</TD><TD>        private final ArrayList&lt;String&gt; params;</TD></TR><TR><TD CLASS="l">1342</TD><TD> </TD></TR><TR><TD CLASS="l">1343</TD><TD>        /** stdin to be passed to cgi script */</TD></TR><TR CLASS="z"><TD CLASS="l">1344</TD><TD>        private InputStream stdin = null;</TD></TR><TR><TD CLASS="l">1345</TD><TD> </TD></TR><TR><TD CLASS="l">1346</TD><TD>        /** response object used to set headers &amp; get output stream */</TD></TR><TR CLASS="z"><TD CLASS="l">1347</TD><TD>        private HttpServletResponse response = null;</TD></TR><TR><TD CLASS="l">1348</TD><TD> </TD></TR><TR><TD CLASS="l">1349</TD><TD>        /** boolean tracking whether this object has enough info to run() */</TD></TR><TR CLASS="z"><TD CLASS="l">1350</TD><TD>        private boolean readyToRun = false;</TD></TR><TR><TD CLASS="l">1351</TD><TD> </TD></TR><TR><TD CLASS="l">1352</TD><TD> </TD></TR><TR><TD CLASS="l">1353</TD><TD>        /**</TD></TR><TR><TD CLASS="l">1354</TD><TD>         *  Creates a CGIRunner and initializes its environment, working</TD></TR><TR><TD CLASS="l">1355</TD><TD>         *  directory, and query parameters.</TD></TR><TR><TD CLASS="l">1356</TD><TD>         *  &lt;BR&gt;</TD></TR><TR><TD CLASS="l">1357</TD><TD>         *  Input/output streams (optional) are set using the</TD></TR><TR><TD CLASS="l">1358</TD><TD>         *  &lt;code&gt;setInput&lt;/code&gt; and &lt;code&gt;setResponse&lt;/code&gt; methods,</TD></TR><TR><TD CLASS="l">1359</TD><TD>         *  respectively.</TD></TR><TR><TD CLASS="l">1360</TD><TD>         *</TD></TR><TR><TD CLASS="l">1361</TD><TD>         * @param  command  string full path to command to be executed</TD></TR><TR><TD CLASS="l">1362</TD><TD>         * @param  env      Hashtable with the desired script environment</TD></TR><TR><TD CLASS="l">1363</TD><TD>         * @param  wd       File with the script's desired working directory</TD></TR><TR><TD CLASS="l"><A NAME="26">1364</A></TD><TD>         * @param  params   ArrayList with the script's query command line</TD></TR><TR><TD CLASS="l">1365</TD><TD>         *                  parameters as strings</TD></TR><TR><TD CLASS="l">1366</TD><TD>         */</TD></TR><TR><TD CLASS="l">1367</TD><TD>        protected CGIRunner(String command, Hashtable&lt;String,String&gt; env,</TD></TR><TR CLASS="z"><TD CLASS="l">1368</TD><TD>                            File wd, ArrayList&lt;String&gt; params) {</TD></TR><TR CLASS="z"><TD CLASS="l">1369</TD><TD>            this.command = command;</TD></TR><TR CLASS="z"><TD CLASS="l">1370</TD><TD>            this.env = env;</TD></TR><TR CLASS="z"><TD CLASS="l">1371</TD><TD>            this.wd = wd;</TD></TR><TR CLASS="z"><TD CLASS="l">1372</TD><TD>            this.params = params;</TD></TR><TR CLASS="z"><TD CLASS="l">1373</TD><TD>            updateReadyStatus();</TD></TR><TR CLASS="z"><TD CLASS="l">1374</TD><TD>        }</TD></TR><TR><TD CLASS="l">1375</TD><TD> </TD></TR><TR><TD CLASS="l">1376</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="30">1377</A></TD><TD>        /**</TD></TR><TR><TD CLASS="l">1378</TD><TD>         * Checks and sets ready status</TD></TR><TR><TD CLASS="l">1379</TD><TD>         */</TD></TR><TR><TD CLASS="l">1380</TD><TD>        protected void updateReadyStatus() {</TD></TR><TR CLASS="z"><TD CLASS="l">1381</TD><TD>            if (command != null</TD></TR><TR><TD CLASS="l">1382</TD><TD>                &amp;&amp; env != null</TD></TR><TR><TD CLASS="l">1383</TD><TD>                &amp;&amp; wd != null</TD></TR><TR><TD CLASS="l">1384</TD><TD>                &amp;&amp; params != null</TD></TR><TR><TD CLASS="l">1385</TD><TD>                &amp;&amp; response != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">1386</TD><TD>                readyToRun = true;</TD></TR><TR><TD CLASS="l">1387</TD><TD>            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">1388</TD><TD>                readyToRun = false;</TD></TR><TR><TD CLASS="l">1389</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">1390</TD><TD>        }</TD></TR><TR><TD CLASS="l">1391</TD><TD> </TD></TR><TR><TD CLASS="l">1392</TD><TD> </TD></TR><TR><TD CLASS="l">1393</TD><TD>        /**</TD></TR><TR><TD CLASS="l">1394</TD><TD>         * Gets ready status</TD></TR><TR><TD CLASS="l">1395</TD><TD>         *</TD></TR><TR><TD CLASS="l"><A NAME="2b">1396</A></TD><TD>         * @return   false if not ready (&lt;code&gt;run&lt;/code&gt; will throw</TD></TR><TR><TD CLASS="l">1397</TD><TD>         *           an exception), true if ready</TD></TR><TR><TD CLASS="l">1398</TD><TD>         */</TD></TR><TR><TD CLASS="l">1399</TD><TD>        protected boolean isReady() {</TD></TR><TR CLASS="z"><TD CLASS="l">1400</TD><TD>            return readyToRun;</TD></TR><TR><TD CLASS="l">1401</TD><TD>        }</TD></TR><TR><TD CLASS="l">1402</TD><TD> </TD></TR><TR><TD CLASS="l">1403</TD><TD> </TD></TR><TR><TD CLASS="l">1404</TD><TD>        /**</TD></TR><TR><TD CLASS="l">1405</TD><TD>         * Sets HttpServletResponse object used to set headers and send</TD></TR><TR><TD CLASS="l">1406</TD><TD>         * output to</TD></TR><TR><TD CLASS="l">1407</TD><TD>         *</TD></TR><TR><TD CLASS="l"><A NAME="2f">1408</A></TD><TD>         * @param  response   HttpServletResponse to be used</TD></TR><TR><TD CLASS="l">1409</TD><TD>         *</TD></TR><TR><TD CLASS="l">1410</TD><TD>         */</TD></TR><TR><TD CLASS="l">1411</TD><TD>        protected void setResponse(HttpServletResponse response) {</TD></TR><TR CLASS="z"><TD CLASS="l">1412</TD><TD>            this.response = response;</TD></TR><TR CLASS="z"><TD CLASS="l">1413</TD><TD>            updateReadyStatus();</TD></TR><TR CLASS="z"><TD CLASS="l">1414</TD><TD>        }</TD></TR><TR><TD CLASS="l">1415</TD><TD> </TD></TR><TR><TD CLASS="l">1416</TD><TD> </TD></TR><TR><TD CLASS="l">1417</TD><TD>        /**</TD></TR><TR><TD CLASS="l">1418</TD><TD>         * Sets standard input to be passed on to the invoked cgi script</TD></TR><TR><TD CLASS="l">1419</TD><TD>         *</TD></TR><TR><TD CLASS="l"><A NAME="2e">1420</A></TD><TD>         * @param  stdin   InputStream to be used</TD></TR><TR><TD CLASS="l">1421</TD><TD>         *</TD></TR><TR><TD CLASS="l">1422</TD><TD>         */</TD></TR><TR><TD CLASS="l">1423</TD><TD>        protected void setInput(InputStream stdin) {</TD></TR><TR CLASS="z"><TD CLASS="l">1424</TD><TD>            this.stdin = stdin;</TD></TR><TR CLASS="z"><TD CLASS="l">1425</TD><TD>            updateReadyStatus();</TD></TR><TR CLASS="z"><TD CLASS="l">1426</TD><TD>        }</TD></TR><TR><TD CLASS="l">1427</TD><TD> </TD></TR><TR><TD CLASS="l">1428</TD><TD> </TD></TR><TR><TD CLASS="l">1429</TD><TD>        /**</TD></TR><TR><TD CLASS="l">1430</TD><TD>         * Converts a Hashtable to a String array by converting each</TD></TR><TR><TD CLASS="l">1431</TD><TD>         * key/value pair in the Hashtable to a String in the form</TD></TR><TR><TD CLASS="l">1432</TD><TD>         * &#34;key=value&#34; (hashkey + &#34;=&#34; + hash.get(hashkey).toString())</TD></TR><TR><TD CLASS="l">1433</TD><TD>         *</TD></TR><TR><TD CLASS="l">1434</TD><TD>         * @param  h   Hashtable to convert</TD></TR><TR><TD CLASS="l">1435</TD><TD>         *</TD></TR><TR><TD CLASS="l">1436</TD><TD>         * @return     converted string array</TD></TR><TR><TD CLASS="l">1437</TD><TD>         *</TD></TR><TR><TD CLASS="l">1438</TD><TD>         * @exception  NullPointerException   if a hash key has a null value</TD></TR><TR><TD CLASS="l"><A NAME="2a">1439</A></TD><TD>         *</TD></TR><TR><TD CLASS="l">1440</TD><TD>         */</TD></TR><TR><TD CLASS="l">1441</TD><TD>        protected String[] hashToStringArray(Hashtable&lt;String,?&gt; h)</TD></TR><TR><TD CLASS="l">1442</TD><TD>            throws NullPointerException {</TD></TR><TR CLASS="z"><TD CLASS="l">1443</TD><TD>            Vector&lt;String&gt; v = new Vector&lt;String&gt;();</TD></TR><TR CLASS="z"><TD CLASS="l">1444</TD><TD>            Enumeration&lt;String&gt; e = h.keys();</TD></TR><TR CLASS="z"><TD CLASS="l">1445</TD><TD>            while (e.hasMoreElements()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1446</TD><TD>                String k = e.nextElement();</TD></TR><TR CLASS="z"><TD CLASS="l">1447</TD><TD>                v.add(k + &#34;=&#34; + h.get(k).toString());</TD></TR><TR CLASS="z"><TD CLASS="l">1448</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">1449</TD><TD>            String[] strArr = new String[v.size()];</TD></TR><TR CLASS="z"><TD CLASS="l">1450</TD><TD>            v.copyInto(strArr);</TD></TR><TR CLASS="z"><TD CLASS="l">1451</TD><TD>            return strArr;</TD></TR><TR><TD CLASS="l">1452</TD><TD>        }</TD></TR><TR><TD CLASS="l">1453</TD><TD> </TD></TR><TR><TD CLASS="l">1454</TD><TD> </TD></TR><TR><TD CLASS="l">1455</TD><TD>        /**</TD></TR><TR><TD CLASS="l">1456</TD><TD>         * Executes a CGI script with the desired environment, current working</TD></TR><TR><TD CLASS="l">1457</TD><TD>         * directory, and input/output streams</TD></TR><TR><TD CLASS="l">1458</TD><TD>         *</TD></TR><TR><TD CLASS="l">1459</TD><TD>         * &lt;p&gt;</TD></TR><TR><TD CLASS="l">1460</TD><TD>         * This implements the following CGI specification recommedations:</TD></TR><TR><TD CLASS="l">1461</TD><TD>         * &lt;/p&gt;</TD></TR><TR><TD CLASS="l">1462</TD><TD>         * &lt;UL&gt;</TD></TR><TR><TD CLASS="l">1463</TD><TD>         * &lt;LI&gt; Servers SHOULD provide the &#34;&lt;code&gt;query&lt;/code&gt;&#34; component of</TD></TR><TR><TD CLASS="l">1464</TD><TD>         *      the script-URI as command-line arguments to scripts if it</TD></TR><TR><TD CLASS="l">1465</TD><TD>         *      does not contain any unencoded &#34;=&#34; characters and the</TD></TR><TR><TD CLASS="l">1466</TD><TD>         *      command-line arguments can be generated in an unambiguous</TD></TR><TR><TD CLASS="l">1467</TD><TD>         *      manner.</TD></TR><TR><TD CLASS="l">1468</TD><TD>         * &lt;LI&gt; Servers SHOULD set the AUTH_TYPE metavariable to the value</TD></TR><TR><TD CLASS="l">1469</TD><TD>         *      of the &#34;&lt;code&gt;auth-scheme&lt;/code&gt;&#34; token of the</TD></TR><TR><TD CLASS="l">1470</TD><TD>         *      &#34;&lt;code&gt;Authorization&lt;/code&gt;&#34; if it was supplied as part of the</TD></TR><TR><TD CLASS="l">1471</TD><TD>         *      request header.  See &lt;code&gt;getCGIEnvironment&lt;/code&gt; method.</TD></TR><TR><TD CLASS="l">1472</TD><TD>         * &lt;LI&gt; Where applicable, servers SHOULD set the current working</TD></TR><TR><TD CLASS="l">1473</TD><TD>         *      directory to the directory in which the script is located</TD></TR><TR><TD CLASS="l">1474</TD><TD>         *      before invoking it.</TD></TR><TR><TD CLASS="l">1475</TD><TD>         * &lt;LI&gt; Server implementations SHOULD define their behavior for the</TD></TR><TR><TD CLASS="l">1476</TD><TD>         *      following cases:</TD></TR><TR><TD CLASS="l">1477</TD><TD>         *     &lt;ul&gt;</TD></TR><TR><TD CLASS="l">1478</TD><TD>         *     &lt;LI&gt; &lt;u&gt;Allowed characters in pathInfo&lt;/u&gt;:  This implementation</TD></TR><TR><TD CLASS="l">1479</TD><TD>         *             does not allow ASCII NUL nor any character which cannot</TD></TR><TR><TD CLASS="l">1480</TD><TD>         *             be URL-encoded according to internet standards;</TD></TR><TR><TD CLASS="l">1481</TD><TD>         *     &lt;LI&gt; &lt;u&gt;Allowed characters in path segments&lt;/u&gt;: This</TD></TR><TR><TD CLASS="l">1482</TD><TD>         *             implementation does not allow non-terminal NULL</TD></TR><TR><TD CLASS="l">1483</TD><TD>         *             segments in the the path -- IOExceptions may be thrown;</TD></TR><TR><TD CLASS="l">1484</TD><TD>         *     &lt;LI&gt; &lt;u&gt;&#34;&lt;code&gt;.&lt;/code&gt;&#34; and &#34;&lt;code&gt;..&lt;/code&gt;&#34; path</TD></TR><TR><TD CLASS="l">1485</TD><TD>         *             segments&lt;/u&gt;:</TD></TR><TR><TD CLASS="l">1486</TD><TD>         *             This implementation does not allow &#34;&lt;code&gt;.&lt;/code&gt;&#34; and</TD></TR><TR><TD CLASS="l">1487</TD><TD>         *             &#34;&lt;code&gt;..&lt;/code&gt;&#34; in the the path, and such characters</TD></TR><TR><TD CLASS="l">1488</TD><TD>         *             will result in an IOException being thrown (this should</TD></TR><TR><TD CLASS="l">1489</TD><TD>         *             never happen since Tomcat normalises the requestURI</TD></TR><TR><TD CLASS="l">1490</TD><TD>         *             before determining the contextPath, servletPath and</TD></TR><TR><TD CLASS="l">1491</TD><TD>         *             pathInfo);</TD></TR><TR><TD CLASS="l">1492</TD><TD>         *     &lt;LI&gt; &lt;u&gt;Implementation limitations&lt;/u&gt;: This implementation</TD></TR><TR><TD CLASS="l">1493</TD><TD>         *             does not impose any limitations except as documented</TD></TR><TR><TD CLASS="l">1494</TD><TD>         *             above.  This implementation may be limited by the</TD></TR><TR><TD CLASS="l">1495</TD><TD>         *             servlet container used to house this implementation.</TD></TR><TR><TD CLASS="l">1496</TD><TD>         *             In particular, all the primary CGI variable values</TD></TR><TR><TD CLASS="l">1497</TD><TD>         *             are derived either directly or indirectly from the</TD></TR><TR><TD CLASS="l">1498</TD><TD>         *             container's implementation of the Servlet API methods.</TD></TR><TR><TD CLASS="l">1499</TD><TD>         *     &lt;/ul&gt;</TD></TR><TR><TD CLASS="l">1500</TD><TD>         * &lt;/UL&gt;</TD></TR><TR><TD CLASS="l">1501</TD><TD>         *</TD></TR><TR><TD CLASS="l">1502</TD><TD>         * @exception IOException if problems during reading/writing occur</TD></TR><TR><TD CLASS="l">1503</TD><TD>         *</TD></TR><TR><TD CLASS="l">1504</TD><TD>         * @see    java.lang.Runtime#exec(String command, String[] envp,</TD></TR><TR><TD CLASS="l">1505</TD><TD>         *                                File dir)</TD></TR><TR><TD CLASS="l">1506</TD><TD>         */</TD></TR><TR><TD CLASS="l">1507</TD><TD>        protected void run() throws IOException {</TD></TR><TR><TD CLASS="l">1508</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="2c">1509</A></TD><TD>            /*</TD></TR><TR><TD CLASS="l">1510</TD><TD>             * REMIND:  this method feels too big; should it be re-written?</TD></TR><TR><TD CLASS="l">1511</TD><TD>             */</TD></TR><TR><TD CLASS="l">1512</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1513</TD><TD>            if (!isReady()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1514</TD><TD>                throw new IOException(this.getClass().getName() + &#34;: not ready to run.&#34;);</TD></TR><TR><TD CLASS="l">1515</TD><TD>            }</TD></TR><TR><TD CLASS="l">1516</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1517</TD><TD>            if (log.isDebugEnabled()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1518</TD><TD>                log.debug(&#34;envp: [&#34; + env + &#34;], command: [&#34; + command + &#34;]&#34;);</TD></TR><TR><TD CLASS="l">1519</TD><TD>            }</TD></TR><TR><TD CLASS="l">1520</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1521</TD><TD>            if ((command.indexOf(File.separator + &#34;.&#34; + File.separator) &gt;= 0)</TD></TR><TR CLASS="z"><TD CLASS="l">1522</TD><TD>                || (command.indexOf(File.separator + &#34;..&#34;) &gt;= 0)</TD></TR><TR CLASS="z"><TD CLASS="l">1523</TD><TD>                || (command.indexOf(&#34;..&#34; + File.separator) &gt;= 0)) {</TD></TR><TR CLASS="z"><TD CLASS="l">1524</TD><TD>                throw new IOException(this.getClass().getName()</TD></TR><TR><TD CLASS="l">1525</TD><TD>                                      + &#34;Illegal Character in CGI command &#34;</TD></TR><TR><TD CLASS="l">1526</TD><TD>                                      + &#34;path ('.' or '..') detected.  Not &#34;</TD></TR><TR><TD CLASS="l">1527</TD><TD>                                      + &#34;running CGI [&#34; + command + &#34;].&#34;);</TD></TR><TR><TD CLASS="l">1528</TD><TD>            }</TD></TR><TR><TD CLASS="l">1529</TD><TD> </TD></TR><TR><TD CLASS="l">1530</TD><TD>            /* original content/structure of this section taken from</TD></TR><TR><TD CLASS="l">1531</TD><TD>             * http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=4216884</TD></TR><TR><TD CLASS="l">1532</TD><TD>             * with major modifications by Martin Dengler</TD></TR><TR><TD CLASS="l">1533</TD><TD>             */</TD></TR><TR CLASS="z"><TD CLASS="l">1534</TD><TD>            Runtime rt = null;</TD></TR><TR CLASS="z"><TD CLASS="l">1535</TD><TD>            BufferedReader cgiHeaderReader = null;</TD></TR><TR CLASS="z"><TD CLASS="l">1536</TD><TD>            InputStream cgiOutput = null;</TD></TR><TR CLASS="z"><TD CLASS="l">1537</TD><TD>            BufferedReader commandsStdErr = null;</TD></TR><TR CLASS="z"><TD CLASS="l">1538</TD><TD>            Thread errReaderThread = null;</TD></TR><TR CLASS="z"><TD CLASS="l">1539</TD><TD>            BufferedOutputStream commandsStdIn = null;</TD></TR><TR CLASS="z"><TD CLASS="l">1540</TD><TD>            Process proc = null;</TD></TR><TR CLASS="z"><TD CLASS="l">1541</TD><TD>            int bufRead = -1;</TD></TR><TR><TD CLASS="l">1542</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1543</TD><TD>            List&lt;String&gt; cmdAndArgs = new ArrayList&lt;String&gt;();</TD></TR><TR CLASS="z"><TD CLASS="l">1544</TD><TD>            if (cgiExecutable.length() != 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">1545</TD><TD>                cmdAndArgs.add(cgiExecutable);</TD></TR><TR><TD CLASS="l">1546</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">1547</TD><TD>            if (cgiExecutableArgs != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">1548</TD><TD>                cmdAndArgs.addAll(cgiExecutableArgs);</TD></TR><TR><TD CLASS="l">1549</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">1550</TD><TD>            cmdAndArgs.add(command);</TD></TR><TR CLASS="z"><TD CLASS="l">1551</TD><TD>            cmdAndArgs.addAll(params);</TD></TR><TR><TD CLASS="l">1552</TD><TD> </TD></TR><TR><TD CLASS="l">1553</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">1554</TD><TD>                rt = Runtime.getRuntime();</TD></TR><TR CLASS="z"><TD CLASS="l">1555</TD><TD>                proc = rt.exec(</TD></TR><TR CLASS="z"><TD CLASS="l">1556</TD><TD>                        cmdAndArgs.toArray(new String[cmdAndArgs.size()]),</TD></TR><TR CLASS="z"><TD CLASS="l">1557</TD><TD>                        hashToStringArray(env), wd);</TD></TR><TR><TD CLASS="l">1558</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1559</TD><TD>                String sContentLength = env.get(&#34;CONTENT_LENGTH&#34;);</TD></TR><TR><TD CLASS="l">1560</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1561</TD><TD>                if(!&#34;&#34;.equals(sContentLength)) {</TD></TR><TR CLASS="z"><TD CLASS="l">1562</TD><TD>                    commandsStdIn = new BufferedOutputStream(proc.getOutputStream());</TD></TR><TR CLASS="z"><TD CLASS="l">1563</TD><TD>                    IOTools.flow(stdin, commandsStdIn);</TD></TR><TR CLASS="z"><TD CLASS="l">1564</TD><TD>                    commandsStdIn.flush();</TD></TR><TR CLASS="z"><TD CLASS="l">1565</TD><TD>                    commandsStdIn.close();</TD></TR><TR><TD CLASS="l">1566</TD><TD>                }</TD></TR><TR><TD CLASS="l">1567</TD><TD> </TD></TR><TR><TD CLASS="l">1568</TD><TD>                /* we want to wait for the process to exit,  Process.waitFor()</TD></TR><TR><TD CLASS="l">1569</TD><TD>                 * is useless in our situation; see</TD></TR><TR><TD CLASS="l">1570</TD><TD>                 * http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=4223650</TD></TR><TR><TD CLASS="l">1571</TD><TD>                 */</TD></TR><TR><TD CLASS="l">1572</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1573</TD><TD>                boolean isRunning = true;</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="31">1574</A></TD><TD>                commandsStdErr = new BufferedReader</TD></TR><TR CLASS="z"><TD CLASS="l">1575</TD><TD>                    (new InputStreamReader(proc.getErrorStream()));</TD></TR><TR CLASS="z"><TD CLASS="l">1576</TD><TD>                final BufferedReader stdErrRdr = commandsStdErr ;</TD></TR><TR><TD CLASS="l"><A NAME="33">1577</A></TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1578</TD><TD>                errReaderThread = new Thread() {</TD></TR><TR><TD CLASS="l">1579</TD><TD>                    @Override</TD></TR><TR><TD CLASS="l">1580</TD><TD>                    public void run () {</TD></TR><TR CLASS="z"><TD CLASS="l">1581</TD><TD>                        sendToLog(stdErrRdr);</TD></TR><TR CLASS="z"><TD CLASS="l">1582</TD><TD>                    }</TD></TR><TR><TD CLASS="l">1583</TD><TD>                };</TD></TR><TR CLASS="z"><TD CLASS="l">1584</TD><TD>                errReaderThread.start();</TD></TR><TR><TD CLASS="l">1585</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1586</TD><TD>                InputStream cgiHeaderStream =</TD></TR><TR CLASS="z"><TD CLASS="l">1587</TD><TD>                    new HTTPHeaderInputStream(proc.getInputStream());</TD></TR><TR CLASS="z"><TD CLASS="l">1588</TD><TD>                cgiHeaderReader =</TD></TR><TR><TD CLASS="l">1589</TD><TD>                    new BufferedReader(new InputStreamReader(cgiHeaderStream));</TD></TR><TR><TD CLASS="l">1590</TD><TD> </TD></TR><TR><TD CLASS="l">1591</TD><TD>                // Need to be careful here. If sendError() is called the</TD></TR><TR><TD CLASS="l">1592</TD><TD>                // response body should be provided by the standard error page</TD></TR><TR><TD CLASS="l">1593</TD><TD>                // process. But, if the output of the CGI process isn't read</TD></TR><TR><TD CLASS="l">1594</TD><TD>                // then that process can hang.</TD></TR><TR CLASS="z"><TD CLASS="l">1595</TD><TD>                boolean skipBody = false;</TD></TR><TR><TD CLASS="l">1596</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1597</TD><TD>                while (isRunning) {</TD></TR><TR><TD CLASS="l">1598</TD><TD>                    try {</TD></TR><TR><TD CLASS="l">1599</TD><TD>                        //set headers</TD></TR><TR CLASS="z"><TD CLASS="l">1600</TD><TD>                        String line = null;</TD></TR><TR CLASS="z"><TD CLASS="l">1601</TD><TD>                        while (((line = cgiHeaderReader.readLine()) != null) &amp;&amp; !(&#34;&#34;.equals(line))) {</TD></TR><TR CLASS="z"><TD CLASS="l">1602</TD><TD>                            if (log.isTraceEnabled()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1603</TD><TD>                                log.trace(&#34;addHeader(\&#34;&#34; + line + &#34;\&#34;)&#34;);</TD></TR><TR><TD CLASS="l">1604</TD><TD>                            }</TD></TR><TR CLASS="z"><TD CLASS="l">1605</TD><TD>                            if (line.startsWith(&#34;HTTP&#34;)) {</TD></TR><TR CLASS="z"><TD CLASS="l">1606</TD><TD>                                skipBody = setStatus(response, getSCFromHttpStatusLine(line));</TD></TR><TR CLASS="z"><TD CLASS="l">1607</TD><TD>                            } else if (line.indexOf(':') &gt;= 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">1608</TD><TD>                                String header =</TD></TR><TR CLASS="z"><TD CLASS="l">1609</TD><TD>                                    line.substring(0, line.indexOf(':')).trim();</TD></TR><TR CLASS="z"><TD CLASS="l">1610</TD><TD>                                String value =</TD></TR><TR CLASS="z"><TD CLASS="l">1611</TD><TD>                                    line.substring(line.indexOf(':') + 1).trim();</TD></TR><TR CLASS="z"><TD CLASS="l">1612</TD><TD>                                if (header.equalsIgnoreCase(&#34;status&#34;)) {</TD></TR><TR CLASS="z"><TD CLASS="l">1613</TD><TD>                                    skipBody = setStatus(response, getSCFromCGIStatusHeader(value));</TD></TR><TR><TD CLASS="l">1614</TD><TD>                                } else {</TD></TR><TR CLASS="z"><TD CLASS="l">1615</TD><TD>                                    response.addHeader(header , value);</TD></TR><TR><TD CLASS="l">1616</TD><TD>                                }</TD></TR><TR CLASS="z"><TD CLASS="l">1617</TD><TD>                            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">1618</TD><TD>                                log.info(sm.getString(&#34;cgiServlet.runBadHeader&#34;, line));</TD></TR><TR><TD CLASS="l">1619</TD><TD>                            }</TD></TR><TR><TD CLASS="l">1620</TD><TD>                        }</TD></TR><TR><TD CLASS="l">1621</TD><TD> </TD></TR><TR><TD CLASS="l">1622</TD><TD>                        //write output</TD></TR><TR CLASS="z"><TD CLASS="l">1623</TD><TD>                        byte[] bBuf = new byte[2048];</TD></TR><TR><TD CLASS="l">1624</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1625</TD><TD>                        OutputStream out = response.getOutputStream();</TD></TR><TR CLASS="z"><TD CLASS="l">1626</TD><TD>                        cgiOutput = proc.getInputStream();</TD></TR><TR><TD CLASS="l">1627</TD><TD> </TD></TR><TR><TD CLASS="l">1628</TD><TD>                        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1629</TD><TD>                            while (!skipBody &amp;&amp; (bufRead = cgiOutput.read(bBuf)) != -1) {</TD></TR><TR CLASS="z"><TD CLASS="l">1630</TD><TD>                                if (log.isTraceEnabled()) {</TD></TR><TR CLASS="z"><TD CLASS="l">1631</TD><TD>                                    log.trace(&#34;output &#34; + bufRead + &#34; bytes of data&#34;);</TD></TR><TR><TD CLASS="l">1632</TD><TD>                                }</TD></TR><TR CLASS="z"><TD CLASS="l">1633</TD><TD>                                out.write(bBuf, 0, bufRead);</TD></TR><TR><TD CLASS="l">1634</TD><TD>                            }</TD></TR><TR CLASS="z"><TD CLASS="l">1635</TD><TD>                        } finally {</TD></TR><TR><TD CLASS="l">1636</TD><TD>                            // Attempt to consume any leftover byte if something bad happens,</TD></TR><TR><TD CLASS="l">1637</TD><TD>                            // such as a socket disconnect on the servlet side; otherwise, the</TD></TR><TR><TD CLASS="l">1638</TD><TD>                            // external process could hang</TD></TR><TR CLASS="z"><TD CLASS="l">1639</TD><TD>                            if (bufRead != -1) {</TD></TR><TR CLASS="z"><TD CLASS="l">1640</TD><TD>                                while ((bufRead = cgiOutput.read(bBuf)) != -1) {</TD></TR><TR><TD CLASS="l">1641</TD><TD>                                    // NOOP - just read the data</TD></TR><TR><TD CLASS="l">1642</TD><TD>                                }</TD></TR><TR><TD CLASS="l">1643</TD><TD>                            }</TD></TR><TR CLASS="z"><TD CLASS="l">1644</TD><TD>                        }</TD></TR><TR><TD CLASS="l">1645</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1646</TD><TD>                        proc.exitValue(); // Throws exception if alive</TD></TR><TR><TD CLASS="l">1647</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1648</TD><TD>                        isRunning = false;</TD></TR><TR><TD CLASS="l">1649</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1650</TD><TD>                    } catch (IllegalThreadStateException e) {</TD></TR><TR><TD CLASS="l">1651</TD><TD>                        try {</TD></TR><TR CLASS="z"><TD CLASS="l">1652</TD><TD>                            Thread.sleep(500);</TD></TR><TR CLASS="z"><TD CLASS="l">1653</TD><TD>                        } catch (InterruptedException ignored) {</TD></TR><TR><TD CLASS="l">1654</TD><TD>                            // Ignore</TD></TR><TR CLASS="z"><TD CLASS="l">1655</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">1656</TD><TD>                    }</TD></TR><TR><TD CLASS="l">1657</TD><TD>                } //replacement for Process.waitFor()</TD></TR><TR><TD CLASS="l">1658</TD><TD>                </TD></TR><TR CLASS="z"><TD CLASS="l">1659</TD><TD>            } catch (IOException e){</TD></TR><TR CLASS="z"><TD CLASS="l">1660</TD><TD>                log.warn(sm.getString(&#34;cgiServlet.runFail&#34;), e);</TD></TR><TR CLASS="z"><TD CLASS="l">1661</TD><TD>                throw e;</TD></TR><TR><TD CLASS="l">1662</TD><TD>            } finally {</TD></TR><TR><TD CLASS="l">1663</TD><TD>                // Close the header reader</TD></TR><TR CLASS="z"><TD CLASS="l">1664</TD><TD>                if (cgiHeaderReader != null) {</TD></TR><TR><TD CLASS="l">1665</TD><TD>                    try {</TD></TR><TR CLASS="z"><TD CLASS="l">1666</TD><TD>                        cgiHeaderReader.close();</TD></TR><TR CLASS="z"><TD CLASS="l">1667</TD><TD>                    } catch (IOException ioe) {</TD></TR><TR CLASS="z"><TD CLASS="l">1668</TD><TD>                        log.warn(sm.getString(&#34;cgiServlet.runHeaderReaderFail&#34;), ioe);</TD></TR><TR CLASS="z"><TD CLASS="l">1669</TD><TD>                    }</TD></TR><TR><TD CLASS="l">1670</TD><TD>                }</TD></TR><TR><TD CLASS="l">1671</TD><TD>                // Close the output stream if used</TD></TR><TR CLASS="z"><TD CLASS="l">1672</TD><TD>                if (cgiOutput != null) {</TD></TR><TR><TD CLASS="l">1673</TD><TD>                    try {</TD></TR><TR CLASS="z"><TD CLASS="l">1674</TD><TD>                        cgiOutput.close();</TD></TR><TR CLASS="z"><TD CLASS="l">1675</TD><TD>                    } catch (IOException ioe) {</TD></TR><TR CLASS="z"><TD CLASS="l">1676</TD><TD>                        log.warn(sm.getString(&#34;cgiServlet.runOutputStreamFail&#34;), ioe);</TD></TR><TR CLASS="z"><TD CLASS="l">1677</TD><TD>                    }</TD></TR><TR><TD CLASS="l">1678</TD><TD>                }</TD></TR><TR><TD CLASS="l">1679</TD><TD>                // Make sure the error stream reader has finished</TD></TR><TR CLASS="z"><TD CLASS="l">1680</TD><TD>                if (errReaderThread != null) {</TD></TR><TR><TD CLASS="l">1681</TD><TD>                    try {</TD></TR><TR CLASS="z"><TD CLASS="l">1682</TD><TD>                        errReaderThread.join(stderrTimeout);</TD></TR><TR CLASS="z"><TD CLASS="l">1683</TD><TD>                    } catch (InterruptedException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1684</TD><TD>                        log.warn(sm.getString(&#34;cgiServlet.runReaderInterupt&#34;));                    }</TD></TR><TR><TD CLASS="l">1685</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1686</TD><TD>                if (proc != null){</TD></TR><TR CLASS="z"><TD CLASS="l">1687</TD><TD>                    proc.destroy();</TD></TR><TR CLASS="z"><TD CLASS="l">1688</TD><TD>                    proc = null;</TD></TR><TR><TD CLASS="l">1689</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1690</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">1691</TD><TD>        }</TD></TR><TR><TD CLASS="l">1692</TD><TD> </TD></TR><TR><TD CLASS="l">1693</TD><TD>        /**</TD></TR><TR><TD CLASS="l">1694</TD><TD>         * Parses the Status-Line and extracts the status code.</TD></TR><TR><TD CLASS="l">1695</TD><TD>         *</TD></TR><TR><TD CLASS="l">1696</TD><TD>         * @param line The HTTP Status-Line (RFC2616, section 6.1)</TD></TR><TR><TD CLASS="l"><A NAME="29">1697</A></TD><TD>         * @return The extracted status code or the code representing an</TD></TR><TR><TD CLASS="l">1698</TD><TD>         * internal error if a valid status code cannot be extracted.</TD></TR><TR><TD CLASS="l">1699</TD><TD>         */</TD></TR><TR><TD CLASS="l">1700</TD><TD>        private int getSCFromHttpStatusLine(String line) {</TD></TR><TR CLASS="z"><TD CLASS="l">1701</TD><TD>            int statusStart = line.indexOf(' ') + 1;</TD></TR><TR><TD CLASS="l">1702</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1703</TD><TD>            if (statusStart &lt; 1 || line.length() &lt; statusStart + 3) {</TD></TR><TR><TD CLASS="l">1704</TD><TD>                // Not a valid HTTP Status-Line</TD></TR><TR CLASS="z"><TD CLASS="l">1705</TD><TD>                log.warn(sm.getString(&#34;cgiServlet.runInvalidStatus&#34;, line));</TD></TR><TR CLASS="z"><TD CLASS="l">1706</TD><TD>                return HttpServletResponse.SC_INTERNAL_SERVER_ERROR;</TD></TR><TR><TD CLASS="l">1707</TD><TD>            }</TD></TR><TR><TD CLASS="l">1708</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1709</TD><TD>            String status = line.substring(statusStart, statusStart + 3);</TD></TR><TR><TD CLASS="l">1710</TD><TD> </TD></TR><TR><TD CLASS="l">1711</TD><TD>            int statusCode;</TD></TR><TR><TD CLASS="l">1712</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">1713</TD><TD>                statusCode = Integer.parseInt(status);</TD></TR><TR CLASS="z"><TD CLASS="l">1714</TD><TD>            } catch (NumberFormatException nfe) {</TD></TR><TR><TD CLASS="l">1715</TD><TD>                // Not a valid status code</TD></TR><TR CLASS="z"><TD CLASS="l">1716</TD><TD>                log.warn(sm.getString(&#34;cgiServlet.runInvalidStatus&#34;, status));</TD></TR><TR CLASS="z"><TD CLASS="l">1717</TD><TD>                return HttpServletResponse.SC_INTERNAL_SERVER_ERROR;</TD></TR><TR CLASS="z"><TD CLASS="l">1718</TD><TD>            }</TD></TR><TR><TD CLASS="l">1719</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1720</TD><TD>            return statusCode;</TD></TR><TR><TD CLASS="l">1721</TD><TD>        }</TD></TR><TR><TD CLASS="l">1722</TD><TD> </TD></TR><TR><TD CLASS="l">1723</TD><TD>        /**</TD></TR><TR><TD CLASS="l">1724</TD><TD>         * Parses the CGI Status Header value and extracts the status code.</TD></TR><TR><TD CLASS="l">1725</TD><TD>         *</TD></TR><TR><TD CLASS="l">1726</TD><TD>         * @param value The CGI Status value of the form &lt;code&gt;</TD></TR><TR><TD CLASS="l">1727</TD><TD>         *             digit digit digit SP reason-phrase&lt;/code&gt;</TD></TR><TR><TD CLASS="l"><A NAME="28">1728</A></TD><TD>         * @return The extracted status code or the code representing an</TD></TR><TR><TD CLASS="l">1729</TD><TD>         * internal error if a valid status code cannot be extracted.</TD></TR><TR><TD CLASS="l">1730</TD><TD>         */</TD></TR><TR><TD CLASS="l">1731</TD><TD>        private int getSCFromCGIStatusHeader(String value) {</TD></TR><TR CLASS="z"><TD CLASS="l">1732</TD><TD>            if (value.length() &lt; 3) {</TD></TR><TR><TD CLASS="l">1733</TD><TD>                // Not a valid status value</TD></TR><TR CLASS="z"><TD CLASS="l">1734</TD><TD>                log.warn(sm.getString(&#34;cgiServlet.runInvalidStatus&#34;, value));</TD></TR><TR CLASS="z"><TD CLASS="l">1735</TD><TD>                return HttpServletResponse.SC_INTERNAL_SERVER_ERROR;</TD></TR><TR><TD CLASS="l">1736</TD><TD>            }</TD></TR><TR><TD CLASS="l">1737</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1738</TD><TD>            String status = value.substring(0, 3);</TD></TR><TR><TD CLASS="l">1739</TD><TD> </TD></TR><TR><TD CLASS="l">1740</TD><TD>            int statusCode;</TD></TR><TR><TD CLASS="l">1741</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">1742</TD><TD>                statusCode = Integer.parseInt(status);</TD></TR><TR CLASS="z"><TD CLASS="l">1743</TD><TD>            } catch (NumberFormatException nfe) {</TD></TR><TR><TD CLASS="l">1744</TD><TD>                // Not a valid status code</TD></TR><TR CLASS="z"><TD CLASS="l">1745</TD><TD>                log.warn(sm.getString(&#34;cgiServlet.runInvalidStatus&#34;, status));</TD></TR><TR CLASS="z"><TD CLASS="l">1746</TD><TD>                return HttpServletResponse.SC_INTERNAL_SERVER_ERROR;</TD></TR><TR CLASS="z"><TD CLASS="l">1747</TD><TD>            }</TD></TR><TR><TD CLASS="l">1748</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="2d">1749</A></TD><TD>            return statusCode;</TD></TR><TR><TD CLASS="l">1750</TD><TD>        }</TD></TR><TR><TD CLASS="l">1751</TD><TD> </TD></TR><TR><TD CLASS="l">1752</TD><TD>        private void sendToLog(BufferedReader rdr) {</TD></TR><TR CLASS="z"><TD CLASS="l">1753</TD><TD>            String line = null;</TD></TR><TR CLASS="z"><TD CLASS="l">1754</TD><TD>            int lineCount = 0 ;</TD></TR><TR><TD CLASS="l">1755</TD><TD>            try {</TD></TR><TR CLASS="z"><TD CLASS="l">1756</TD><TD>                while ((line = rdr.readLine()) != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">1757</TD><TD>                    log.warn(sm.getString(&#34;cgiServlet.runStdErr&#34;, line));</TD></TR><TR CLASS="z"><TD CLASS="l">1758</TD><TD>                    lineCount++ ;</TD></TR><TR><TD CLASS="l">1759</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1760</TD><TD>            } catch (IOException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1761</TD><TD>                log.warn(sm.getString(&#34;cgiServlet.runStdErrFail&#34;), e);</TD></TR><TR CLASS="z"><TD CLASS="l">1762</TD><TD>            } finally {</TD></TR><TR CLASS="z"><TD CLASS="l">1763</TD><TD>                try {</TD></TR><TR CLASS="z"><TD CLASS="l">1764</TD><TD>                    rdr.close();</TD></TR><TR CLASS="z"><TD CLASS="l">1765</TD><TD>                } catch (IOException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">1766</TD><TD>                    log.warn(sm.getString(&#34;cgiServlet.runStdErrFail&#34;), e);</TD></TR><TR CLASS="z"><TD CLASS="l">1767</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">1768</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">1769</TD><TD>            if (lineCount &gt; 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">1770</TD><TD>                log.warn(sm.getString(&#34;cgiServlet.runStdErrCount&#34;, Integer.valueOf(lineCount)));</TD></TR><TR><TD CLASS="l">1771</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">1772</TD><TD>        }</TD></TR><TR><TD CLASS="l">1773</TD><TD>    } //class CGIRunner</TD></TR><TR><TD CLASS="l">1774</TD><TD> </TD></TR><TR><TD CLASS="l">1775</TD><TD>    /**</TD></TR><TR><TD CLASS="l">1776</TD><TD>     * This is an input stream specifically for reading HTTP headers. It reads</TD></TR><TR><TD CLASS="l">1777</TD><TD>     * upto and including the two blank lines terminating the headers. It</TD></TR><TR><TD CLASS="l">1778</TD><TD>     * allows the content to be read using bytes or characters as appropriate.</TD></TR><TR><TD CLASS="l">1779</TD><TD>     */</TD></TR><TR><TD CLASS="l">1780</TD><TD>    protected static class HTTPHeaderInputStream extends InputStream {</TD></TR><TR><TD CLASS="l">1781</TD><TD>        private static final int STATE_CHARACTER = 0;</TD></TR><TR><TD CLASS="l">1782</TD><TD>        private static final int STATE_FIRST_CR = 1;</TD></TR><TR><TD CLASS="l">1783</TD><TD>        private static final int STATE_FIRST_LF = 2;</TD></TR><TR><TD CLASS="l">1784</TD><TD>        private static final int STATE_SECOND_CR = 3;</TD></TR><TR><TD CLASS="l">1785</TD><TD>        private static final int STATE_HEADER_END = 4;</TD></TR><TR><TD CLASS="l"><A NAME="34">1786</A></TD><TD> </TD></TR><TR><TD CLASS="l">1787</TD><TD>        private final InputStream input;</TD></TR><TR><TD CLASS="l">1788</TD><TD>        private int state;</TD></TR><TR><TD CLASS="l">1789</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1790</TD><TD>        HTTPHeaderInputStream(InputStream theInput) {</TD></TR><TR CLASS="z"><TD CLASS="l">1791</TD><TD>            input = theInput;</TD></TR><TR CLASS="z"><TD CLASS="l">1792</TD><TD>            state = STATE_CHARACTER;</TD></TR><TR CLASS="z"><TD CLASS="l">1793</TD><TD>        }</TD></TR><TR><TD CLASS="l">1794</TD><TD> </TD></TR><TR><TD CLASS="l">1795</TD><TD>        /**</TD></TR><TR><TD CLASS="l"><A NAME="36">1796</A></TD><TD>         * @see java.io.InputStream#read()</TD></TR><TR><TD CLASS="l">1797</TD><TD>         */</TD></TR><TR><TD CLASS="l">1798</TD><TD>        @Override</TD></TR><TR><TD CLASS="l">1799</TD><TD>        public int read() throws IOException {</TD></TR><TR CLASS="z"><TD CLASS="l">1800</TD><TD>            if (state == STATE_HEADER_END) {</TD></TR><TR CLASS="z"><TD CLASS="l">1801</TD><TD>                return -1;</TD></TR><TR><TD CLASS="l">1802</TD><TD>            }</TD></TR><TR><TD CLASS="l">1803</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1804</TD><TD>            int i = input.read();</TD></TR><TR><TD CLASS="l">1805</TD><TD> </TD></TR><TR><TD CLASS="l">1806</TD><TD>            // Update the state</TD></TR><TR><TD CLASS="l">1807</TD><TD>            // State machine looks like this</TD></TR><TR><TD CLASS="l">1808</TD><TD>            //</TD></TR><TR><TD CLASS="l">1809</TD><TD>            //    --------&gt;--------</TD></TR><TR><TD CLASS="l">1810</TD><TD>            //   |      (CR)       |</TD></TR><TR><TD CLASS="l">1811</TD><TD>            //   |                 |</TD></TR><TR><TD CLASS="l">1812</TD><TD>            //  CR1---&gt;---         |</TD></TR><TR><TD CLASS="l">1813</TD><TD>            //   |        |        |</TD></TR><TR><TD CLASS="l">1814</TD><TD>            //   ^(CR)    |(LF)    |</TD></TR><TR><TD CLASS="l">1815</TD><TD>            //   |        |        |</TD></TR><TR><TD CLASS="l">1816</TD><TD>            // CHAR---&gt;--LF1---&gt;--EOH</TD></TR><TR><TD CLASS="l">1817</TD><TD>            //      (LF)  |  (LF)  |</TD></TR><TR><TD CLASS="l">1818</TD><TD>            //            |(CR)    ^(LF)</TD></TR><TR><TD CLASS="l">1819</TD><TD>            //            |        |</TD></TR><TR><TD CLASS="l">1820</TD><TD>            //          (CR2)--&gt;---</TD></TR><TR><TD CLASS="l">1821</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1822</TD><TD>            if (i == 10) {</TD></TR><TR><TD CLASS="l">1823</TD><TD>                // LF</TD></TR><TR CLASS="z"><TD CLASS="l">1824</TD><TD>                switch(state) {</TD></TR><TR><TD CLASS="l">1825</TD><TD>                    case STATE_CHARACTER:</TD></TR><TR CLASS="z"><TD CLASS="l">1826</TD><TD>                        state = STATE_FIRST_LF;</TD></TR><TR CLASS="z"><TD CLASS="l">1827</TD><TD>                        break;</TD></TR><TR><TD CLASS="l">1828</TD><TD>                    case STATE_FIRST_CR:</TD></TR><TR CLASS="z"><TD CLASS="l">1829</TD><TD>                        state = STATE_FIRST_LF;</TD></TR><TR CLASS="z"><TD CLASS="l">1830</TD><TD>                        break;</TD></TR><TR><TD CLASS="l">1831</TD><TD>                    case STATE_FIRST_LF:</TD></TR><TR><TD CLASS="l">1832</TD><TD>                    case STATE_SECOND_CR:</TD></TR><TR CLASS="z"><TD CLASS="l">1833</TD><TD>                        state = STATE_HEADER_END;</TD></TR><TR CLASS="z"><TD CLASS="l">1834</TD><TD>                        break;</TD></TR><TR><TD CLASS="l">1835</TD><TD>                }</TD></TR><TR><TD CLASS="l">1836</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1837</TD><TD>            } else if (i == 13) {</TD></TR><TR><TD CLASS="l">1838</TD><TD>                // CR</TD></TR><TR CLASS="z"><TD CLASS="l">1839</TD><TD>                switch(state) {</TD></TR><TR><TD CLASS="l">1840</TD><TD>                    case STATE_CHARACTER:</TD></TR><TR CLASS="z"><TD CLASS="l">1841</TD><TD>                        state = STATE_FIRST_CR;</TD></TR><TR CLASS="z"><TD CLASS="l">1842</TD><TD>                        break;</TD></TR><TR><TD CLASS="l">1843</TD><TD>                    case STATE_FIRST_CR:</TD></TR><TR CLASS="z"><TD CLASS="l">1844</TD><TD>                        state = STATE_HEADER_END;</TD></TR><TR CLASS="z"><TD CLASS="l">1845</TD><TD>                        break;</TD></TR><TR><TD CLASS="l">1846</TD><TD>                    case STATE_FIRST_LF:</TD></TR><TR CLASS="z"><TD CLASS="l">1847</TD><TD>                        state = STATE_SECOND_CR;</TD></TR><TR CLASS="z"><TD CLASS="l">1848</TD><TD>                        break;</TD></TR><TR><TD CLASS="l">1849</TD><TD>                }</TD></TR><TR><TD CLASS="l">1850</TD><TD> </TD></TR><TR><TD CLASS="l">1851</TD><TD>            } else {</TD></TR><TR CLASS="z"><TD CLASS="l">1852</TD><TD>                state = STATE_CHARACTER;</TD></TR><TR><TD CLASS="l">1853</TD><TD>            }</TD></TR><TR><TD CLASS="l">1854</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">1855</TD><TD>            return i;</TD></TR><TR><TD CLASS="l">1856</TD><TD>        }</TD></TR><TR><TD CLASS="l">1857</TD><TD>    }  // class HTTPHeaderInputStream</TD></TR><TR><TD CLASS="l">1858</TD><TD> </TD></TR><TR><TD CLASS="l">1859</TD><TD>} //class CGIServlet</TD></TR></TABLE><P></P><TABLE WIDTH="100%" CLASS="hdft" CELLSPACING="0"><TR><TD CLASS="nv">[<A HREF="../index.html">all classes</A>][<A HREF="13.html">org.apache.catalina.servlets</A>]</TD></TR><TR><TD CLASS="tl"><A HREF="http://sourceforge.net/projects/emma">EMMA 2.1.5320 (stable)</A> (C) Vladimir Roubtsov</TD></TR></TABLE></BODY></HTML>